<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/public/img/pestana-LB.png" type="image/png">
    <title>Resultado del Pago - LOCOBAR</title>
    <link href="/libs/css/bootstrap.min.css" rel="stylesheet">
    <link href="/libs/css/bootstrap-icons.css" rel="stylesheet">
    <link href="/public/css/theme.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container mt-5 text-center">
        <div id="loadingState">
            <div class="spinner-border text-primary mb-3" role="status"></div>
            <p>Confirmando su pago...</p>
        </div>
        <div id="successState" class="d-none card card-lb shadow-sm d-inline-block p-4 text-start">
            <h4 class="text-success mb-3"><i class="bi bi-check-circle"></i> ¡Pago confirmado!</h4>
            <p class="text-muted mb-0">Su pedido ha sido registrado correctamente.</p>
            <p class="small text-muted mt-2">Redirigiendo a Mis Pedidos...</p>
        </div>
        <div id="errorState" class="d-none card card-lb shadow-sm d-inline-block p-4 text-start">
            <h4 class="text-danger mb-3"><i class="bi bi-x-circle"></i> Pago no completado</h4>
            <p id="errorMsg" class="text-muted"></p>
            <a href="/customer/checkout" class="btn btn-lb-primary mt-3">Volver al Checkout</a>
        </div>
    </div>
    <script src="/libs/js/jquery.min.js"></script>
    <script>
        function getQueryParam(name) {
            const params = new URLSearchParams(window.location.search);
            return params.get(name);
        }
        const id = getQueryParam('id');
        const clientTransactionId = getQueryParam('clientTransactionId');
        const token = localStorage.getItem('customerToken');

        if (!token) {
            document.getElementById('loadingState').classList.add('d-none');
            document.getElementById('errorState').classList.remove('d-none');
            document.getElementById('errorMsg').textContent = 'Debe iniciar sesión para completar el proceso.';
            const btn = document.querySelector('#errorState .btn');
            btn.href = '/customer/login';
            btn.textContent = 'Iniciar sesión';
        } else if (!id || !clientTransactionId) {
            document.getElementById('loadingState').classList.add('d-none');
            document.getElementById('errorState').classList.remove('d-none');
            document.getElementById('errorMsg').textContent = 'Faltan parámetros de la transacción.';
        } else {
            $.ajax({
                url: '/api/customer/checkout/confirm-payphone',
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + token },
                contentType: 'application/json',
                data: JSON.stringify({ id, clientTransactionId }),
                success: function(response) {
                    document.getElementById('loadingState').classList.add('d-none');
                    document.getElementById('successState').classList.remove('d-none');
                    localStorage.removeItem('customerCart');
                    setTimeout(function() {
                        window.location.href = '/customer/orders';
                    }, 2500);
                },
                error: function(xhr) {
                    document.getElementById('loadingState').classList.add('d-none');
                    document.getElementById('errorState').classList.remove('d-none');
                    var msg = 'Error al confirmar el pago.';
                    try {
                        if (xhr.responseJSON && xhr.responseJSON.error) {
                            msg = xhr.responseJSON.error;
                        } else if (xhr.responseText) {
                            var parsed = JSON.parse(xhr.responseText);
                            msg = parsed.error || msg;
                        }
                    } catch(e) {
                        msg = 'Error de comunicación con el servidor (status: ' + xhr.status + '). El pago pudo haberse procesado. Verifique en Mis Pedidos.';
                    }
                    document.getElementById('errorMsg').textContent = msg;
                }
            });
        }
    </script>
</body>
</html>

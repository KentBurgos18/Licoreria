<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/public/img/pestana-LB.png" type="image/png">
    <title>Catálogo - LOCOBAR</title>
    <link href="/libs/css/bootstrap.min.css" rel="stylesheet">
    <link href="/libs/css/bootstrap-icons.css" rel="stylesheet">
    <link href="/public/css/theme.css" rel="stylesheet">
    <style>
        /* ── Product grid ── */
        .pgrid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        /* ── Product card ── */
        .product-card {
            background: var(--surf);
            border: 1px solid var(--border);
            border-radius: 13px;
            padding: 14px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: border-color .18s, transform .18s, box-shadow .18s;
            position: relative;
            overflow: hidden;
        }
        .product-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        /* ── Image ── */
        .product-card-image-wrap {
            flex-shrink: 0;
            width: 60px; height: 60px;
            border-radius: 9px;
            background: var(--surf2);
            border: 1px solid var(--border);
            overflow: hidden;
            display: flex; align-items: center; justify-content: center;
        }
        .product-card-image-wrap img { width: 100%; height: 100%; object-fit: cover; }
        .product-card-image-placeholder { color: var(--text3); opacity: .5; font-size: 1.6em; }
        /* ── Body ── */
        .product-card-body {
            flex: 1; min-width: 0;
            display: flex; flex-direction: column; justify-content: center;
        }
        .pname {
            font-size: 13px; font-weight: 500;
            color: var(--text);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            margin-bottom: 4px; line-height: 1.3; cursor: pointer;
        }
        .pname.expanded { white-space: normal; overflow: visible; }
        /* ── Stock ── */
        .pstock {
            font-size: 10.5px; font-weight: 500;
            padding: 2px 8px; border-radius: 20px;
            display: inline-flex; align-items: center; gap: 4px;
            margin-bottom: 6px;
        }
        .pstock::before { content: ''; width: 4px; height: 4px; border-radius: 50%; flex-shrink: 0; }
        .pstock.ok  { background: var(--gbg);  color: var(--green); }
        .pstock.ok::before  { background: var(--green); }
        .pstock.low { background: var(--ambg); color: var(--amber); }
        .pstock.low::before { background: var(--amber); }
        .pstock.out { background: var(--rbg);  color: var(--red); }
        .pstock.out::before { background: var(--red); }
        /* ── Combo badge ── */
        .combo-badge {
            font-size: 9.5px; font-weight: 800;
            padding: 2px 7px; border-radius: 4px;
            background: var(--ambg); color: var(--amber);
            letter-spacing: .04em; text-transform: uppercase;
            border: 1px solid rgba(251,191,36,.2);
        }
        /* ── Price ── */
        .pprice { font-family: 'JetBrains Mono', monospace; font-size: 17px; font-weight: 500; color: var(--accent); letter-spacing: -.01em; }
        /* ── Cart button ── */
        .cart-btn {
            width: 38px; height: 38px;
            background: var(--accent);
            border: none; border-radius: 9px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: #fff;
            box-shadow: 0 3px 10px rgba(0,0,0,.3);
            transition: all .18s; flex-shrink: 0;
        }
        .cart-btn:hover:not(:disabled) { filter: brightness(1.12); }
        .cart-btn:disabled { opacity: .4; cursor: default; }
        /* ── Qty pill ── */
        .qty-pill {
            display: inline-flex; align-items: center;
            border-radius: 20px;
            border: 1px solid var(--border);
            overflow: hidden;
            background: var(--surf2);
        }
        .qty-pill .qty-btn {
            background: transparent; border: none;
            padding: 4px 9px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            line-height: 1; transition: background .15s; color: var(--text2);
        }
        .qty-pill .qty-btn:hover:not(:disabled) { background: var(--surf3); }
        .qty-pill .qty-btn:disabled { opacity: .4; cursor: default; }
        .qty-pill .qty-btn.qty-remove { color: var(--red); }
        .qty-pill .qty-btn.qty-add    { color: var(--green); }
        .qty-pill .qty-num {
            min-width: 26px; text-align: center;
            font-weight: 600; font-size: .88rem; color: var(--text);
            border-left: 1px solid var(--border);
            border-right: 1px solid var(--border);
            padding: 0 4px; user-select: none;
        }
        /* ── Search ── */
        .search-wrap { position: relative; margin-bottom: 14px; }
        .search-icon {
            position: absolute; left: 14px; top: 50%;
            transform: translateY(-50%); color: var(--text3); pointer-events: none;
        }
        .search-input {
            width: 100%; background: var(--surf);
            border: 1px solid var(--border); border-radius: 10px;
            padding: 11px 14px 11px 42px;
            font-size: 13.5px; color: var(--text); outline: none;
            transition: border-color .2s, box-shadow .2s;
        }
        .search-input::placeholder { color: var(--text3); }
        .search-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accentbg); }
        /* ── Filters ── */
        .filters { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-sel {
            flex: 1; min-width: 130px;
            background: var(--surf); border: 1px solid var(--border);
            border-radius: 9px; padding: 9px 30px 9px 12px;
            font-size: 13px; color: var(--text2);
            outline: none; cursor: pointer; transition: border-color .2s;
            appearance: none;
        }
        .filter-sel:focus { border-color: var(--accent); }
        /* ── Cart bottom bar ── */
        #cartBottomBar {
            position: fixed; bottom: 0; left: 0; right: 0; z-index: 1050;
            background: var(--hdr);
            border-top: 1px solid var(--hborder);
            height: 64px;
            display: flex; align-items: center; gap: 12px;
            padding: 0 16px;
            box-shadow: 0 -4px 20px rgba(0,0,0,.3);
            backdrop-filter: blur(10px);
            transform: translateY(100%);
            transition: transform .35s cubic-bezier(.34,1.3,.64,1);
        }
        #cartBottomBar.cart-bar-visible { transform: translateY(0); }
        .cart-count {
            width: 28px; height: 28px; border-radius: 8px;
            background: var(--accentbg); border: 1px solid var(--border);
            font-size: 13px; font-weight: 800; color: var(--accent);
            font-family: 'JetBrains Mono', monospace;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }
        .cart-info { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 1px; }
        .cart-label { font-size: 13px; font-weight: 600; color: var(--text); }
        .cart-expiry { font-size: 11px; color: var(--text2); }
        .cart-expiry.cart-expiry-warn { color: var(--red) !important; }
        .cart-total {
            font-size: 14px; font-weight: 700;
            color: var(--accent2); font-family: 'JetBrains Mono', monospace;
            flex-shrink: 0;
        }
        .cart-clear {
            background: var(--rbg); color: var(--red);
            border: 1px solid rgba(248,113,113,.15);
            padding: 6px 12px; border-radius: 8px;
            font-size: 12px; font-weight: 600;
            cursor: pointer; white-space: nowrap;
            transition: filter .18s; flex-shrink: 0;
        }
        .cart-clear:hover { filter: brightness(1.1); }
        .cart-view {
            background: var(--accent); color: #fff !important;
            border: none; padding: 7px 14px; border-radius: 8px;
            font-size: 13px; font-weight: 600;
            display: inline-flex; align-items: center; gap: 6px;
            text-decoration: none !important; white-space: nowrap;
            transition: filter .18s; flex-shrink: 0;
        }
        .cart-view:hover { filter: brightness(1.1); color: #fff !important; }
        body.cart-bar-visible { padding-bottom: 64px; }
        /* Row wrappers: transparentes en desktop (display:contents) */
        .cb-row1, .cb-row2 { display: contents; }
        /* ── Cart bar: responsive mobile ── */
        @media (max-width: 560px) {
            #cartBottomBar { flex-direction: column; height: auto; padding: 10px 12px; gap: 6px; }
            .cb-row1 { display: flex; align-items: center; gap: 10px; width: 100%; }
            .cb-row2 { display: flex; gap: 8px; width: 100%; }
            .cart-info { flex: 1; }
            .cart-clear { flex: 1; text-align: center; }
            .cart-view { flex: 2; justify-content: center; }
            body.cart-bar-visible { padding-bottom: 96px; }
        }
        /* ── Custom Toast ── */
        .lb-toast {
            background: var(--surf); border: 1px solid var(--border);
            border-radius: 12px; padding: 11px 14px;
            display: flex; align-items: center; gap: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,.1);
            font-size: 13px; font-weight: 500; color: var(--text);
            min-width: 280px; max-width: 380px;
            position: fixed; top: 80px; right: 20px; z-index: 9999;
            opacity: 0; transform: translateY(-8px);
            transition: opacity .22s, transform .22s;
        }
        .lb-toast.lb-toast-show { opacity: 1; transform: translateY(0); }
        .lb-toast.lb-toast-hide { opacity: 0; transform: translateY(-8px); }
        .lb-toast-icon { display: flex; align-items: center; flex-shrink: 0; }
        .lb-toast-msg  { flex: 1; }
        .lb-toast-close {
            margin-left: auto; background: none; border: none;
            padding: 2px 5px; cursor: pointer; color: var(--text3);
            border-radius: 5px; flex-shrink: 0; font-size: 16px; line-height: 1;
        }
        .lb-toast-close:hover { color: var(--text); background: var(--surf2); }
        @media (max-width: 576px) {
            .lb-toast {
                top: auto; bottom: 24px; right: auto; left: 50%;
                transform: translateX(-50%) translateY(16px);
                min-width: min(340px, calc(100vw - 32px));
                max-width: calc(100vw - 32px);
            }
            .lb-toast.lb-toast-show { transform: translateX(-50%) translateY(0); }
            .lb-toast.lb-toast-hide { transform: translateX(-50%) translateY(16px); }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-dark navbar-custom navbar-lb">
        <div class="container-fluid">
            <a class="navbar-brand spa-link" href="/customer/catalog">
                <i class="bi bi-shop"></i> LOCOBAR
            </a>
            <div class="d-flex align-items-center">
                <div class="dropdown">
                    <button class="btn btn-outline-light dropdown-toggle d-flex align-items-center" type="button" id="userMenu" data-bs-toggle="dropdown" aria-expanded="false" title="Mi cuenta">
                        <i class="bi bi-person-circle fs-4"></i>
                        <span class="user-name-text ms-1" id="userName">Usuario</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item spa-link" href="/customer/orders"><i class="bi bi-receipt"></i> Mis Pedidos</a></li>
                        <li><a class="dropdown-item spa-link" href="/customer/credits"><i class="bi bi-credit-card"></i> Crédito que está debiendo</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="logout(); return false;"><i class="bi bi-box-arrow-right"></i> Cerrar Sesión</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div id="spa-view-content">
    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Búsqueda -->
        <div class="search-wrap">
            <span class="search-icon"><i class="bi bi-search"></i></span>
            <input type="text" class="search-input" id="searchInput" placeholder="Buscar productos...">
        </div>
        <!-- Filtros -->
        <div class="filters">
            <select class="filter-sel" id="categoryFilter">
                <option value="">Todas las categorías</option>
            </select>
            <select class="filter-sel" id="presentationFilter">
                <option value="">Todas las presentaciones</option>
            </select>
            <select class="filter-sel" id="typeFilter" style="max-width:160px">
                <option value="">Todos</option>
                <option value="SIMPLE">Simples</option>
                <option value="COMBO">Combos</option>
            </select>
        </div>

        <!-- Products Grid -->
        <div id="productsGrid" class="pgrid">
            <div style="grid-column:1/-1;text-align:center;padding:40px 0;color:var(--text2)">
                <div class="spinner-border" role="status"><span class="visually-hidden">Cargando...</span></div>
            </div>
        </div>
    </div>

    <!-- Barra inferior del carrito (aparece al agregar ítems) -->
    <div id="cartBottomBar" aria-hidden="true">
        <div class="cb-row1">
            <div class="cart-count" id="cartBarCount">0</div>
            <div class="cart-info">
                <span class="cart-label" id="cartBarLabel">items en tu carrito</span>
                <span class="cart-expiry" id="cartBarExpiry"></span>
            </div>
            <span class="cart-total" id="cartBarTotal">$0.00</span>
        </div>
        <div class="cb-row2">
            <button class="cart-clear" onclick="clearCart()">Vaciar</button>
            <a href="/customer/cart" class="cart-view spa-link" id="cartBarBtn">
                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2.2" viewBox="0 0 24 24"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
                Ver mi carrito
            </a>
        </div>
    </div>

    <script src="/libs/js/jquery.min.js"></script>
    <script src="/libs/js/bootstrap.bundle.min.js"></script>
    <script>
        let cart = JSON.parse(localStorage.getItem('customerCart')) || [];
        let customer = JSON.parse(localStorage.getItem('customer')) || null;
        let lastProducts = [];
        let searchTimeout;

        function bindCatalogEvents() {
            $('#searchInput').off('input keyup keypress').on('input keyup', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(loadProducts, 300);
            }).on('keypress', function(e) {
                if (e.which === 13) loadProducts();
            });
            $('#typeFilter').off('change').on('change', loadProducts);
            $('#categoryFilter').off('change').on('change', loadProducts);
            $('#presentationFilter').off('change').on('change', loadProducts);
        }

        $(document).ready(function() {
            $.get('/api/public/brand-slogan', function(r) { if (r && r.pageTitleCatalog) document.title = r.pageTitleCatalog; });
            var token = localStorage.getItem('customerToken');
            if (!token) {
                window.location.href = '/customer/login';
                return;
            }
            if (customer) $('#userName').text(customer.name);
            updateCartBar();
            startCartExpiryTimer();
            loadCategoryFilter();
            loadPresentationFilter();
            loadProducts();
            bindCatalogEvents();
        });

        function loadCategoryFilter() {
            $.ajax({
                url: '/api/public/product-categories',
                method: 'GET',
                data: { tenantId: 1 },
                success: function(data) {
                    var cats = data.categories || [];
                    var opts = '<option value="">Todas las categorías</option>';
                    cats.forEach(function(c) {
                        opts += '<option value="' + c.id + '">' + c.name + '</option>';
                    });
                    $('#categoryFilter').html(opts);
                }
            });
        }

        function loadPresentationFilter() {
            $.ajax({
                url: '/api/public/product-presentations',
                method: 'GET',
                data: { tenantId: 1 },
                success: function(data) {
                    var items = data.presentations || [];
                    var opts = '<option value="">Todas las presentaciones</option>';
                    items.forEach(function(p) {
                        opts += '<option value="' + p.id + '">' + p.name + '</option>';
                    });
                    $('#presentationFilter').html(opts);
                }
            });
        }

        function loadProducts() {
            const search = $('#searchInput').val();
            const productType = $('#typeFilter').val();
            const categoryId = $('#categoryFilter').val();
            const presentationId = $('#presentationFilter').val();

            var params = {};
            if (search) params.search = search;
            if (productType) params.productType = productType;
            if (categoryId) params.categoryId = categoryId;
            if (presentationId) params.presentationId = presentationId;

            $.ajax({
                url: '/api/customer/products',
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('customerToken')
                },
                data: params,
                success: function(response) {
                    lastProducts = response.products || [];
                    displayProducts(lastProducts);
                },
                error: function(xhr) {
                    if (xhr.status === 401) {
                        window.location.href = '/customer/login';
                    } else {
                        showAlert('Error al cargar productos', 'danger');
                    }
                }
            });
        }

        function displayProducts(products) {
            const grid = $('#productsGrid');
            grid.empty();

            if (products.length === 0) {
                grid.html(`
                    <div style="grid-column:1/-1;text-align:center;padding:60px 0;color:var(--text2)">
                        <i class="bi bi-inbox" style="font-size:3em;color:var(--text3)"></i>
                        <p class="mt-3">No se encontraron productos disponibles</p>
                    </div>
                `);
                return;
            }

            products.forEach(product => {
                const cartItem = cart.find(item => item.productId === product.id);
                const cartQty = cartItem ? cartItem.quantity : 0;
                const effectiveStock = Math.max(0, (product.currentStock || 0) - cartQty);
                const stockClass = effectiveStock > 10 ? 'ok' : effectiveStock > 0 ? 'low' : 'out';
                const stockText = effectiveStock > 0 ? `Disponibles: ${effectiveStock}` : 'Sin stock';
                const nameEscaped = (product.name || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const imgEscaped = (product.imageUrl || '').replace(/'/g, "\\'");
                const maxStock = product.currentStock || 0;
                const isCombo = product.productType === 'COMBO';

                const btnArea = cartQty > 0
                    ? `<div class="qty-pill">
                            <button class="qty-btn qty-remove" onclick="catalogDecrease(${product.id})" title="Quitar uno">
                                <i class="bi bi-trash3-fill" style="font-size:.7em"></i>
                            </button>
                            <span class="qty-num">${cartQty}</span>
                            <button class="qty-btn qty-add" onclick="catalogIncrease(${product.id}, ${maxStock})"
                                    ${effectiveStock === 0 ? 'disabled' : ''} title="Agregar uno">
                                <i class="bi bi-plus-lg" style="font-size:.8em"></i>
                            </button>
                       </div>`
                    : `<button class="cart-btn"
                               onclick="addToCart(${product.id}, '${nameEscaped}', ${product.salePrice || 0}, ${maxStock}, '${imgEscaped}')"
                               ${effectiveStock === 0 ? 'disabled' : ''} title="Agregar al carrito">
                           <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2.2" viewBox="0 0 24 24"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
                       </button>`;

                const productCard = `
                    <div class="product-card${isCombo ? ' is-combo' : ''}">
                        <div class="product-card-image-wrap">
                            ${product.imageUrl
                                ? `<img src="${product.imageUrl}" alt="${nameEscaped}">`
                                : `<div class="product-card-image-placeholder"><i class="bi bi-image"></i></div>`}
                        </div>
                        <div class="product-card-body">
                            <div class="pname" onclick="this.classList.toggle('expanded')">${product.name}</div>
                            <div style="display:flex;align-items:center;gap:6px">
                                <span class="pstock ${stockClass}">${stockText}</span>
                                ${isCombo ? '<span class="combo-badge">COMBO</span>' : ''}
                            </div>
                            <div style="display:flex;justify-content:space-between;align-items:center">
                                <span class="pprice">$${(product.salePrice || 0).toFixed(2)}</span>
                                ${btnArea}
                            </div>
                        </div>
                    </div>
                `;
                grid.append(productCard);
            });
        }

        function addToCart(productId, productName, price, maxStock, imageUrl) {
            const wasEmpty = cart.length === 0;
            const existingItem = cart.find(item => item.productId === productId);
            
            if (existingItem) {
                if (existingItem.quantity >= maxStock) {
                    showAlert('No hay más stock disponible', 'warning');
                    return;
                }
                existingItem.quantity += 1;
            } else {
                cart.push({
                    productId,
                    productName,
                    price,
                    quantity: 1,
                    maxStock,
                    imageUrl: imageUrl || null
                });
            }

            if (wasEmpty && !localStorage.getItem('cartExpiresAt')) {
                localStorage.setItem('cartExpiresAt', String(Date.now() + 30 * 60 * 1000));
            }
            localStorage.setItem('customerCart', JSON.stringify(cart));
            updateCartBar();
            if (lastProducts.length > 0) displayProducts(lastProducts);
            showAlert('Producto agregado con éxito!', 'success');
        }

        function catalogDecrease(productId) {
            const idx = cart.findIndex(item => item.productId === productId);
            if (idx === -1) return;
            if (cart[idx].quantity <= 1) {
                cart.splice(idx, 1);
                if (cart.length === 0) localStorage.removeItem('cartExpiresAt');
            } else {
                cart[idx].quantity -= 1;
            }
            localStorage.setItem('customerCart', JSON.stringify(cart));
            updateCartBar();
            if (lastProducts.length > 0) displayProducts(lastProducts);
        }

        function catalogIncrease(productId, maxStock) {
            const existing = cart.find(item => item.productId === productId);
            if (!existing) return;
            if (existing.quantity >= maxStock) {
                showAlert('No hay más stock disponible', 'warning');
                return;
            }
            existing.quantity += 1;
            localStorage.setItem('customerCart', JSON.stringify(cart));
            updateCartBar();
            if (lastProducts.length > 0) displayProducts(lastProducts);
        }

        function updateCartBar() {
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            const totalAmount = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const bar = document.getElementById('cartBottomBar');
            if (!bar) return;
            if (totalItems > 0) {
                bar.classList.add('cart-bar-visible');
                bar.setAttribute('aria-hidden', 'false');
                document.body.classList.add('cart-bar-visible');
                document.getElementById('cartBarCount').textContent = totalItems;
                document.getElementById('cartBarLabel').textContent = totalItems === 1 ? 'item en tu carrito' : 'items en tu carrito';
                document.getElementById('cartBarTotal').textContent = '$' + totalAmount.toFixed(2);
            } else {
                bar.classList.remove('cart-bar-visible');
                bar.setAttribute('aria-hidden', 'true');
                document.body.classList.remove('cart-bar-visible');
            }
        }

        function clearCart() {
            cart = [];
            localStorage.removeItem('customerCart');
            localStorage.removeItem('cartExpiresAt');
            updateCartBar();
            if (lastProducts.length > 0) displayProducts(lastProducts);
        }

        function logout() {
            localStorage.removeItem('customerToken');
            localStorage.removeItem('customer');
            localStorage.removeItem('customerCart');
            localStorage.removeItem('cartExpiresAt');
            window.location.href = '/customer/login';
        }

        var _toastTimeout;
        var _toastSvgMap = {
            success: '<svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/></svg>',
            warning: '<svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/></svg>',
            danger:  '<svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293 5.354 4.646z"/></svg>',
            info:    '<svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/></svg>'
        };
        function showAlert(message, type) {
            var colorMap = { success:'var(--green)', warning:'var(--amber)', danger:'var(--red)', info:'var(--accent)' };
            var svgMap = {
                success: '<svg width="17" height="17" fill="currentColor" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/></svg>',
                warning: '<svg width="17" height="17" fill="currentColor" viewBox="0 0 16 16"><path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/></svg>',
                danger:  '<svg width="17" height="17" fill="currentColor" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293 5.354 4.646z"/></svg>',
                info:    '<svg width="17" height="17" fill="currentColor" viewBox="0 0 16 16"><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/></svg>'
            };
            var color = colorMap[type] || colorMap.info;
            var svgIcon = svgMap[type] || svgMap.info;
            var existing = document.getElementById('lbToastGlobal');
            if (existing) existing.remove();
            clearTimeout(_toastTimeout);
            var toast = document.createElement('div');
            toast.id = 'lbToastGlobal';
            toast.className = 'lb-toast';
            toast.innerHTML =
                '<span class="lb-toast-icon" style="color:' + color + '">' + svgIcon + '</span>' +
                '<span class="lb-toast-msg">' + message + '</span>' +
                '<button class="lb-toast-close" onclick="this.closest(\'.lb-toast\').remove()" aria-label="Cerrar">&times;</button>';
            (document.getElementById('app-content') || document.body).appendChild(toast);
            requestAnimationFrame(function() {
                requestAnimationFrame(function() { toast.classList.add('lb-toast-show'); });
            });
            _toastTimeout = setTimeout(function() {
                toast.classList.remove('lb-toast-show');
                toast.classList.add('lb-toast-hide');
                setTimeout(function() { if (toast.parentNode) toast.parentNode.removeChild(toast); }, 250);
            }, 3500);
        }

        function startCartExpiryTimer() {
            if (window._cartTimerInterval) {
                clearInterval(window._cartTimerInterval);
                window._cartTimerInterval = null;
            }
            function tick() {
                var currentCart = JSON.parse(localStorage.getItem('customerCart')) || [];
                var expiryEl = document.getElementById('cartBarExpiry');
                if (currentCart.length === 0) {
                    if (expiryEl) expiryEl.textContent = '';
                    clearInterval(window._cartTimerInterval);
                    window._cartTimerInterval = null;
                    return;
                }
                var expiresAt = parseInt(localStorage.getItem('cartExpiresAt'), 10);
                if (!expiresAt) { if (expiryEl) expiryEl.textContent = ''; return; }
                var remaining = expiresAt - Date.now();
                if (remaining <= 0) {
                    localStorage.removeItem('customerCart');
                    localStorage.removeItem('cartExpiresAt');
                    cart = [];
                    clearInterval(window._cartTimerInterval);
                    window._cartTimerInterval = null;
                    if (expiryEl) expiryEl.textContent = '';
                    updateCartBar();
                    if (lastProducts.length > 0) displayProducts(lastProducts);
                    showAlert('Tu carrito expiró (30 min). Agrega los productos nuevamente.', 'warning');
                    return;
                }
                if (expiryEl) {
                    var totalSeconds = Math.floor(remaining / 1000);
                    var mins = Math.floor(totalSeconds / 60);
                    var secs = totalSeconds % 60;
                    expiryEl.textContent = (remaining < 5 * 60 * 1000 ? '⚠ ' : '') + 'Expira en: ' + mins + ':' + (secs < 10 ? '0' : '') + secs;
                    expiryEl.classList.toggle('cart-expiry-warn', remaining < 5 * 60 * 1000);
                }
            }
            tick();
            window._cartTimerInterval = setInterval(tick, 1000);
        }

        // Reiniciar catálogo al volver (logo o atrás): datos, barra de carrito, filtros y eventos
        window.initCatalogView = function() {
            cart = JSON.parse(localStorage.getItem('customerCart')) || [];
            updateCartBar();
            startCartExpiryTimer();
            loadCategoryFilter();
            loadPresentationFilter();
            loadProducts();
            bindCatalogEvents();
        };
    </script>
    </div><!-- #spa-view-content -->
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/public/img/pestana-LB.png" type="image/png">
    <title>Mis Pedidos - LOCOBAR</title>
    <link href="/libs/css/bootstrap.min.css" rel="stylesheet">
    <link href="/libs/css/bootstrap-icons.css" rel="stylesheet">
    <link href="/public/css/theme.css" rel="stylesheet">
    <style>
        .navbar-custom {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        }
        #userMenu .user-name-text {
            display: none;
        }
        @media (min-width: 576px) {
            #userMenu .user-name-text {
                display: inline;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-dark navbar-custom navbar-lb">
        <div class="container-fluid">
            <a class="navbar-brand spa-link" href="/customer/catalog">
                <i class="bi bi-shop"></i> LOCOBAR
            </a>
            <div class="d-flex align-items-center">
                <div class="dropdown">
                    <button class="btn btn-outline-light dropdown-toggle d-flex align-items-center" type="button" id="userMenu" data-bs-toggle="dropdown" aria-expanded="false" title="Mi cuenta">
                        <i class="bi bi-person-circle fs-4"></i>
                        <span class="user-name-text ms-1" id="userName">Usuario</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item spa-link" href="/customer/orders"><i class="bi bi-receipt"></i> Mis Pedidos</a></li>
                        <li><a class="dropdown-item spa-link" href="/customer/credits"><i class="bi bi-credit-card"></i> Crédito que está debiendo</a></li>
                        <li><a class="dropdown-item spa-link" href="/customer/group-purchases"><i class="bi bi-people"></i> Compras Grupales</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="logout(); return false;"><i class="bi bi-box-arrow-right"></i> Cerrar Sesión</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div id="spa-view-content">
    <!-- Main Content -->
    <div class="container mt-4">
        <h2 class="mb-4"><i class="bi bi-receipt"></i> Mis Pedidos</h2>
        
        <div id="ordersContent">
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
            </div>
        </div>
    </div>

    <script src="/libs/js/jquery.min.js"></script>
    <script src="/libs/js/bootstrap.bundle.min.js"></script>
    <script>
        let customer = JSON.parse(localStorage.getItem('customer')) || null;

        $(document).ready(function() {
            $.get('/api/public/brand-slogan', function(r) { if (r && r.pageTitleOrders) document.title = r.pageTitleOrders; });
            // Check authentication
            const token = localStorage.getItem('customerToken');
            if (!token) {
                window.location.href = '/customer/login';
                return;
            }

            if (customer) {
                $('#userName').text(customer.name);
            }

            loadOrders();
        });

        function loadOrders() {
            $.ajax({
                url: '/api/customer/orders',
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('customerToken')
                },
                success: function(response) {
                    const orders = response && Array.isArray(response.orders) ? response.orders : [];
                    displayOrders(orders);
                },
                error: function(xhr) {
                    if (xhr.status === 401) {
                        window.location.href = '/customer/login';
                    } else {
                        const msg = xhr.responseJSON && xhr.responseJSON.error ? xhr.responseJSON.error : 'Error al cargar los pedidos';
                        $('#ordersContent').html(`
                            <div class="alert alert-danger">
                                ${msg}
                            </div>
                        `);
                    }
                }
            });
        }

        function displayOrders(orders) {
            const content = $('#ordersContent');
            if (!Array.isArray(orders)) {
                content.html('<div class="alert alert-warning">No se recibieron datos de pedidos.</div>');
                return;
            }
            if (orders.length === 0) {
                content.html(`
                    <div class="text-center py-5">
                        <i class="bi bi-inbox" style="font-size: 4em; color: #ccc;"></i>
                        <h4 class="mt-3 text-muted">No tienes pedidos aún</h4>
                        <a href="/customer/catalog" class="btn btn-primary mt-3 spa-link">
                            <i class="bi bi-shop"></i> Ver Catálogo
                        </a>
                    </div>
                `);
                return;
            }

            let html = '';
            orders.forEach(order => {
                const date = new Date(order.createdAt).toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const statusBadge = order.status === 'COMPLETED' ? 
                    '<span class="badge bg-success">Completado</span>' :
                    order.status === 'VOIDED' ?
                    '<span class="badge bg-danger">Anulado</span>' :
                    '<span class="badge bg-warning">Pendiente</span>';

                let itemsHtml = '';
                const orderItems = Array.isArray(order.items) ? order.items : [];
                orderItems.forEach(item => {
                    const productName = (item.product && item.product.name) ? item.product.name : 'Producto';
                    const totalPrice = parseFloat(item.totalPrice || 0).toFixed(2);
                    const qty = item.quantity != null ? item.quantity : 0;
                    itemsHtml += `
                        <div class="d-flex justify-content-between mb-2">
                            <span>${productName} x ${qty}</span>
                            <span>$${totalPrice}</span>
                        </div>
                    `;
                });

                html += `
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <strong>Pedido #${order.id}</strong>
                                <div class="small text-muted">${date}</div>
                            </div>
                            ${statusBadge}
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <h6>Productos:</h6>
                                    ${itemsHtml}
                                </div>
                                <div class="col-md-4 text-end">
                                    <div class="mb-2">
                                        <small class="text-muted">Método de pago:</small><br>
                                        <strong>${getPaymentMethodName(order.paymentMethod)}</strong>
                                    </div>
                                    <div>
                                        <small class="text-muted">Total:</small><br>
                                        <h4 class="text-primary mb-0">$${parseFloat(order.totalAmount).toFixed(2)}</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            content.html(html);
        }

        function getPaymentMethodName(method) {
            const methods = {
                'CASH': 'Efectivo',
                'CARD': 'Tarjeta',
                'TRANSFER': 'Transferencia',
                'CREDIT': 'Crédito'
            };
            return methods[method] || (method || '');
        }

        function logout() {
            localStorage.removeItem('customerToken');
            localStorage.removeItem('customer');
            localStorage.removeItem('customerCart');
            window.location.href = '/customer/login';
        }
    </script>
    </div><!-- #spa-view-content -->
</body>
</html>

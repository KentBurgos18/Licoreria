<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/public/img/pestana-LB.png" type="image/png">
    <title>Checkout - LOCOBAR</title>
    <link href="/libs/css/bootstrap.min.css" rel="stylesheet">
    <link href="/libs/css/bootstrap-icons.css" rel="stylesheet">
    <link href="/public/css/theme.css" rel="stylesheet">
    <style>
        /* â”€â”€ Page layout â”€â”€ */
        .co-page { max-width: 1100px; margin: 0 auto; padding: 24px 16px 60px; }
        .co-title { display: flex; align-items: center; gap: 10px; margin-bottom: 18px; }
        .co-title h1 { font-size: 21px; font-weight: 800; color: var(--text); letter-spacing: -.01em; margin: 0; }
        .co-title-icon { color: var(--accent2); flex-shrink: 0; }

        /* â”€â”€ Alert wrap â”€â”€ */
        .alert-wrap { margin-bottom: 14px; }
        .alert-wrap .alert { border-radius: 10px; font-size: 13.5px; }

        /* â”€â”€ Timer Banner â”€â”€ */
        .timer-banner {
            background: var(--accentbg);
            border: 1px solid var(--border);
            border-radius: 12px; padding: 12px 18px;
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 20px;
            position: relative; overflow: hidden;
            transition: all .3s;
        }
        .timer-banner::before {
            content: ''; position: absolute;
            left: 0; top: 0; bottom: 0;
            width: var(--progress, 100%);
            background: linear-gradient(90deg, var(--accentbg), transparent);
            transition: width 1s linear;
        }
        .timer-banner.warn { background: var(--ambg); border-color: rgba(251,191,36,.25); }
        .timer-banner.warn .timer-icon { background: var(--ambg); color: var(--amber); }
        .timer-banner.warn .timer-display { color: var(--amber); }
        .timer-banner.warn .timer-ring-fill { stroke: var(--amber); }
        .timer-left { display: flex; align-items: center; gap: 10px; position: relative; z-index: 1; }
        .timer-icon {
            width: 32px; height: 32px; border-radius: 8px;
            background: var(--accentbg);
            display: flex; align-items: center; justify-content: center;
            color: var(--accent2); flex-shrink: 0;
        }
        .timer-msg { font-size: 13px; color: var(--text2); }
        .timer-msg strong { color: var(--text); }
        .timer-right { display: flex; align-items: center; gap: 8px; position: relative; z-index: 1; }
        .timer-label { font-size: 10.5px; font-weight: 700; color: var(--text3); text-transform: uppercase; letter-spacing: .08em; }
        .timer-display {
            font-family: 'JetBrains Mono', monospace;
            font-size: 20px; font-weight: 700; letter-spacing: .05em;
            color: var(--accent2); min-width: 80px; text-align: center;
            transition: color .3s;
        }
        .timer-ring { position: relative; width: 44px; height: 44px; flex-shrink: 0; }
        .timer-ring svg { transform: rotate(-90deg); }
        .timer-ring-track { stroke: var(--border); }
        .timer-ring-fill {
            stroke: var(--accent2);
            stroke-dasharray: 120;
            stroke-dashoffset: var(--ring-offset, 0);
            transition: stroke-dashoffset 1s linear, stroke .3s;
        }

        /* â”€â”€ Checkout grid â”€â”€ */
        /* Desktop: 2 columnas. Cada secciÃ³n ocupa su fila en col-1; sidebar en col-2 */
        .checkout-grid {
            display: grid;
            grid-template-columns: 1fr 320px;
            grid-template-rows: auto auto auto;
            column-gap: 18px;
            row-gap: 14px;
            align-items: start;
        }
        .co-pay     { grid-column: 1; grid-row: 1; }
        .co-notes   { grid-column: 1; grid-row: 2; }
        .co-order   { grid-column: 1; grid-row: 3; }
        .co-sidebar { grid-column: 2; grid-row: 1 / 4; }
        /* Quitar margin-bottom de sections dentro del grid (el gap ya separa) */
        .co-pay, .co-notes, .co-order { margin-bottom: 0; }

        /* MÃ³vil: flex columna con orden: Pago â†’ Total â†’ Notas â†’ Resumen pedido */
        @media (max-width: 860px) {
            .checkout-grid { display: flex; flex-direction: column; gap: 14px; }
            .co-pay,
            .co-notes,
            .co-order,
            .co-sidebar { width: 100%; max-width: none; box-sizing: border-box; }
            .co-pay     { order: 1; }
            .co-sidebar { order: 2; position: static; top: auto; }
            .co-notes   { order: 3; }
            .co-order   { order: 4; }
        }

        /* â”€â”€ Section cards â”€â”€ */
        .section {
            background: var(--surf);
            border: 1px solid var(--border);
            border-radius: 16px; overflow: hidden;
            box-shadow: var(--shadow);
            margin-bottom: 14px;
            transition: background .3s, border-color .3s;
        }
        .section:last-child { margin-bottom: 0; }
        .section-head {
            padding: 14px 18px;
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; gap: 9px;
        }
        .section-num {
            width: 22px; height: 22px; border-radius: 6px;
            background: var(--accentbg);
            display: flex; align-items: center; justify-content: center;
            font-size: 11px; font-weight: 800; color: var(--accent);
            flex-shrink: 0;
        }
        .section-title { font-size: 14px; font-weight: 700; color: var(--text); }
        .section-body { padding: 18px; }

        /* â”€â”€ Payment method cards â”€â”€ */
        .pay-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        @media (max-width: 560px) {
            .pay-grid {
                display: flex;
                flex-wrap: nowrap;
                overflow-x: auto;
                gap: 10px;
                padding-bottom: 4px;
                scroll-snap-type: x mandatory;
                -webkit-overflow-scrolling: touch;
            }
            .pay-grid::-webkit-scrollbar { display: none; }
            .pay-grid .pay-card {
                flex: 0 0 148px;
                min-width: 148px;
                scroll-snap-align: start;
            }
        }
        .pay-card {
            background: var(--surf2);
            border: 1.5px solid var(--border);
            border-radius: 12px; padding: 16px 12px;
            cursor: pointer; text-align: center;
            transition: all .2s; position: relative; overflow: hidden;
        }
        .pay-card::before {
            content: ''; position: absolute; inset: 0;
            background: var(--accentbg); opacity: 0; transition: opacity .2s;
            border-radius: 12px;
        }
        .pay-card:hover { border-color: var(--accent2); transform: translateY(-1px); box-shadow: var(--shadow); }
        .pay-card.active { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accentbg); }
        .pay-card.active::before { opacity: 1; }
        .pay-icon-wrap {
            width: 44px; height: 44px; border-radius: 12px;
            margin: 0 auto 10px;
            background: var(--accentbg);
            display: flex; align-items: center; justify-content: center;
            color: var(--accent2); position: relative; z-index: 1;
            transition: background .2s;
        }
        .pay-card.active .pay-icon-wrap { background: var(--accent); color: #fff; }
        .pay-name { font-size: 13px; font-weight: 700; color: var(--text); position: relative; z-index: 1; margin-bottom: 3px; }
        .pay-sub { font-size: 11px; color: var(--text3); position: relative; z-index: 1; }
        .pay-check {
            position: absolute; top: 8px; right: 8px;
            width: 16px; height: 16px; border-radius: 50%;
            background: var(--accent);
            display: flex; align-items: center; justify-content: center;
            opacity: 0; transform: scale(.5);
            transition: all .2s; z-index: 2;
        }
        .pay-card.active .pay-check { opacity: 1; transform: scale(1); }
        .payphone-badge {
            display: inline-flex; align-items: center; gap: 4px;
            font-size: 9.5px; font-weight: 700;
            background: var(--ambg); color: var(--amber);
            border: 1px solid rgba(251,191,36,.2);
            border-radius: 4px; padding: 2px 6px;
            position: relative; z-index: 1; margin-top: 4px;
            letter-spacing: .04em;
        }

        /* â”€â”€ Card visual preview (decorative) â”€â”€ */
        .card-preview-wrap { margin-bottom: 14px; animation: coSlideDown .3s ease both; }
        @keyframes coSlideDown { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: none; } }
        .payphone-section-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 12px;
        }
        .payphone-logo-badge {
            background: var(--ambg); border: 1px solid rgba(251,191,36,.2);
            border-radius: 6px; padding: 4px 10px;
            display: flex; align-items: center; gap: 5px;
        }
        .payphone-logo-badge span { font-size: 11px; font-weight: 800; color: var(--amber); letter-spacing: .04em; }
        .payphone-secure { display: flex; align-items: center; gap: 5px; font-size: 11px; color: var(--text3); }
        .card-preview {
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            border-radius: 14px; padding: 20px;
            position: relative; overflow: hidden; min-height: 130px;
            margin-bottom: 12px;
        }
        .card-preview::before {
            content: ''; position: absolute;
            width: 180px; height: 180px; border-radius: 50%;
            background: rgba(255,255,255,.07);
            top: -50px; right: -50px;
        }
        .card-preview::after {
            content: ''; position: absolute;
            width: 110px; height: 110px; border-radius: 50%;
            background: rgba(255,255,255,.04);
            bottom: -20px; left: 30px;
        }
        /* card top row: bank name + chip */
        .cp-top {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 12px; position: relative; z-index: 1;
        }
        .cp-bank {
            font-size: 11px; font-weight: 700; letter-spacing: .1em;
            color: rgba(255,255,255,.85); text-transform: uppercase;
            min-height: 14px; transition: opacity .2s;
        }
        .cp-bank.cp-updating { opacity: 0; }
        .cp-chip {
            width: 34px; height: 26px; border-radius: 4px;
            background: rgba(255,255,255,.3);
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }
        .cp-num {
            font-family: 'JetBrains Mono', monospace;
            font-size: 15px; letter-spacing: .18em;
            color: rgba(255,255,255,.9); margin-bottom: 14px;
            position: relative; z-index: 1;
            transition: opacity .15s;
        }
        .cp-num.cp-updating { opacity: 0; }
        .cp-val { transition: opacity .15s; }
        .cp-val.cp-updating { opacity: 0; }
        .cp-bottom {
            display: flex; justify-content: space-between; align-items: flex-end;
            position: relative; z-index: 1;
        }
        .cp-label { font-size: 9px; color: rgba(255,255,255,.5); text-transform: uppercase; letter-spacing: .08em; margin-bottom: 3px; }
        .cp-val { font-size: 13px; font-weight: 600; color: rgba(255,255,255,.9); }
        .cp-brand-wrap { display: flex; flex-direction: column; align-items: flex-end; gap: 3px; }
        .cp-brand { font-size: 22px; line-height: 1; }
        .cp-type {
            font-size: 9px; font-weight: 700; letter-spacing: .08em;
            color: rgba(255,255,255,.7); text-transform: uppercase;
            min-height: 11px; transition: opacity .2s;
        }
        .cp-type.cp-updating { opacity: 0; }
        .payphone-hint {
            display: flex; align-items: center; gap: 6px;
            font-size: 12px; color: var(--text2);
            padding: 8px 12px; background: var(--accentbg);
            border: 1px solid var(--border); border-radius: 8px;
            margin-bottom: 14px;
        }

        /* â”€â”€ Transfer bank list â”€â”€ */
        .transfer-info { margin-top: 14px; animation: coSlideDown .3s ease both; }
        .transfer-info-header {
            font-size: 12px; font-weight: 700; color: var(--text);
            display: flex; align-items: center; gap: 6px; margin-bottom: 10px;
        }
        .bank-list { display: flex; flex-direction: column; gap: 8px; }
        .bank-row {
            background: var(--surf2); border: 1.5px solid var(--border);
            border-radius: 10px; overflow: hidden; cursor: pointer;
            transition: border-color .2s;
        }
        .bank-row.selected {
            border-color: var(--bank-p, var(--accent));
            box-shadow: 0 0 0 2.5px var(--bank-bg, var(--accentbg));
        }
        .bank-row-head {
            display: flex; align-items: center; gap: 10px;
            padding: 11px 14px; transition: background .2s;
        }
        .bank-row.open .bank-row-head { background: var(--bank-bg, transparent); }
        .bank-row-icon {
            width: 36px; height: 36px; border-radius: 10px;
            background: var(--accentbg); display: flex; align-items: center; justify-content: center;
            color: var(--accent2); flex-shrink: 0; overflow: hidden;
            transition: background .2s, color .2s, box-shadow .2s;
        }
        /* Logo del banco â€” se muestra cuando carga correctamente */
        .bank-logo-img { width: 32px; height: 32px; object-fit: contain; display: none; image-rendering: auto; }
        .bank-row-icon.has-logo { background: #fff; }
        .bank-row-icon.has-logo .bank-logo-img { display: block; }
        .bank-row-icon.has-logo .bank-icon-fb { display: none; }
        /* Seleccionado sin logo: fondo del color del banco */
        .bank-row.selected .bank-row-icon:not(.has-logo) { background: var(--bank-p, var(--accent)); color: var(--bank-icon-fg, #fff); }
        /* Seleccionado con logo: sin borde adicional, solo el borde del .bank-row */
        .bank-row-info { flex: 1; min-width: 0; }
        .bank-row-name {
            font-size: 13px; font-weight: 700; color: var(--text);
            transition: color .2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        /* Al seleccionar: el nombre queda blanco para mÃ¡ximo contraste sobre cualquier fondo de banco */
        .bank-row.selected .bank-row-name { color: var(--text); }
        .bank-row-type { font-size: 11px; color: var(--text3); }
        .bank-row-chevron { color: var(--text3); transition: transform .2s, color .2s; flex-shrink: 0; }
        .bank-row.selected .bank-row-chevron { color: var(--bank-p, var(--accent)); }
        .bank-row.open .bank-row-chevron { transform: rotate(180deg); }
        .bank-row-body {
            display: none; padding: 0 14px 14px;
            border-top: 1px solid rgba(128,128,128,.15);
            background: var(--bank-bg, transparent);
        }
        .bank-row.open .bank-row-body { display: block; }
        /* Tabla de datos bancarios â€” 2 columnas fijas */
        .bank-detail { display: grid; gap: 1px 0; margin-top: 8px; }
        .bank-detail-row {
            display: grid;
            grid-template-columns: 100px 1fr;
            gap: 0 10px;
            font-size: 12px;
            align-items: baseline;
            padding: 2px 0;
        }
        .bank-detail-row .dk { color: var(--text2); white-space: nowrap; }
        .bank-detail-row .dv {
            font-weight: 700; color: var(--text); text-align: right;
            font-family: 'JetBrains Mono', monospace;
            word-break: break-word; overflow-wrap: anywhere;
        }
        .bank-detail-row .dv.dv-plain { font-family: inherit; font-size: 12.5px; }
        .dv-copyable {
            cursor: pointer; position: relative;
            transition: color .15s;
            display: inline-flex; align-items: center; gap: 5px; justify-content: flex-end;
        }
        .dv-copyable::after {
            content: 'â§‰'; font-size: 10px; opacity: .35;
            transition: opacity .15s; font-family: inherit;
        }
        .dv-copyable:hover::after { opacity: .8; }
        .dv-copyable:hover { color: var(--bank-p, var(--accent)); }
        .dv-copyable.copied { color: var(--green, #22c55e) !important; }
        .dv-copyable.copied::after { content: 'âœ“'; opacity: 1; }
        .transfer-notice {
            margin-top: 10px; padding: 9px 12px;
            background: var(--ambg); border: 1px solid rgba(251,191,36,.2);
            border-radius: 8px; font-size: 11.5px; color: var(--text2);
            display: flex; align-items: flex-start; gap: 6px;
        }
        .transfer-empty {
            text-align: center; padding: 18px 0; font-size: 13px; color: var(--text3);
        }

        /* â”€â”€ Notes textarea â”€â”€ */
        .notes-ta {
            width: 100%; background: var(--surf2);
            border: 1px solid var(--border); border-radius: 10px;
            padding: 11px 14px; font-size: 13px;
            color: var(--text); outline: none;
            resize: vertical; min-height: 80px;
            transition: border-color .2s, box-shadow .2s;
            font-family: inherit;
        }
        .notes-ta::placeholder { color: var(--text3); }
        .notes-ta:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accentbg); }

        /* â”€â”€ Order summary items â”€â”€ */
        .order-item {
            display: flex; align-items: center; gap: 12px;
            padding: 12px 0; border-bottom: 1px solid var(--border);
        }
        .order-item:last-child { border-bottom: none; padding-bottom: 0; }
        .order-item-img {
            width: 44px; height: 44px; border-radius: 8px; flex-shrink: 0;
            background: var(--surf2); border: 1px solid var(--border);
            overflow: hidden; display: flex; align-items: center; justify-content: center;
            color: var(--text3);
        }
        .order-item-img img { width: 100%; height: 100%; object-fit: cover; }
        .order-item-info { flex: 1; min-width: 0; }
        .order-item-name { font-size: 13px; font-weight: 700; color: var(--text); margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .order-item-meta { font-size: 11.5px; color: var(--text2); }
        .order-item-price { font-family: 'JetBrains Mono', monospace; font-size: 14px; font-weight: 600; color: var(--accent2); flex-shrink: 0; }

        /* â”€â”€ Total sidebar â”€â”€ */
        /* sticky solo en desktop â€” en mÃ³vil lo controla la media query */
        @media (min-width: 861px) {
            .co-sidebar { position: sticky; top: 76px; z-index: 1; }
        }
        .total-card {
            background: var(--surf);
            border: 1px solid var(--border);
            border-radius: 16px; overflow: hidden;
            box-shadow: var(--shadow);
            transition: background .3s, border-color .3s;
        }
        .total-head {
            padding: 13px 18px;
            background: var(--accentbg);
            border-bottom: 1px solid var(--border);
            font-size: 13px; font-weight: 800; color: var(--text);
            display: flex; align-items: center; gap: 7px;
        }
        .total-body { padding: 16px 18px; }
        .total-line {
            display: flex; align-items: center; justify-content: space-between;
            padding: 6px 0; font-size: 13px;
        }
        .total-line .lk { color: var(--text2); }
        .total-line .lv { font-weight: 600; color: var(--text); font-family: 'JetBrains Mono', monospace; }
        .total-divider { height: 1px; background: var(--border); margin: 10px 0; }
        .total-final {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 0 4px;
        }
        .total-final .lk { font-size: 15px; font-weight: 800; color: var(--text); }
        .total-final .lv {
            font-size: 22px; font-weight: 800; color: var(--accent2);
            font-family: 'JetBrains Mono', monospace;
        }
        .confirm-btn {
            width: 100%; margin-top: 14px;
            padding: 14px 16px; border-radius: 12px;
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            color: #fff !important;
            font-size: 15px; font-weight: 800;
            border: none; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 9px;
            letter-spacing: .02em;
            box-shadow: 0 6px 20px rgba(0,0,0,.25);
            transition: all .2s; position: relative; overflow: hidden;
        }
        .confirm-btn::after {
            content: ''; position: absolute; inset: 0;
            background: rgba(255,255,255,.08);
            opacity: 0; transition: opacity .2s;
        }
        .confirm-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 28px rgba(0,0,0,.35); }
        .confirm-btn:hover::after { opacity: 1; }
        .confirm-btn:active { transform: translateY(0); }
        .confirm-btn:disabled { opacity: .5; cursor: not-allowed; transform: none; }
        .back-btn {
            width: 100%; margin-top: 8px;
            padding: 10px; border-radius: 10px;
            background: var(--accentbg); color: var(--text2) !important;
            border: 1px solid var(--border);
            font-size: 13px; font-weight: 600;
            cursor: pointer; transition: all .15s;
            display: flex; align-items: center; justify-content: center; gap: 6px;
            text-decoration: none !important;
        }
        .back-btn:hover { color: var(--text) !important; border-color: var(--accent); }
        .security-row {
            display: flex; align-items: center; justify-content: center; gap: 14px;
            margin-top: 14px; padding-top: 14px;
            border-top: 1px solid var(--border);
        }
        .sec-badge { display: flex; align-items: center; gap: 4px; font-size: 10.5px; color: var(--text3); }

        /* â”€â”€ Thank you modal styling â”€â”€ */
        .modal-content { background: var(--surf) !important; border: 1px solid var(--border) !important; border-radius: 16px !important; }
        .modal-header { border-bottom: 1px solid var(--border) !important; }
        .modal-footer { border-top: 1px solid var(--border) !important; }
        .modal-title { color: var(--text) !important; font-weight: 700; }
        .btn-close { filter: invert(1) !important; }

        /* user name responsive */
        #userMenu .user-name-text { display: none; }
        @media (min-width: 576px) { #userMenu .user-name-text { display: inline; } }
        /* â”€â”€ Custom Toast â”€â”€ */
        .lb-toast {
            background: var(--surf); border: 1px solid var(--border);
            border-radius: 12px; padding: 11px 14px;
            display: flex; align-items: center; gap: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,.1);
            font-size: 13px; font-weight: 500; color: var(--text);
            min-width: 280px; max-width: 420px;
            position: fixed; top: 80px; right: 20px; z-index: 9999;
            opacity: 0; transform: translateY(-8px);
            transition: opacity .22s, transform .22s;
        }
        .lb-toast.lb-toast-show { opacity: 1; transform: translateY(0); }
        .lb-toast.lb-toast-hide { opacity: 0; transform: translateY(-8px); }
        .lb-toast-icon { display: flex; align-items: center; flex-shrink: 0; }
        .lb-toast-msg  { flex: 1; }
        .lb-toast-close {
            margin-left: auto; background: none; border: none;
            padding: 2px 5px; cursor: pointer; color: var(--text3);
            border-radius: 5px; flex-shrink: 0; font-size: 16px; line-height: 1;
        }
        .lb-toast-close:hover { color: var(--text); background: var(--surf2); }
        @media (max-width: 576px) {
            .lb-toast {
                top: auto; bottom: 24px; right: auto; left: 50%;
                transform: translateX(-50%) translateY(16px);
                min-width: min(340px, calc(100vw - 32px));
                max-width: calc(100vw - 32px);
            }
            .lb-toast.lb-toast-show { transform: translateX(-50%) translateY(0); }
            .lb-toast.lb-toast-hide { transform: translateX(-50%) translateY(16px); }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-dark navbar-custom navbar-lb">
        <div class="container-fluid">
            <a class="navbar-brand spa-link" href="/customer/catalog">
                <i class="bi bi-shop"></i> LOCOBAR
            </a>
            <div class="d-flex align-items-center">
                <div class="dropdown">
                    <button class="btn btn-outline-light dropdown-toggle d-flex align-items-center" type="button" id="userMenu" data-bs-toggle="dropdown" aria-expanded="false" title="Mi cuenta">
                        <i class="bi bi-person-circle fs-4"></i>
                        <span class="user-name-text ms-1" id="userName">Usuario</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item spa-link" href="/customer/orders"><i class="bi bi-receipt"></i> Mis Pedidos</a></li>
                        <li><a class="dropdown-item spa-link" href="/customer/credits"><i class="bi bi-credit-card"></i> Mi CrÃ©dito</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="logout(); return false;"><i class="bi bi-box-arrow-right"></i> Cerrar SesiÃ³n</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div id="spa-view-content">
    <div class="co-page">

        <!-- Alert container -->
        <div id="alertContainer" class="alert-wrap"></div>

        <!-- Page title -->
        <div class="co-title">
            <svg class="co-title-icon" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
            <h1>Finalizar Compra</h1>
        </div>

        <!-- Timer Banner -->
        <div id="cartExpiryBanner" class="timer-banner d-none" role="alert">
            <div class="timer-left">
                <div class="timer-icon">
                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                </div>
                <div>
                    <div class="timer-msg">Los Ã­tems del carrito se reservan por <strong>30 min</strong></div>
                    <div style="font-size:11px;color:var(--text3);margin-top:1px;">Completa tu compra antes de que expire</div>
                </div>
            </div>
            <div class="timer-right">
                <div>
                    <div class="timer-label">Tiempo restante</div>
                    <div class="timer-display" id="cartExpiryCountdown">--:--</div>
                </div>
                <div class="timer-ring">
                    <svg width="44" height="44" viewBox="0 0 44 44">
                        <circle class="timer-ring-track" cx="22" cy="22" r="19" fill="none" stroke-width="3"/>
                        <circle class="timer-ring-fill" id="cartTimerRing" cx="22" cy="22" r="19" fill="none" stroke-width="3" stroke-linecap="round"/>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Checkout Grid -->
        <div class="checkout-grid">

                <!-- 1. MÃ©todo de Pago -->
                <div class="section co-pay">
                    <div class="section-head">
                        <div class="section-num">1</div>
                        <div class="section-title">MÃ©todo de Pago</div>
                    </div>
                    <div class="section-body">
                        <input type="hidden" id="paymentMethod" value="" required>
                        <div class="pay-grid">
                            <!-- CASH -->
                            <div class="pay-card payment-method-card" data-method="CASH" onclick="selectPaymentMethod('CASH', this)">
                                <div class="pay-check">
                                    <svg width="9" height="9" fill="none" stroke="#fff" stroke-width="3" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>
                                </div>
                                <div class="pay-icon-wrap">
                                    <svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
                                </div>
                                <div class="pay-name">Efectivo</div>
                                <div class="pay-sub">Pago al recibir</div>
                            </div>
                            <!-- CARD -->
                            <div class="pay-card payment-method-card" data-method="CARD" onclick="selectPaymentMethod('CARD', this)">
                                <div class="pay-check">
                                    <svg width="9" height="9" fill="none" stroke="#fff" stroke-width="3" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>
                                </div>
                                <div class="pay-icon-wrap">
                                    <svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/><line x1="6" y1="15" x2="10" y2="15"/></svg>
                                </div>
                                <div class="pay-name">Tarjeta</div>
                                <div class="pay-sub">Visa, Mastercard</div>
                                <div class="payphone-badge">âš¡ Payphone</div>
                            </div>
                            <!-- TRANSFER -->
                            <div class="pay-card payment-method-card" data-method="TRANSFER" onclick="selectPaymentMethod('TRANSFER', this)">
                                <div class="pay-check">
                                    <svg width="9" height="9" fill="none" stroke="#fff" stroke-width="3" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>
                                </div>
                                <div class="pay-icon-wrap">
                                    <svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                                </div>
                                <div class="pay-name">Transferencia</div>
                                <div class="pay-sub">Transferencia bancaria</div>
                            </div>
                        </div>

                        <!-- Transfer info (shown when TRANSFER selected) -->
                        <div id="transferInfoSection" class="transfer-info d-none">
                            <div class="transfer-info-header">
                                <svg width="13" height="13" fill="none" stroke="var(--accent2)" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                                Selecciona la cuenta a la que realizarÃ¡s la transferencia
                            </div>
                            <div class="bank-list" id="bankList">
                                <div class="transfer-empty"><span class="spinner-border spinner-border-sm"></span> Cargando...</div>
                            </div>
                            <div class="transfer-notice">
                                <svg width="14" height="14" fill="none" stroke="var(--amber)" stroke-width="2" viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                                Luego de realizar la transferencia, confirma tu pedido. Un representante validarÃ¡ el pago.
                            </div>
                        </div>

                        <!-- PayPhone section (tarjeta) -->
                        <div id="payphone-inline-section" class="d-none" style="margin-top: 18px;">
                            <!-- Card visual preview (decorativa) -->
                            <div class="card-preview-wrap">
                                <div class="payphone-section-header">
                                    <div class="payphone-logo-badge">
                                        <svg width="12" height="12" fill="none" stroke="#d97706" stroke-width="2.5" viewBox="0 0 24 24"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
                                        <span>PAYPHONE</span>
                                    </div>
                                    <div class="payphone-secure">
                                        <svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                                        Pago seguro SSL
                                    </div>
                                </div>
                                <div class="card-preview" id="cardPreviewEl">
                                    <div class="cp-top">
                                        <div class="cp-bank" id="cpBank"></div>
                                        <div class="cp-chip">
                                            <svg width="16" height="12" viewBox="0 0 16 12" fill="none">
                                                <rect x="0.5" y="0.5" width="15" height="11" rx="1.5" stroke="rgba(255,255,255,0.4)" fill="rgba(255,255,255,0.1)"/>
                                                <line x1="0.5" y1="4" x2="15.5" y2="4" stroke="rgba(255,255,255,0.3)"/>
                                                <line x1="0.5" y1="8" x2="15.5" y2="8" stroke="rgba(255,255,255,0.3)"/>
                                                <line x1="5" y1="0.5" x2="5" y2="11.5" stroke="rgba(255,255,255,0.3)"/>
                                                <line x1="11" y1="0.5" x2="11" y2="11.5" stroke="rgba(255,255,255,0.3)"/>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="cp-num" id="cpNum">â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢</div>
                                    <div class="cp-bottom">
                                        <div>
                                            <div class="cp-label">Titular</div>
                                            <div class="cp-val" id="cpHolder">NOMBRE APELLIDO</div>
                                        </div>
                                        <div style="text-align:right">
                                            <div class="cp-label">Expira</div>
                                            <div class="cp-val" id="cpExpiry">MM/AA</div>
                                        </div>
                                        <div class="cp-brand-wrap">
                                            <div class="cp-brand" id="cpBrand">ðŸ’³</div>
                                            <div class="cp-type" id="cpType"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="payphone-hint">
                                    <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                                    Completa el formulario de pago de PayPhone a continuaciÃ³n para procesar tu tarjeta:
                                </div>
                            </div>
                            <div id="pp-button-inline"></div>
                        </div>
                    </div>
                </div>

                <!-- 2. Notas adicionales -->
                <div class="section co-notes">
                    <div class="section-head">
                        <div class="section-num">2</div>
                        <div class="section-title">Notas adicionales <span style="font-weight:400;color:var(--text3);font-size:11.5px;">(opcional)</span></div>
                    </div>
                    <div class="section-body">
                        <textarea class="notes-ta" id="notes" rows="3" placeholder="Instrucciones especiales, direcciÃ³n de entrega, horario preferido..."></textarea>
                    </div>
                </div>

                <!-- 3. Resumen del Pedido -->
                <div class="section co-order">
                    <div class="section-head">
                        <div class="section-num">3</div>
                        <div class="section-title">Resumen del Pedido</div>
                    </div>
                    <div class="section-body" id="orderSummary">
                        <!-- filled by JS -->
                    </div>
                </div>

            <!-- RIGHT: Total sidebar -->
            <div class="co-sidebar">
                <div class="total-card">
                    <div class="total-head">
                        <svg width="14" height="14" fill="none" stroke="var(--accent2)" stroke-width="2" viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                        Resumen del Total
                    </div>
                    <div class="total-body">
                        <div class="total-line">
                            <span class="lk">Subtotal</span>
                            <span class="lv" id="subtotal">$0.00</span>
                        </div>
                        <div class="total-line tax-row d-none">
                            <span class="lk" id="taxLabel">IVA:</span>
                            <span class="lv" id="tax">$0.00</span>
                        </div>
                        <div class="total-line discount-row d-none" id="discountRow">
                            <span class="lk" style="color:var(--green);">Descuento</span>
                            <span class="lv" id="discount" style="color:var(--green);">-$0.00</span>
                        </div>
                        <div class="total-divider"></div>
                        <div class="total-final">
                            <span class="lk">Total</span>
                            <span class="lv" id="total">$0.00</span>
                        </div>
                        <p id="payphoneConfirmNote" class="d-none" style="font-size:12px;color:var(--text2);margin-top:10px;padding:8px 12px;background:var(--ambg);border-radius:8px;border:1px solid rgba(251,191,36,.2);">
                            Complete el formulario de pago con tarjeta y use el botÃ³n de PayPhone para pagar.
                        </p>
                        <button class="confirm-btn" onclick="processOrder()" id="processBtn">
                            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>
                            Confirmar Pedido
                        </button>
                        <a href="/customer/cart" class="back-btn spa-link">
                            <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>
                            Volver al Carrito
                        </a>
                        <div class="security-row">
                            <div class="sec-badge">
                                <svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                                Pago seguro
                            </div>
                            <div class="sec-badge">
                                <svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                                SSL cifrado
                            </div>
                            <div class="sec-badge">
                                <svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>
                                Verificado
                            </div>
                        </div>
                    </div>
                </div>
            </div><!-- end co-sidebar -->

        </div><!-- end checkout-grid -->
    </div><!-- end co-page -->

    <!-- Modal: Pago con tarjeta (Cajita PayPhone) -->
    <div class="modal fade" id="payphoneModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-credit-card"></i> Pagar con tarjeta</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <div id="pp-button-modal"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Esperando confirmaciÃ³n de pago (efectivo o transferencia) -->
    <div class="modal fade" id="waitingCashModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-hourglass-split"></i> Esperando confirmaciÃ³n</h5>
                </div>
                <div class="modal-body text-center">
                    <p>Esperando que un empleado o administrador confirme su pago (efectivo o transferencia).</p>
                    <p class="text-muted small">Tiempo mÃ¡ximo de espera sugerido: 10 minutos.</p>
                    <div class="spinner-border text-primary my-3" role="status"></div>
                    <p id="waitingTenMinMsg" class="text-muted small mt-2 d-none">Puede seguir esperando o cerrar esta ventana. Puede ver el estado del pedido en <a href="/customer/orders" class="spa-link">Mis Pedidos</a>.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Gracias por su compra -->
    <div class="modal fade" id="thankYouModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center py-5">
                    <div style="width:70px;height:70px;border-radius:50%;border:3px solid var(--accent);display:flex;align-items:center;justify-content:center;margin:0 auto 20px;">
                        <svg width="32" height="32" fill="none" stroke="var(--accent2)" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>
                    </div>
                    <h4 style="font-weight:800;color:var(--text);margin-bottom:8px;">Â¡Gracias por su compra!</h4>
                    <p style="color:var(--text2);margin-bottom:0;" id="thankYouSlogan">Sistema de LicorerÃ­a</p>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="confirm-btn" style="max-width:200px;" id="thankYouCloseBtn">Aceptar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/libs/js/jquery.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/libs/js/bootstrap.bundle.min.js"></script>
    <script>
        let cart = JSON.parse(localStorage.getItem('customerCart')) || [];
        let customer = JSON.parse(localStorage.getItem('customer')) || null;
        let currentTaxRate = null;
        let taxEnabled = true;
        let currentDiscountRate = 0;

        $(document).ready(function() {
            $.get('/api/public/brand-slogan', function(r) { if (r && r.pageTitleCheckout) document.title = r.pageTitleCheckout; });
            // Check authentication
            const token = localStorage.getItem('customerToken');
            if (!token) {
                window.location.href = '/customer/login';
                return;
            }

            if (customer) {
                $('#userName').text(customer.name);
            }

            // Check cart expiry
            var expiresAt = parseInt(localStorage.getItem('cartExpiresAt'), 10);
            if (expiresAt && Date.now() >= expiresAt) {
                localStorage.removeItem('customerCart');
                localStorage.removeItem('cartExpiresAt');
                cart = [];
                if (window.spaNavigate) window.spaNavigate('/customer/catalog'); else window.location.href = '/customer/catalog';
                return;
            }
            cart = JSON.parse(localStorage.getItem('customerCart')) || [];

            if (cart.length === 0) {
                if (window.spaNavigate) window.spaNavigate('/customer/cart'); else window.location.href = '/customer/cart';
                return;
            }

            loadTaxRate();
            loadPayphoneAssets();
            startCartExpiryTimer(function() {
                showAlert('Tu carrito expirÃ³. Redirigiendo al catÃ¡logo...', 'warning');
                setTimeout(function() {
                    if (window.spaNavigate) window.spaNavigate('/customer/catalog'); else window.location.href = '/customer/catalog';
                }, 2000);
            });
        });

        function loadPayphoneAssets() {
            if (document.querySelector('script[data-payphone-sdk]')) return;
            var link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = 'https://cdn.payphonetodoesposible.com/box/v1.1/payphone-payment-box.css';
            link.setAttribute('data-payphone-sdk', '1');
            document.head.appendChild(link);
            var script = document.createElement('script');
            script.src = 'https://cdn.payphonetodoesposible.com/box/v1.1/payphone-payment-box.js';
            script.type = 'module';
            script.setAttribute('data-payphone-sdk', '1');
            document.head.appendChild(script);
        }

        function selectPaymentMethod(method, el) {
            document.querySelectorAll('.payment-method-card').forEach(function(c) { c.classList.remove('active'); });
            el.classList.add('active');
            document.getElementById('paymentMethod').value = method;
            onPaymentMethodChange();
        }

        function onPaymentMethodChange() {
            var method = $('#paymentMethod').val();
            if (method === 'CARD') {
                $('#payphone-inline-section').removeClass('d-none');
                $('#transferInfoSection').addClass('d-none');
                $('#processBtn').addClass('d-none');
                $('#payphoneConfirmNote').removeClass('d-none');
                showPayphoneInline();
            } else if (method === 'TRANSFER') {
                $('#payphone-inline-section').addClass('d-none');
                $('#pp-button-inline').empty();
                $('#payphoneConfirmNote').addClass('d-none');
                $('#processBtn').removeClass('d-none');
                $('#transferInfoSection').removeClass('d-none');
                payphonePPB = null;
                loadBankAccounts();
            } else {
                $('#payphone-inline-section').addClass('d-none');
                $('#transferInfoSection').addClass('d-none');
                $('#pp-button-inline').empty();
                $('#processBtn').removeClass('d-none');
                $('#payphoneConfirmNote').addClass('d-none');
                payphonePPB = null;
            }
            updateTotals();
        }

        var _bankAccountsCache = null;
        function loadBankAccounts() {
            if (_bankAccountsCache !== null) { renderBankList(_bankAccountsCache); return; }
            $('#bankList').html('<div class="transfer-empty"><span class="spinner-border spinner-border-sm"></span> Cargando...</div>');
            $.get('/api/public/bank-accounts', function(r) {
                _bankAccountsCache = r.accounts || [];
                renderBankList(_bankAccountsCache);
            }).fail(function() {
                _bankAccountsCache = [];
                renderBankList([]);
            });
        }

        // p = color principal (borde, icono-bg)    â€” fuente: brandfetch / logo oficial
        // pd = color para texto/chevron (versiÃ³n oscura si p es muy claro)
        // bg = tinte de fondo translÃºcido
        // iconFg = color del Ã­cono dentro del badge (para fondos claros: usar oscuro)
        var BANK_THEMES = {
            // â”€â”€ Bancos privados â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            pichincha:     { p:'#ffdd00', pd:'#7a6500', bg:'rgba(255,221,0,.13)',   iconFg:'#3d3200', domain:'pichincha.com'               },
            pacifico:      { p:'#009fd4', pd:'#006e94', bg:'rgba(0,159,212,.12)',                     domain:'bancodelpacifico.com'         },
            guayaquil:     { p:'#d2006e', pd:'#d2006e', bg:'rgba(210,0,110,.12)',                     domain:'bancoguayaquil.com'           },
            internacional: { p:'#f98f16', pd:'#c06800', bg:'rgba(249,143,22,.12)',                    domain:'bancointernacional.com.ec'    },
            produbanco:    { p:'#69bd27', pd:'#3d7000', bg:'rgba(105,189,39,.12)',                    domain:'produbanco.com.ec'            },
            bolivariano:   { p:'#006576', pd:'#006576', bg:'rgba(0,101,118,.12)',                     domain:'bolivariano.com'              },
            austro:        { p:'#c8102e', pd:'#c8102e', bg:'rgba(200,16,46,.12)',                     domain:'bancoaustro.com'              },
            bgr:           { p:'#003f87', pd:'#003f87', bg:'rgba(0,63,135,.12)',                      domain:'bgr.com.ec'                   },
            solidario:     { p:'#e87722', pd:'#a84f00', bg:'rgba(232,119,34,.12)',                    domain:'banco-solidario.com'          },
            dmiro:         { p:'#00897b', pd:'#00897b', bg:'rgba(0,137,123,.12)',                     domain:'bancodmiro.com'               },
            bancodesarrollo:{ p:'#1565c0', pd:'#1565c0', bg:'rgba(21,101,192,.12)',                   domain:'bancodesarrollo.fin.ec'       },
            procredit:     { p:'#e30613', pd:'#e30613', bg:'rgba(227,6,19,.12)',                      domain:'bancoprocredit.com.ec'        },
            finca:         { p:'#f77f00', pd:'#a85500', bg:'rgba(247,127,0,.12)',                     domain:'bancofinca.com.ec'            },
            capital:       { p:'#0d47a1', pd:'#0d47a1', bg:'rgba(13,71,161,.12)',                     domain:'bancocapital.com.ec'          },
            // â”€â”€ Bancos pÃºblicos â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            bde:           { p:'#004f9f', pd:'#004f9f', bg:'rgba(0,79,159,.12)',                      domain:'bde.fin.ec'                   },
            banecuador:    { p:'#007a3d', pd:'#007a3d', bg:'rgba(0,122,61,.12)',                      domain:'banecuador.fin.ec'            },
            cfn:           { p:'#1a237e', pd:'#1a237e', bg:'rgba(26,35,126,.12)',                     domain:'cfn.fin.ec'                   },
            // â”€â”€ Cooperativas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            jep:           { p:'#5c2d91', pd:'#5c2d91', bg:'rgba(92,45,145,.12)',                     domain:'jep.fin.ec'                   },
            jardinazuayo:  { p:'#1a6faf', pd:'#1a6faf', bg:'rgba(26,111,175,.12)',                    domain:'jardineazuayo.fin.ec'         },
            cacpeco:       { p:'#009639', pd:'#006626', bg:'rgba(0,150,57,.12)',                       domain:'cacpeco.fin.ec'               },
            octubre29:     { p:'#c62828', pd:'#c62828', bg:'rgba(198,40,40,.12)',                      domain:'29deoctubre.fin.ec'           },
            cooprogreso:   { p:'#2e7d32', pd:'#2e7d32', bg:'rgba(46,125,50,.12)',                     domain:'cooprogreso.fin.ec'           },
            munozvega:     { p:'#1565c0', pd:'#1565c0', bg:'rgba(21,101,192,.12)',                    domain:'pablomunozvega.fin.ec'        },
            mego:          { p:'#ad1457', pd:'#ad1457', bg:'rgba(173,20,87,.12)',                     domain:'mego.fin.ec'                  },
            erco:          { p:'#00796b', pd:'#00796b', bg:'rgba(0,121,107,.12)',                     domain:'erco.fin.ec'                  },
            policia:       { p:'#1a237e', pd:'#1a237e', bg:'rgba(26,35,126,.12)',                     domain:'coopnacional.fin.ec'          },
            riobamba:      { p:'#b71c1c', pd:'#b71c1c', bg:'rgba(183,28,28,.12)',                     domain:'riobamba.fin.ec'              },
            oscus:         { p:'#004d40', pd:'#004d40', bg:'rgba(0,77,64,.12)',                       domain:'oscus.fin.ec'                 },
            mushucruna:    { p:'#e65100', pd:'#e65100', bg:'rgba(230,81,0,.12)',                       domain:'mushucrunapastaza.fin.ec'     },
            sanfrancisco:  { p:'#1976d2', pd:'#1976d2', bg:'rgba(25,118,210,.12)',                    domain:'coopsanfrancisco.fin.ec'      },
            andina:        { p:'#880e4f', pd:'#880e4f', bg:'rgba(136,14,79,.12)',                     domain:'andina.fin.ec'                }
        };

        function getBankTheme(name) {
            var l = (name || '').toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '');  // quitar tildes para matching
            // Bancos privados
            if (/pichincha/.test(l))              return BANK_THEMES.pichincha;
            if (/pac[i]fico/.test(l))             return BANK_THEMES.pacifico;
            if (/guayaquil/.test(l))              return BANK_THEMES.guayaquil;
            if (/internacion/.test(l))            return BANK_THEMES.internacional;
            if (/produ/.test(l))                  return BANK_THEMES.produbanco;
            if (/bolivar/.test(l))                return BANK_THEMES.bolivariano;
            if (/austro/.test(l))                 return BANK_THEMES.austro;
            if (/rumi[nÃ±]ahui|bgr/.test(l))       return BANK_THEMES.bgr;
            if (/solidar/.test(l))                return BANK_THEMES.solidario;
            if (/d.miro|dmiro/.test(l))           return BANK_THEMES.dmiro;
            if (/desarrollo/.test(l))             return BANK_THEMES.bancodesarrollo;
            if (/procredit/.test(l))              return BANK_THEMES.procredit;
            if (/\bfinca\b/.test(l))              return BANK_THEMES.finca;
            if (/capital/.test(l))                return BANK_THEMES.capital;
            // Bancos pÃºblicos
            if (/\bbde\b|banco del estado/.test(l)) return BANK_THEMES.bde;
            if (/banecuador/.test(l))             return BANK_THEMES.banecuador;
            if (/\bcfn\b/.test(l))                return BANK_THEMES.cfn;
            // Cooperativas
            if (/\bjep\b/.test(l))                return BANK_THEMES.jep;
            if (/jardin\s*azuayo/.test(l))        return BANK_THEMES.jardinazuayo;
            if (/cacpeco/.test(l))                return BANK_THEMES.cacpeco;
            if (/29\s*de\s*octubre/.test(l))      return BANK_THEMES.octubre29;
            if (/cooprogreso/.test(l))            return BANK_THEMES.cooprogreso;
            if (/mu[nÃ±]oz\s*vega/.test(l))        return BANK_THEMES.munozvega;
            if (/\bmego\b/.test(l))               return BANK_THEMES.mego;
            if (/\berco\b/.test(l))               return BANK_THEMES.erco;
            if (/polic[i]a/.test(l))              return BANK_THEMES.policia;
            if (/riobamba/.test(l))               return BANK_THEMES.riobamba;
            if (/\boscus\b/.test(l))              return BANK_THEMES.oscus;
            if (/mushuc\s*runa/.test(l))          return BANK_THEMES.mushucruna;
            if (/san\s*francisco/.test(l))        return BANK_THEMES.sanfrancisco;
            if (/andina/.test(l))                 return BANK_THEMES.andina;
            return null;
        }

        function renderBankList(accounts) {
            var list = document.getElementById('bankList');
            if (!list) return;
            if (!accounts.length) {
                list.innerHTML = '<div class="transfer-empty">No hay cuentas bancarias configuradas. Contacta con el negocio.</div>';
                return;
            }
            list.innerHTML = accounts.map(function(acc, i) {
                var theme = getBankTheme(acc.bankName);
                var styleAttr = '';
                if (theme) {
                    styleAttr = ' style="--bank-p:' + theme.p + ';--bank-bg:' + theme.bg +
                        ';--bank-pd:' + (theme.pd || theme.p) +
                        (theme.iconFg ? ';--bank-icon-fg:' + theme.iconFg : '') + ';"';
                }
                var fbSvg = '<svg class="bank-icon-fb" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="12" width="4" height="7"/><rect x="10" y="8" width="4" height="11"/><rect x="17" y="4" width="4" height="15"/><line x1="1" y1="21" x2="23" y2="21"/></svg>';
                var iconHtml = '';
                if (theme && theme.domain) {
                    // Brandfetch CDN â€” logos vectoriales de alta calidad, sin API key
                    // Fallback: si falla, intenta con Google Favicon; si falla, quita el img
                    var d = theme.domain;
                    var primary  = 'https://cdn.brandfetch.io/' + d + '/w/256/h/256';
                    var fallback = 'https://t2.gstatic.com/faviconV2?client=SOCIAL&type=FAVICON&fallback_opts=TYPE,SIZE,URL&url=https://' + d + '&size=256';
                    iconHtml = '<img class="bank-logo-img" src="' + primary + '" ' +
                        'onload="var ic=this.parentElement;if(ic)ic.classList.add(\'has-logo\')" ' +
                        'onerror="if(!this.dataset.fb){this.dataset.fb=1;this.src=\'' + fallback + '\';}else{this.remove();}" ' +
                        'alt="' + escCheckout(acc.bankName) + '">' + fbSvg;
                } else {
                    iconHtml = fbSvg.replace('class="bank-icon-fb" ', '');
                }
                return '<div class="bank-row" id="bankRow'+i+'"' + styleAttr + ' onclick="toggleBankRow('+i+')">' +
                    '<div class="bank-row-head">' +
                        '<div class="bank-row-icon">' + iconHtml + '</div>' +
                        '<div class="bank-row-info"><div class="bank-row-name">' + escCheckout(acc.bankName) + '</div>' +
                        '<div class="bank-row-type">' + escCheckout(acc.accountType || '') + '</div></div>' +
                        '<svg class="bank-row-chevron" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"/></svg>' +
                    '</div>' +
                    '<div class="bank-row-body">' +
                        '<div class="bank-detail">' +
                            '<div class="bank-detail-row"><span class="dk">Banco</span><span class="dv dv-plain">' + escCheckout(acc.bankName) + '</span></div>' +
                            '<div class="bank-detail-row"><span class="dk">Tipo</span><span class="dv dv-plain">' + escCheckout(acc.accountType || '') + '</span></div>' +
                            '<div class="bank-detail-row"><span class="dk">NÂ° Cuenta</span><span class="dv dv-copyable" onclick="copyBankField(this,\'' + escCheckout(acc.accountNumber) + '\',event)" title="Clic para copiar">' + escCheckout(acc.accountNumber) + '</span></div>' +
                            '<div class="bank-detail-row"><span class="dk">Beneficiario</span><span class="dv dv-plain">' + escCheckout(acc.beneficiary) + '</span></div>' +
                            (acc.identification ? '<div class="bank-detail-row"><span class="dk">RUC / CÃ©dula</span><span class="dv dv-copyable" onclick="copyBankField(this,\'' + escCheckout(acc.identification) + '\',event)" title="Clic para copiar">' + escCheckout(acc.identification) + '</span></div>' : '') +
                        '</div>' +
                    '</div>' +
                '</div>';
            }).join('');
        }

        function escCheckout(s) { return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

        function copyBankField(el, text, e) {
            if (e) e.stopPropagation();
            navigator.clipboard.writeText(text).then(function() {
                el.classList.add('copied');
                setTimeout(function() { el.classList.remove('copied'); }, 1800);
            }).catch(function() {
                // Fallback para navegadores sin clipboard API
                var ta = document.createElement('textarea');
                ta.value = text; ta.style.position = 'fixed'; ta.style.opacity = '0';
                document.body.appendChild(ta); ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                el.classList.add('copied');
                setTimeout(function() { el.classList.remove('copied'); }, 1800);
            });
        }

        function toggleBankRow(i) {
            var row = document.getElementById('bankRow'+i);
            if (!row) return;
            var wasOpen = row.classList.contains('open');
            // Cerrar todos
            document.querySelectorAll('.bank-row').forEach(function(r) { r.classList.remove('open','selected'); });
            if (!wasOpen) {
                row.classList.add('open', 'selected');
            }
        }

        function showPayphoneInline() {
            var container = document.getElementById('pp-button-inline');
            if (!container) return;
            container.innerHTML = '<div class="text-center py-3"><div class="spinner-border text-primary"></div><p class="mt-2 small text-muted">Cargando formulario de pago...</p></div>';
            var items = cart.map(function(item) { return { productId: item.productId, quantity: item.quantity }; });
            if (items.length === 0) {
                container.innerHTML = '<p class="text-warning">AÃ±ada productos al carrito.</p>';
                return;
            }
            $.ajax({
                url: '/api/customer/checkout/prepare-payphone',
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + localStorage.getItem('customerToken') },
                contentType: 'application/json',
                data: JSON.stringify({ items: items, notes: $('#notes').val() || null }),
                success: function(config) {
                    container.innerHTML = '';
                    resetCardPreview();
                    initCardPreviewSync();
                    loadPayphoneScript(function() {
                        initPayphoneCajitaInline(config);
                    });
                },
                error: function(xhr) {
                    var msg = xhr.responseJSON && xhr.responseJSON.error ? xhr.responseJSON.error : 'Error al preparar el pago con tarjeta';
                    container.innerHTML = '<p class="text-danger">' + msg + '</p>';
                }
            });
        }

        // â”€â”€ Card preview live sync â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function resetCardPreview() {
            var n = document.getElementById('cpNum');
            var h = document.getElementById('cpHolder');
            var e = document.getElementById('cpExpiry');
            var b = document.getElementById('cpBrand');
            var bk = document.getElementById('cpBank');
            var t = document.getElementById('cpType');
            if (n) n.textContent = 'â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢';
            if (h) h.textContent = 'NOMBRE APELLIDO';
            if (e) e.textContent = 'MM/AA';
            if (b) b.textContent = 'ðŸ’³';
            if (bk) bk.textContent = '';
            if (t) t.textContent = '';
        }

        function initCardPreviewSync() {
            var container = document.getElementById('pp-button-inline');
            if (!container) return;
            if (window._ppPreviewPollTimer) { clearInterval(window._ppPreviewPollTimer); window._ppPreviewPollTimer = null; }
            // MutationObserver para detectar cuÃ¡ndo PayPhone termina de renderizar
            var obs = new MutationObserver(function() {
                if (container.querySelectorAll('input').length > 0) {
                    obs.disconnect();
                    startPreviewPolling(container);
                }
            });
            obs.observe(container, { childList: true, subtree: true });
            if (container.querySelectorAll('input').length > 0) {
                obs.disconnect();
                startPreviewPolling(container);
            }
        }

        // Polling â€” PayPhone usa React y sus inputs no disparan eventos DOM nativos
        function startPreviewPolling(container) {
            var prev = {};
            window._ppPreviewPollTimer = setInterval(function() {
                var ppSection = document.getElementById('payphone-inline-section');
                if (!ppSection || ppSection.classList.contains('d-none')) {
                    clearInterval(window._ppPreviewPollTimer);
                    window._ppPreviewPollTimer = null;
                    return;
                }
                container.querySelectorAll('input').forEach(function(inp, idx) {
                    var cur = inp.value;
                    if (cur !== prev[idx]) {
                        prev[idx] = cur;
                        processPayphoneInput(cur, inp.placeholder || '');
                    }
                });
            }, 200);
        }

        function processPayphoneInput(raw, placeholder) {
            raw = (raw || '').trim();
            var stripped = raw.replace(/[\s\-]/g, '');

            var numEl    = document.getElementById('cpNum');
            var holderEl = document.getElementById('cpHolder');
            var expiryEl = document.getElementById('cpExpiry');
            var brandEl  = document.getElementById('cpBrand');

            // NÃºmero: 12-19 dÃ­gitos
            if (/^\d{12,19}$/.test(stripped)) {
                var parts = stripped.match(/.{1,4}/g) || [];
                var masked = parts.map(function(p, i) {
                    return i < parts.length - 1 ? 'â€¢â€¢â€¢â€¢' : p;
                }).join(' ');
                setCardPreviewText(numEl, masked);
                updateCardBrand(stripped, brandEl);
                if (stripped.length >= 8) lookupBin(stripped.substring(0, 8));
                return;
            }

            // ExpiraciÃ³n: MM/YY o MM/YYYY
            if (/^\d{1,2}\/\d{2,4}$/.test(raw)) {
                setCardPreviewText(expiryEl, raw);
                return;
            }

            // CVV: 3-4 dÃ­gitos solos â€” ignorar
            if (/^\d{3,4}$/.test(stripped) && stripped.length <= 4) return;

            // Nombre: letras y espacios (â‰¥2 chars)
            if (raw.length >= 2 && /^[a-zA-ZÃ¡Ã©Ã­Ã³ÃºÃ¼Ã±ÃÃ‰ÃÃ“ÃšÃœÃ‘\s'.\-]+$/.test(raw)) {
                setCardPreviewText(holderEl, raw.toUpperCase());
                return;
            }

            // Campo vaciado â†’ reset segÃºn placeholder
            if (raw === '') {
                var ph = placeholder.toLowerCase();
                if (/nÃºmero|card|tarjeta|1234/.test(ph)) {
                    setCardPreviewText(numEl, 'â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢');
                    if (brandEl) brandEl.innerHTML = 'ðŸ’³';
                    setCardPreviewText(document.getElementById('cpBank'), '');
                    setCardPreviewText(document.getElementById('cpType'), '');
                } else if (/expir|mm|fecha/.test(ph)) {
                    setCardPreviewText(expiryEl, 'MM/AA');
                } else if (/titular|nombre|name/.test(ph)) {
                    setCardPreviewText(holderEl, 'NOMBRE APELLIDO');
                }
            }
        }

        function setCardPreviewText(el, val) {
            if (!el || el.textContent === val) return;
            el.classList.add('cp-updating');
            setTimeout(function() {
                el.textContent = val;
                el.classList.remove('cp-updating');
            }, 80);
        }

        function updateCardBrand(cardNum, brandEl) {
            if (!brandEl) return;
            var first  = cardNum.charAt(0);
            var first2 = cardNum.substring(0, 2);
            var numVal = parseInt(cardNum.substring(0, 4), 10);
            var html;
            if (first === '4') {
                // VISA â€” texto blanco en negrita
                html = '<span style="font-family:Arial,sans-serif;font-size:14px;font-weight:900;font-style:italic;color:#fff;letter-spacing:.5px">VISA</span>';
            } else if (first === '5' || (numVal >= 2221 && numVal <= 2720)) {
                // Mastercard â€” dos cÃ­rculos
                html = '<svg width="34" height="22" viewBox="0 0 34 22" fill="none" style="display:block">'
                     + '<circle cx="12" cy="11" r="10" fill="#EB001B" opacity=".9"/>'
                     + '<circle cx="22" cy="11" r="10" fill="#F79E1B" opacity=".85"/>'
                     + '<path d="M17 3.2a10 10 0 0 1 0 15.6A10 10 0 0 1 17 3.2z" fill="#FF5F00" opacity=".85"/>'
                     + '</svg>';
            } else if (first2 === '34' || first2 === '37') {
                // Amex
                html = '<span style="font-family:Arial,sans-serif;font-size:11px;font-weight:900;color:#fff;letter-spacing:.5px">AMEX</span>';
            } else if (first === '6') {
                // Discover
                html = '<span style="font-family:Arial,sans-serif;font-size:10px;font-weight:900;color:#fff;letter-spacing:.5px">DISCOVER</span>';
            } else {
                html = 'ðŸ’³';
            }
            if (brandEl.innerHTML !== html) brandEl.innerHTML = html;
        }

        // BIN lookup â€” banco emisor + dÃ©bito/crÃ©dito
        var _binCache = {};
        var _binPending = {};
        function lookupBin(bin) {
            if (_binCache[bin]) { applyBinData(_binCache[bin]); return; }
            if (_binPending[bin]) return;
            _binPending[bin] = true;
            fetch('/api/public/bin/' + bin)
                .then(function(r) { return r.ok ? r.json() : null; })
                .then(function(data) {
                    _binPending[bin] = false;
                    if (!data) return;
                    _binCache[bin] = data;
                    applyBinData(data);
                })
                .catch(function() { _binPending[bin] = false; });
        }

        function applyBinData(data) {
            setCardPreviewText(document.getElementById('cpBank'), data.bank ? data.bank.toUpperCase() : '');
            var label = data.type === 'debit' ? 'DÃ©bito'
                      : data.type === 'credit' ? 'CrÃ©dito'
                      : data.type === 'prepaid' ? 'Prepago' : '';
            setCardPreviewText(document.getElementById('cpType'), label);
        }
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        function logout() {
            localStorage.removeItem('customerToken');
            localStorage.removeItem('customer');
            localStorage.removeItem('customerCart');
            localStorage.removeItem('cartExpiresAt');
            window.location.href = '/customer/login';
        }

        function loadTaxRate() {
            $.ajax({
                url: '/api/public/tax-rate',
                method: 'GET',
                data: { tenantId: 1 },
                success: function(response) {
                    taxEnabled = response.enabled !== false;
                    currentTaxRate = response.configured && response.value != null ? parseFloat(response.value) : null;
                    updateTaxLabel();
                    displayOrderSummary();
                },
                error: function() {
                    taxEnabled = true;
                    currentTaxRate = null;
                    updateTaxLabel();
                    displayOrderSummary();
                }
            });
            $.ajax({
                url: '/api/public/discount-rate',
                method: 'GET',
                data: { tenantId: 1 },
                success: function(r) {
                    currentDiscountRate = r.value || 0;
                    updateTotals();
                }
            });
        }

        function updateTaxLabel() {
            if (!taxEnabled) {
                $('.tax-row').removeClass('d-flex').addClass('d-none');
                $('#processBtn').prop('disabled', false);
            } else if (currentTaxRate == null) {
                $('.tax-row').removeClass('d-none').addClass('d-flex');
                $('#taxLabel').text('IVA: No configurado');
                $('#processBtn').prop('disabled', true);
            } else {
                $('.tax-row').removeClass('d-none').addClass('d-flex');
                $('#taxLabel').text(`IVA (${currentTaxRate.toFixed(0)}%):`);
                $('#processBtn').prop('disabled', false);
            }
        }

        function displayOrderSummary() {
            const summary = $('#orderSummary');
            let html = '';
            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                const imgHtml = item.imageUrl
                    ? `<img src="${item.imageUrl}" alt="${item.productName}">`
                    : `<svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="m3 9 4-4 4 4 4-4 4 4"/><circle cx="8" cy="14" r="2"/></svg>`;
                html += `
                    <div class="order-item">
                        <div class="order-item-img">${imgHtml}</div>
                        <div class="order-item-info">
                            <div class="order-item-name">${item.productName}</div>
                            <div class="order-item-meta">${item.quantity} Ã— $${item.price.toFixed(2)}</div>
                        </div>
                        <div class="order-item-price">$${itemTotal.toFixed(2)}</div>
                    </div>
                `;
            });
            summary.html(html);
            updateTotals();
        }

        function updateTotals() {
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const tax = (taxEnabled && currentTaxRate != null) ? subtotal * (currentTaxRate / 100) : 0;
            const payMethod = $('#paymentMethod').val();
            const applyDiscount = (payMethod === 'CASH' || payMethod === 'TRANSFER') && currentDiscountRate > 0;
            const discountAmt = applyDiscount ? Math.round((subtotal + tax) * (currentDiscountRate / 100) * 100) / 100 : 0;
            const total = subtotal + tax - discountAmt;

            $('#subtotal').text(`$${subtotal.toFixed(2)}`);
            $('#tax').text(`$${tax.toFixed(2)}`);
            if (applyDiscount) {
                $('#discountRow').removeClass('d-none');
                $('#discount').text(`-$${discountAmt.toFixed(2)}`);
            } else {
                $('#discountRow').addClass('d-none');
            }
            $('#total').text(`$${total.toFixed(2)}`);
        }

        function processOrder() {
            const paymentMethod = $('#paymentMethod').val();

            if (taxEnabled && currentTaxRate == null) {
                showAlert('El IVA no estÃ¡ configurado. No es posible completar la compra. Contacte al administrador.', 'warning');
                return;
            }
            if (!paymentMethod) {
                showAlert('Por favor seleccione un mÃ©todo de pago', 'warning');
                return;
            }

            if (cart.length === 0) {
                showAlert('El carrito estÃ¡ vacÃ­o', 'warning');
                return;
            }

            const items = cart.map(item => ({
                productId: item.productId,
                quantity: item.quantity
            }));

            if (paymentMethod === 'CARD') {
                showAlert('Complete el pago con el formulario de tarjeta que se muestra arriba y use el botÃ³n de PayPhone para pagar.', 'info');
                return;
            }

            $.ajax({
                url: '/api/customer/cart/validate',
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('customerToken')
                },
                contentType: 'application/json',
                data: JSON.stringify({ items }),
                success: function(response) {
                    if (!response.valid) {
                        const invalidItems = response.validations.filter(v => !v.valid);
                        let errorMsg = 'Algunos productos ya no estÃ¡n disponibles:\n';
                        invalidItems.forEach(item => {
                            errorMsg += `- ${item.productName}: Disponible ${item.availableStock}, solicitado ${item.requestedQty}\n`;
                        });
                        showAlert(errorMsg, 'danger');
                        return;
                    }

                    const orderData = {
                        items,
                        paymentMethod,
                        notes: $('#notes').val() || null
                    };

                    $.ajax({
                        url: '/api/customer/checkout',
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + localStorage.getItem('customerToken')
                        },
                        contentType: 'application/json',
                        data: JSON.stringify(orderData),
                        success: function(response) {
                            if (response.status === 'PENDING' && response.saleId) {
                                showWaitingCashAndListen(response.saleId);
                                return;
                            }
                            showAlert('Â¡Pedido realizado exitosamente!', 'success');
                            localStorage.removeItem('customerCart');
                            localStorage.removeItem('cartExpiresAt');
                            cart = [];
                            setTimeout(function() { if (window.spaNavigate) window.spaNavigate('/customer/orders'); else window.location.href = '/customer/orders'; }, 2000);
                        },
                        error: function(xhr) {
                            if (xhr.status === 401) {
                                window.location.href = '/customer/login';
                            } else {
                                const error = xhr.responseJSON?.error || 'Error al procesar el pedido';
                                showAlert(error, 'danger');
                            }
                        }
                    });
                },
                error: function(xhr) {
                    if (xhr.status === 401) {
                        window.location.href = '/customer/login';
                    } else {
                        showAlert('Error al validar el carrito', 'danger');
                    }
                }
            });
        }

        var payphonePPB = null;

        function initPayphoneCajitaInline(config) {
            try {
                if (typeof window.PPaymentButtonBox === 'undefined') {
                    document.getElementById('pp-button-inline').innerHTML = '<p class="text-danger">No se pudo cargar el formulario de pago. Recarga la pÃ¡gina e intenta de nuevo.</p>';
                    return;
                }
                if (payphonePPB) payphonePPB = null;
                var ppbConfig = {
                    token: config.token,
                    storeId: config.storeId,
                    clientTransactionId: config.clientTransactionId,
                    amount: config.amount,
                    amountWithoutTax: config.amountWithoutTax,
                    amountWithTax: config.amountWithTax,
                    tax: config.tax,
                    currency: config.currency || 'USD',
                    reference: config.reference || 'Venta LOCOBAR',
                    lang: 'es',
                    defaultMethod: 'card'
                };
                if (config.returnUrl) ppbConfig.returnUrl = config.returnUrl;
                payphonePPB = new window.PPaymentButtonBox(ppbConfig);
                payphonePPB.render('pp-button-inline');
            } catch (e) {
                console.error('PayPhone init error:', e);
                document.getElementById('pp-button-inline').innerHTML = '<p class="text-danger">Error al cargar el formulario de pago. Intente de nuevo.</p>';
            }
        }

        function initPayphoneCajita(config, modal) {
            try {
                if (typeof window.PPaymentButtonBox === 'undefined') {
                    showAlert('No se pudo cargar el formulario de pago. Recarga la pÃ¡gina e intenta de nuevo.', 'danger');
                    if (modal && modal.hide) modal.hide();
                    return;
                }
                if (payphonePPB) payphonePPB = null;
                var ppbConfig2 = {
                    token: config.token,
                    storeId: config.storeId,
                    clientTransactionId: config.clientTransactionId,
                    amount: config.amount,
                    amountWithoutTax: config.amountWithoutTax,
                    amountWithTax: config.amountWithTax,
                    tax: config.tax,
                    currency: config.currency || 'USD',
                    reference: config.reference || 'Venta LOCOBAR',
                    lang: 'es',
                    defaultMethod: 'card'
                };
                if (config.returnUrl) ppbConfig2.returnUrl = config.returnUrl;
                payphonePPB = new window.PPaymentButtonBox(ppbConfig2);
                payphonePPB.render('pp-button-modal');
            } catch (e) {
                console.error('PayPhone init error:', e);
                showAlert('Error al cargar el formulario de pago. Intente de nuevo.', 'danger');
                if (modal && modal.hide) modal.hide();
            }
        }

        function loadPayphoneScript(callback) {
            if (typeof window.PPaymentButtonBox !== 'undefined') {
                callback();
                return;
            }
            import('https://cdn.payphonetodoesposible.com/box/v1.1/payphone-payment-box.js').then(function(m) {
                window.PPaymentButtonBox = m.PPaymentButtonBox || m.default || m;
                callback();
            }).catch(function() {
                callback();
            });
        }

        function startPayphoneFlow(items) {
            $.ajax({
                url: '/api/customer/checkout/prepare-payphone',
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + localStorage.getItem('customerToken') },
                contentType: 'application/json',
                data: JSON.stringify({
                    items,
                    notes: $('#notes').val() || null
                }),
                success: function(config) {
                    var modalEl = document.getElementById('payphoneModal');
                    var modal = new bootstrap.Modal(modalEl);
                    document.getElementById('pp-button-modal').innerHTML = '';

                    // Primero mostrar el modal, y DESPUÃ‰S de que sea visible,
                    // inicializar la cajita de Payphone (necesita el div visible para renderizar)
                    modalEl.addEventListener('shown.bs.modal', function onShown() {
                        modalEl.removeEventListener('shown.bs.modal', onShown);
                        loadPayphoneScript(function() {
                            initPayphoneCajita(config, modal);
                        });
                    }, { once: true });
                    modal.show();
                },
                error: function(xhr) {
                    if (xhr.status === 401) {
                        window.location.href = '/customer/login';
                    } else {
                        const msg = xhr.responseJSON?.error || 'Error al preparar el pago con tarjeta';
                        showAlert(msg, 'danger');
                    }
                }
            });
        }

        function showAlert(message, type) {
            var colorMap = { success:'var(--green)', warning:'var(--amber)', danger:'var(--red)', info:'var(--accent)' };
            var svgMap = {
                success: '<svg width="17" height="17" fill="currentColor" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/></svg>',
                warning: '<svg width="17" height="17" fill="currentColor" viewBox="0 0 16 16"><path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/></svg>',
                danger:  '<svg width="17" height="17" fill="currentColor" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293 5.354 4.646z"/></svg>',
                info:    '<svg width="17" height="17" fill="currentColor" viewBox="0 0 16 16"><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/></svg>'
            };
            var color = colorMap[type] || colorMap.info;
            var svgIcon = svgMap[type] || svgMap.info;
            var existing = document.getElementById('lbToastGlobal');
            if (existing) existing.remove();
            var toast = document.createElement('div');
            toast.id = 'lbToastGlobal';
            toast.className = 'lb-toast';
            toast.innerHTML =
                '<span class="lb-toast-icon" style="color:' + color + '">' + svgIcon + '</span>' +
                '<span class="lb-toast-msg">' + message.replace(/\n/g, '<br>') + '</span>' +
                '<button class="lb-toast-close" onclick="this.closest(\'.lb-toast\').remove()" aria-label="Cerrar">&times;</button>';
            (document.getElementById('app-content') || document.body).appendChild(toast);
            requestAnimationFrame(function() {
                requestAnimationFrame(function() { toast.classList.add('lb-toast-show'); });
            });
            setTimeout(function() {
                toast.classList.remove('lb-toast-show');
                toast.classList.add('lb-toast-hide');
                setTimeout(function() { if (toast.parentNode) toast.parentNode.removeChild(toast); }, 250);
            }, 4500);
        }

        var waitingCashModalShown = false;
        var saleStatusPollInterval = null;

        function showWaitingCashAndListen(saleId) {
            const token = localStorage.getItem('customerToken');
            const waitModal = new bootstrap.Modal(document.getElementById('waitingCashModal'));
            waitModal.show();
            waitingCashModalShown = true;

            const onConfirmed = function() {
                if (!waitingCashModalShown) return;
                waitingCashModalShown = false;
                if (saleStatusPollInterval) clearInterval(saleStatusPollInterval);
                waitModal.hide();
                localStorage.removeItem('customerCart');
                localStorage.removeItem('cartExpiresAt');
                cart = [];
                $.get('/api/public/brand-slogan', function(r) {
                    const slogan = (r && r.brandSlogan) ? r.brandSlogan : 'Sistema de LicorerÃ­a';
                    $('#thankYouSlogan').text(slogan);
                });
                const thankYouModal = new bootstrap.Modal(document.getElementById('thankYouModal'));
                thankYouModal.show();
                document.getElementById('thankYouCloseBtn').onclick = function() {
                    thankYouModal.hide();
                    if (window.spaNavigate) window.spaNavigate('/customer/catalog'); else window.location.href = '/customer/catalog';
                };
            };

            const socket = io({
                auth: { token: token },
                query: { saleId: saleId }
            });
            socket.on('sale-confirmed', onConfirmed);
            socket.on('sale-voided', function(payload) {
                if (payload && payload.saleId === parseInt(saleId, 10)) {
                    if (waitingCashModalShown) {
                        waitingCashModalShown = false;
                        if (saleStatusPollInterval) clearInterval(saleStatusPollInterval);
                        waitModal.hide();
                        showAlert('Su pedido fue rechazado. Si tiene dudas, contacte al local.', 'warning');
                    }
                }
            });
            socket.on('connect_error', function() {
                // Fallback: poll status
                saleStatusPollInterval = setInterval(function() {
                    $.ajax({
                        url: '/api/customer/sales/' + saleId + '/status',
                        method: 'GET',
                        headers: { 'Authorization': 'Bearer ' + token },
                        success: function(data) {
                            if (data.status === 'COMPLETED') {
                                onConfirmed();
                            } else if (data.status === 'VOIDED') {
                                if (waitingCashModalShown) {
                                    waitingCashModalShown = false;
                                    clearInterval(saleStatusPollInterval);
                                    saleStatusPollInterval = null;
                                    waitModal.hide();
                                    showAlert('Su pedido fue rechazado. Si tiene dudas, contacte al local.', 'warning');
                                }
                            }
                        }
                    });
                }, 3000);
            });

            setTimeout(function() {
                if (waitingCashModalShown) {
                    document.getElementById('waitingTenMinMsg').classList.remove('d-none');
                }
            }, 10 * 60 * 1000);
        }

        function startCartExpiryTimer(onExpired) {
            if (window._cartTimerInterval) {
                clearInterval(window._cartTimerInterval);
                window._cartTimerInterval = null;
            }
            var totalDuration = 30 * 60 * 1000; // 30 min
            function tick() {
                var currentCart = JSON.parse(localStorage.getItem('customerCart')) || [];
                var banner = document.getElementById('cartExpiryBanner');
                var countdownEl = document.getElementById('cartExpiryCountdown');
                var ringEl = document.getElementById('cartTimerRing');
                if (currentCart.length === 0) {
                    if (banner) banner.classList.add('d-none');
                    clearInterval(window._cartTimerInterval);
                    window._cartTimerInterval = null;
                    return;
                }
                var expiresAt = parseInt(localStorage.getItem('cartExpiresAt'), 10);
                if (!expiresAt) { if (banner) banner.classList.add('d-none'); return; }
                var remaining = expiresAt - Date.now();
                if (remaining <= 0) {
                    localStorage.removeItem('customerCart');
                    localStorage.removeItem('cartExpiresAt');
                    cart = [];
                    clearInterval(window._cartTimerInterval);
                    window._cartTimerInterval = null;
                    if (banner) banner.classList.add('d-none');
                    if (onExpired) onExpired();
                    return;
                }
                if (banner) {
                    banner.classList.remove('d-none');
                    banner.classList.toggle('warn', remaining < 5 * 60 * 1000);
                }
                if (countdownEl) {
                    var totalSeconds = Math.floor(remaining / 1000);
                    var mins = Math.floor(totalSeconds / 60);
                    var secs = totalSeconds % 60;
                    countdownEl.textContent = mins + ':' + (secs < 10 ? '0' : '') + secs;
                }
                // Ring animation: circumference â‰ˆ 2Ï€Ã—19 â‰ˆ 119.4 (dasharray=120)
                if (ringEl) {
                    var pct = Math.min(1, Math.max(0, remaining / totalDuration));
                    var offset = 120 * (1 - pct);
                    ringEl.style.strokeDasharray = '120';
                    ringEl.style.strokeDashoffset = offset;
                }
                // Progress bar bg
                if (banner) {
                    var pctBg = Math.min(1, Math.max(0, remaining / totalDuration));
                    banner.style.setProperty('--progress', (pctBg * 100) + '%');
                }
            }
            tick();
            window._cartTimerInterval = setInterval(tick, 1000);
        }

        // Reinicializar checkout al navegar por SPA
        window.initCheckoutView = function() {
            var expiresAt = parseInt(localStorage.getItem('cartExpiresAt'), 10);
            if (expiresAt && Date.now() >= expiresAt) {
                localStorage.removeItem('customerCart');
                localStorage.removeItem('cartExpiresAt');
                cart = [];
                if (window.spaNavigate) window.spaNavigate('/customer/catalog'); else window.location.href = '/customer/catalog';
                return;
            }
            cart = JSON.parse(localStorage.getItem('customerCart')) || [];
            if (cart.length === 0) {
                if (window.spaNavigate) window.spaNavigate('/customer/cart'); else window.location.href = '/customer/cart';
                return;
            }
            // Resetear selecciÃ³n de mÃ©todo de pago
            document.querySelectorAll('.payment-method-card').forEach(function(c) { c.classList.remove('active'); });
            document.getElementById('paymentMethod').value = '';
            document.getElementById('payphone-inline-section').classList.add('d-none');
            document.getElementById('transferInfoSection').classList.add('d-none');
            document.getElementById('processBtn').classList.remove('d-none');
            _bankAccountsCache = null; // forzar recarga de cuentas en siguiente visita
            // Mostrar productos y totales inmediatamente, sin esperar AJAX
            currentDiscountRate = 0;
            displayOrderSummary();
            // Cargar IVA y descuento de forma asÃ­ncrona y actualizar totales al llegar
            loadTaxRate();
            loadPayphoneAssets();
            startCartExpiryTimer(function() {
                showAlert('Tu carrito expirÃ³. Redirigiendo al catÃ¡logo...', 'warning');
                setTimeout(function() {
                    if (window.spaNavigate) window.spaNavigate('/customer/catalog'); else window.location.href = '/customer/catalog';
                }, 2000);
            });
        };
    </script>
    </div><!-- #spa-view-content -->
</body>
</html>

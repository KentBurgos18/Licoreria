<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/public/img/pestana-LB.png" type="image/png">
    <title id="dashboardPageTitle">Sistema de Licorería - Dashboard</title>
    <link href="/libs/css/bootstrap.min.css" rel="stylesheet">
    <link href="/libs/css/bootstrap-icons.css" rel="stylesheet">
    <!-- Google Maps API (carga optimizada con async) -->
    <script>(g=>{var h,a,k,p="The Google Maps JavaScript API",c="google",l="importLibrary",q="__ib__",m=document,b=window;b=b[c]||(b[c]={});var d=b.maps||(b.maps={}),r=new Set,e=new URLSearchParams,u=()=>h||(h=new Promise(async(f,n)=>{await (a=m.createElement("script"));e.set("libraries",[...r]);for(k in g)e.set(k.replace(/[A-Z]/g,t=>"_"+t[0].toLowerCase()),g[k]);e.set("callback",c+".maps."+q);a.src=`https://maps.googleapis.com/maps/api/js?`+e;d[q]=f;a.onerror=()=>h=n(Error(p+" could not load."));a.nonce=m.querySelector("script[nonce]")?.nonce||"";m.head.append(a)}));d[l]?console.warn(p+" only loads once. Ignoring:",g):d[l]=(f,...n)=>r.add(f)&&u().then(()=>d[l](f,...n))})({
        key: "AIzaSyA2QRfT8cdYlLfnzeLOA7HTzqOCibzfBt8",
        v: "weekly"
    });</script>
    <style>
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 250px;
            background-color: #2c3e50;
            padding-top: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .sidebar-nav-scroll {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }
        .sidebar-nav-scroll::-webkit-scrollbar {
            width: 4px;
        }
        .sidebar-nav-scroll::-webkit-scrollbar-track {
            background: transparent;
        }
        .sidebar-nav-scroll::-webkit-scrollbar-thumb {
            background: #4a6278;
            border-radius: 2px;
        }
        .sidebar-logout {
            flex-shrink: 0;
            border-top: 1px solid rgba(255,255,255,0.15);
            padding: 8px 10px;
        }
        
        .sidebar .nav-link {
            color: #ecf0f1;
            padding: 12px 20px;
            margin: 5px 10px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        
        .sidebar .nav-link:hover {
            background-color: #34495e;
            color: #3498db;
        }
        
        .sidebar .nav-link.active {
            background-color: #3498db;
            color: white;
        }
        
        .main-content {
            margin-left: 250px;
            padding: 20px;
            min-height: 100vh;
            background-color: #f8f9fa;
        }
        
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .stats-card.success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .stats-card.warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .stats-card.info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .content-section {
            display: none;
        }
        
        .content-section.active {
            display: block;
        }
        
        .navbar-custom {
            background-color: #34495e;
            padding: 15px 30px;
            margin-left: 250px;
        }

        /* Cuadro de notificaciones: responsive (laptop y móvil) */
        .notifications-dropdown-menu {
            min-width: 380px;
            max-width: min(480px, 95vw);
            max-height: min(450px, 70vh);
            overflow-y: auto;
            padding: 0.5rem 0;
            border-radius: 10px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            margin-top: 0.5rem;
        }
        .notifications-dropdown-menu .dropdown-item {
            padding: 0.6rem 1rem;
            white-space: normal;
            min-height: 44px;
        }
        .notifications-dropdown-menu .notifications-item-text {
            white-space: normal;
            word-wrap: break-word;
            overflow-wrap: break-word;
            min-width: 0;
            flex: 1 1 auto;
        }
        .notifications-dropdown-menu .dropdown-item .btn {
            min-height: 36px;
            padding: 0.35rem 0.75rem;
        }
        .notifications-dropdown-menu .notifications-item-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            flex-shrink: 0;
        }
        .notifications-dropdown-header {
            padding: 0.5rem 1rem;
            font-weight: 600;
        }
        
        .table-actions {
            display: flex;
            gap: 5px;
        }
        
        .btn-sm-custom {
            padding: 4px 8px;
            font-size: 12px;
        }
        
        .price-input-group {
            display: flex;
            gap: 10px;
            align-items: end;
        }
        
        .price-input-group .form-group {
            flex: 1;
        }
        
        .modal-header {
            background-color: #34495e;
            color: white;
        }
        
        .product-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .product-card:hover {
            transform: translateY(-5px);
        }
        
        /* POS Product Cards - Mosaico compacto */
        .pos-product-card {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            position: relative;
            overflow: hidden;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }
        
        .pos-product-card:hover {
            border-color: #3498db;
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }
        
        .pos-product-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f5f5f5;
        }
        
        .pos-product-card.disabled:hover {
            transform: none;
            border-color: #e0e0e0;
            box-shadow: none;
        }
        
        .pos-product-image-container {
            width: 100%;
            height: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
            padding: 8px;
        }
        
        .pos-product-image {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
            border-radius: 6px;
        }
        
        .pos-product-image-placeholder {
            width: 100%;
            height: 140px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2.5em;
        }
        
        .pos-product-name {
            font-weight: 600;
            font-size: 0.9em;
            margin-bottom: 6px;
            color: #2c3e50;
            min-height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.3;
            word-wrap: break-word;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        .pos-product-price {
            font-size: 1.15em;
            font-weight: bold;
            color: #27ae60;
            margin: 4px 0;
        }
        
        .pos-product-stock {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 0.7em;
            font-weight: 500;
            margin-top: 4px;
        }
        
        .pos-product-stock.available {
            background: #d4edda;
            color: #155724;
        }
        
        .pos-product-stock.low {
            background: #fff3cd;
            color: #856404;
        }
        
        .pos-product-stock.out {
            background: #f8d7da;
            color: #721c24;
        }
        
        .pos-combo-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #ffc107;
            color: #000;
            padding: 3px 6px;
            border-radius: 10px;
            font-size: 0.7em;
            font-weight: bold;
            z-index: 1;
        }

        /* Vender: estilo catálogo (como catálogo del cliente) */
        #sell .sell-search-input-wrap .form-control { border-right: 0; }
        #sell .sell-search-input-wrap .input-group-text { border-left: 0; background: #fff; }
        #sell .sell-search-input-wrap .form-control:focus { border-color: #ced4da; box-shadow: none; }
        #sell .sell-search-input-wrap .form-control:focus + .input-group-text,
        #sell .sell-search-input-wrap:focus-within .input-group-text { border-color: #86b7fe; }
        .sell-catalog-card {
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 10px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 10px;
            height: 100%;
            background: #fff;
            position: relative;
        }
        .sell-catalog-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .sell-catalog-card.disabled { opacity: 0.65; cursor: not-allowed; }
        .sell-catalog-card.disabled:hover { transform: none; }
        .sell-catalog-card:not(.disabled) { cursor: pointer; }
        .sell-catalog-card-image-wrap {
            flex-shrink: 0;
            width: 70px;
            height: 70px;
            border-radius: 8px;
            overflow: hidden;
            background: #f8f8f8;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sell-catalog-card-image-wrap img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .sell-catalog-card-image-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ccc;
            font-size: 1.8em;
        }
        .sell-catalog-card-body {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .sell-catalog-card-body h5 {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            line-height: 1.3;
        }
        .sell-catalog-combo-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #ffc107;
            color: #000;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7em;
            font-weight: bold;
        }
        .sell-catalog-stock-badge {
            display: inline;
            padding: 2px 8px;
            border-radius: 2px 12px 12px 2px;
            font-size: 0.65em;
            white-space: nowrap;
            align-self: flex-start;
            margin-top: 4px;
        }
        .sell-catalog-stock-available { background: #d4edda; color: #155724; }
        .sell-catalog-stock-low { background: #fff3cd; color: #856404; }
        .sell-catalog-stock-out { background: #f8d7da; color: #721c24; }
        
        .pos-search-loading {
            position: absolute;
            right: 50px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        /* Carrito del modal Vender: estilo como carrito del cliente */
        #sellCartModal .cart-item {
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 12px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            flex-direction: row;
            align-items: stretch;
            gap: 12px;
        }
        #sellCartModal .cart-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        #sellCartModal .cart-item-image-wrap {
            flex-shrink: 0;
            width: 90px;
            height: 90px;
            border-radius: 8px;
            overflow: hidden;
            background: #f0f0f0;
        }
        #sellCartModal .cart-item-image-wrap img,
        #sellCartModal .cart-item-image-wrap .cart-image-placeholder {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        #sellCartModal .cart-image-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ccc;
            font-size: 2em;
        }
        #sellCartModal .cart-item-body {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        #sellCartModal .cart-item-body h5 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0;
            line-height: 1.3;
        }
        #sellCartModal .cart-item-price-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 2px;
        }
        #sellCartModal .quantity-controls {
            display: inline-flex;
            align-items: stretch;
            background: #f8f9fa;
            border-radius: 20px;
            border: 1px solid #dee2e6;
            overflow: hidden;
            height: 36px;
        }
        #sellCartModal .quantity-controls .btn {
            flex: 1;
            min-width: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            border: none;
            background: transparent;
            padding: 0;
            margin: 0;
            cursor: pointer;
            transition: background 0.2s;
        }
        #sellCartModal .quantity-controls .btn:hover {
            background: rgba(0,0,0,0.08);
        }
        #sellCartModal .quantity-controls .btn-danger {
            color: #dc3545;
        }
        #sellCartModal .quantity-controls .btn-danger:hover {
            background: rgba(220, 53, 69, 0.1);
        }
        #sellCartModal .quantity-controls span {
            flex: 1;
            min-width: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.95rem;
            border-left: 1px solid #dee2e6;
            border-right: 1px solid #dee2e6;
        }
        /* Evitar que el dropdown del método de pago quede detrás del modal o sin poder seleccionar */
        #sellCartModal .modal-footer {
            position: relative;
            z-index: 1060;
            overflow: visible;
        }
        #sellCartModal #sellCartModalPaymentMethod {
            position: relative;
            z-index: 1061;
            pointer-events: auto;
            min-height: 38px;
            cursor: pointer;
        }
        #sellCartModal #sellCartModalNormalSaleFields .row {
            overflow: visible;
        }
        #sellCartModal #sellCartModalPaymentMethodCol {
            position: relative;
            z-index: 1060;
        }
        @media (max-width: 768px) {
            #sellCartModal .cart-item-image-wrap { width: 70px; height: 70px; }
        }

        /* Burbuja flotante del carrito */
        .sell-cart-bubble {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
            animation: sellCartPulse 2s infinite;
        }
        
        .sell-cart-bubble:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(102, 126, 234, 0.6);
        }
        
        .sell-cart-bubble.show {
            display: flex;
        }
        
        .sell-cart-bubble-icon {
            color: white;
            font-size: 1.8em;
            position: relative;
        }
        
        .sell-cart-bubble-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: #dc3545;
            color: white;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75em;
            font-weight: bold;
            border: 2px solid white;
        }
        
        @keyframes sellCartPulse {
            0% {
                box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            }
            50% {
                box-shadow: 0 4px 30px rgba(102, 126, 234, 0.6);
            }
            100% {
                box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            }
        }

        /* Barra inferior del carrito (igual que catálogo cliente):
           - Sin ítems: barra oculta con translateY(100%) y sin clase .sell-cart-bar-visible.
           - Con ítems (y en sección Vender): se añade .sell-cart-bar-visible → barra sube con animación (translateY(0)).
           Solo se muestra en sección Vender; en Dashboard y demás la barra queda fuera de vista y no interactiva. */
        #sellCartBottomBar {
            position: fixed;
            bottom: 0;
            left: 250px;
            right: 0;
            z-index: 1001;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #fff;
            padding: 14px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
            transform: translateY(100%);
            transition: transform 0.3s ease;
            will-change: transform;
        }
        /* Fuera de Vender: barra siempre oculta e inactiva (como si no existiera) */
        body:not(.section-sell) #sellCartBottomBar {
            transform: translateY(100%) !important;
            visibility: hidden;
            pointer-events: none;
        }
        /* En Vender, sin ítems: barra oculta pero ya “presente” para la animación al agregar el primero */
        body.section-sell #sellCartBottomBar {
            visibility: visible;
            pointer-events: auto;
        }
        /* En Vender, con ítems: misma animación que cliente (barra sube desde abajo) */
        body.section-sell #sellCartBottomBar.sell-cart-bar-visible {
            transform: translateY(0);
        }
        #sellCartBottomBar .sell-cart-bar-left {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        #sellCartBottomBar .sell-cart-bar-items {
            font-size: 1.25rem;
            font-weight: 700;
        }
        #sellCartBottomBar .sell-cart-bar-total {
            font-size: 0.9rem;
            opacity: 0.95;
        }
        #sellCartBottomBar .btn-ver-carrito-sell {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #fff;
            color: #0f3460;
            font-weight: 600;
            padding: 10px 18px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            white-space: nowrap;
            text-decoration: none;
        }
        #sellCartBottomBar .btn-ver-carrito-sell:hover {
            background: #f0f0f0;
            color: #16213e;
        }
        body.sell-cart-bar-visible .main-content { padding-bottom: 90px; }
        
        /* Group Sale Styles */
        #groupSaleFields {
            border-top: 2px solid #3498db;
            padding-top: 15px;
            margin-top: 15px;
        }
        
        #groupSaleCustomersList {
            background: #f8f9fa;
        }
        
        /* Customer Dropdown Styles */
        .customer-dropdown {
            background: white;
        }
        
        .customer-dropdown .form-check {
            padding: 10px 15px;
            margin: 0;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .customer-dropdown .form-check:hover {
            background: #f8f9fa;
        }
        
        .customer-dropdown .form-check:last-child {
            border-bottom: none;
        }
        
        .customer-dropdown .form-check.selected {
            background: #d4edda;
        }
        
        .customer-dropdown .form-check-label {
            cursor: pointer;
            width: 100%;
            font-size: 0.95em;
            margin: 0;
            padding: 0;
        }
        
        /* Asegurar que el modal de cliente aparezca sobre el modal del carrito */
        #customerModal {
            z-index: 1060 !important;
        }
        
        #customerModal .modal-backdrop {
            z-index: 1055 !important;
        }
        
        /* Modal de verificación de código también debe estar arriba */
        #verificationCodeModal {
            z-index: 1070 !important;
        }
        
        #verificationCodeModal .modal-backdrop {
            z-index: 1065 !important;
        }
        
        /* Modal del mapa debe quedar por encima del modal de cliente al elegir ubicación */
        #mapModal {
            z-index: 1080 !important;
        }
        
        #mapModal .modal-dialog {
            z-index: 1080 !important;
        }
        
        #mapModal .modal-backdrop {
            z-index: 1075 !important;
        }
        
        #groupSaleParticipantsTable {
            font-size: 0.9em;
        }
        
        #groupSaleParticipantsTable input,
        #groupSaleParticipantsTable select {
            font-size: 0.9em;
        }
        
        .group-sale-participant-row:hover {
            background-color: #f8f9fa;
        }
        
        .stock-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .stock-high { background-color: #28a745; }
        .stock-medium { background-color: #ffc107; }
        .stock-low { background-color: #dc3545; }
        .stock-zero { background-color: #6c757d; }
        
        /* Mobile Bottom Navigation */
        .mobile-bottom-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #2c3e50;
            padding: 10px 0;
            z-index: 1002;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
        }
        
        .mobile-bottom-nav .nav {
            display: flex;
            justify-content: space-evenly;
            align-items: center;
            margin: 0;
            padding: 0;
            list-style: none;
            width: 100%;
        }
        
        .mobile-bottom-nav .nav-item {
            flex: 1 1 0;
            min-width: 0;
            text-align: center;
        }
        
        .mobile-bottom-nav .nav-link {
            color: #ecf0f1;
            padding: 8px 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 11px;
            border-radius: 5px;
            transition: all 0.3s ease;
            text-decoration: none;
        }
        
        .mobile-bottom-nav .nav-link i {
            font-size: 20px;
            margin-bottom: 4px;
        }
        
        .mobile-bottom-nav .nav-link.active {
            color: #3498db;
            background-color: rgba(52, 152, 219, 0.2);
        }
        
        .mobile-bottom-nav .nav-link:hover {
            color: #3498db;
        }
        
        /* Mobile Sidebar Overlay */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 999;
        }
        
        .sidebar-overlay.active {
            display: block;
        }
        
        /* Responsive Styles */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                z-index: 1000;
            }
            
            .sidebar.mobile-open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
                padding: 60px 15px 80px 15px;
            }
            
            .navbar-custom {
                margin-left: 0;
                padding: 10px 15px;
                overflow: visible;
            }

            /* Notificaciones en móvil: un poco más ancho, sin recortes */
            .notifications-dropdown-menu {
                min-width: 320px !important;
                width: auto !important;
                max-width: calc(100vw - 20px) !important;
                max-height: min(70vh, 400px);
                margin-top: 0.5rem;
                padding: 0.5rem 0;
            }
            .notifications-dropdown-menu .dropdown-item {
                padding: 0.75rem 1rem;
                min-height: 48px;
                font-size: 0.95rem;
                flex-wrap: wrap;
            }
            .notifications-dropdown-menu .notifications-item-text {
                flex: 1 1 100%;
                margin-bottom: 0.35rem;
                max-width: 100%;
            }
            .notifications-dropdown-menu .notifications-item-actions {
                flex: 1 1 100%;
                gap: 0.4rem;
            }
            .notifications-dropdown-menu .dropdown-item .btn {
                min-height: 40px;
                padding: 0.5rem 0.85rem;
                font-size: 0.9rem;
            }
            /* Barra carrito Vender: igual que en cliente (animación de barrido), pero posicionada
               justo encima del menú inferior para no montarse sobre los botones. */
            .mobile-bottom-nav {
                display: flex;
                min-height: 56px;
                height: 72px;
                box-sizing: border-box;
                align-items: center;
            }
            #sellCartBottomBar {
                left: 0;
                bottom: 72px; /* altura del menú inferior: queda justo encima, sin solaparlo */
            }
            body.sell-cart-bar-visible { padding-bottom: 135px; }
            .notifications-empty {
                padding: 0.75rem 1rem !important;
            }
            
            .stats-card {
                margin-bottom: 15px;
                display: flex;
                flex-direction: column;
                justify-content: flex-start;
                padding: 10px 12px;
            }
            .stats-card h5 {
                font-size: 0.85rem;
                margin-bottom: 2px;
            }
            .stats-card h2 {
                font-size: 1.4rem;
                margin: 2px 0;
            }
            .stats-card small {
                font-size: 0.7rem;
            }
            
            .table-responsive {
                font-size: 12px;
            }
        }
        
        /* Estilos para Google Places Autocomplete Element */
        /* Estilos para el contenedor del autocomplete */
        .places-autocomplete-wrapper {
            width: 100%;
            position: relative;
        }
        
        /* Estilos para el componente PlaceAutocompleteElement */
        .places-autocomplete-wrapper gmp-place-autocomplete {
            width: 100%;
            display: block;
        }
        
        /* Estilos para el input del fallback */
        #mapSearchInput,
        #mapSearchInputFallback {
            width: 100% !important;
            padding: 10px 15px !important;
            border: 1px solid #ced4da !important;
            border-radius: 6px !important;
            font-size: 14px !important;
            background-color: white !important;
            color: #212529 !important;
        }
        
        #mapSearchInput:focus,
        #mapSearchInputFallback:focus {
            border-color: #86b7fe !important;
            outline: 0 !important;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25) !important;
        }
        
        /* Asegurar que el modal-body permita overflow visible para el dropdown */
        #mapModal .modal-body {
            overflow: visible !important;
        }
        
        #mapModal .p-3.border-bottom {
            overflow: visible !important;
            position: relative;
            z-index: 1060;
        }
        
        .places-autocomplete-wrapper input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            background-color: white !important;
            color: #212529 !important;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        
        .places-autocomplete-wrapper input:focus {
            border-color: #86b7fe;
            outline: 0;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
            background-color: white !important;
        }
        
        /* Fallback input styling */
        #mapSearchInputFallback {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            background-color: white !important;
            color: #212529 !important;
        }
        
        /* Botón de detectar ubicación */
        .btn-detect-location {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
        }
        
        .btn-detect-location:hover {
            background-color: #218838;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.4);
        }
        
        .btn-detect-location:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
        }
        
        .btn-detect-location i {
            font-size: 16px;
        }
        /* Ocultar todas las secciones por defecto, se mostrarán con JavaScript */
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
    </style>
    <!-- Script inline para evitar parpadeo al cargar la página -->
    <script>
        // Ejecutar inmediatamente para evitar parpadeo visual
        (function() {
            // Función para extraer la sección desde la ruta real
            function getSectionFromPath() {
                const path = window.location.pathname;
                const validSections = ['dashboard', 'products', 'suppliers', 'purchases', 'sell', 'sales', 'group-purchases', 'credits', 'customers', 'users', 'settings'];
                
                if (path === '/dashboard' || path === '/') {
                    return 'dashboard';
                }
                
                const pathParts = path.split('/').filter(part => part);
                if (pathParts.length >= 2 && pathParts[0] === 'dashboard') {
                    const section = pathParts[1];
                    if (validSections.includes(section)) {
                        return section;
                    }
                }
                
                return 'dashboard';
            }
            
            // Ejecutar cuando el DOM esté listo (pero antes de que se renderice)
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initSection);
            } else {
                initSection();
            }
            
            function initSection() {
                const section = getSectionFromPath();
                
                // Ocultar todas las secciones
                const sections = document.querySelectorAll('.content-section');
                sections.forEach(function(sec) {
                    sec.classList.remove('active');
                });
                
                // Mostrar la sección correcta
                const targetSection = document.getElementById(section);
                if (targetSection) {
                    targetSection.classList.add('active');
                }
                
                // Remover active de todos los enlaces de navegación
                const navLinks = document.querySelectorAll('.sidebar .nav-link, .mobile-bottom-nav .nav-link');
                navLinks.forEach(function(link) {
                    link.classList.remove('active');
                });
                
                // Activar el enlace correspondiente
                const activeLink = document.querySelector(`.sidebar .nav-link[data-section="${section}"], .mobile-bottom-nav .nav-link[data-section="${section}"]`);
                if (activeLink) {
                    activeLink.classList.add('active');
                }
                // Clase en body para mostrar barra del carrito solo en Vender (CSS la oculta en el resto)
                document.body.classList.remove('section-sell');
                if (section === 'sell') document.body.classList.add('section-sell');
                if (typeof updateSellCart === 'function') updateSellCart();
            }
        })();
    </script>
</head>
<body>
    <!-- Sidebar Overlay (for mobile) -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeMobileMenu()"></div>
    
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="text-center mb-3">
            <h4 style="color: white;">
                <i class="bi bi-shop"></i> LOCOBAR
            </h4>
        </div>
        <div class="sidebar-nav-scroll">
            <nav class="nav flex-column">
                <a class="nav-link" href="#" data-section="dashboard">
                    <i class="bi bi-speedometer2"></i> Dashboard
                </a>
                <a class="nav-link" href="#" data-section="products">
                    <i class="bi bi-box"></i> Productos
                </a>
                <a class="nav-link" href="#" data-section="suppliers">
                    <i class="bi bi-truck"></i> Proveedores
                    <span class="badge bg-danger ms-1 d-none" id="supplierDebtsBadge">0</span>
                </a>
                <a class="nav-link" href="#" data-section="purchases">
                    <i class="bi bi-cart-plus"></i> Compras
                </a>
                <a class="nav-link" href="#" data-section="sell">
                    <i class="bi bi-cash"></i> Vender
                </a>
                <a class="nav-link" href="#" data-section="sales">
                    <i class="bi bi-cash-stack"></i> Ventas
                </a>
                <a class="nav-link" href="#" data-section="group-purchases">
                    <i class="bi bi-people"></i> Compras Grupales
                </a>
                <a class="nav-link" href="#" data-section="credits">
                    <i class="bi bi-credit-card"></i> Créditos
                </a>
                <a class="nav-link" href="#" data-section="customers">
                    <i class="bi bi-people-fill"></i> Clientes
                </a>
                <a class="nav-link" href="#" data-section="users">
                    <i class="bi bi-people"></i> Usuarios
                </a>
                <a class="nav-link" href="#" data-section="settings">
                    <i class="bi bi-gear"></i> Configuración
                </a>
            </nav>
        </div>
        <div class="sidebar-logout">
            <a class="nav-link text-danger" href="#" onclick="logout()">
                <i class="bi bi-box-arrow-right"></i> Cerrar Sesión
            </a>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-dark navbar-custom">
        <div class="container-fluid d-flex justify-content-between align-items-center">
            <span class="navbar-text mb-0">
                <i class="bi bi-person-circle"></i> 
                <span id="currentUser">Cargando...</span>
                <small class="ms-2 badge bg-light text-dark" id="currentUserRole"></small>
            </span>
            <div class="dropdown">
                <button class="btn btn-outline-light btn-sm position-relative" type="button" id="notificationsDropdown" data-bs-toggle="dropdown" aria-expanded="false" title="Notificaciones">
                    <i class="bi bi-bell"></i>
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none" id="notificationsBadge">0</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-end notifications-dropdown-menu" id="notificationsList" aria-label="Notificaciones">
                    <li class="dropdown-header notifications-dropdown-header">Notificaciones</li>
                    <li><hr class="dropdown-divider"></li>
                    <li id="notificationsListEmpty" class="notifications-empty px-3 py-2 text-muted small">No hay notificaciones</li>
                    <li id="notificationsListItems"></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Dashboard Section -->
        <div id="dashboard" class="content-section">
            <h2 class="mb-4">
                <i class="bi bi-speedometer2"></i> Dashboard
            </h2>
            
            <!-- Stats cards: en desktop 4 por fila (como antes); en móvil 2 por fila, cuadradas -->
            <div class="row stats-cards-row">
                <div class="col-6 col-md-3">
                    <div class="stats-card">
                        <h5>Productos Totales</h5>
                        <h2 id="totalProducts">0</h2>
                        <small><i class="bi bi-box"></i> Activos en sistema</small>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="stats-card success">
                        <h5>Stock Disponible</h5>
                        <h2 id="totalStock">0</h2>
                        <small><i class="bi bi-check-circle"></i> Unidades totales</small>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="stats-card warning">
                        <h5>Ventas del Mes</h5>
                        <h2 id="monthlySales">$0</h2>
                        <small><i class="bi bi-cash"></i> Facturación actual</small>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="stats-card info">
                        <h5>Combos Activos</h5>
                        <h2 id="totalCombos">0</h2>
                        <small><i class="bi bi-gift"></i> Ofertas virtuales</small>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-graph-up"></i> Ventas Recientes
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover" id="recentSalesTable">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Fecha</th>
                                            <th>Total</th>
                                            <th>Método</th>
                                            <th>Estado</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="5" class="text-center text-muted">
                                                Cargando ventas recientes...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-exclamation-triangle"></i> Productos con Stock Bajo
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="lowStockProducts">
                                <div class="text-center text-muted">
                                    Cargando productos...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Products Section -->
        <div id="products" class="content-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">
                    <i class="bi bi-box"></i> Gestión de Productos
                </h2>
                <button class="btn btn-primary admin-only" id="btnNewProduct" onclick="showCreateProductModal()">
                    <i class="bi bi-plus"></i> Nuevo Producto
                </button>
            </div>

            <!-- Filters -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <label class="form-label">Buscar</label>
                            <input type="text" class="form-control" id="productSearch" placeholder="Nombre o SKU...">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Tipo</label>
                            <select class="form-select" id="productTypeFilter">
                                <option value="">Todos</option>
                                <option value="SIMPLE">Simple</option>
                                <option value="COMBO">Combo</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Categoría</label>
                            <select class="form-select" id="productCategoryFilter">
                                <option value="">Todas</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Presentación</label>
                            <select class="form-select" id="productPresentationFilter">
                                <option value="">Todas</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Estado</label>
                            <select class="form-select" id="productStatusFilter">
                                <option value="">Todos</option>
                                <option value="true">Activo</option>
                                <option value="false">Inactivo</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <button class="btn btn-outline-secondary w-100" onclick="filterProducts()">
                                <i class="bi bi-funnel"></i> Filtrar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Products Table -->
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="productsTable">
                            <thead>
                                <tr>
                                    <th style="width:80px"></th>
                                    <th>Nombre</th>
                                    <th>Categoría</th>
                                    <th>Presentación</th>
                                    <th>Pool</th>
                                    <th>IVA</th>
                                    <th>Precio Venta</th>
                                    <th>Stock</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="10" class="text-center text-muted">
                                        Cargando productos...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Suppliers Section -->
        <div id="suppliers" class="content-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">
                    <i class="bi bi-truck"></i> Proveedores
                </h2>
                <button class="btn btn-primary" onclick="showCreateSupplierModal()">
                    <i class="bi bi-plus-circle"></i> Nuevo Proveedor
                </button>
            </div>

            <!-- Tabs -->
            <ul class="nav nav-tabs mb-3" id="suppliersTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="tab-lista-proveedores" data-bs-toggle="tab" data-bs-target="#tabListaProveedores" type="button" role="tab">
                        <i class="bi bi-list-ul"></i> Lista de Proveedores
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="tab-cuentas-pagar" data-bs-toggle="tab" data-bs-target="#tabCuentasPagar" type="button" role="tab" onclick="loadPendingSupplierPayments()">
                        <i class="bi bi-exclamation-circle"></i> Cuentas por Pagar
                        <span class="badge bg-danger ms-1 d-none" id="pendingPaymentsBadge">0</span>
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="suppliersTabContent">
                <!-- Tab 1: Lista de Proveedores -->
                <div class="tab-pane fade show active" id="tabListaProveedores" role="tabpanel">
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover" id="suppliersTable">
                                    <thead>
                                        <tr>
                                            <th>Código</th>
                                            <th>RUC</th>
                                            <th>Nombre</th>
                                            <th>Contacto</th>
                                            <th>Teléfono</th>
                                            <th>Días Crédito</th>
                                            <th>Estado</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="8" class="text-center text-muted">Cargando proveedores...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab 2: Cuentas por Pagar -->
                <div class="tab-pane fade" id="tabCuentasPagar" role="tabpanel">
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover" id="pendingPaymentsTable">
                                    <thead>
                                        <tr>
                                            <th>Proveedor</th>
                                            <th>Código</th>
                                            <th>N° Factura</th>
                                            <th>Fecha Compra</th>
                                            <th>Vence</th>
                                            <th>Total</th>
                                            <th>Pagado</th>
                                            <th>Saldo</th>
                                            <th>Estado</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="10" class="text-center text-muted">Cargando cuentas pendientes...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Purchases Section -->
        <div id="purchases" class="content-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">
                    <i class="bi bi-cart-plus"></i> Historial de Compras
                </h2>
                <button class="btn btn-success" onclick="showCreatePurchaseModal()">
                    <i class="bi bi-plus"></i> Nueva Compra
                </button>
            </div>

            <!-- Filters -->
            <div class="card mb-3">
                <div class="card-body py-2">
                    <div class="row g-2 align-items-end">
                        <div class="col-md-3">
                            <label class="form-label form-label-sm mb-1">Proveedor</label>
                            <select class="form-select form-select-sm" id="purchaseFilterSupplier">
                                <option value="">Todos los proveedores</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label form-label-sm mb-1">Estado</label>
                            <select class="form-select form-select-sm" id="purchaseFilterStatus">
                                <option value="">Todos</option>
                                <option value="PAID">Pagado</option>
                                <option value="PENDING">Pendiente</option>
                                <option value="PARTIAL">Parcial</option>
                                <option value="OVERDUE">Vencido</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label form-label-sm mb-1">Desde</label>
                            <input type="date" class="form-control form-control-sm" id="purchaseFilterFrom">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label form-label-sm mb-1">Hasta</label>
                            <input type="date" class="form-control form-control-sm" id="purchaseFilterTo">
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary btn-sm w-100" onclick="loadPurchases()">
                                <i class="bi bi-funnel"></i> Filtrar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Purchases Table -->
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="purchasesTable">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Código Prov.</th>
                                    <th>Proveedor</th>
                                    <th>N° Factura</th>
                                    <th>Ítems</th>
                                    <th>Total</th>
                                    <th>Días Créd.</th>
                                    <th>Vence</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="9" class="text-center text-muted">Cargando compras...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sell Section (estilo catálogo del cliente) -->
        <div id="sell" class="content-section">
            <h2 class="mb-4">
                <i class="bi bi-cash"></i> Punto de Venta
            </h2>

            <!-- Burbuja flotante del carrito -->
            <div class="sell-cart-bubble" id="sellCartBubble" onclick="openSellCartModal()">
                <div class="sell-cart-bubble-icon">
                    <i class="bi bi-cart3"></i>
                    <span class="sell-cart-bubble-badge" id="sellCartBubbleBadge">0</span>
                </div>
            </div>

            <!-- Búsqueda y filtro (igual que catálogo cliente) -->
            <div class="mb-4">
                <div class="input-group input-group-lg sell-search-input-wrap mb-2">
                    <input type="text" class="form-control" id="sellProductSearch" placeholder="Buscar productos..." autocomplete="off">
                    <span class="input-group-text"><i class="bi bi-search text-muted"></i></span>
                </div>
                <div class="mt-2 d-flex flex-wrap gap-2 align-items-center">
                    <select class="form-select form-select-sm" id="sellCategoryFilter" aria-label="Filtro de categoría" style="min-width: 160px;">
                        <option value="">Todas las categorías</option>
                    </select>
                    <select class="form-select form-select-sm" id="sellPresentationFilter" aria-label="Filtro de presentación" style="min-width: 160px;">
                        <option value="">Todas las presentaciones</option>
                    </select>
                    <select class="form-select form-select-sm" id="sellTypeFilter" aria-label="Filtro de tipo" style="max-width: 180px;">
                        <option value="">Todos los tipos</option>
                        <option value="SIMPLE">Productos simples</option>
                        <option value="COMBO">Combos</option>
                    </select>
                </div>
            </div>

            <!-- Grid de productos (tarjetas tipo catálogo) -->
            <div class="row g-3" id="sellProductsGrid">
                <div class="col-12 text-center text-muted">
                    <div class="spinner-border" role="status"><span class="visually-hidden">Cargando...</span></div>
                    <p class="mt-2">Cargando productos...</p>
                </div>
            </div>
        </div>

        <!-- Sales Section -->
        <div id="sales" class="content-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">
                    <i class="bi bi-cash-stack"></i> Historial de Ventas
                </h2>
            </div>
            
            <!-- Filters -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Estado</label>
                            <select class="form-select" id="salesStatusFilter">
                                <option value="">Todos</option>
                                <option value="COMPLETED">Completadas</option>
                                <option value="PENDING">Pendientes</option>
                                <option value="VOIDED">Anuladas</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Fecha Desde</label>
                            <input type="date" class="form-control" id="salesStartDateFilter">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Fecha Hasta</label>
                            <input type="date" class="form-control" id="salesEndDateFilter">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <button class="btn btn-primary w-100" onclick="filterSales()">
                                <i class="bi bi-funnel"></i> Filtrar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sales Table -->
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="salesTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Fecha</th>
                                    <th>Cliente</th>
                                    <th>Subtotal</th>
                                    <th>IVA</th>
                                    <th>Total</th>
                                    <th>Método Pago</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="7" class="text-center text-muted">
                                        Cargando ventas...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Group Purchases Section -->
        <div id="group-purchases" class="content-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">
                    <i class="bi bi-people"></i> Compras Grupales
                </h2>
                <button class="btn btn-primary" onclick="showCreateGroupPurchaseModal()">
                    <i class="bi bi-plus"></i> Nueva Compra Grupal
                </button>
            </div>

            <!-- Filters -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Estado</label>
                            <select class="form-select" id="groupPurchaseStatusFilter">
                                <option value="">Todos</option>
                                <option value="PENDING">Pendiente</option>
                                <option value="PARTIAL">Parcial</option>
                                <option value="COMPLETED">Completada</option>
                                <option value="CANCELLED">Cancelada</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Fecha Desde</label>
                            <input type="date" class="form-control" id="groupPurchaseStartDateFilter">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Fecha Hasta</label>
                            <input type="date" class="form-control" id="groupPurchaseEndDateFilter">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <button class="btn btn-primary w-100" onclick="filterGroupPurchases()">
                                <i class="bi bi-funnel"></i> Filtrar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Group Purchases Table -->
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="groupPurchasesTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Producto</th>
                                    <th>Total</th>
                                    <th>Participantes</th>
                                    <th>Estado</th>
                                    <th>Fecha</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="7" class="text-center text-muted">
                                        Cargando compras grupales...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Credits Section -->
        <div id="credits" class="content-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">
                    <i class="bi bi-credit-card"></i> Créditos y Deudas
                </h2>
                <button class="btn btn-info" onclick="calculateAllInterests()">
                    <i class="bi bi-calculator"></i> Calcular Intereses
                </button>
            </div>

            <!-- Credits Table -->
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="creditsTable">
                            <thead>
                                <tr>
                                    <th>Cliente</th>
                                    <th>Monto Inicial</th>
                                    <th>Saldo Actual</th>
                                    <th>Intereses</th>
                                    <th>Fecha Inicio</th>
                                    <th>Días</th>
                                    <th>Fecha Límite</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="9" class="text-center text-muted">
                                        Cargando créditos...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Customers Section -->
        <div id="customers" class="content-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">
                    <i class="bi bi-people-fill"></i> Gestión de Clientes
                </h2>
                <button class="btn btn-primary" onclick="showCreateCustomerModal()">
                    <i class="bi bi-plus"></i> Nuevo Cliente
                </button>
            </div>

            <!-- Filters -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Buscar</label>
                            <input type="text" class="form-control" id="customerSearch" placeholder="Nombre, email o teléfono...">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Estado</label>
                            <select class="form-select" id="customerStatusFilter">
                                <option value="">Todos</option>
                                <option value="true">Activo</option>
                                <option value="false">Inactivo</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <button class="btn btn-outline-secondary w-100" onclick="filterCustomers()">
                                <i class="bi bi-funnel"></i> Filtrar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Customers Table -->
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="customersTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre</th>
                                    <th>Cédula</th>
                                    <th>Email</th>
                                    <th>Teléfono</th>
                                    <th>Dirección</th>
                                    <th>Estado</th>
                                    <th>Fecha Registro</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="9" class="text-center text-muted">
                                        Cargando clientes...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Users Section -->
        <div id="users" class="content-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">
                    <i class="bi bi-people"></i> Gestión de Usuarios
                </h2>
                <button class="btn btn-primary" onclick="showCreateUserModal()">
                    <i class="bi bi-plus"></i> Nuevo Usuario
                </button>
            </div>

            <!-- Users Table -->
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="usersTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre</th>
                                    <th>Email</th>
                                    <th>Rol</th>
                                    <th>Estado</th>
                                    <th>Último Acceso</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="7" class="text-center text-muted">
                                        Cargando usuarios...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Section -->
        <div id="settings" class="content-section">
            <h2 class="mb-4">
                <i class="bi bi-gear"></i> Configuración
            </h2>

            <!-- Settings Tabs -->
            <ul class="nav nav-tabs mb-4" id="settingsTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general-settings" type="button" role="tab">
                        <i class="bi bi-pencil-square"></i> General
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="tax-tab" data-bs-toggle="tab" data-bs-target="#tax-settings" type="button" role="tab">
                        <i class="bi bi-percent"></i> IVA
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="smtp-tab" data-bs-toggle="tab" data-bs-target="#smtp-settings" type="button" role="tab">
                        <i class="bi bi-envelope"></i> SMTP / Correo
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="backup-tab" data-bs-toggle="tab" data-bs-target="#backup-settings" type="button" role="tab">
                        <i class="bi bi-database"></i> Respaldo
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="settingsTabContent">
                <!-- General Settings Tab -->
                <div class="tab-pane fade show active" id="general-settings" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-pencil-square"></i> Texto y marca
                            </h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted">Este texto se muestra en la pantalla de login bajo el nombre LOCOBAR y en el título del navegador del dashboard.</p>
                            <form id="generalSettingsForm">
                                <div class="mb-3">
                                    <label class="form-label">Frase / eslogan (login y correos)</label>
                                    <input type="text" class="form-control" id="brandSlogan" 
                                           placeholder="Donde el sabor se vuelve locura" maxlength="200">
                                    <small class="form-text text-muted">Ejemplo: Donde el sabor se vuelve locura. Se usa en login, asunto de correos y cabeceras de los emails.</small>
                                </div>
                                <hr class="my-4">
                                <h6 class="mb-3"><i class="bi bi-window"></i> Títulos de la pestaña del navegador</h6>
                                <p class="text-muted small">Texto que aparece en la pestaña del navegador en cada página o formulario.</p>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Dashboard (panel admin)</label>
                                            <input type="text" class="form-control" id="pageTitleDashboard" 
                                                   placeholder="Donde el sabor se vuelve locura - Dashboard" maxlength="150">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Login (iniciar sesión)</label>
                                            <input type="text" class="form-control" id="pageTitleLogin" 
                                                   placeholder="Iniciar Sesión - LOCOBAR" maxlength="150">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Registro (cliente)</label>
                                            <input type="text" class="form-control" id="pageTitleRegister" 
                                                   placeholder="Registro - LOCOBAR" maxlength="150">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Catálogo</label>
                                            <input type="text" class="form-control" id="pageTitleCatalog" 
                                                   placeholder="Catálogo - LOCOBAR" maxlength="150">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Carrito</label>
                                            <input type="text" class="form-control" id="pageTitleCart" 
                                                   placeholder="Carrito - LOCOBAR" maxlength="150">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Checkout</label>
                                            <input type="text" class="form-control" id="pageTitleCheckout" 
                                                   placeholder="Checkout - LOCOBAR" maxlength="150">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Mis Créditos</label>
                                            <input type="text" class="form-control" id="pageTitleCredits" 
                                                   placeholder="Mis Créditos - LOCOBAR" maxlength="150">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Compras grupales</label>
                                            <input type="text" class="form-control" id="pageTitleGroupPurchases" 
                                                   placeholder="Mis Compras Grupales - LOCOBAR" maxlength="150">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Mis Pedidos</label>
                                            <input type="text" class="form-control" id="pageTitleOrders" 
                                                   placeholder="Mis Pedidos - LOCOBAR" maxlength="150">
                                        </div>
                                    </div>
                                </div>
                                <hr class="my-4">
                                <h6 class="mb-3"><i class="bi bi-envelope-at"></i> Asuntos de correo</h6>
                                <p class="text-muted small">Texto que aparece como asunto en cada tipo de correo enviado por el sistema.</p>
                                <div class="mb-3">
                                    <label class="form-label">Código de verificación (registro)</label>
                                    <input type="text" class="form-control" id="emailSubjectVerificationCode" 
                                           placeholder="Código de Verificación" maxlength="150">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Bienvenida (nuevo cliente)</label>
                                    <input type="text" class="form-control" id="emailSubjectWelcome" 
                                           placeholder="Bienvenido" maxlength="150">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Código recuperación de contraseña</label>
                                    <input type="text" class="form-control" id="emailSubjectPasswordReset" 
                                           placeholder="Código de Recuperación de Contraseña" maxlength="150">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Clave temporal (cambio de contraseña)</label>
                                    <input type="text" class="form-control" id="emailSubjectTemporaryPassword" 
                                           placeholder="Clave Temporal" maxlength="150">
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-save"></i> Guardar
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- IVA Settings Tab -->
                <div class="tab-pane fade" id="tax-settings" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-percent"></i> Configuración de IVA
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> 
                                <strong>Importante:</strong> El cambio del IVA solo afectará a las nuevas ventas. 
                                Las ventas históricas mantendrán el IVA que se usó en el momento de la venta.
                            </div>
                            <form id="taxSettingsForm">
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="taxEnabled" checked>
                                    <label class="form-check-label fw-bold" for="taxEnabled">
                                        Activar IVA en el sistema
                                    </label>
                                    <small class="form-text text-muted d-block">
                                        Si está desactivado, no se calculará ni mostrará IVA en ventas ni en el catálogo del cliente.
                                    </small>
                                </div>
                                <div class="row" id="taxRateSection">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Porcentaje de IVA (%)</label>
                                            <input type="number" class="form-control" id="taxRate"
                                                   step="0.01" min="0" max="100" placeholder="Ej: 12">
                                            <small class="form-text text-muted">
                                                El IVA se aplica en carrito, checkout, ventas y POS según esta configuración.
                                            </small>
                                        </div>
                                    </div>
                                </div>
                                <hr>
                                <h6 class="fw-bold mb-3"><i class="bi bi-tag"></i> Descuento por Efectivo / Transferencia</h6>
                                <p class="text-muted small mb-3">
                                    Los precios del sistema incluyen el recargo de tarjeta. Al pagar en efectivo o transferencia
                                    se aplica este descuento automáticamente sobre el total (subtotal + IVA).
                                </p>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Porcentaje de descuento (%)</label>
                                            <input type="number" class="form-control" id="discountRate"
                                                   step="0.01" min="0" max="100" placeholder="Ej: 5.75">
                                            <small class="form-text text-muted">
                                                Pon 0 para deshabilitar el descuento.
                                            </small>
                                        </div>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-save"></i> Guardar Configuración de IVA y Descuento
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- SMTP Settings Tab -->
                <div class="tab-pane fade" id="smtp-settings" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-envelope"></i> Configuración SMTP
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle"></i> 
                                <strong>Seguridad:</strong> Las credenciales se guardan de forma encriptada.
                            </div>
                            <form id="smtpSettingsForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Servidor SMTP (Host)</label>
                                            <input type="text" class="form-control" id="smtpHost" 
                                                   placeholder="smtp.gmail.com" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Puerto</label>
                                            <input type="number" class="form-control" id="smtpPort" 
                                                   placeholder="587" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Usuario / Email</label>
                                            <input type="email" class="form-control" id="smtpUser" 
                                                   placeholder="tu-email@gmail.com" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Contraseña</label>
                                            <input type="password" class="form-control" id="smtpPassword" 
                                                   placeholder="Tu contraseña de aplicación" required autocomplete="off">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Email Remitente</label>
                                            <input type="email" class="form-control" id="smtpFromEmail" 
                                                   placeholder="noreply@licoreria.com">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Nombre Remitente</label>
                                            <input type="text" class="form-control" id="smtpFromName" 
                                                   placeholder="Sistema de Licorería">
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="smtpSecure">
                                        <label class="form-check-label" for="smtpSecure">
                                            Usar SSL/TLS (Secure)
                                        </label>
                                    </div>
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-save"></i> Guardar Configuración SMTP
                                    </button>
                                    <button type="button" class="btn btn-info" onclick="testSMTPConnection()">
                                        <i class="bi bi-check-circle"></i> Probar Conexión
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Respaldo -->
                <div class="tab-pane fade" id="backup-settings" role="tabpanel">
                    <div class="row g-4">

                        <!-- Descargar backup -->
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="bi bi-download"></i> Generar Backup</h5>
                                </div>
                                <div class="card-body d-flex flex-column">
                                    <p class="text-muted">Descarga un archivo <code>.sql</code> con toda la base de datos. Guárdalo en un lugar seguro.</p>
                                    <ul class="text-muted small mb-4">
                                        <li>Incluye todas las tablas, datos y configuraciones</li>
                                        <li>El archivo generado es compatible para restaurar</li>
                                        <li>Nombre: <code>licoreria_backup_YYYY-MM-DD.sql</code></li>
                                    </ul>
                                    <div class="mt-auto">
                                        <button class="btn btn-primary w-100" onclick="downloadBackup()" id="btnDownloadBackup">
                                            <i class="bi bi-cloud-download"></i> Descargar Backup
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Restaurar backup -->
                        <div class="col-md-6">
                            <div class="card h-100 border-warning">
                                <div class="card-header bg-warning bg-opacity-10">
                                    <h5 class="mb-0"><i class="bi bi-upload text-warning"></i> Restaurar Backup</h5>
                                </div>
                                <div class="card-body d-flex flex-column">
                                    <div class="alert alert-warning py-2 small">
                                        <i class="bi bi-exclamation-triangle-fill"></i>
                                        <strong>Atención:</strong> Esto borrará y reemplazará <strong>todos los datos actuales</strong> con los del archivo. Esta acción no se puede deshacer.
                                    </div>
                                    <p class="text-muted small">Solo se aceptan archivos <code>.sql</code> generados por esta misma aplicación.</p>
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">Archivo de backup (.sql)</label>
                                        <input type="file" class="form-control" id="backupFileInput" accept=".sql">
                                        <div class="form-text" id="backupFileName">Ningún archivo seleccionado</div>
                                    </div>
                                    <div class="mt-auto">
                                        <button class="btn btn-warning w-100" onclick="confirmRestore()" id="btnRestoreBackup" disabled>
                                            <i class="bi bi-arrow-counterclockwise"></i> Restaurar Base de Datos
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div class="modal fade" id="productModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalTitle">Nuevo Producto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="productForm">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Nombre del Producto</label>
                                <input type="text" class="form-control" id="productName" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">SKU</label>
                                <input type="text" class="form-control" id="productSku" required>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-md-4">
                                <label class="form-label">Tipo de Producto</label>
                                <select class="form-select" id="productType" required>
                                    <option value="SIMPLE">Producto Simple</option>
                                    <option value="COMBO">Combo Virtual</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Categoría</label>
                                <div class="input-group">
                                    <select class="form-select" id="productCategory">
                                        <option value="">Sin categoría</option>
                                    </select>
                                    <button class="btn btn-outline-secondary" type="button" onclick="showCategoryModal()" title="Gestionar categorías">
                                        <i class="bi bi-gear"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Estado</label>
                                <select class="form-select" id="productStatus">
                                    <option value="true">Activo</option>
                                    <option value="false">Inactivo</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mt-3" id="presentationRow">
                            <div class="col-md-4">
                                <label class="form-label">Presentación</label>
                                <div class="input-group">
                                    <select class="form-select" id="productPresentation">
                                        <option value="">Sin presentación</option>
                                    </select>
                                    <button class="btn btn-outline-secondary" type="button" onclick="showPresentationModal()" title="Gestionar presentaciones">
                                        <i class="bi bi-gear"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Producto Base (Pool)</label>
                                <select class="form-select" id="productBaseProduct">
                                    <option value="">Ninguno (es producto base)</option>
                                </select>
                                <small class="form-text text-muted">Si comparte stock con otro producto base</small>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Unidades por Venta</label>
                                <input type="number" class="form-control" id="productUnitsPerSale" value="1" min="0.001" step="any">
                                <small class="form-text text-muted">Unidades base que consume cada venta</small>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-4">
                                <label class="form-label">Stock Mínimo</label>
                                <input type="number" class="form-control" id="productStockMin" step="0.001" min="0">
                            </div>
                            <div class="col-md-4 d-flex align-items-center pt-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="productTaxApplies" checked>
                                    <label class="form-check-label" for="productTaxApplies">
                                        <i class="bi bi-percent"></i> Aplica IVA
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <div class="col-md-4">
                                <label class="form-label">Precio de Venta</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="productSalePrice" step="0.01" min="0" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Costo Unitario (opcional)</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="productPurchasePrice" step="0.01" min="0">
                                </div>
                            </div>
                            <div class="col-md-4" id="initialStockSection">
                                <label class="form-label">Stock Inicial</label>
                                <input type="number" class="form-control" id="productInitialStock" step="0.001" min="0" value="0">
                                <small class="form-text text-muted">Solo al crear producto nuevo</small>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <div class="col-md-12">
                                <label class="form-label">Imagen del Producto</label>
                                <input type="file" class="form-control" id="productImage" accept="image/*">
                                <input type="hidden" id="productImageUrl">
                                <div id="imagePreview" class="mt-2"></div>
                            </div>
                        </div>

                        <!-- Combo Components Section -->
                        <div id="comboComponentsSection" style="display: none;">
                            <hr>
                            <h5>Componentes del Combo</h5>
                            <div class="mb-3">
                                <label class="form-label">Agregar Componente</label>
                                <select class="form-select" id="componentSelect">
                                    <option value="">Seleccione un producto...</option>
                                </select>
                                <button type="button" class="btn btn-outline-primary ms-2" onclick="addComponent()">
                                    <i class="bi bi-plus"></i> Agregar
                                </button>
                            </div>
                            <div id="componentsList"></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="saveProduct()">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Category Management Modal -->
    <div class="modal fade" id="categoryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Gestionar Categorías</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="newCategoryName" placeholder="Nueva categoría...">
                        <input type="number" class="form-control" id="newCategorySortOrder" placeholder="Orden" style="max-width:80px" value="0" min="0">
                        <button class="btn btn-primary" onclick="saveCategory()"><i class="bi bi-plus"></i> Agregar</button>
                    </div>
                    <input type="hidden" id="editingCategoryId">
                    <div id="categoriesList">
                        <div class="text-center text-muted py-3">Cargando...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Presentation Management Modal -->
    <div class="modal fade" id="presentationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-box-seam me-2"></i>Gestionar Presentaciones</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info py-2 small mb-3">
                        <i class="bi bi-info-circle me-1"></i>
                        Las presentaciones definen cómo se vende un producto: individual, six pack, caja, etc. Cada una indica cuántas unidades base se descuentan del inventario por cada venta.
                    </div>
                    <div class="row g-2 mb-3">
                        <div class="col-12 col-sm-5">
                            <label class="form-label small fw-bold mb-1">
                                Nombre
                                <span class="text-muted fw-normal" data-bs-toggle="tooltip" data-bs-placement="top" title="Nombre de la presentación, ej: Individual, Six Pack, Caja, Cajetilla"><i class="bi bi-question-circle ms-1"></i></span>
                            </label>
                            <input type="text" class="form-control form-control-sm" id="newPresentationName" placeholder="Ej: Six Pack">
                        </div>
                        <div class="col-6 col-sm-4">
                            <label class="form-label small fw-bold mb-1">
                                Unidades
                                <span class="text-muted fw-normal" data-bs-toggle="tooltip" data-bs-placement="top" title="Cantidad de unidades individuales que contiene esta presentación. Ej: Six Pack = 6, Caja = 24, Individual = 1"><i class="bi bi-question-circle ms-1"></i></span>
                            </label>
                            <input type="number" class="form-control form-control-sm" id="newPresentationUnits" value="1" min="0.001" step="any" placeholder="Ej: 6">
                        </div>
                        <div class="col-6 col-sm-3">
                            <label class="form-label small fw-bold mb-1">
                                Orden
                                <span class="text-muted fw-normal" data-bs-toggle="tooltip" data-bs-placement="top" title="Orden en que aparece en los selectores. Menor número = aparece primero."><i class="bi bi-question-circle ms-1"></i></span>
                            </label>
                            <input type="number" class="form-control form-control-sm" id="newPresentationSortOrder" value="0" min="0" placeholder="0">
                        </div>
                        <div class="col-12 mt-2">
                            <button class="btn btn-primary btn-sm w-100" onclick="savePresentation()"><i class="bi bi-plus-lg me-1"></i> Agregar Presentación</button>
                        </div>
                    </div>
                    <input type="hidden" id="editingPresentationId">
                    <hr class="my-2">
                    <div id="presentationsList">
                        <div class="text-center text-muted py-3">Cargando...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Stock Modal -->
    <div class="modal fade" id="addStockModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Agregar Stock</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addStockForm">
                        <input type="hidden" id="addStockProductId">
                        <div class="mb-3">
                            <label class="form-label">Producto</label>
                            <input type="text" class="form-control" id="addStockProductName" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Stock Actual</label>
                            <input type="text" class="form-control" id="addStockCurrentStock" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Cantidad a Agregar <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="addStockQuantity" step="0.001" min="0.001" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Costo Unitario (opcional)</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="addStockUnitCost" step="0.01" min="0">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="saveAddStock()">Agregar Stock</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Purchase Modal -->
    <div class="modal fade" id="purchaseModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nueva Compra</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="purchaseForm">
                        <div class="row">
                            <div class="col-md-4">
                                <label class="form-label">Proveedor</label>
                                <select class="form-select" id="purchaseSupplierId" onchange="onPurchaseSupplierChange()">
                                    <option value="">Sin proveedor / otro</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Fecha de Compra</label>
                                <input type="date" class="form-control" id="purchaseDate" required>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">N° Factura</label>
                                <input type="text" class="form-control" id="purchaseInvoice">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Días Crédito</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="purchaseCreditDays" min="0" value="0">
                                    <span class="input-group-text">d</span>
                                </div>
                            </div>
                        </div>

                        <hr>
                        <h5>Productos de la Compra</h5>
                        <div class="mb-3">
                            <button type="button" class="btn btn-success" onclick="addPurchaseItem()">
                                <i class="bi bi-plus"></i> Agregar Producto
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="table" id="purchaseItemsTable">
                                <thead>
                                    <tr>
                                        <th>Producto</th>
                                        <th>Cantidad</th>
                                        <th>Precio Compra Unitario</th>
                                        <th>Precio Venta Sugerido</th>
                                        <th>Subtotal</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="6" class="text-center text-muted">
                                            Haga clic en "Agregar Producto" para añadir items
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label class="form-label">Notas</label>
                                <textarea class="form-control" id="purchaseNotes" rows="3"></textarea>
                            </div>
                            <div class="col-md-6">
                                <h5>Total de la Compra:</h5>
                                <h3 id="purchaseTotal">$0.00</h3>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="savePurchase()">Guardar Compra</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Purchase Item Selection Modal -->
    <div class="modal fade" id="purchaseItemModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Agregar Producto a Compra</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="purchaseItemForm">
                        <div class="mb-3">
                            <label class="form-label">Producto <span class="text-danger">*</span></label>
                            <select class="form-select" id="purchaseItemProduct" required>
                                <option value="">Seleccione un producto...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Cantidad <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="purchaseItemQuantity" step="0.001" min="0.001" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Costo Unitario <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="purchaseItemUnitCost" step="0.01" min="0" required>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="confirmAddPurchaseItem()">Agregar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Purchase Detail Modal -->
    <div class="modal fade" id="purchaseDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalle de Compra</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Info general -->
                    <div class="row g-2 mb-3" id="purchaseDetailInfo"></div>
                    <!-- Tabla de ítems -->
                    <h6 class="fw-semibold mb-2">Productos comprados</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Producto</th>
                                    <th class="text-center">Cantidad</th>
                                    <th class="text-end">Costo Unit.</th>
                                    <th class="text-end">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody id="purchaseDetailItems"></tbody>
                            <tfoot>
                                <tr class="fw-bold">
                                    <td colspan="3" class="text-end">Total</td>
                                    <td class="text-end" id="purchaseDetailTotal"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- User Modal -->
    <div class="modal fade" id="userModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userModalTitle">Nuevo Usuario</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="userForm">
                        <div class="mb-3">
                            <label class="form-label">Nombre Completo <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="userName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="userEmail" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Contraseña <span class="text-danger" id="userPasswordRequired">*</span></label>
                            <input type="password" class="form-control" id="userPassword" minlength="6" autocomplete="new-password">
                            <small class="form-text text-muted">Mínimo 6 caracteres. Solo requerida al crear.</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Rol</label>
                            <select class="form-select" id="userRole">
                                <option value="CASHIER">Empleado</option>
                                <option value="ADMIN">Administrador</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Estado</label>
                            <select class="form-select" id="userStatus">
                                <option value="true">Activo</option>
                                <option value="false">Inactivo</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="saveUser()">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Group Purchase Modal -->
    <div class="modal fade" id="groupPurchaseModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nueva Compra Grupal</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="groupPurchaseForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Producto <span class="text-danger">*</span></label>
                                <select class="form-select" id="groupPurchaseProduct" required>
                                    <option value="">Seleccione un producto...</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Cantidad <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="groupPurchaseQuantity" step="0.001" min="0.001" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Total</label>
                                <input type="text" class="form-control" id="groupPurchaseTotal" readonly value="$0.00">
                            </div>
                        </div>
                        
                        <hr>
                        <h5>Participantes</h5>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Cliente</label>
                                <select class="form-select" id="groupPurchaseParticipantCustomer">
                                    <option value="">Seleccione un cliente...</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Monto a Pagar</label>
                                <input type="number" class="form-control" id="groupPurchaseParticipantAmount" step="0.01" min="0">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Fecha Límite</label>
                                <input type="date" class="form-control" id="groupPurchaseParticipantDueDate">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Interés Diario (%)</label>
                                <input type="number" class="form-control" id="groupPurchaseParticipantInterestRate" step="0.0001" min="0" value="0">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">&nbsp;</label>
                                <button type="button" class="btn btn-success w-100" onclick="addGroupPurchaseParticipant()">
                                    <i class="bi bi-plus"></i> Agregar
                                </button>
                            </div>
                        </div>
                        <div id="groupPurchaseParticipantsList"></div>
                        
                        <div class="mb-3 mt-3">
                            <label class="form-label">Notas</label>
                            <textarea class="form-control" id="groupPurchaseNotes" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="saveGroupPurchase()">Crear Compra Grupal</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Group Purchase Details Modal -->
    <div class="modal fade" id="groupPurchaseDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalles de Compra Grupal #<span id="groupPurchaseDetailsId"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Producto:</strong> <span id="groupPurchaseDetailsProduct"></span>
                        </div>
                        <div class="col-md-6">
                            <strong>Total:</strong> <span id="groupPurchaseDetailsTotal"></span>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Fecha:</strong> <span id="groupPurchaseDetailsDate"></span>
                        </div>
                        <div class="col-md-6">
                            <strong>Estado:</strong> <span id="groupPurchaseDetailsStatus"></span>
                        </div>
                    </div>
                    <hr>
                    <h6>Participantes:</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Cliente</th>
                                    <th>Monto a Pagar</th>
                                    <th>Pagado</th>
                                    <th>Pendiente</th>
                                    <th>Intereses</th>
                                    <th>Vence</th>
                                    <th>Estado</th>
                                    <th>Acción</th>
                                </tr>
                            </thead>
                            <tbody id="groupPurchaseDetailsParticipants">
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Participant Payment Modal -->
    <div class="modal fade" id="participantPaymentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Registrar Pago</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="participantPaymentForm">
                        <input type="hidden" id="participantPaymentParticipantId">
                        <div class="mb-3">
                            <label class="form-label">Monto <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="participantPaymentAmount" step="0.01" min="0.01" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Método de Pago <span class="text-danger">*</span></label>
                            <select class="form-select" id="participantPaymentMethod" required>
                                <option value="CASH">Efectivo</option>
                                <option value="CARD">Tarjeta</option>
                                <option value="TRANSFER">Transferencia</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Fecha de Pago <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="participantPaymentDate" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Notas</label>
                            <textarea class="form-control" id="participantPaymentNotes" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="saveParticipantPayment()">Registrar Pago</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Credit Payment Modal -->
    <div class="modal fade" id="creditPaymentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Registrar Pago de Crédito</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="creditPaymentForm">
                        <input type="hidden" id="creditPaymentCreditId">
                        <div class="mb-3">
                            <label class="form-label">Saldo Actual</label>
                            <input type="text" class="form-control" id="creditPaymentBalance" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Monto a Pagar <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="creditPaymentAmount" step="0.01" min="0.01" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Método de Pago <span class="text-danger">*</span></label>
                            <select class="form-select" id="creditPaymentMethod" required>
                                <option value="CASH">Efectivo</option>
                                <option value="CARD">Tarjeta</option>
                                <option value="TRANSFER">Transferencia</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Fecha de Pago <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="creditPaymentDate" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Notas</label>
                            <textarea class="form-control" id="creditPaymentNotes" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="saveCreditPayment()">Registrar Pago</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Customer Modal -->
    <div class="modal fade" id="customerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="customerModalTitle">Nuevo Cliente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="customerForm">
                        <div class="mb-3">
                            <label class="form-label">Nombre Completo <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="customerName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Número de Cédula <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="customerCedula" required pattern="[A-Za-z0-9-]+" 
                                   placeholder="Ej: 1234567890" maxlength="50">
                            <small class="form-text text-muted">Solo letras, números y guiones. Debe ser único.</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="customerEmail">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Teléfono</label>
                            <input type="tel" class="form-control" id="customerPhone">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Dirección</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="customerAddress" readonly placeholder="Seleccione ubicación en el mapa">
                                <button type="button" class="btn btn-outline-primary" onclick="openMapModal()">
                                    <i class="bi bi-geo-alt-fill"></i> Mapa
                                </button>
                            </div>
                            <input type="hidden" id="customerLatitude">
                            <input type="hidden" id="customerLongitude">
                            <small class="form-text text-muted">Haz clic en "Mapa" para seleccionar la ubicación.</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Contraseña <span class="text-danger" id="passwordRequired">*</span></label>
                            <input type="password" class="form-control" id="customerPassword" minlength="6" autocomplete="new-password">
                            <small class="form-text text-muted">Mínimo 6 caracteres. Solo requerida al crear.</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Estado</label>
                            <select class="form-select" id="customerStatus">
                                <option value="true">Activo</option>
                                <option value="false">Inactivo</option>
                            </select>
                        </div>
                        <!-- Verificación automática: se enviará código si hay email -->
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="saveCustomer()">
                        <i class="bi bi-arrow-right"></i> Siguiente
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Selección de Ubicación en Mapa (Google Maps) -->
    <div class="modal fade" id="mapModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="modal-title mb-0"><i class="bi bi-geo-alt-fill"></i> Seleccionar Ubicación</h5>
                    <div class="d-flex align-items-center gap-2 flex-wrap">
                        <button type="button" class="btn-detect-location" onclick="GoogleMapsHelper.getCurrentLocation()" title="Detectar mi ubicación">
                            <i class="bi bi-geo-alt"></i> Detectar mi ubicación
                        </button>
                        <small class="text-white-50" style="font-size: 0.7rem;">En HTTP (sin certificado) el navegador puede bloquear la ubicación.</small>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                </div>
                <div class="modal-body p-0">
                    <!-- Buscador de direcciones con Google Places Autocomplete -->
                    <div class="p-3 border-bottom">
                        <div id="placesAutocompleteContainer" class="places-autocomplete-wrapper">
                            <!-- El PlaceAutocompleteElement se insertará aquí -->
                        </div>
                        <small class="text-muted">Escribe para buscar (ej: "Locobar") o haz clic en el mapa.</small>
                    </div>
                    <!-- Contenedor del mapa Google Maps -->
                    <div id="googleMap" style="height: 400px; width: 100%;"></div>
                    <!-- Info de ubicación seleccionada -->
                    <div class="p-3 border-top bg-light">
                        <div class="row">
                            <div class="col-12">
                                <label class="form-label fw-bold"><i class="bi bi-pin-map"></i> Dirección seleccionada:</label>
                                <input type="text" class="form-control" id="selectedAddress" readonly 
                                       placeholder="Haz clic en el mapa o busca una dirección">
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-6">
                                <label class="form-label small text-muted">Latitud:</label>
                                <input type="text" class="form-control form-control-sm" id="selectedLatitude" readonly>
                            </div>
                            <div class="col-6">
                                <label class="form-label small text-muted">Longitud:</label>
                                <input type="text" class="form-control form-control-sm" id="selectedLongitude" readonly>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </button>
                    <button type="button" class="btn btn-success" onclick="confirmMapLocation()">
                        <i class="bi bi-check-circle"></i> Confirmar Ubicación
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Verificación de Código -->
    <div class="modal fade" id="verificationCodeModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-shield-check"></i> Verificar Código</h5>
                </div>
                <div class="modal-body text-center">
                    <div class="mb-3">
                        <i class="bi bi-envelope-check text-primary" style="font-size: 48px;"></i>
                    </div>
                    <p>Se ha enviado un código de verificación a:</p>
                    <p class="fw-bold text-primary" id="verificationEmail"></p>
                    <p class="text-muted small">Revisa tu bandeja de entrada (y carpeta de spam)</p>
                    <div class="mb-3">
                        <label class="form-label">Ingresa el código de 6 dígitos:</label>
                        <input type="text" class="form-control form-control-lg text-center" id="verificationCodeInput" 
                               maxlength="6" pattern="[0-9]{6}" placeholder="000000" style="font-size: 24px; letter-spacing: 8px;">
                    </div>
                    <div id="verificationError" class="text-danger mb-2" style="display: none;">
                        <i class="bi bi-exclamation-circle"></i> Código incorrecto. Intenta de nuevo.
                    </div>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-secondary" onclick="cancelVerification()">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </button>
                    <button type="button" class="btn btn-primary" onclick="verifyCode()">
                        <i class="bi bi-check-circle"></i> Verificar y Crear Cliente
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Supplier Modal -->
    <div class="modal fade" id="supplierModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="supplierModalTitle">Nuevo Proveedor</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="supplierForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">RUC</label>
                                <input type="text" class="form-control" id="supplierRuc" placeholder="Ej: 1791234567001" oninput="updateSupplierCode()">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Código del Proveedor</label>
                                <input type="text" class="form-control" id="supplierCode" readonly placeholder="Se genera automáticamente" style="background:#f8f9fa">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Nombre del Proveedor <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="supplierName" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Nombre de Contacto</label>
                                <input type="text" class="form-control" id="supplierContactName">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Días de Crédito</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="supplierCreditDays" min="0" value="0" placeholder="0">
                                    <span class="input-group-text">días</span>
                                </div>
                                <small class="form-text text-muted">0 = sin crédito</small>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" id="supplierEmail">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Teléfono</label>
                                <input type="tel" class="form-control" id="supplierPhone">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Dirección</label>
                            <input type="text" class="form-control" id="supplierAddress">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Notas</label>
                            <textarea class="form-control" id="supplierNotes" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Estado</label>
                            <select class="form-select" id="supplierStatus">
                                <option value="true">Activo</option>
                                <option value="false">Inactivo</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="saveSupplier()">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Supplier Payment Modal -->
    <div class="modal fade" id="supplierPayModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Registrar Pago a Proveedor</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info py-2" id="supplierPayInfo"></div>
                    <form id="supplierPayForm">
                        <div class="mb-3">
                            <label class="form-label">Monto a Pagar <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="supplierPayAmount" step="0.01" min="0.01" required>
                            </div>
                            <small class="form-text text-muted" id="supplierPayBalance"></small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Fecha de Pago <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="supplierPayDate" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Método de Pago</label>
                            <select class="form-select" id="supplierPayMethod">
                                <option value="CASH">Efectivo</option>
                                <option value="TRANSFER">Transferencia</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Notas</label>
                            <textarea class="form-control" id="supplierPayNotes" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="saveSupplierPayment()">Registrar Pago</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Bottom Navigation -->
    <nav class="mobile-bottom-nav">
        <ul class="nav">
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="toggleMobileMenu(); return false;" title="Menú">
                    <i class="bi bi-list"></i>
                    <span>Menú</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-section="products" onclick="handleMobileNav(this); return false;" title="Productos">
                    <i class="bi bi-box"></i>
                    <span>Productos</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-section="sell" onclick="handleMobileNav(this); return false;" title="Vender">
                    <i class="bi bi-cash"></i>
                    <span>Vender</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-section="customers" onclick="handleMobileNav(this); return false;" title="Clientes">
                    <i class="bi bi-people-fill"></i>
                    <span>Clientes</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-section="sales" onclick="handleMobileNav(this); return false;" title="Ventas">
                    <i class="bi bi-cash-stack"></i>
                    <span>Ventas</span>
                </a>
            </li>
        </ul>
    </nav>

    <!-- Barra inferior carrito Punto de Venta (como catálogo cliente) -->
    <div id="sellCartBottomBar" aria-hidden="true">
        <div class="sell-cart-bar-left">
            <span class="sell-cart-bar-items" id="sellCartBarItems">0 items</span>
            <span class="sell-cart-bar-total" id="sellCartBarTotal">Total: $0.00</span>
        </div>
        <button type="button" class="btn-ver-carrito-sell" id="sellCartBarBtn" onclick="openSellCartModal()">
            <i class="bi bi-cart3"></i> Ver mi carrito
        </button>
    </div>

    <!-- Scripts -->
    <script src="/libs/js/jquery.min.js"></script>
    <script src="/libs/js/bootstrap.bundle.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/libs/js/google-maps-helper.js"></script>
    <script>
        // Global variables
        let currentEditingProduct = null;
        let currentEditingCustomer = null;
        let currentEditingUser = null;
        let purchaseItems = [];
        let comboComponents = [];
        let groupPurchaseParticipants = [];
        let currentTaxRate = null;
        let taxEnabled = true;
        var currentUserRole = null;

        // ============================================
        // FIX: Bootstrap Modal aria-hidden warning
        // Solución para "Blocked aria-hidden on an element 
        // because its descendant retained focus"
        // ============================================
        window.addEventListener('hide.bs.modal', function(event) {
            // Quitar el foco del elemento activo antes de ocultar el modal
            if (document.activeElement) {
                document.activeElement.blur();
            }
        });

        // ============================================
        // FUNCIONES DE GOOGLE MAPS CON GEOLOCALIZACIÓN
        // Usando GoogleMapsHelper compartido
        // ============================================
        
        // Configurar Google Maps Helper para el dashboard
        $(document).ready(function() {
            // Configurar el helper con los campos específicos del dashboard
            GoogleMapsHelper.config({
                addressFieldId: '#customerAddress',
                latitudeFieldId: '#customerLatitude',
                longitudeFieldId: '#customerLongitude',
                mapId: 'LICORERIA_MAP_ID',
                defaultLocation: { lat: -0.1807, lng: -78.4678 }, // Quito, Ecuador
                countryRestriction: 'ec', // Restringir a Ecuador
                onLocationSelected: function(location) {
                    // Callback opcional cuando se confirma la ubicación
                    // Ya se guarda automáticamente en los campos configurados
                }
            });

        });

        // Función para abrir el modal del mapa (llamada desde el botón)
        function openMapModal() {
            GoogleMapsHelper.openMapModal();
        }

        // Función para confirmar ubicación (llamada desde el botón del modal)
        function confirmMapLocation() {
            GoogleMapsHelper.confirmMapLocation();
        }

        // ============================================
        // FIN FUNCIONES DE GOOGLE MAPS
        // ============================================

        // Función para extraer la sección desde la ruta real
        function getSectionFromPath() {
            const path = window.location.pathname;
            const validSections = ['dashboard', 'products', 'suppliers', 'purchases', 'sell', 'sales', 'group-purchases', 'credits', 'customers', 'users', 'settings'];
            
            // Si la ruta es /dashboard o /, retornar 'dashboard'
            if (path === '/dashboard' || path === '/') {
                return 'dashboard';
            }
            
            // Extraer la sección de rutas como /dashboard/products
            const pathParts = path.split('/').filter(part => part);
            if (pathParts.length >= 2 && pathParts[0] === 'dashboard') {
                const section = pathParts[1];
                if (validSections.includes(section)) {
                    return section;
                }
            }
            
            // Fallback a dashboard
            return 'dashboard';
        }

        $(document).ready(function() {
            // Inicializar tooltips de Bootstrap
            document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(function(el) {
                new bootstrap.Tooltip(el);
            });

            initializeNavigation();
            
            // Restaurar sección desde ruta real de URL al cargar la página
            // Nota: El script inline ya estableció el estado correcto, solo verificamos y cargamos datos
            const validSections = ['dashboard', 'products', 'suppliers', 'purchases', 'sell', 'sales', 'group-purchases', 'credits', 'customers', 'users', 'settings'];
            const sectionToShow = getSectionFromPath();
            
            // Verificar que el estado esté correcto (el script inline ya lo hizo, pero por si acaso)
            const currentActive = $('.content-section.active').attr('id');
            if (currentActive !== sectionToShow) {
                // Solo cambiar si realmente es necesario (no debería ser necesario gracias al script inline)
                $('.content-section').removeClass('active');
                $(`#${sectionToShow}`).addClass('active');
                
                // Actualizar navegación activa
                $('.sidebar .nav-link, .mobile-bottom-nav .nav-link').removeClass('active');
                $(`.sidebar .nav-link[data-section="${sectionToShow}"], .mobile-bottom-nav .nav-link[data-section="${sectionToShow}"]`).addClass('active');
            }
            
            // Update mobile nav if on mobile
            if (window.innerWidth <= 768) {
                updateMobileNavActive(sectionToShow);
            }
            
            // Cargar datos de la sección (sin actualizar URL para evitar movimiento)
            switch(sectionToShow) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'products':
                    loadProducts();
                    break;
                case 'suppliers':
                    loadSuppliers();
                    loadPendingSupplierPayments();
                    checkSupplierDebtsAndNotify();
                    break;
                case 'purchases':
                    loadPurchases();
                    loadPurchaseSupplierFilter();
                    break;
                case 'settings':
                    loadSettings();
                    break;
                case 'sell':
                    loadSellProducts();
                    break;
                case 'sales':
                    loadSales();
                    break;
                case 'group-purchases':
                    loadGroupPurchases();
                    break;
                case 'credits':
                    loadCredits();
                    break;
                case 'customers':
                    loadCustomers();
                    break;
                case 'users':
                    loadUsers();
                    break;
            }
            
            // Cargar datos generales (solo una vez al inicio)
            loadTaxRate(); // Load tax rate from settings
            
            // Handle window resize
            $(window).resize(function() {
                if (window.innerWidth > 768) {
                    closeMobileMenu();
                }
            });
            
            // Manejar cambios en la ruta (navegación del navegador hacia atrás/adelante)
            window.addEventListener('popstate', function(event) {
                const section = getSectionFromPath();
                if (validSections.includes(section)) {
                    showSection(section, false); // false para no actualizar URL nuevamente
                }
            });
        });

        // Función para mostrar una sección y actualizar la URL
        function showSection(section, updateURL = true) {
            // Empleado (CASHIER) no puede acceder a Usuarios, Configuración, Compras grupales, Créditos
            if (currentUserRole === 'CASHIER' && ['users', 'settings', 'group-purchases', 'credits'].indexOf(section) !== -1) {
                section = 'dashboard';
                updateURL = true;
            }
            // Verificar si ya estamos en esta sección para evitar cambios innecesarios
            const currentSection = $('.content-section.active').attr('id');
            if (currentSection === section && updateURL) {
                return; // Ya estamos en esta sección, no hacer nada
            }
            
            // Ocultar todas las secciones y mostrar la seleccionada en una sola operación
            $('.content-section').removeClass('active');
            $(`#${section}`).addClass('active');
            
            // Actualizar la URL con ruta real solo si se solicita (evitar al cargar la página)
            if (updateURL) {
                const newPath = section === 'dashboard' ? '/dashboard' : `/dashboard/${section}`;
                const currentPath = window.location.pathname;
                
                if (currentPath !== newPath) {
                    if (history.pushState) {
                        history.pushState(null, null, newPath);
                    } else {
                        window.location.pathname = newPath;
                    }
                }
            }
            
            // Actualizar navegación activa
            $('.sidebar .nav-link, .mobile-bottom-nav .nav-link').removeClass('active');
            $(`.sidebar .nav-link[data-section="${section}"], .mobile-bottom-nav .nav-link[data-section="${section}"]`).addClass('active');
            
            // Update mobile nav if on mobile
            if (window.innerWidth <= 768) {
                updateMobileNavActive(section);
                closeMobileMenu();
            }
            
            // Clase en body: barra del carrito solo visible en Vender (CSS la oculta en Dashboard y demás)
            document.body.classList.remove('section-sell');
            if (section === 'sell') document.body.classList.add('section-sell');
            if (typeof updateSellCart === 'function') updateSellCart();
            
            // Load section-specific data
            switch(section) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'products':
                    loadProducts();
                    break;
                case 'suppliers':
                    loadSuppliers();
                    loadPendingSupplierPayments();
                    checkSupplierDebtsAndNotify();
                    break;
                case 'purchases':
                    loadPurchases();
                    loadPurchaseSupplierFilter();
                    break;
                case 'settings':
                    loadSettings();
                    break;
                case 'sell':
                    loadSellProducts();
                    break;
                case 'sales':
                    loadSales();
                    break;
                case 'group-purchases':
                    loadGroupPurchases();
                    break;
                case 'credits':
                    loadCredits();
                    break;
                case 'customers':
                    loadCustomers();
                    break;
                case 'users':
                    loadUsers();
                    break;
            }
        }

        function initializeNavigation() {
            // Solo aplicar a navegación principal, no a pestañas Bootstrap
            // Los enlaces sin data-section (ej. Menú, Cerrar sesión) solo ejecutan su onclick y no cambian de sección
            $('.sidebar .nav-link, .mobile-bottom-nav .nav-link').click(function(e) {
                e.preventDefault();
                const section = $(this).data('section');
                if (section) {
                    showSection(section);
                }
            });

            // Handle product type change
            $('#productType').change(function() {
                if ($(this).val() === 'COMBO') {
                    $('#comboComponentsSection').show();
                    $('#productPurchasePrice').closest('.col-md-4').hide();
                    $('#productStockMin').closest('.col-md-4').hide();
                    $('#initialStockSection').hide();
                    $('#presentationRow').hide();
                } else {
                    $('#comboComponentsSection').hide();
                    $('#productPurchasePrice').closest('.col-md-4').show();
                    $('#productStockMin').closest('.col-md-4').show();
                    $('#presentationRow').show();
                    if (currentEditingProduct === null) {
                        $('#initialStockSection').show();
                    }
                }
            });

            // Handle product image change
            $('#productImage').change(function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        $('#imagePreview').html(`
                            <img src="${e.target.result}" style="max-width: 100%; max-height: 150px; border-radius: 5px;" alt="Preview">
                        `);
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // Mobile Menu Functions
        function toggleMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('mobile-open');
            overlay.classList.toggle('active');
        }
        
        function closeMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.remove('mobile-open');
            overlay.classList.remove('active');
        }
        
        function handleMobileNav(element) {
            // Close mobile menu if open
            closeMobileMenu();
            
            // Get section from element
            const section = $(element).data('section');
            if (section) {
                // Use showSection for consistent behavior
                showSection(section);
            }
        }
        
        function updateMobileNavActive(section) {
            $('.mobile-bottom-nav .nav-link').removeClass('active');
            const mobileLink = $(`.mobile-bottom-nav .nav-link[data-section="${section}"]`);
            if (mobileLink.length > 0) {
                mobileLink.addClass('active');
            }
        }

        function loadDashboardData() {
            // Load dashboard statistics
            $.ajax({
                url: '/api/products',
                method: 'GET',
                data: { tenantId: 1, isActive: true, limit: 100 },
                success: function(response) {
                    const products = response.products;
                    const simpleProducts = products.filter(p => p.productType === 'SIMPLE');
                    const comboProducts = products.filter(p => p.productType === 'COMBO');
                    
                    $('#totalProducts').text(products.length);
                    $('#totalCombos').text(comboProducts.length);
                    
                    // Calculate total stock from availability
                    const productIds = simpleProducts.map(p => p.id);
                    if (productIds.length > 0) {
                        $.ajax({
                            url: '/api/products/availability/bulk',
                            method: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify({
                                tenantId: 1,
                                productIds: productIds
                            }),
                            success: function(availabilityResponse) {
                                let totalStock = 0;
                                availabilityResponse.products.forEach(av => {
                                    if (av.productType === 'SIMPLE' && av.currentStock) {
                                        totalStock += parseFloat(av.currentStock) || 0;
                                    }
                                });
                                $('#totalStock').text(Math.floor(totalStock));
                            },
                            error: function() {
                                $('#totalStock').text('0');
                            }
                        });
                    } else {
                        $('#totalStock').text('0');
                    }
                }
            });

            // Ventas del mes: suma de ventas COMPLETED del mes actual
            $.ajax({
                url: '/api/sales/stats/monthly-total',
                method: 'GET',
                data: { tenantId: 1 },
                success: function(res) {
                    const total = res.total != null ? parseFloat(res.total) : 0;
                    $('#monthlySales').text('$' + total.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }));
                },
                error: function() {
                    $('#monthlySales').text('$0.00');
                }
            });

            // Load recent sales
            loadRecentSales();
            
            // Load low stock products
            loadLowStockProducts();
        }

        function loadProducts() {
            $.ajax({
                url: '/api/products',
                method: 'GET',
                data: { tenantId: 1, limit: 500 },
                cache: false,
                success: function(response) {
                    const productIds = response.products.map(p => p.id);
                    
                    // Get availability for all products
                    $.ajax({
                        url: '/api/products/availability/bulk',
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({
                            tenantId: 1,
                            productIds: productIds
                        }),
                        success: function(availabilityResponse) {
                            // Merge stock info into products
                            const availabilityMap = {};
                            availabilityResponse.products.forEach(av => {
                                availabilityMap[av.productId] = av;
                            });
                            
                            response.products.forEach(product => {
                                const availability = availabilityMap[product.id];
                                if (availability) {
                                    if (availability.productType === 'SIMPLE') {
                                        product.currentStock = availability.currentStock || 0;
                                    } else {
                                        product.currentStock = availability.availableStock || 0;
                                    }
                                } else {
                                    product.currentStock = 0;
                                }
                            });
                            
                            // Store all products for real-time filtering
                            allProductsList = response.products;
                            displayProducts(response.products);
                        },
                        error: function() {
                            // Fallback: display without stock
                            response.products.forEach(product => {
                                product.currentStock = 0;
                            });
                            // Store all products for real-time filtering
                            allProductsList = response.products;
                            displayProducts(response.products);
                        }
                    });
                },
                error: function() {
                    showAlert('Error al cargar productos', 'danger');
                }
            });
        }

        function displayProducts(products) {
            const tbody = $('#productsTable tbody');
            tbody.empty();

            products.forEach(product => {
                const statusBadge = product.isActive ? 
                    '<span class="badge bg-success">Activo</span>' : 
                    '<span class="badge bg-danger">Inactivo</span>';
                
                const typeBadge = product.productType === 'COMBO' ? 
                    '<span class="badge bg-info">COMBO</span>' : 
                    '<span class="badge bg-secondary">SIMPLE</span>';

                const categoryName = (product.category && product.category.name) ? product.category.name : '<span class="text-muted">—</span>';
                const presentationName = (product.presentation && product.presentation.name) ? product.presentation.name : '<span class="text-muted">—</span>';
                const poolName = (product.baseProduct && product.baseProduct.name) ? '<span class="badge bg-warning text-dark">' + product.baseProduct.name + '</span>' : '<span class="text-muted">—</span>';
                const taxBadge = product.taxApplies !== false ? '<span class="badge bg-success">Sí</span>' : '<span class="badge bg-secondary">No</span>';

                const stockIndicator = product.currentStock > 10 ? 'stock-high' :
                                     product.currentStock > 5 ? 'stock-medium' :
                                     product.currentStock > 0 ? 'stock-low' : 'stock-zero';

                const row = `
                    <tr data-product-id="${product.id}">
                        <td>
                            ${product.imageUrl ?
                                `<img src="${product.imageUrl}" alt="${product.name}"
                                      style="width: 56px; height: 56px; object-fit: cover; border-radius: 6px;
                                             border: 1px solid #dee2e6; cursor: pointer;"
                                      onclick="showProductImageModal('${(product.imageUrl || '').replace(/'/g, "\\'")}', '${(product.name || '').replace(/'/g, "\\'")}')"
                                      title="Ver imagen">` :
                                `<div style="width: 56px; height: 56px; background: #f8f9fa; border-radius: 6px;
                                            border: 1px solid #dee2e6; display: flex; align-items: center;
                                            justify-content: center; color: #adb5bd;">
                                    <i class="bi bi-image"></i>
                                 </div>`
                            }
                        </td>
                        <td class="fw-semibold">${product.name}</td>
                        <td>${categoryName}</td>
                        <td>${presentationName}</td>
                        <td>${poolName}</td>
                        <td>${taxBadge}</td>
                        <td>$${parseFloat(product.salePrice).toFixed(2)}</td>
                        <td>
                            <span class="stock-indicator ${stockIndicator}"></span>
                            ${product.currentStock ?? 'N/A'}
                        </td>
                        <td>${statusBadge}</td>
                        <td>
                            <div class="table-actions">
                                ${(function() {
                                    if (currentUserRole === 'CASHIER') return '<span class="text-muted">Solo consulta</span>';
                                    var actions = '';
                                    actions += '<button class="btn btn-sm btn-outline-primary btn-sm-custom" onclick="editProduct(' + product.id + ')" title="Editar"><i class="bi bi-pencil"></i></button>';
                                    actions += '<button class="btn btn-sm btn-outline-success btn-sm-custom" onclick="duplicateProduct(' + product.id + ')" title="Duplicar"><i class="bi bi-files"></i></button>';
                                    actions += '<button class="btn btn-sm btn-outline-danger btn-sm-custom" onclick="deleteProduct(' + product.id + ')" title="Eliminar"><i class="bi bi-trash"></i></button>';
                                    return actions;
                                })()}
                            </div>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
        }

        function loadPurchaseSupplierFilter() {
            $.ajax({
                url: '/api/suppliers',
                method: 'GET',
                data: { tenantId: 1, isActive: 'true', limit: 200 },
                success: function(response) {
                    const sel = $('#purchaseFilterSupplier');
                    sel.find('option:not(:first)').remove();
                    response.suppliers.forEach(function(s) {
                        sel.append(`<option value="${s.id}">${s.supplierCode ? s.supplierCode + ' — ' : ''}${s.name}</option>`);
                    });
                }
            });
        }

        function loadPurchases() {
            const params = { tenantId: 1, limit: 50, page: 1 };
            const supplierId = $('#purchaseFilterSupplier').val();
            const status = $('#purchaseFilterStatus').val();
            const from = $('#purchaseFilterFrom').val();
            const to = $('#purchaseFilterTo').val();
            if (supplierId) params.supplierId = supplierId;
            if (status) params.status = status;
            if (from) params.startDate = from;
            if (to) params.endDate = to;

            $.ajax({
                url: '/api/purchases',
                method: 'GET',
                data: params,
                success: function(response) {
                    displayPurchaseOrders(response.purchaseOrders);
                },
                error: function() {
                    $('#purchasesTable tbody').html('<tr><td colspan="9" class="text-center text-danger">Error al cargar compras</td></tr>');
                }
            });
        }

        var purchaseOrdersData = [];

        function displayPurchaseOrders(orders) {
            purchaseOrdersData = orders || [];
            const tbody = $('#purchasesTable tbody');
            tbody.empty();

            if (!orders || orders.length === 0) {
                tbody.html('<tr><td colspan="9" class="text-center text-muted">No se encontraron compras</td></tr>');
                return;
            }

            orders.forEach(function(o, idx) {
                const supplierCode = o.supplier ? (o.supplier.supplierCode || '—') : '—';
                const supplierName = o.supplier ? o.supplier.name : '—';
                const itemsCount = (o.items && o.items.length > 0) ? o.items.length : (o.movements ? o.movements.length : 0);
                let statusBadge = '';
                if (o.status === 'PAID') statusBadge = '<span class="badge bg-success">Pagado</span>';
                else if (o.status === 'OVERDUE') statusBadge = '<span class="badge bg-danger">Vencida</span>';
                else if (o.status === 'PARTIAL') statusBadge = '<span class="badge bg-warning text-dark">Parcial</span>';
                else statusBadge = '<span class="badge bg-info text-dark">Pendiente</span>';

                const supplierCell = supplierName !== '—'
                    ? `<a href="#" class="text-decoration-none fw-semibold" onclick="showPurchaseDetail(${idx}); return false;">${supplierName}</a>`
                    : '—';

                const row = `<tr>
                    <td>${o.purchaseDate || '—'}</td>
                    <td><code>${supplierCode}</code></td>
                    <td>${supplierCell}</td>
                    <td>${o.invoiceNumber || '—'}</td>
                    <td class="text-center">${itemsCount} ítem(s)</td>
                    <td>$${parseFloat(o.totalAmount).toFixed(2)}</td>
                    <td>${o.creditDays > 0 ? o.creditDays + ' días' : '—'}</td>
                    <td>${o.dueDate || '—'}</td>
                    <td>${statusBadge}</td>
                </tr>`;
                tbody.append(row);
            });
        }

        function showPurchaseDetail(idx) {
            const o = purchaseOrdersData[idx];
            if (!o) return;

            const supplierName = o.supplier ? o.supplier.name : '—';
            const supplierCode = o.supplier ? (o.supplier.supplierCode || '—') : '—';

            let statusBadge = '';
            if (o.status === 'PAID') statusBadge = '<span class="badge bg-success">Pagado</span>';
            else if (o.status === 'OVERDUE') statusBadge = '<span class="badge bg-danger">Vencida</span>';
            else if (o.status === 'PARTIAL') statusBadge = '<span class="badge bg-warning text-dark">Parcial</span>';
            else statusBadge = '<span class="badge bg-info text-dark">Pendiente</span>';

            const amountPaid = parseFloat(o.amountPaid || 0);
            const totalAmount = parseFloat(o.totalAmount || 0);
            const balance = totalAmount - amountPaid;

            $('#purchaseDetailModal .modal-title').text('Detalle de Compra — ' + supplierName);

            $('#purchaseDetailInfo').html(`
                <div class="col-6 col-md-3"><small class="text-muted d-block">Código Proveedor</small><code>${supplierCode}</code></div>
                <div class="col-6 col-md-3"><small class="text-muted d-block">Fecha</small>${o.purchaseDate || '—'}</div>
                <div class="col-6 col-md-3"><small class="text-muted d-block">N° Factura</small>${o.invoiceNumber || '—'}</div>
                <div class="col-6 col-md-3"><small class="text-muted d-block">Estado</small>${statusBadge}</div>
                <div class="col-6 col-md-3"><small class="text-muted d-block">Días Crédito</small>${o.creditDays > 0 ? o.creditDays + ' días' : 'Sin crédito'}</div>
                <div class="col-6 col-md-3"><small class="text-muted d-block">Vence</small>${o.dueDate || '—'}</div>
                <div class="col-6 col-md-3"><small class="text-muted d-block">Pagado</small>$${amountPaid.toFixed(2)}</div>
                <div class="col-6 col-md-3"><small class="text-muted d-block">Saldo</small><span class="${balance > 0 ? 'text-danger fw-semibold' : 'text-success'}">$${balance.toFixed(2)}</span></div>
            `);

            // Preferir purchase_order_items (datos exactos del usuario); fallback a movements para compras antiguas
            const orderItems = (o.items && o.items.length > 0) ? o.items : null;
            const fallbackMovements = (!orderItems && o.movements && o.movements.length > 0) ? o.movements : null;
            const displayRows = orderItems || fallbackMovements || [];

            const itemsTbody = $('#purchaseDetailItems');
            itemsTbody.empty();

            if (displayRows.length === 0) {
                itemsTbody.html('<tr><td colspan="4" class="text-center text-muted">Sin ítems registrados</td></tr>');
            } else {
                displayRows.forEach(function(row) {
                    const productName = row.product ? row.product.name : '(producto eliminado)';
                    // items tiene quantity/unitCost; movements tiene qty/unitCost
                    const qty = parseFloat(row.quantity != null ? row.quantity : row.qty || 0);
                    const unitCost = parseFloat(row.unitCost || 0);
                    const subtotal = qty * unitCost;
                    itemsTbody.append(`<tr>
                        <td>${productName}</td>
                        <td class="text-center">${qty % 1 === 0 ? qty : qty.toFixed(3)}</td>
                        <td class="text-end">$${unitCost.toFixed(2)}</td>
                        <td class="text-end">$${subtotal.toFixed(2)}</td>
                    </tr>`);
                });
            }
            // Siempre usar el total de la orden (fuente de verdad)
            $('#purchaseDetailTotal').text('$' + totalAmount.toFixed(2));

            new bootstrap.Modal(document.getElementById('purchaseDetailModal')).show();
        }

        function loadSales() {
            const status = $('#salesStatusFilter').val() || '';
            const customerId = $('#salesCustomerFilter').val() || '';
            const startDate = $('#salesStartDateFilter').val() || '';
            const endDate = $('#salesEndDateFilter').val() || '';
            
            const params = {
                tenantId: 1,
                page: 1,
                limit: 50
            };
            
            if (status) params.status = status;
            if (customerId) params.customerId = customerId;
            if (startDate) params.startDate = startDate;
            if (endDate) params.endDate = endDate;
            
            $.ajax({
                url: '/api/sales',
                method: 'GET',
                data: params,
                success: function(response) {
                    displaySales(response.sales);
                },
                error: function(xhr) {
                    console.error('Error loading sales:', xhr);
                    const tbody = $('#salesTable tbody');
                    tbody.html(`
                        <tr>
                            <td colspan="7" class="text-center text-danger">
                                Error al cargar ventas
                            </td>
                        </tr>
                    `);
                }
            });
        }
        
        function displaySales(sales) {
            const tbody = $('#salesTable tbody');
            tbody.empty();
            
            if (sales.length === 0) {
                tbody.html(`
                    <tr>
                                    <td colspan="9" class="text-center text-muted">
                                        No se encontraron ventas
                                    </td>
                    </tr>
                `);
                return;
            }
            
            sales.forEach(sale => {
                const date = new Date(sale.createdAt).toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const customerName = sale.customer ? sale.customer.name : 'Cliente General';
                const taxRate = sale.taxRate !== null && sale.taxRate !== undefined ? parseFloat(sale.taxRate).toFixed(2) : '0.00';
                const taxAmount = sale.taxAmount ? parseFloat(sale.taxAmount).toFixed(2) : '0.00';
                const total = parseFloat(sale.totalAmount).toFixed(2);
                const subtotal = (parseFloat(total) - parseFloat(taxAmount)).toFixed(2);
                
                let statusBadge = '';
                if (sale.status === 'COMPLETED') {
                    statusBadge = '<span class="badge bg-success">Completada</span>';
                } else if (sale.status === 'PENDING') {
                    statusBadge = '<span class="badge bg-warning">Pendiente</span>';
                } else if (sale.status === 'VOIDED') {
                    statusBadge = '<span class="badge bg-danger">Anulada</span>';
                }
                
                const paymentMethod = sale.paymentMethod === 'CASH' ? 'Efectivo' :
                                     sale.paymentMethod === 'CARD' ? 'Tarjeta' :
                                     sale.paymentMethod === 'TRANSFER' ? 'Transferencia' : sale.paymentMethod;
                
                const voidButton = (currentUserRole !== 'CASHIER' && sale.status === 'COMPLETED') ? 
                    `<button class="btn btn-sm btn-outline-danger btn-sm-custom" onclick="voidSale(${sale.id})" title="Anular">
                        <i class="bi bi-x-circle"></i>
                    </button>` : '';
                
                const confirmTransferButton = sale.status === 'PENDING' && sale.paymentMethod === 'TRANSFER' ?
                    `<button class="btn btn-sm btn-outline-success btn-sm-custom" onclick="confirmTransfer(${sale.id})" title="Confirmar Transferencia">
                        <i class="bi bi-check-circle"></i> Confirmar
                    </button>` : '';
                const confirmCashButton = sale.status === 'PENDING' && sale.paymentMethod === 'CASH' ?
                    `<button class="btn btn-sm btn-outline-success btn-sm-custom" onclick="confirmCash(${sale.id})" title="Confirmar pago en efectivo">
                        <i class="bi bi-cash-coin"></i> Confirmar pago
                    </button>` : '';
                const rejectPendingButton = sale.status === 'PENDING' && (sale.paymentMethod === 'CASH' || sale.paymentMethod === 'TRANSFER') ?
                    `<button class="btn btn-sm btn-outline-danger btn-sm-custom" onclick="rejectPendingOrder(${sale.id})" title="Rechazar orden (cliente no llegó / no pagó)">
                        <i class="bi bi-x-circle"></i> Rechazar
                    </button>` : '';
                
                const transferRef = sale.transferReference ? `<br><small class="text-muted">Ref: ${sale.transferReference}</small>` : '';
                
                const row = `
                    <tr>
                        <td>${sale.id}</td>
                        <td>${date}</td>
                        <td>${customerName}</td>
                        <td>$${subtotal}</td>
                        <td>$${taxAmount} (${taxRate}%)</td>
                        <td>$${total}</td>
                        <td>${paymentMethod}${transferRef}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <div class="table-actions">
                                <button class="btn btn-sm btn-outline-primary btn-sm-custom" onclick="viewSaleDetails(${sale.id})" title="Ver Detalles">
                                    <i class="bi bi-eye"></i>
                                </button>
                                ${confirmTransferButton}
                                ${confirmCashButton}
                                ${rejectPendingButton}
                                ${voidButton}
                            </div>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
        }
        
        function viewSaleDetails(saleId) {
            $.ajax({
                url: `/api/sales/${saleId}`,
                method: 'GET',
                data: { tenantId: 1 },
                success: function(sale) {
                    const date = new Date(sale.createdAt).toLocaleDateString('es-ES', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    $('#saleDetailsId').text(sale.id);
                    $('#saleDetailsDate').text(date);
                    
                    let statusBadge = '';
                    if (sale.status === 'COMPLETED') {
                        statusBadge = '<span class="badge bg-success">Completada</span>';
                    } else if (sale.status === 'PENDING') {
                        statusBadge = '<span class="badge bg-warning">Pendiente</span>';
                    } else if (sale.status === 'VOIDED') {
                        statusBadge = '<span class="badge bg-danger">Anulada</span>';
                    }
                    $('#saleDetailsStatus').html(statusBadge);
                    
                    const customerName = sale.customer ? sale.customer.name : 'Cliente General';
                    $('#saleDetailsCustomer').text(customerName);
                    
                    const paymentMethod = sale.paymentMethod === 'CASH' ? 'Efectivo' :
                                         sale.paymentMethod === 'CARD' ? 'Tarjeta' :
                                         sale.paymentMethod === 'TRANSFER' ? 'Transferencia' : sale.paymentMethod;
                    $('#saleDetailsPayment').text(paymentMethod);
                    
                    $('#saleDetailsNotes').text(sale.notes || 'Sin notas');
                    $('#saleDetailsTotal').text(parseFloat(sale.totalAmount).toFixed(2));
                    
                    // Render items
                    const itemsTbody = $('#saleDetailsItems');
                    itemsTbody.empty();
                    
                    if (sale.items && sale.items.length > 0) {
                        sale.items.forEach(item => {
                            const productName = item.product ? item.product.name : 'Producto eliminado';
                            const quantity = parseFloat(item.quantity).toFixed(3);
                            const unitPrice = parseFloat(item.unitPrice).toFixed(2);
                            const subtotal = (parseFloat(item.quantity) * parseFloat(item.unitPrice)).toFixed(2);
                            
                            const row = `
                                <tr>
                                    <td>${productName}</td>
                                    <td>${quantity}</td>
                                    <td>$${unitPrice}</td>
                                    <td>$${subtotal}</td>
                                </tr>
                            `;
                            itemsTbody.append(row);
                        });
                    } else {
                        itemsTbody.html('<tr><td colspan="4" class="text-center text-muted">No hay items</td></tr>');
                    }
                    
                    const modal = new bootstrap.Modal(document.getElementById('saleDetailsModal'));
                    modal.show();
                },
                error: function(xhr) {
                    showAlert('Error al cargar detalles de la venta', 'danger');
                }
            });
        }
        
        function confirmTransfer(saleId) {
            if (!confirm('¿Está seguro de que desea confirmar esta transferencia? Esto descontará el inventario y completará la venta.')) {
                return;
            }
            const token = localStorage.getItem('adminToken');
            $.ajax({
                url: `/api/sales/${saleId}/confirm-transfer`,
                method: 'PATCH',
                headers: { 'Authorization': 'Bearer ' + token },
                contentType: 'application/json',
                data: JSON.stringify({ tenantId: 1 }),
                success: function(response) {
                    showAlert('Transferencia confirmada exitosamente. La venta ha sido completada.', 'success');
                    loadSales();
                    loadNotifications();
                    loadDashboardData();
                    loadSellProducts();
                },
                error: function(xhr) {
                    const error = xhr.responseJSON?.error || 'Error al confirmar la transferencia';
                    showAlert(error, 'danger');
                }
            });
        }

        function confirmCash(saleId) {
            if (!confirm('¿Confirmar que recibió el pago en efectivo? Esto descontará el inventario y completará la venta.')) {
                return;
            }
            const token = localStorage.getItem('adminToken');
            $.ajax({
                url: `/api/sales/${saleId}/confirm-cash`,
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + token },
                contentType: 'application/json',
                data: JSON.stringify({ tenantId: 1 }),
                success: function(response) {
                    showAlert('Pago en efectivo confirmado. La venta ha sido completada.', 'success');
                    loadSales();
                    loadNotifications();
                    loadDashboardData();
                    loadSellProducts();
                },
                error: function(xhr) {
                    const error = xhr.responseJSON?.error || 'Error al confirmar el pago';
                    showAlert(error, 'danger');
                }
            });
        }

        function rejectPendingOrder(saleId) {
            if (!confirm('¿Rechazar esta orden? El cliente no podrá completar el pedido. Use esta opción si el cliente no llegó o no realizó el pago.')) {
                return;
            }
            const reason = prompt('Motivo del rechazo (opcional):', 'Cliente no llegó / no pagó');
            const voidReason = (reason && reason.trim()) ? reason.trim() : 'Orden rechazada (cliente no llegó o no pagó)';
            const token = localStorage.getItem('adminToken');
            $.ajax({
                url: `/api/sales/${saleId}/reject-pending`,
                method: 'PATCH',
                headers: { 'Authorization': 'Bearer ' + token },
                contentType: 'application/json',
                data: JSON.stringify({ tenantId: 1, voidReason: voidReason }),
                success: function(response) {
                    showAlert('Orden rechazada. La venta ha sido anulada.', 'success');
                    loadSales();
                    loadNotifications();
                    loadDashboardData();
                },
                error: function(xhr) {
                    const error = xhr.responseJSON?.error || 'Error al rechazar la orden';
                    showAlert(error, 'danger');
                }
            });
        }

        function voidSale(saleId) {
            if (!confirm('¿Está seguro de anular esta venta? Esta acción revertirá el inventario.')) {
                return;
            }
            
            const reason = prompt('Ingrese el motivo de la anulación (opcional):') || 'Venta anulada';
            
            $.ajax({
                url: `/api/sales/${saleId}/void`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    tenantId: 1,
                    reason: reason
                }),
                success: function() {
                    showAlert('Venta anulada exitosamente', 'success');
                    loadSales();
                },
                error: function(xhr) {
                    const error = xhr.responseJSON?.error || 'Error al anular la venta';
                    showAlert(error, 'danger');
                }
            });
        }

        function loadCustomers() {
            const search = $('#customerSearch').val() || '';
            const isActive = $('#customerStatusFilter').val();
            
            $.ajax({
                url: '/api/customers',
                method: 'GET',
                data: {
                    tenantId: 1,
                    search: search,
                    isActive: isActive,
                    limit: 100
                },
                success: function(response) {
                    displayCustomers(response.customers);
                },
                error: function() {
                    showAlert('Error al cargar clientes', 'danger');
                }
            });
        }

        function displayCustomers(customers) {
            const tbody = $('#customersTable tbody');
            tbody.empty();

            if (customers.length === 0) {
                tbody.html(`
                    <tr>
                        <td colspan="9" class="text-center text-muted">
                            No se encontraron clientes
                        </td>
                    </tr>
                `);
                return;
            }

            customers.forEach(customer => {
                const statusBadge = customer.isActive ? 
                    '<span class="badge bg-success">Activo</span>' : 
                    '<span class="badge bg-danger">Inactivo</span>';
                
                const date = new Date(customer.createdAt).toLocaleDateString('es-ES');

                const row = `
                    <tr>
                        <td>${customer.id}</td>
                        <td>${customer.name}</td>
                        <td><strong>${customer.cedula || '<span class="text-muted">N/A</span>'}</strong></td>
                        <td>${customer.email || '<span class="text-muted">N/A</span>'}</td>
                        <td>${customer.phone || '<span class="text-muted">N/A</span>'}</td>
                        <td>${customer.address ? (customer.address.length > 50 ? customer.address.substring(0, 50) + '...' : customer.address) : '<span class="text-muted">N/A</span>'}</td>
                        <td>${statusBadge}</td>
                        <td>${date}</td>
                        <td>
                            <div class="table-actions">
                                <button class="btn btn-sm btn-outline-primary btn-sm-custom" onclick="editCustomer(${customer.id})" title="Editar">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                ${currentUserRole !== 'CASHIER' ? `<button class="btn btn-sm btn-outline-danger btn-sm-custom" onclick="deleteCustomer(${customer.id})" title="Eliminar">
                                    <i class="bi bi-trash"></i>
                                </button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
        }

        function filterCustomers() {
            loadCustomers();
        }

        function showCreateCustomerModal() {
            currentEditingCustomer = null;
            $('#customerModalTitle').text('Nuevo Cliente');
            $('#customerForm')[0].reset();
            $('#passwordRequired').show();
            $('#customerPassword').prop('required', true);
            $('#customerPassword').closest('.mb-3').show();
            $('#customerStatus').val('true');
            $('#customerCedula').prop('readonly', false);
            $('#customerCedula').prop('required', true);
            // Limpiar campos de ubicación del mapa
            $('#customerLatitude').val('');
            $('#customerLongitude').val('');
            $('#customerAddress').val('');
            
            const modal = new bootstrap.Modal(document.getElementById('customerModal'));
            modal.show();
        }

        function editCustomer(customerId) {
            $.ajax({
                url: `/api/customers/${customerId}`,
                method: 'GET',
                data: { tenantId: 1 },
                success: function(customer) {
                    currentEditingCustomer = customer;
                    $('#customerModalTitle').text('Editar Cliente');
                    
                    $('#customerName').val(customer.name);
                    $('#customerCedula').val(customer.cedula || '');
                    $('#customerEmail').val(customer.email || '');
                    $('#customerPhone').val(customer.phone || '');
                    
                    // Manejar dirección y coordenadas
                    const address = customer.address || '';
                    $('#customerAddress').val(address);
                    
                    // Intentar extraer coordenadas de la dirección si existen
                    const coordMatch = address.match(/Coordenadas:\s*([-\d.]+),\s*([-\d.]+)/);
                    if (coordMatch) {
                        $('#customerLatitude').val(coordMatch[1]);
                        $('#customerLongitude').val(coordMatch[2]);
                    } else {
                        $('#customerLatitude').val('');
                        $('#customerLongitude').val('');
                    }
                    
                    $('#customerStatus').val(customer.isActive.toString());
                    $('#customerPassword').val('');
                    $('#passwordRequired').hide();
                    $('#customerPassword').prop('required', false);
                    $('#customerPassword').closest('.mb-3').hide();
                    $('#customerCedula').prop('readonly', true);
                    
                    const modal = new bootstrap.Modal(document.getElementById('customerModal'));
                    modal.show();
                },
                error: function() {
                    showAlert('Error al cargar datos del cliente', 'danger');
                }
            });
        }

        function deleteCustomer(customerId) {
            const action = prompt(
                '¿Qué desea hacer con este cliente?\n\n' +
                'Escriba "ELIMINAR" para eliminar permanentemente\n' +
                'Escriba "DESACTIVAR" para solo desactivarlo\n\n' +
                'O presione Cancelar para no hacer nada:'
            );
            
            if (!action) return; // Usuario canceló
            
            const actionUpper = action.trim().toUpperCase();
            
            if (actionUpper === 'ELIMINAR') {
                $.ajax({
                    url: `/api/customers/${customerId}?tenantId=1&permanent=true`,
                    method: 'DELETE',
                    success: function() {
                        showAlert('Cliente eliminado permanentemente', 'success');
                        loadCustomers();
                    },
                    error: function(xhr) {
                        const error = xhr.responseJSON?.error || 'Error al eliminar cliente';
                        showAlert(error, 'danger');
                    }
                });
            } else if (actionUpper === 'DESACTIVAR') {
                $.ajax({
                    url: `/api/customers/${customerId}?tenantId=1&permanent=false`,
                    method: 'DELETE',
                    success: function() {
                        showAlert('Cliente desactivado exitosamente', 'success');
                        loadCustomers();
                    },
                    error: function(xhr) {
                        const error = xhr.responseJSON?.error || 'Error al desactivar cliente';
                        showAlert(error, 'danger');
                    }
                });
            } else {
                showAlert('Acción no reconocida. Escriba "ELIMINAR" o "DESACTIVAR"', 'warning');
            }
        }

        // Variables globales para verificación de código
        let pendingCustomerData = null;
        let pendingVerificationCode = null;

        function saveCustomer() {
            const cedula = $('#customerCedula').val().trim();
            if (!cedula) {
                showAlert('El número de cédula es requerido', 'warning');
                return;
            }

            const customerEmail = $('#customerEmail').val() || null;
            const isEditing = currentEditingCustomer !== null;

            // Validar contraseña para nuevos clientes
            const password = $('#customerPassword').val();
            if (!isEditing && !password) {
                showAlert('La contraseña es requerida al crear un nuevo cliente', 'warning');
                return;
            }

            // Obtener coordenadas del mapa si están disponibles
            const latitude = $('#customerLatitude').val() || null;
            const longitude = $('#customerLongitude').val() || null;

            const formData = {
                tenantId: 1,
                name: $('#customerName').val(),
                cedula: cedula,
                email: customerEmail,
                phone: $('#customerPhone').val() || null,
                address: $('#customerAddress').val() || null,
                latitude: latitude ? parseFloat(latitude) : null,
                longitude: longitude ? parseFloat(longitude) : null,
                isActive: $('#customerStatus').val() === 'true'
            };

            if (password) {
                formData.password = password;
            }

            // Si es nuevo cliente Y tiene email, enviar código de verificación AUTOMÁTICAMENTE
            if (!isEditing && customerEmail) {
                // Generar código de 6 dígitos
                pendingVerificationCode = Math.floor(100000 + Math.random() * 900000).toString();
                pendingCustomerData = formData;
                
                // Enviar código por email
                showAlert('Enviando código de verificación...', 'info');
                $.ajax({
                    url: '/api/email/verification-code',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        tenantId: 1,
                        email: customerEmail,
                        code: pendingVerificationCode
                    }),
                    success: function() {
                        // Ocultar modal de cliente y mostrar modal de verificación
                        bootstrap.Modal.getInstance(document.getElementById('customerModal')).hide();
                        
                        $('#verificationEmail').text(customerEmail);
                        $('#verificationCodeInput').val('');
                        $('#verificationError').hide();
                        
                        setTimeout(() => {
                            const verifyModal = new bootstrap.Modal(document.getElementById('verificationCodeModal'));
                            verifyModal.show();
                        }, 300);
                        
                        showAlert(`Código enviado a ${customerEmail}. Ingresa el código para crear el cliente.`, 'success');
                        console.log('Código de verificación (para pruebas):', pendingVerificationCode);
                    },
                    error: function(xhr) {
                        // Si falla el envío de email, preguntar si desea continuar sin verificación
                        pendingCustomerData = null;
                        pendingVerificationCode = null;
                        
                        if (confirm('No se pudo enviar el código de verificación. ¿Desea crear el cliente sin verificar el email?')) {
                            createCustomerDirectly(formData, isEditing, customerEmail);
                        } else {
                            showAlert('Verifique la configuración SMTP en Configuración > Email.', 'warning');
                        }
                    }
                });
                return; // No crear cliente aún, esperar verificación
            }

            // Si es edición o no tiene email, crear/actualizar cliente directamente
            createCustomerDirectly(formData, isEditing, customerEmail);
        }

        // Función auxiliar para crear cliente directamente
        function createCustomerDirectly(formData, isEditing, customerEmail) {
            const url = isEditing ? `/api/customers/${currentEditingCustomer.id}` : '/api/customers';
            const method = isEditing ? 'PUT' : 'POST';

            $.ajax({
                url: url,
                method: method,
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    const message = isEditing ? 'Cliente actualizado exitosamente' : 'Cliente creado exitosamente';
                    showAlert(message, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('customerModal')).hide();
                    loadCustomers();
                    // Si el modal de crédito está abierto, actualizar la lista de clientes
                    if ($('#sellCartModal').hasClass('show') && $('#sellCartModalPaymentMethod').val() === 'CREDIT') {
                        // Agregar el nuevo cliente a la lista si no existe
                        const exists = allCustomersList.find(c => c.id === response.id);
                        if (!exists) {
                            allCustomersList.push(response);
                        }
                        filterCustomersForCredit($('#sellCartModalCustomerSearch').val());
                        // Solo mostrar si el campo tiene foco
                        if ($('#sellCartModalCustomerSearch').is(':focus')) {
                            showCustomersDropdown();
                        }
                    }
                    currentEditingCustomer = null;
                    
                    // Limpiar campos del mapa
                    $('#customerLatitude').val('');
                    $('#customerLongitude').val('');
                    
                    // Send welcome email if new customer and has email
                    if (!isEditing && customerEmail) {
                        $.ajax({
                            url: '/api/email/welcome',
                            method: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify({
                                tenantId: 1,
                                email: customerEmail,
                                customerName: formData.name
                            }),
                            success: function() {
                                console.log('Welcome email sent successfully');
                            },
                            error: function(xhr) {
                                console.warn('Could not send welcome email:', xhr.responseJSON?.message || 'SMTP not configured');
                            }
                        });
                    }
                },
                error: function(xhr) {
                    const error = xhr.responseJSON?.error || 'Error al guardar cliente';
                    showAlert(error, 'danger');
                }
            });
        }

        function loadUsers() {
            $.ajax({
                url: '/api/users',
                method: 'GET',
                data: {
                    tenantId: 1,
                    limit: 100
                },
                success: function(response) {
                    displayUsers(response.users);
                },
                error: function() {
                    showAlert('Error al cargar usuarios', 'danger');
                }
            });
        }

        // Group Purchases Functions
        function loadGroupPurchases() {
            const status = $('#groupPurchaseStatusFilter').val() || '';
            const startDate = $('#groupPurchaseStartDateFilter').val() || '';
            const endDate = $('#groupPurchaseEndDateFilter').val() || '';
            
            const params = {
                tenantId: 1,
                page: 1,
                limit: 50
            };
            
            if (status) params.status = status;
            if (startDate) params.startDate = startDate;
            if (endDate) params.endDate = endDate;
            
            $.ajax({
                url: '/api/group-purchases',
                method: 'GET',
                data: params,
                success: function(response) {
                    displayGroupPurchases(response.groupPurchases);
                },
                error: function(xhr) {
                    console.error('Error loading group purchases:', xhr);
                    const tbody = $('#groupPurchasesTable tbody');
                    tbody.html(`
                        <tr>
                            <td colspan="7" class="text-center text-danger">
                                Error al cargar compras grupales
                            </td>
                        </tr>
                    `);
                }
            });
        }
        
        function displayGroupPurchases(groupPurchases) {
            const tbody = $('#groupPurchasesTable tbody');
            tbody.empty();
            
            if (groupPurchases.length === 0) {
                tbody.html(`
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            No se encontraron compras grupales
                        </td>
                    </tr>
                `);
                return;
            }
            
            groupPurchases.forEach(gp => {
                const date = new Date(gp.createdAt).toLocaleDateString('es-ES');
                const total = parseFloat(gp.totalAmount).toFixed(2);
                const participantCount = gp.participants ? gp.participants.length : 0;
                
                let statusBadge = '';
                if (gp.status === 'COMPLETED') {
                    statusBadge = '<span class="badge bg-success">Completada</span>';
                } else if (gp.status === 'PARTIAL') {
                    statusBadge = '<span class="badge bg-warning">Parcial</span>';
                } else if (gp.status === 'PENDING') {
                    statusBadge = '<span class="badge bg-info">Pendiente</span>';
                } else if (gp.status === 'CANCELLED') {
                    statusBadge = '<span class="badge bg-danger">Cancelada</span>';
                }
                
                const productName = gp.product ? gp.product.name : 'N/A';
                
                const row = `
                    <tr>
                        <td>${gp.id}</td>
                        <td>${productName}</td>
                        <td>$${total}</td>
                        <td>${participantCount}</td>
                        <td>${statusBadge}</td>
                        <td>${date}</td>
                        <td>
                            <div class="table-actions">
                                <button class="btn btn-sm btn-outline-primary btn-sm-custom" onclick="viewGroupPurchaseDetails(${gp.id})" title="Ver Detalles">
                                    <i class="bi bi-eye"></i>
                                </button>
                                ${gp.status !== 'CANCELLED' && gp.status !== 'COMPLETED' ? 
                                    `<button class="btn btn-sm btn-outline-danger btn-sm-custom" onclick="cancelGroupPurchase(${gp.id})" title="Cancelar">
                                        <i class="bi bi-x-circle"></i>
                                    </button>` : ''
                                }
                            </div>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
        }
        
        function filterGroupPurchases() {
            loadGroupPurchases();
        }
        
        function showCreateGroupPurchaseModal() {
            $('#groupPurchaseForm')[0].reset();
            $('#groupPurchaseParticipantsList').empty();
            groupPurchaseParticipants = [];
            $('#groupPurchaseTotal').text('$0.00');
            
            // Load products
            $.ajax({
                url: '/api/products',
                method: 'GET',
                data: { tenantId: 1, isActive: true, limit: 100 },
                success: function(response) {
                    const select = $('#groupPurchaseProduct');
                    select.empty();
                    select.append('<option value="">Seleccione un producto...</option>');
                    response.products.forEach(product => {
                        select.append(`<option value="${product.id}" data-price="${product.salePrice}">${product.name} - $${product.salePrice}</option>`);
                    });
                }
            });
            
            // Load customers
            $.ajax({
                url: '/api/customers',
                method: 'GET',
                data: { tenantId: 1, isActive: true, limit: 100 },
                success: function(response) {
                    const select = $('#groupPurchaseParticipantCustomer');
                    select.empty();
                    select.append('<option value="">Seleccione un cliente...</option>');
                    response.customers.forEach(customer => {
                        select.append(`<option value="${customer.id}">${customer.name} (${customer.cedula})</option>`);
                    });
                }
            });
            
            // Calculate total when product or quantity changes
            $('#groupPurchaseProduct, #groupPurchaseQuantity').on('change', function() {
                const productId = $('#groupPurchaseProduct').val();
                const quantity = parseFloat($('#groupPurchaseQuantity').val()) || 0;
                
                if (productId && quantity > 0) {
                    const productOption = $('#groupPurchaseProduct option:selected');
                    const price = parseFloat(productOption.data('price')) || 0;
                    const total = price * quantity;
                    $('#groupPurchaseTotal').text('$' + total.toFixed(2));
                } else {
                    $('#groupPurchaseTotal').text('$0.00');
                }
            });
            
            const modal = new bootstrap.Modal(document.getElementById('groupPurchaseModal'));
            modal.show();
        }
        
        function addGroupPurchaseParticipant() {
            const customerId = $('#groupPurchaseParticipantCustomer').val();
            const amountDue = parseFloat($('#groupPurchaseParticipantAmount').val());
            const dueDate = $('#groupPurchaseParticipantDueDate').val() || null;
            const interestRate = parseFloat($('#groupPurchaseParticipantInterestRate').val()) || 0;
            
            if (!customerId || !amountDue || amountDue <= 0) {
                showAlert('Cliente y monto son requeridos', 'warning');
                return;
            }
            
            const customerName = $('#groupPurchaseParticipantCustomer option:selected').text();
            
            groupPurchaseParticipants.push({
                customerId: parseInt(customerId),
                customerName: customerName,
                amountDue: amountDue,
                dueDate: dueDate,
                interestRate: interestRate
            });
            
            updateGroupPurchaseParticipantsList();
            $('#groupPurchaseParticipantCustomer').val('');
            $('#groupPurchaseParticipantAmount').val('');
            $('#groupPurchaseParticipantDueDate').val('');
            $('#groupPurchaseParticipantInterestRate').val('0');
        }
        
        function updateGroupPurchaseParticipantsList() {
            const list = $('#groupPurchaseParticipantsList');
            list.empty();
            
            if (groupPurchaseParticipants.length === 0) {
                list.html('<div class="text-muted text-center">No hay participantes agregados</div>');
                return;
            }
            
            let total = 0;
            groupPurchaseParticipants.forEach((p, index) => {
                total += p.amountDue;
                const dueDateText = p.dueDate ? new Date(p.dueDate).toLocaleDateString('es-ES') : 'Sin fecha límite';
                const interestText = p.interestRate > 0 ? `${p.interestRate}% diario` : 'Sin interés';
                
                const item = `
                    <div class="card mb-2">
                        <div class="card-body p-2">
                            <div class="row align-items-center">
                                <div class="col-md-4">
                                    <strong>${p.customerName}</strong>
                                </div>
                                <div class="col-md-2">
                                    <small>Monto: $${p.amountDue.toFixed(2)}</small>
                                </div>
                                <div class="col-md-2">
                                    <small>Vence: ${dueDateText}</small>
                                </div>
                                <div class="col-md-2">
                                    <small>Interés: ${interestText}</small>
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-sm btn-outline-danger" onclick="removeGroupPurchaseParticipant(${index})">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                list.append(item);
            });
        }
        
        function removeGroupPurchaseParticipant(index) {
            groupPurchaseParticipants.splice(index, 1);
            updateGroupPurchaseParticipantsList();
        }
        
        function saveGroupPurchase() {
            const productId = $('#groupPurchaseProduct').val();
            const quantity = parseFloat($('#groupPurchaseQuantity').val());
            const notes = $('#groupPurchaseNotes').val() || null;
            
            if (!productId || !quantity || quantity <= 0) {
                showAlert('Producto y cantidad son requeridos', 'warning');
                return;
            }
            
            if (groupPurchaseParticipants.length === 0) {
                showAlert('Debe agregar al menos un participante', 'warning');
                return;
            }
            
            // Get product price to validate total
            const productOption = $('#groupPurchaseProduct option:selected');
            const productPrice = parseFloat(productOption.data('price'));
            const totalAmount = productPrice * quantity;
            
            const participantsTotal = groupPurchaseParticipants.reduce((sum, p) => sum + p.amountDue, 0);
            
            if (Math.abs(participantsTotal - totalAmount) > 0.01) {
                showAlert(`La suma de montos ($${participantsTotal.toFixed(2)}) debe igualar el total ($${totalAmount.toFixed(2)})`, 'warning');
                return;
            }
            
            const participants = groupPurchaseParticipants.map(p => ({
                customerId: p.customerId,
                amountDue: p.amountDue,
                dueDate: p.dueDate || null,
                interestRate: p.interestRate || 0
            }));
            
            $.ajax({
                url: '/api/group-purchases',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    tenantId: 1,
                    productId: parseInt(productId),
                    quantity: quantity,
                    participants: participants,
                    notes: notes
                }),
                success: function() {
                    showAlert('Compra grupal creada exitosamente', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('groupPurchaseModal')).hide();
                    groupPurchaseParticipants = [];
                    loadGroupPurchases();
                    loadCredits();
                    loadDashboardData();
                },
                error: function(xhr) {
                    const error = xhr.responseJSON?.error || 'Error al crear compra grupal';
                    showAlert(error, 'danger');
                }
            });
        }
        
        function viewGroupPurchaseDetails(groupPurchaseId) {
            $.ajax({
                url: `/api/group-purchases/${groupPurchaseId}`,
                method: 'GET',
                data: { tenantId: 1 },
                success: function(groupPurchase) {
                    $('#groupPurchaseDetailsId').text(groupPurchase.id);
                    $('#groupPurchaseDetailsProduct').text(groupPurchase.product ? groupPurchase.product.name : 'N/A');
                    $('#groupPurchaseDetailsTotal').text('$' + parseFloat(groupPurchase.totalAmount).toFixed(2));
                    $('#groupPurchaseDetailsDate').text(new Date(groupPurchase.createdAt).toLocaleDateString('es-ES'));
                    
                    let statusBadge = '';
                    if (groupPurchase.status === 'COMPLETED') {
                        statusBadge = '<span class="badge bg-success">Completada</span>';
                    } else if (groupPurchase.status === 'PARTIAL') {
                        statusBadge = '<span class="badge bg-warning">Parcial</span>';
                    } else if (groupPurchase.status === 'PENDING') {
                        statusBadge = '<span class="badge bg-info">Pendiente</span>';
                    } else {
                        statusBadge = '<span class="badge bg-danger">Cancelada</span>';
                    }
                    $('#groupPurchaseDetailsStatus').html(statusBadge);
                    
                    const tbody = $('#groupPurchaseDetailsParticipants');
                    tbody.empty();
                    
                    if (groupPurchase.participants && groupPurchase.participants.length > 0) {
                        groupPurchase.participants.forEach(participant => {
                            const amountDue = parseFloat(participant.amountDue);
                            const amountPaid = parseFloat(participant.amountPaid || 0);
                            const remaining = amountDue - amountPaid;
                            const interestAmount = parseFloat(participant.interestAmount || 0);
                            
                            let statusBadge = '';
                            if (participant.status === 'PAID') {
                                statusBadge = '<span class="badge bg-success">Pagado</span>';
                            } else if (participant.status === 'PARTIAL') {
                                statusBadge = '<span class="badge bg-warning">Parcial</span>';
                            } else if (participant.status === 'OVERDUE') {
                                statusBadge = '<span class="badge bg-danger">Vencido</span>';
                            } else {
                                statusBadge = '<span class="badge bg-info">Pendiente</span>';
                            }
                            
                            const dueDateText = participant.dueDate ? new Date(participant.dueDate).toLocaleDateString('es-ES') : 'N/A';
                            
                            const row = `
                                <tr>
                                    <td>${participant.customer ? participant.customer.name : 'N/A'}</td>
                                    <td>$${amountDue.toFixed(2)}</td>
                                    <td>$${amountPaid.toFixed(2)}</td>
                                    <td>$${remaining.toFixed(2)}</td>
                                    <td>$${interestAmount.toFixed(2)}</td>
                                    <td>${dueDateText}</td>
                                    <td>${statusBadge}</td>
                                    <td>
                                        ${participant.status !== 'PAID' ? 
                                            `<button class="btn btn-sm btn-outline-success" onclick="registerParticipantPayment(${participant.id}, ${groupPurchase.id})">
                                                <i class="bi bi-cash"></i> Pagar
                                            </button>` : ''
                                        }
                                    </td>
                                </tr>
                            `;
                            tbody.append(row);
                        });
                    }
                    
                    const modal = new bootstrap.Modal(document.getElementById('groupPurchaseDetailsModal'));
                    modal.show();
                },
                error: function() {
                    showAlert('Error al cargar detalles de la compra grupal', 'danger');
                }
            });
        }
        
        function cancelGroupPurchase(groupPurchaseId) {
            if (!confirm('¿Está seguro de cancelar esta compra grupal? Se revertirá el inventario.')) {
                return;
            }
            
            const reason = prompt('Ingrese el motivo de la cancelación:') || 'Cancelada por administrador';
            
            $.ajax({
                url: `/api/group-purchases/${groupPurchaseId}/cancel`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    tenantId: 1,
                    reason: reason
                }),
                success: function() {
                    showAlert('Compra grupal cancelada exitosamente', 'success');
                    loadGroupPurchases();
                    loadCredits();
                    loadDashboardData();
                },
                error: function(xhr) {
                    const error = xhr.responseJSON?.error || 'Error al cancelar compra grupal';
                    showAlert(error, 'danger');
                }
            });
        }
        
        let currentGroupPurchaseId = null;
        
        function registerParticipantPayment(participantId, groupPurchaseId) {
            currentGroupPurchaseId = groupPurchaseId;
            $('#participantPaymentParticipantId').val(participantId);
            $('#participantPaymentAmount').val('');
            $('#participantPaymentMethod').val('CASH');
            $('#participantPaymentDate').val(new Date().toISOString().split('T')[0]);
            $('#participantPaymentNotes').val('');
            
            const modal = new bootstrap.Modal(document.getElementById('participantPaymentModal'));
            modal.show();
        }
        
        function saveParticipantPayment() {
            const participantId = $('#participantPaymentParticipantId').val();
            const amount = parseFloat($('#participantPaymentAmount').val());
            const paymentMethod = $('#participantPaymentMethod').val();
            const paymentDate = $('#participantPaymentDate').val();
            const notes = $('#participantPaymentNotes').val() || null;
            
            if (!participantId || !amount || amount <= 0 || !paymentMethod) {
                showAlert('Complete todos los campos requeridos', 'warning');
                return;
            }
            
            // Get participant info first
            const groupPurchaseId = currentGroupPurchaseId || $('#groupPurchaseDetailsId').text();
            $.ajax({
                url: `/api/group-purchases/${groupPurchaseId}/participants`,
                method: 'GET',
                data: { tenantId: 1 },
                success: function(response) {
                    const participant = response.participants.find(p => p.id == participantId);
                    if (!participant) {
                        showAlert('Participante no encontrado', 'danger');
                        return;
                    }
                    
                    $.ajax({
                        url: '/api/customer-payments/apply-to-credit',
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({
                            tenantId: 1,
                            customerId: participant.customerId,
                            groupPurchaseParticipantId: participantId,
                            amount: amount,
                            paymentMethod: paymentMethod,
                            paymentDate: paymentDate,
                            notes: notes
                        }),
                        success: function() {
                            showAlert('Pago registrado exitosamente', 'success');
                            bootstrap.Modal.getInstance(document.getElementById('participantPaymentModal')).hide();
                            viewGroupPurchaseDetails(groupPurchaseId);
                            loadGroupPurchases();
                            loadCredits();
                        },
                        error: function(xhr) {
                            const error = xhr.responseJSON?.error || 'Error al registrar pago';
                            showAlert(error, 'danger');
                        }
                    });
                },
                error: function() {
                    showAlert('Error al obtener información del participante', 'danger');
                }
            });
        }

        // Credits Functions
        function loadCredits() {
            $.ajax({
                url: '/api/customer-credits',
                method: 'GET',
                data: {
                    tenantId: 1,
                    status: 'ACTIVE'
                },
                success: function(response) {
                    displayCredits(response.credits);
                },
                error: function(xhr) {
                    console.error('Error loading credits:', xhr);
                    const tbody = $('#creditsTable tbody');
                    tbody.html(`
                        <tr>
                            <td colspan="7" class="text-center text-danger">
                                Error al cargar créditos
                            </td>
                        </tr>
                    `);
                }
            });
        }
        
        function displayCredits(credits) {
            const tbody = $('#creditsTable tbody');
            tbody.empty();
            
            if (credits.length === 0) {
                tbody.html(`
                    <tr>
                        <td colspan="9" class="text-center text-muted">
                            No hay créditos activos
                        </td>
                    </tr>
                `);
                return;
            }

            credits.forEach(credit => {
                const initialAmount = parseFloat(credit.initialAmount).toFixed(2);
                const currentBalance = parseFloat(credit.currentBalance || 0).toFixed(2);
                const interestAmount = (parseFloat(credit.currentBalance || 0) - parseFloat(credit.initialAmount || 0)).toFixed(2);
                const dueDate = credit.dueDate ? new Date(credit.dueDate).toLocaleDateString('es-ES') : 'Sin fecha límite';

                const startDate = credit.createdAt ? new Date(credit.createdAt) : null;
                const startDateStr = startDate ? startDate.toLocaleDateString('es-ES') : '-';
                const daysElapsed = startDate ? Math.floor((new Date() - startDate) / (1000 * 60 * 60 * 24)) : '-';

                const isOverdue = credit.dueDate && new Date() > new Date(credit.dueDate) && parseFloat(credit.currentBalance) > 0.01;
                const statusBadge = credit.status === 'PAID' ?
                    '<span class="badge bg-success">Pagado</span>' :
                    isOverdue ?
                    '<span class="badge bg-danger">Vencido</span>' :
                    '<span class="badge bg-warning">Activo</span>';

                const customerName = credit.customer ? credit.customer.name : 'N/A';

                const row = `
                    <tr ${isOverdue ? 'class="table-danger"' : ''}>
                        <td>${customerName}</td>
                        <td>$${initialAmount}</td>
                        <td>$${currentBalance}</td>
                        <td>$${interestAmount}</td>
                        <td>${startDateStr}</td>
                        <td>${daysElapsed}</td>
                        <td>${dueDate}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <div class="table-actions">
                                <button class="btn btn-sm btn-outline-success btn-sm-custom" onclick="registerCreditPayment(${credit.id})" title="Registrar Pago">
                                    <i class="bi bi-cash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
        }
        
        function calculateAllInterests() {
            $.ajax({
                url: '/api/customer-credits',
                method: 'GET',
                data: { tenantId: 1, status: 'ACTIVE' },
                success: function(response) {
                    const promises = response.credits.map(credit => {
                        return $.ajax({
                            url: `/api/customer-credits/${credit.id}/calculate-interest?tenantId=1`,
                            method: 'POST'
                        });
                    });
                    
                    Promise.all(promises).then(() => {
                        showAlert('Intereses calculados exitosamente', 'success');
                        loadCredits();
                    }).catch(() => {
                        showAlert('Error al calcular algunos intereses', 'warning');
                        loadCredits();
                    });
                },
                error: function() {
                    showAlert('Error al cargar créditos para calcular intereses', 'danger');
                }
            });
        }
        
        function registerCreditPayment(creditId) {
            $('#creditPaymentCreditId').val(creditId);
            $('#creditPaymentAmount').val('');
            $('#creditPaymentMethod').val('CASH');
            $('#creditPaymentDate').val(new Date().toISOString().split('T')[0]);
            $('#creditPaymentNotes').val('');
            
            $.ajax({
                url: `/api/customer-credits/${creditId}`,
                method: 'GET',
                data: { tenantId: 1 },
                success: function(credit) {
                    $('#creditPaymentBalance').val('$' + parseFloat(credit.currentBalance).toFixed(2));
                    const modal = new bootstrap.Modal(document.getElementById('creditPaymentModal'));
                    modal.show();
                }
            });
        }
        
        function saveCreditPayment() {
            const creditId = $('#creditPaymentCreditId').val();
            const amount = parseFloat($('#creditPaymentAmount').val());
            const paymentMethod = $('#creditPaymentMethod').val();
            const paymentDate = $('#creditPaymentDate').val();
            const notes = $('#creditPaymentNotes').val() || null;
            
            if (!creditId || !amount || amount <= 0 || !paymentMethod) {
                showAlert('Complete todos los campos requeridos', 'warning');
                return;
            }
            
            $.ajax({
                url: `/api/customer-credits/${creditId}`,
                method: 'GET',
                data: { tenantId: 1 },
                success: function(credit) {
                    $.ajax({
                        url: '/api/customer-payments/apply-to-credit',
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({
                            tenantId: 1,
                            creditId: creditId,
                            customerId: credit.customerId,
                            amount: amount,
                            paymentMethod: paymentMethod,
                            paymentDate: paymentDate,
                            notes: notes
                        }),
                        success: function() {
                            showAlert('Pago registrado exitosamente', 'success');
                            bootstrap.Modal.getInstance(document.getElementById('creditPaymentModal')).hide();
                            loadCredits();
                            loadGroupPurchases();
                        },
                        error: function(xhr) {
                            const error = xhr.responseJSON?.error || 'Error al registrar pago';
                            showAlert(error, 'danger');
                        }
                    });
                },
                error: function() {
                    showAlert('Error al obtener información del crédito', 'danger');
                }
            });
        }
        
        function displayUsers(users) {
            const tbody = $('#usersTable tbody');
            tbody.empty();
            
            if (users.length === 0) {
                tbody.html(`
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            No se encontraron usuarios
                        </td>
                    </tr>
                `);
                return;
            }
            
            users.forEach(user => {
                const statusBadge = user.isActive ? 
                    '<span class="badge bg-success">Activo</span>' : 
                    '<span class="badge bg-danger">Inactivo</span>';
                
                const roleBadge = user.role === 'ADMIN' ? 
                    '<span class="badge bg-danger">Administrador</span>' : 
                    '<span class="badge bg-secondary">Empleado</span>';
                
                const lastAccess = user.lastAccess ? 
                    new Date(user.lastAccess).toLocaleDateString('es-ES') : 
                    '<span class="text-muted">Nunca</span>';
                
                const row = `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td>${roleBadge}</td>
                        <td>${statusBadge}</td>
                        <td>${lastAccess}</td>
                        <td>
                            <div class="table-actions">
                                <button class="btn btn-sm btn-outline-primary btn-sm-custom" onclick="editUser(${user.id})" title="Editar">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                ${user.role !== 'ADMIN' || user.id !== 1 ? 
                                    `<button class="btn btn-sm btn-outline-danger btn-sm-custom" onclick="deleteUser(${user.id})" title="Eliminar">
                                        <i class="bi bi-trash"></i>
                                    </button>` : ''
                                }
                            </div>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
        }
        
        function showCreateUserModal() {
            currentEditingUser = null;
            $('#userModalTitle').text('Nuevo usuario');
            $('#userForm')[0].reset();
            $('#userPassword').closest('.mb-3').show();
            $('#userPassword').prop('required', true);
            $('#userPasswordRequired').show();
            
            const modal = new bootstrap.Modal(document.getElementById('userModal'));
            modal.show();
        }
        
        function editUser(userId) {
            $.ajax({
                url: `/api/users/${userId}`,
                method: 'GET',
                data: { tenantId: 1 },
                success: function(user) {
                    currentEditingUser = user;
                    $('#userModalTitle').text('Editar usuario');
                    
                    $('#userName').val(user.name);
                    $('#userEmail').val(user.email);
                    $('#userRole').val(user.role);
                    $('#userStatus').val(user.isActive.toString());
                    $('#userPassword').val('');
                    $('#userPassword').closest('.mb-3').hide();
                    $('#userPassword').prop('required', false);
                    $('#userPasswordRequired').hide();
                    
                    const modal = new bootstrap.Modal(document.getElementById('userModal'));
                    modal.show();
                },
                error: function() {
                    showAlert('Error al cargar datos del usuario', 'danger');
                }
            });
        }
        
        function deleteUser(userId) {
            if (confirm('¿Está seguro de eliminar este usuario? Esta acción no se puede deshacer.')) {
                $.ajax({
                    url: `/api/users/${userId}`,
                    method: 'DELETE',
                    data: { tenantId: 1 },
                    success: function() {
                        showAlert('Usuario eliminado exitosamente.', 'success');
                        loadUsers();
                    },
                    error: function(xhr) {
                        const error = xhr.responseJSON?.error || 'Error al eliminar usuario';
                        showAlert(error, 'danger');
                    }
                });
            }
        }
        
        function saveUser() {
            const formData = {
                tenantId: 1,
                name: $('#userName').val(),
                email: $('#userEmail').val(),
                role: $('#userRole').val(),
                isActive: $('#userStatus').val() === 'true'
            };
            
            const password = $('#userPassword').val();
            if (password) {
                if (password.length < 6) {
                    showAlert('La contraseña debe tener al menos 6 caracteres', 'warning');
                    return;
                }
                formData.password = password;
            }
            
            const isEditing = currentEditingUser !== null;
            if (isEditing && !password) {
                // Password not required when editing
            } else if (!isEditing && !password) {
                showAlert('La contraseña es requerida al crear un usuario', 'warning');
                return;
            }
            
            const url = isEditing ? `/api/users/${currentEditingUser.id}` : '/api/users';
            const method = isEditing ? 'PUT' : 'POST';
            
            $.ajax({
                url: url,
                method: method,
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function() {
                    const message = isEditing ? 'Usuario actualizado exitosamente.' : 'Usuario creado exitosamente.';
                    showAlert(message, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
                    loadUsers();
                    currentEditingUser = null;
                },
                error: function(xhr) {
                    const error = xhr.responseJSON?.error || 'Error al guardar usuario';
                    showAlert(error, 'danger');
                }
            });
        }

        function loadRecentSales() {
            $.ajax({
                url: '/api/sales',
                method: 'GET',
                data: {
                    tenantId: 1,
                    status: 'COMPLETED',
                    limit: 10,
                    page: 1
                },
                success: function(response) {
                    const tbody = $('#recentSalesTable tbody');
                    tbody.empty();
                    
                    if (response.sales.length === 0) {
                        tbody.html(`
                            <tr>
                                <td colspan="5" class="text-center text-muted">
                                    No hay ventas recientes
                                </td>
                            </tr>
                        `);
                        return;
                    }
                    
                    response.sales.forEach(sale => {
                        const date = new Date(sale.createdAt).toLocaleDateString('es-ES', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        
                        const total = parseFloat(sale.totalAmount).toFixed(2);
                        const paymentMethod = sale.paymentMethod === 'CASH' ? 'Efectivo' :
                                             sale.paymentMethod === 'CARD' ? 'Tarjeta' :
                                             sale.paymentMethod === 'TRANSFER' ? 'Transferencia' : sale.paymentMethod;
                        
                        const statusBadge = sale.status === 'COMPLETED' ? 
                            '<span class="badge bg-success">Completada</span>' :
                            '<span class="badge bg-warning">Pendiente</span>';
                        
                        const row = `
                            <tr>
                                <td>${sale.id}</td>
                                <td>${date}</td>
                                <td>$${total}</td>
                                <td>${paymentMethod}</td>
                                <td>${statusBadge}</td>
                            </tr>
                        `;
                        tbody.append(row);
                    });
                },
                error: function() {
                    const tbody = $('#recentSalesTable tbody');
                    tbody.html(`
                        <tr>
                            <td colspan="5" class="text-center text-danger">
                                Error al cargar ventas recientes
                            </td>
                        </tr>
                    `);
                }
            });
        }

        function loadLowStockProducts() {
            $.ajax({
                url: '/api/products',
                method: 'GET',
                data: {
                    tenantId: 1,
                    productType: 'SIMPLE',
                    isActive: true,
                    limit: 100
                },
                success: function(response) {
                    const productIds = response.products.map(p => p.id);
                    
                    if (productIds.length === 0) {
                        $('#lowStockProducts').html(`
                            <div class="text-center text-muted">
                                No hay productos simples
                            </div>
                        `);
                        return;
                    }
                    
                    // Get availability for all products
                    $.ajax({
                        url: '/api/products/availability/bulk',
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({
                            tenantId: 1,
                            productIds: productIds
                        }),
                        success: function(availabilityResponse) {
                            const availabilityMap = {};
                            availabilityResponse.products.forEach(av => {
                                availabilityMap[av.productId] = av;
                            });
                            
                            // Filter products with low stock
                            const lowStockProducts = response.products.filter(product => {
                                const availability = availabilityMap[product.id];
                                if (!availability || availability.productType !== 'SIMPLE') {
                                    return false;
                                }
                                const currentStock = parseFloat(availability.currentStock || 0);
                                const stockMin = parseFloat(product.stockMin || 0);
                                return currentStock <= stockMin;
                            });
                            
                            const container = $('#lowStockProducts');
                            container.empty();
                            
                            if (lowStockProducts.length === 0) {
                                container.html(`
                                    <div class="text-center text-success">
                                        <i class="bi bi-check-circle" style="font-size: 2em;"></i>
                                        <p class="mt-2">Todos los productos tienen stock suficiente</p>
                                    </div>
                                `);
                                return;
                            }
                            
                            // Display low stock products
                            lowStockProducts.forEach(product => {
                                const availability = availabilityMap[product.id];
                                const currentStock = parseFloat(availability.currentStock || 0);
                                const stockMin = parseFloat(product.stockMin || 0);
                                
                                const alertClass = currentStock === 0 ? 'alert-danger' : 'alert-warning';
                                
                                const productHtml = `
                                    <div class="alert ${alertClass} mb-2" role="alert">
                                        <strong>${product.name}</strong><br>
                                        <small>
                                            Stock: <strong>${currentStock}</strong> | 
                                            Mínimo: ${stockMin}
                                        </small>
                                    </div>
                                `;
                                container.append(productHtml);
                            });
                        },
                        error: function() {
                            $('#lowStockProducts').html(`
                                <div class="text-center text-danger">
                                    Error al cargar disponibilidad
                                </div>
                            `);
                        }
                    });
                },
                error: function() {
                    $('#lowStockProducts').html(`
                        <div class="text-center text-danger">
                            Error al cargar productos
                        </div>
                    `);
                }
            });
        }

        // ============ Category Management ============
        var allCategories = [];

        function loadCategoriesForDropdowns() {
            $.ajax({
                url: '/api/product-categories',
                method: 'GET',
                data: { tenantId: 1 },
                success: function(data) {
                    allCategories = data.categories || [];
                    var opts = '<option value="">Sin categoría</option>';
                    allCategories.forEach(function(c) {
                        opts += '<option value="' + c.id + '">' + c.name + '</option>';
                    });
                    $('#productCategory').html(opts);
                    // Filter dropdown
                    var filterOpts = '<option value="">Todas</option>';
                    allCategories.forEach(function(c) {
                        filterOpts += '<option value="' + c.id + '">' + c.name + '</option>';
                    });
                    $('#productCategoryFilter').html(filterOpts);
                },
                error: function() { console.warn('No se pudieron cargar categorías'); }
            });
        }

        var allPresentations = [];

        function loadPresentationsForDropdowns() {
            $.ajax({
                url: '/api/product-presentations',
                method: 'GET',
                data: { tenantId: 1 },
                success: function(data) {
                    allPresentations = data.presentations || [];
                    var opts = '<option value="">Sin presentación</option>';
                    allPresentations.forEach(function(p) {
                        opts += '<option value="' + p.id + '">' + p.name + ' (' + p.unitsPerSale + ' uds)</option>';
                    });
                    $('#productPresentation').html(opts);
                    var filterOpts = '<option value="">Todas</option>';
                    allPresentations.forEach(function(p) {
                        filterOpts += '<option value="' + p.id + '">' + p.name + '</option>';
                    });
                    $('#productPresentationFilter').html(filterOpts);
                },
                error: function() { console.warn('No se pudieron cargar presentaciones'); }
            });
        }

        function loadBaseProductOptions(excludeId) {
            $.ajax({
                url: '/api/products',
                method: 'GET',
                data: { tenantId: 1, productType: 'SIMPLE', isActive: 'true' },
                success: function(data) {
                    var products = (data.products || []).filter(function(p) {
                        return !p.baseProductId && (!excludeId || p.id != excludeId);
                    });
                    var opts = '<option value="">Ninguno (es producto base)</option>';
                    products.forEach(function(p) {
                        opts += '<option value="' + p.id + '">' + p.name + ' (' + p.sku + ')</option>';
                    });
                    $('#productBaseProduct').html(opts);
                },
                error: function() { console.warn('No se pudieron cargar productos base'); }
            });
        }

        // Auto-fill unitsPerSale when presentation changes
        $(document).on('change', '#productPresentation', function() {
            var selId = $(this).val();
            if (selId) {
                var pres = allPresentations.find(function(p) { return p.id == selId; });
                if (pres) {
                    $('#productUnitsPerSale').val(pres.unitsPerSale);
                }
            }
        });

        function showPresentationModal() {
            $('#editingPresentationId').val('');
            $('#newPresentationName').val('');
            $('#newPresentationUnits').val('1');
            $('#newPresentationSortOrder').val('0');
            loadPresentationsInModal();
            var modal = new bootstrap.Modal(document.getElementById('presentationModal'));
            modal.show();
            // Reinicializar tooltips dentro del modal
            document.querySelectorAll('#presentationModal [data-bs-toggle="tooltip"]').forEach(function(el) {
                new bootstrap.Tooltip(el);
            });
        }

        function loadPresentationsInModal() {
            $.ajax({
                url: '/api/product-presentations',
                method: 'GET',
                data: { tenantId: 1 },
                success: function(data) {
                    var items = data.presentations || [];
                    allPresentations = items;
                    if (items.length === 0) {
                        $('#presentationsList').html('<div class="text-center text-muted py-3"><i class="bi bi-inbox me-1"></i>No hay presentaciones creadas.<br><small>Agrega tu primera presentación arriba.</small></div>');
                        return;
                    }
                    var html = '<ul class="list-group list-group-flush">';
                    items.forEach(function(p) {
                        html += '<li class="list-group-item d-flex justify-content-between align-items-center px-1 py-2">';
                        html += '<div>';
                        html += '<strong>' + p.name + '</strong>';
                        html += ' <span class="badge bg-primary ms-1" title="Unidades que se descuentan del inventario por venta">' + p.unitsPerSale + ' ud' + (p.unitsPerSale != 1 ? 's' : '') + '/venta</span>';
                        html += '</div>';
                        html += '<div class="btn-group btn-group-sm">';
                        html += '<button class="btn btn-outline-primary" onclick="editPresentation(' + p.id + ', \'' + p.name.replace(/'/g, "\\'") + '\', ' + p.unitsPerSale + ', ' + p.sortOrder + ')" title="Editar"><i class="bi bi-pencil"></i></button>';
                        html += '<button class="btn btn-outline-danger" onclick="deletePresentation(' + p.id + ')" title="Eliminar"><i class="bi bi-trash"></i></button>';
                        html += '</div></li>';
                    });
                    html += '</ul>';
                    $('#presentationsList').html(html);
                }
            });
        }

        function savePresentation() {
            var name = $('#newPresentationName').val().trim();
            if (!name) { showAlert('El nombre de la presentación es obligatorio', 'warning'); return; }
            var unitsPerSale = parseFloat($('#newPresentationUnits').val()) || 1;
            var sortOrder = parseInt($('#newPresentationSortOrder').val()) || 0;
            var editId = $('#editingPresentationId').val();

            if (editId) {
                $.ajax({
                    url: '/api/product-presentations/' + editId,
                    method: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify({ tenantId: 1, name: name, unitsPerSale: unitsPerSale, sortOrder: sortOrder }),
                    success: function() {
                        $('#editingPresentationId').val('');
                        $('#newPresentationName').val('');
                        $('#newPresentationUnits').val('1');
                        $('#newPresentationSortOrder').val('0');
                        $('#presentationModal .btn-primary').html('<i class="bi bi-plus-lg me-1"></i> Agregar Presentación');
                        loadPresentationsInModal();
                        loadPresentationsForDropdowns();
                        showAlert('Presentación actualizada', 'success');
                    },
                    error: function(xhr) {
                        showAlert(xhr.responseJSON?.error || 'Error al actualizar', 'danger');
                    }
                });
            } else {
                $.ajax({
                    url: '/api/product-presentations',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ tenantId: 1, name: name, unitsPerSale: unitsPerSale, sortOrder: sortOrder }),
                    success: function() {
                        $('#newPresentationName').val('');
                        $('#newPresentationUnits').val('1');
                        $('#newPresentationSortOrder').val('0');
                        loadPresentationsInModal();
                        loadPresentationsForDropdowns();
                        showAlert('Presentación creada', 'success');
                    },
                    error: function(xhr) {
                        showAlert(xhr.responseJSON?.error || 'Error al crear', 'danger');
                    }
                });
            }
        }

        function editPresentation(id, name, units, sortOrder) {
            $('#editingPresentationId').val(id);
            $('#newPresentationName').val(name);
            $('#newPresentationUnits').val(units);
            $('#newPresentationSortOrder').val(sortOrder);
            $('#presentationModal .btn-primary').html('<i class="bi bi-check-lg me-1"></i> Actualizar');
            $('#newPresentationName').focus();
        }

        function deletePresentation(id) {
            if (!confirm('¿Eliminar esta presentación? Los productos asociados quedarán sin presentación.')) return;
            $.ajax({
                url: '/api/product-presentations/' + id + '?tenantId=1',
                method: 'DELETE',
                success: function() {
                    loadPresentationsInModal();
                    loadPresentationsForDropdowns();
                    loadProducts();
                    showAlert('Presentación eliminada', 'success');
                },
                error: function(xhr) {
                    showAlert(xhr.responseJSON?.error || 'Error al eliminar', 'danger');
                }
            });
        }

        function showCategoryModal() {
            $('#editingCategoryId').val('');
            $('#newCategoryName').val('');
            $('#newCategorySortOrder').val('0');
            loadCategoriesInModal();
            var modal = new bootstrap.Modal(document.getElementById('categoryModal'));
            modal.show();
        }

        function loadCategoriesInModal() {
            $.ajax({
                url: '/api/product-categories',
                method: 'GET',
                data: { tenantId: 1 },
                success: function(data) {
                    var cats = data.categories || [];
                    allCategories = cats;
                    if (cats.length === 0) {
                        $('#categoriesList').html('<div class="text-center text-muted py-3">No hay categorías creadas</div>');
                        return;
                    }
                    var html = '<ul class="list-group">';
                    cats.forEach(function(c) {
                        html += '<li class="list-group-item d-flex justify-content-between align-items-center">';
                        html += '<div><strong>' + c.name + '</strong> <small class="text-muted ms-2">Orden: ' + c.sortOrder + '</small></div>';
                        html += '<div>';
                        html += '<button class="btn btn-sm btn-outline-primary me-1" onclick="editCategory(' + c.id + ', \'' + c.name.replace(/'/g, "\\'") + '\', ' + c.sortOrder + ')"><i class="bi bi-pencil"></i></button>';
                        html += '<button class="btn btn-sm btn-outline-danger" onclick="deleteCategory(' + c.id + ')"><i class="bi bi-trash"></i></button>';
                        html += '</div></li>';
                    });
                    html += '</ul>';
                    $('#categoriesList').html(html);
                }
            });
        }

        function saveCategory() {
            var name = $('#newCategoryName').val().trim();
            if (!name) { showAlert('El nombre de la categoría es obligatorio', 'warning'); return; }
            var sortOrder = parseInt($('#newCategorySortOrder').val()) || 0;
            var editId = $('#editingCategoryId').val();

            if (editId) {
                $.ajax({
                    url: '/api/product-categories/' + editId,
                    method: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify({ tenantId: 1, name: name, sortOrder: sortOrder }),
                    success: function() {
                        $('#editingCategoryId').val('');
                        $('#newCategoryName').val('');
                        $('#newCategorySortOrder').val('0');
                        loadCategoriesInModal();
                        loadCategoriesForDropdowns();
                        showAlert('Categoría actualizada', 'success');
                    },
                    error: function(xhr) {
                        showAlert(xhr.responseJSON?.error || 'Error al actualizar', 'danger');
                    }
                });
            } else {
                $.ajax({
                    url: '/api/product-categories',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ tenantId: 1, name: name, sortOrder: sortOrder }),
                    success: function() {
                        $('#newCategoryName').val('');
                        $('#newCategorySortOrder').val('0');
                        loadCategoriesInModal();
                        loadCategoriesForDropdowns();
                        showAlert('Categoría creada', 'success');
                    },
                    error: function(xhr) {
                        showAlert(xhr.responseJSON?.error || 'Error al crear', 'danger');
                    }
                });
            }
        }

        function editCategory(id, name, sortOrder) {
            $('#editingCategoryId').val(id);
            $('#newCategoryName').val(name);
            $('#newCategorySortOrder').val(sortOrder);
            $('#newCategoryName').focus();
        }

        function deleteCategory(id) {
            if (!confirm('¿Eliminar esta categoría? Los productos asociados quedarán sin categoría.')) return;
            $.ajax({
                url: '/api/product-categories/' + id + '?tenantId=1',
                method: 'DELETE',
                success: function() {
                    loadCategoriesInModal();
                    loadCategoriesForDropdowns();
                    loadProducts();
                    showAlert('Categoría eliminada', 'success');
                },
                error: function(xhr) {
                    showAlert(xhr.responseJSON?.error || 'Error al eliminar', 'danger');
                }
            });
        }

        function showCreateProductModal() {
            currentEditingProduct = null;
            $('#productModalTitle').text('Nuevo Producto');
            $('#productForm')[0].reset();
            $('#comboComponentsSection').hide();
            $('#componentsList').empty();
            comboComponents = [];
            
            // Show/hide fields based on product type
            $('#productPurchasePrice').closest('.col-md-4').show();
            $('#productStockMin').closest('.col-md-4').show();
            $('#initialStockSection').show();
            $('#productPurchasePrice').prop('disabled', false);
            $('#productStockMin').prop('disabled', false);
            
            // Reset product type to SIMPLE
            $('#productType').val('SIMPLE').trigger('change');
            $('#productCategory').val('');
            $('#productPresentation').val('');
            $('#productBaseProduct').val('');
            $('#productUnitsPerSale').val('1');
            $('#productTaxApplies').prop('checked', true);
            $('#presentationRow').show();
            
            // Load categories, presentations and component options
            loadCategoriesForDropdowns();
            loadPresentationsForDropdowns();
            loadBaseProductOptions();
            loadComponentOptions();
            
            const modal = new bootstrap.Modal(document.getElementById('productModal'));
            modal.show();
        }

        function editProduct(productId) {
            loadCategoriesForDropdowns();
            loadPresentationsForDropdowns();
            loadBaseProductOptions(productId);
            $.ajax({
                url: `/api/products/${productId}`,
                method: 'GET',
                data: { tenantId: 1 },
                success: function(product) {
                    currentEditingProduct = product;
                    $('#productModalTitle').text('Editar Producto');
                    
                    // Hide initial stock section when editing
                    $('#initialStockSection').hide();
                    
                    // Populate form with product data
                    $('#productName').val(product.name);
                    $('#productSku').val(product.sku);
                    $('#productType').val(product.productType);
                    $('#productSalePrice').val(product.salePrice);
                    $('#productStatus').val(product.isActive.toString());
                    $('#productCategory').val(product.categoryId || '');
                    $('#productTaxApplies').prop('checked', product.taxApplies !== false);

                    // Set presentation/pool fields after a short delay to allow dropdowns to load
                    setTimeout(function() {
                        $('#productPresentation').val(product.presentationId || '');
                        $('#productBaseProduct').val(product.baseProductId || '');
                        $('#productUnitsPerSale').val(product.unitsPerSale || 1);
                    }, 300);
                    
                    if (product.productType === 'SIMPLE') {
                        $('#presentationRow').show();
                    } else {
                        $('#presentationRow').hide();
                    }
                    
                    if (product.productType === 'SIMPLE') {
                        $('#productPurchasePrice').val(product.purchasePrice || '');
                        $('#productStockMin').val(product.stockMin || '');
                        $('#comboComponentsSection').hide();
                        $('#productPurchasePrice').closest('.col-md-4').show();
                        $('#productStockMin').closest('.col-md-4').show();
                        $('#productPurchasePrice').prop('disabled', false);
                        $('#productStockMin').prop('disabled', false);
                    } else {
                        $('#comboComponentsSection').show();
                        $('#productPurchasePrice').closest('.col-md-4').hide();
                        $('#productStockMin').closest('.col-md-4').hide();
                        // Load components for combo
                        loadProductComponents(productId);
                    }
                    
                    // Load image
                    if (product.imageUrl) {
                        $('#imagePreview').html(`
                            <img src="${product.imageUrl}" style="max-width: 100%; max-height: 150px; border-radius: 5px;" alt="Current image">
                            <button type="button" class="btn btn-sm btn-outline-danger mt-2" onclick="removeProductImage()">
                                <i class="bi bi-trash"></i> Quitar imagen
                            </button>
                        `);
                        $('#productImageUrl').val(product.imageUrl);
                    } else {
                        $('#imagePreview').html('');
                        $('#productImageUrl').val('');
                    }
                    
                    const modal = new bootstrap.Modal(document.getElementById('productModal'));
                    modal.show();
                },
                error: function() {
                    showAlert('Error al cargar datos del producto', 'danger');
                }
            });
        }

        function deleteProduct(productId) {
            if (confirm('¿Está seguro de eliminar este producto? Esta acción no se puede deshacer.')) {
                $.ajax({
                    url: `/api/products/${productId}`,
                    method: 'DELETE',
                    data: { tenantId: 1 },
                    success: function() {
                        showAlert('Producto eliminado exitosamente', 'success');
                        loadProducts();
                        loadDashboardData();
                    },
                    error: function(xhr) {
                        const error = xhr.responseJSON?.error || 'Error al eliminar producto';
                        showAlert(error, 'danger');
                    }
                });
            }
        }

        function duplicateProduct(productId) {
            $.ajax({
                url: `/api/products/${productId}`,
                method: 'GET',
                data: { tenantId: 1 },
                success: function(product) {
                    currentEditingProduct = null;
                    $('#productModalTitle').text('Duplicar Producto');
                    
                    // Show initial stock section when duplicating (creating new)
                    $('#initialStockSection').show();
                    
                    // Clear form
                    $('#productForm')[0].reset();
                    $('#comboComponentsSection').hide();
                    $('#componentsList').empty();
                    comboComponents = [];
                    $('#imagePreview').html('');
                    $('#productImageUrl').val('');
                    
                    // Show/hide fields based on product type
                    if (product.productType === 'SIMPLE') {
                        $('#productPurchasePrice').closest('.col-md-4').show();
                        $('#productStockMin').closest('.col-md-4').show();
                        $('#productPurchasePrice').prop('disabled', false);
                        $('#productStockMin').prop('disabled', false);
                    } else {
                        $('#productPurchasePrice').closest('.col-md-4').hide();
                        $('#productStockMin').closest('.col-md-4').hide();
                    }
                    
                    // Populate with duplicated data (without ID)
                    $('#productName').val(product.name + ' (Copiado)');
                    $('#productSku').val(product.sku + '-COPY');
                    $('#productType').val(product.productType);
                    $('#productSalePrice').val(product.salePrice);
                    $('#productStatus').val('true');
                    
                    if (product.productType === 'SIMPLE') {
                        $('#productPurchasePrice').val(product.purchasePrice || '');
                        $('#productStockMin').val(product.stockMin || '');
                        $('#productInitialStock').val('0');
                    }
                    
                    const modal = new bootstrap.Modal(document.getElementById('productModal'));
                    modal.show();
                },
                error: function() {
                    showAlert('Error al cargar datos del producto', 'danger');
                }
            });
        }

        function loadProductComponents(comboId) {
            $.ajax({
                url: `/api/products/${comboId}/components`,
                method: 'GET',
                data: { tenantId: 1 },
                success: function(response) {
                    comboComponents = [];
                    
                    if (response.components && response.components.length > 0) {
                        response.components.forEach(component => {
                            comboComponents.push({
                                componentProductId: component.componentProductId || component.component.id,
                                qty: parseFloat(component.qty)
                            });
                        });
                    }
                    
                    displayComponents();
                },
                error: function(xhr) {
                    console.error('Error loading combo components:', xhr);
                    comboComponents = [];
                    displayComponents();
                }
            });
        }

        function removeProductImage() {
            $('#imagePreview').html('');
            $('#productImageUrl').val('');
            $('#productImage').val('');
        }

        function saveProduct() {
            const isEditing = currentEditingProduct !== null;
            const url = isEditing ? `/api/products/${currentEditingProduct.id}` : '/api/products';
            const method = isEditing ? 'PUT' : 'POST';

            // Check if there's a file to upload
            const imageFile = $('#productImage')[0].files[0];
            const imageUrl = $('#productImageUrl').val();

            // If there's a file, use FormData; otherwise use JSON
            if (imageFile) {
                const formData = new FormData();
                formData.append('image', imageFile);
                formData.append('tenantId', '1');
                formData.append('name', $('#productName').val());
                formData.append('sku', $('#productSku').val());
                formData.append('productType', $('#productType').val());
                formData.append('salePrice', $('#productSalePrice').val());
                formData.append('costMode', 'AVERAGE');
                formData.append('isActive', $('#productStatus').val() === 'true');
                formData.append('categoryId', $('#productCategory').val() || '');
                formData.append('presentationId', $('#productPresentation').val() || '');
                formData.append('baseProductId', $('#productBaseProduct').val() || '');
                formData.append('unitsPerSale', $('#productUnitsPerSale').val() || '1');
                formData.append('taxApplies', $('#productTaxApplies').is(':checked'));

                if ($('#productType').val() === 'SIMPLE') {
                    const stockMin = $('#productStockMin').val();
                    const initialStock = $('#productInitialStock').val();
                    const unitCost = $('#productPurchasePrice').val();
                    
                    if (stockMin) formData.append('stockMin', stockMin);
                    if (initialStock) formData.append('initialStock', initialStock);
                    if (unitCost) formData.append('unitCost', unitCost);
                } else {
                    if (comboComponents && comboComponents.length > 0) {
                        formData.append('components', JSON.stringify(comboComponents));
                    }
                }

                if (imageUrl && !imageFile) {
                    formData.append('imageUrl', imageUrl);
                }

                $.ajax({
                    url: url,
                    method: method,
                    processData: false,
                    contentType: false,
                    data: formData,
                    success: function() {
                        const message = isEditing ? 'Producto actualizado exitosamente' : 'Producto creado exitosamente';
                        showAlert(message, 'success');
                        bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
                        loadProducts();
                        loadDashboardData();
                        currentEditingProduct = null;
                        // Clear image input
                        $('#productImage').val('');
                        $('#productImageUrl').val('');
                        $('#imagePreview').html('');
                    },
                    error: function(xhr) {
                        const error = xhr.responseJSON?.error || 'Error al guardar producto';
                        showAlert(error, 'danger');
                    }
                });
            } else {
                // No file, send as JSON (existing behavior)
                const formData = {
                    tenantId: 1,
                    name: $('#productName').val(),
                    sku: $('#productSku').val(),
                    productType: $('#productType').val(),
                    salePrice: parseFloat($('#productSalePrice').val()),
                    costMode: 'AVERAGE',
                    isActive: $('#productStatus').val() === 'true',
                    imageUrl: imageUrl || null,
                    categoryId: $('#productCategory').val() || null,
                    presentationId: $('#productPresentation').val() || null,
                    baseProductId: $('#productBaseProduct').val() || null,
                    unitsPerSale: parseFloat($('#productUnitsPerSale').val()) || 1,
                    taxApplies: $('#productTaxApplies').is(':checked'),
                    components: $('#productType').val() === 'COMBO' ? comboComponents : undefined
                };

                if ($('#productType').val() === 'SIMPLE') {
                    formData.stockMin = $('#productStockMin').val() ? parseFloat($('#productStockMin').val()) : null;
                    formData.initialStock = $('#productInitialStock').val() ? parseFloat($('#productInitialStock').val()) : 0;
                    formData.unitCost = $('#productPurchasePrice').val() ? parseFloat($('#productPurchasePrice').val()) : null;
                }

                $.ajax({
                    url: url,
                    method: method,
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function() {
                        const message = isEditing ? 'Producto actualizado exitosamente' : 'Producto creado exitosamente';
                        showAlert(message, 'success');
                        bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
                        loadProducts();
                        loadDashboardData();
                        currentEditingProduct = null;
                    },
                    error: function(xhr) {
                        const error = xhr.responseJSON?.error || 'Error al guardar producto';
                        showAlert(error, 'danger');
                    }
                });
            }
        }

        function loadComponentOptions() {
            $.ajax({
                url: '/api/products',
                method: 'GET',
                data: { tenantId: 1, productType: 'SIMPLE', isActive: true, limit: 100 },
                success: function(response) {
                    const select = $('#componentSelect');
                    select.empty();
                    select.append('<option value="">Seleccione un producto...</option>');
                    
                    response.products.forEach(product => {
                        select.append(`
                            <option value="${product.id}">
                                ${product.name} (${product.sku}) - Stock: ${product.currentStock || 'N/A'}
                            </option>
                        `);
                    });
                }
            });
        }

        function addComponent() {
            const componentId = $('#componentSelect').val();
            if (!componentId) {
                showAlert('Seleccione un componente', 'warning');
                return;
            }

            // Check if already added
            if (comboComponents.find(c => c.componentProductId === componentId)) {
                showAlert('Este componente ya fue agregado', 'warning');
                return;
            }

            const componentName = $('#componentSelect option:selected').text();
            comboComponents.push({
                componentProductId: parseInt(componentId),
                qty: 1
            });

            displayComponents();
            $('#componentSelect').val('');
        }

        function displayComponents() {
            const list = $('#componentsList');
            list.empty();

            comboComponents.forEach((component, index) => {
                const componentHtml = `
                    <div class="card mb-2">
                        <div class="card-body p-2">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <strong>Componente ${index + 1}</strong>
                                </div>
                                <div class="col-md-3">
                                    <input type="number" class="form-control form-control-sm" 
                                           value="${component.qty}" min="0.001" step="0.001"
                                           onchange="updateComponentQty(${index}, this.value)"
                                           placeholder="Cantidad">
                                </div>
                                <div class="col-md-3">
                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeComponent(${index})">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                list.append(componentHtml);
            });
        }

        function updateComponentQty(index, qty) {
            comboComponents[index].qty = parseFloat(qty);
        }

        function removeComponent(index) {
            comboComponents.splice(index, 1);
            displayComponents();
        }

        function showCreatePurchaseModal() {
            $('#purchaseForm')[0].reset();
            $('#purchaseDate').val(new Date().toISOString().split('T')[0]);
            $('#purchaseCreditDays').val(0);
            purchaseItems = [];
            updatePurchaseItemsTable();
            // Load suppliers into the select
            $.ajax({
                url: '/api/suppliers',
                method: 'GET',
                data: { tenantId: 1, isActive: 'true', limit: 200 },
                success: function(response) {
                    const sel = $('#purchaseSupplierId');
                    sel.find('option:not(:first)').remove();
                    response.suppliers.forEach(function(s) {
                        sel.append(`<option value="${s.id}" data-credit="${s.creditDays}">${s.supplierCode ? s.supplierCode + ' — ' : ''}${s.name}</option>`);
                    });
                }
            });
            const modal = new bootstrap.Modal(document.getElementById('purchaseModal'));
            modal.show();
        }

        function onPurchaseSupplierChange() {
            const selected = $('#purchaseSupplierId option:selected');
            const creditDays = selected.data('credit');
            if (creditDays !== undefined && creditDays !== '') {
                $('#purchaseCreditDays').val(creditDays);
            }
        }

        function addPurchaseItem() {
            // Load simple products for selection
            $.ajax({
                url: '/api/products',
                method: 'GET',
                data: {
                    tenantId: 1,
                    productType: 'SIMPLE',
                    isActive: true,
                    limit: 100
                },
                success: function(response) {
                    const select = $('#purchaseItemProduct');
                    select.empty();
                    select.append('<option value="">Seleccione un producto...</option>');
                    
                    response.products.forEach(product => {
                        select.append(`
                            <option value="${product.id}" data-price="${product.salePrice}">
                                ${product.name} (${product.sku})
                            </option>
                        `);
                    });
                    
                    // Set suggested sale price when product is selected
                    $('#purchaseItemProduct').change(function() {
                        const selectedOption = $(this).find('option:selected');
                        const suggestedPrice = selectedOption.data('price');
                        if (suggestedPrice) {
                            // Could show suggested price somewhere
                        }
                    });
                    
                    const modal = new bootstrap.Modal(document.getElementById('purchaseItemModal'));
                    modal.show();
                },
                error: function() {
                    showAlert('Error al cargar productos', 'danger');
                }
            });
        }
        
        function confirmAddPurchaseItem() {
            const productId = $('#purchaseItemProduct').val();
            const quantity = parseFloat($('#purchaseItemQuantity').val());
            const unitCost = parseFloat($('#purchaseItemUnitCost').val());
            
            if (!productId || !quantity || quantity <= 0 || !unitCost || unitCost < 0) {
                showAlert('Por favor complete todos los campos correctamente', 'warning');
                return;
            }
            
            // Get product name
            const productName = $('#purchaseItemProduct option:selected').text();
            
            // Check if product already in cart
            const existingIndex = purchaseItems.findIndex(item => item.productId === parseInt(productId));
            if (existingIndex >= 0) {
                // Update existing item
                purchaseItems[existingIndex].quantity += quantity;
                purchaseItems[existingIndex].unitCost = (purchaseItems[existingIndex].unitCost + unitCost) / 2; // Average cost
            } else {
                // Add new item
                purchaseItems.push({
                    productId: parseInt(productId),
                    productName: productName,
                    quantity: quantity,
                    unitCost: unitCost
                });
            }
            
            updatePurchaseItemsTable();
            
            // Close modal and reset form
            bootstrap.Modal.getInstance(document.getElementById('purchaseItemModal')).hide();
            $('#purchaseItemForm')[0].reset();
        }

        function updatePurchaseItemsTable() {
            const tbody = $('#purchaseItemsTable tbody');
            
            if (purchaseItems.length === 0) {
                tbody.html(`
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            Haga clic en "Agregar Producto" para añadir items
                        </td>
                    </tr>
                `);
                $('#purchaseTotal').text('$0.00');
                return;
            }
            
            tbody.empty();
            let total = 0;
            
            purchaseItems.forEach((item, index) => {
                const subtotal = item.quantity * item.unitCost;
                total += subtotal;
                
                // Get suggested sale price (would need to fetch from product)
                const suggestedPrice = item.unitCost * 1.5; // Simple markup
                
                const row = `
                    <tr>
                        <td>${item.productName}</td>
                        <td>
                            <input type="number" class="form-control form-control-sm" 
                                   value="${item.quantity}" step="0.001" min="0.001"
                                   onchange="updatePurchaseItemQuantity(${index}, this.value)">
                        </td>
                        <td>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" 
                                       value="${item.unitCost.toFixed(2)}" step="0.01" min="0"
                                       onchange="updatePurchaseItemCost(${index}, this.value)">
                            </div>
                        </td>
                        <td>$${suggestedPrice.toFixed(2)}</td>
                        <td>$${subtotal.toFixed(2)}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger" onclick="removePurchaseItem(${index})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
            
            $('#purchaseTotal').text('$' + total.toFixed(2));
        }
        
        function updatePurchaseItemQuantity(index, quantity) {
            if (quantity > 0) {
                purchaseItems[index].quantity = parseFloat(quantity);
                updatePurchaseItemsTable();
            }
        }
        
        function updatePurchaseItemCost(index, cost) {
            if (cost >= 0) {
                purchaseItems[index].unitCost = parseFloat(cost);
                updatePurchaseItemsTable();
            }
        }
        
        function removePurchaseItem(index) {
            purchaseItems.splice(index, 1);
            updatePurchaseItemsTable();
        }

        function savePurchase() {
            if (purchaseItems.length === 0) {
                showAlert('Debe agregar al menos un producto a la compra', 'warning');
                return;
            }

            const supplierId = $('#purchaseSupplierId').val() || null;
            const purchaseDate = $('#purchaseDate').val();
            const invoiceNumber = $('#purchaseInvoice').val() || null;
            const creditDays = parseInt($('#purchaseCreditDays').val()) || 0;
            const notes = $('#purchaseNotes').val() || null;

            if (!purchaseDate) {
                showAlert('La fecha de compra es requerida', 'warning');
                return;
            }

            const items = purchaseItems.map(item => ({
                productId: item.productId,
                quantity: item.quantity,
                unitCost: item.unitCost
            }));

            $.ajax({
                url: '/api/purchases',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    tenantId: 1,
                    supplierId: supplierId ? parseInt(supplierId) : null,
                    purchaseDate: purchaseDate,
                    invoiceNumber: invoiceNumber,
                    creditDays: creditDays,
                    items: items,
                    notes: notes
                }),
                success: function() {
                    showAlert('Compra registrada exitosamente', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('purchaseModal')).hide();
                    purchaseItems = [];
                    updatePurchaseItemsTable();
                    $('#purchaseForm')[0].reset();
                    loadPurchases();
                    loadProducts();
                    loadDashboardData();
                },
                error: function(xhr) {
                    const error = xhr.responseJSON?.error || 'Error al guardar la compra';
                    showAlert(error, 'danger');
                }
            });
        }

        // Variables for Products section real-time search
        let allProductsList = [];
        let productSearchTimeout = null;

        function filterProducts() {
            loadProducts();
        }
        
        // Real-time search for Products section
        function filterProductsRealtime(searchTerm) {
            let filtered = allProductsList;
            
            // Apply type filter if selected
            const typeFilter = $('#productTypeFilter').val();
            if (typeFilter) {
                filtered = filtered.filter(product => product.productType === typeFilter);
            }

            // Apply category filter if selected
            const catFilter = $('#productCategoryFilter').val();
            if (catFilter) {
                filtered = filtered.filter(product => String(product.categoryId) === catFilter);
            }

            // Apply presentation filter if selected
            const presFilter = $('#productPresentationFilter').val();
            if (presFilter) {
                filtered = filtered.filter(product => String(product.presentationId) === presFilter);
            }
            
            // Apply status filter if selected
            const statusFilter = $('#productStatusFilter').val();
            if (statusFilter !== '') {
                const isActive = statusFilter === 'true';
                filtered = filtered.filter(product => product.isActive === isActive);
            }
            
            // Apply search term filter
            if (searchTerm && searchTerm.length > 0) {
                const term = searchTerm.toLowerCase();
                filtered = filtered.filter(product => {
                    const nameMatch = product.name.toLowerCase().includes(term);
                    const skuMatch = product.sku.toLowerCase().includes(term);
                    return nameMatch || skuMatch;
                });
            }

            displayProducts(filtered);
        }

        let allSellProducts = []; // Store all products for local filtering
        let sellSearchTimeout = null;

        function loadSellFilterOptions() {
            var catVal = $('#sellCategoryFilter').val();
            var presVal = $('#sellPresentationFilter').val();
            $.ajax({
                url: '/api/product-categories',
                method: 'GET',
                data: { tenantId: 1 },
                success: function(data) {
                    var cats = data.categories || [];
                    var opts = '<option value="">Todas las categorías</option>';
                    cats.forEach(function(c) { opts += '<option value="' + c.id + '">' + (c.name || '').replace(/</g, '&lt;') + '</option>'; });
                    $('#sellCategoryFilter').html(opts).val(catVal || '');
                }
            });
            $.ajax({
                url: '/api/product-presentations',
                method: 'GET',
                data: { tenantId: 1 },
                success: function(data) {
                    var items = data.presentations || [];
                    var opts = '<option value="">Todas las presentaciones</option>';
                    items.forEach(function(p) { opts += '<option value="' + p.id + '">' + (p.name || '').replace(/</g, '&lt;') + '</option>'; });
                    $('#sellPresentationFilter').html(opts).val(presVal || '');
                }
            });
        }

        function loadSellProducts() {
            loadSellFilterOptions();
            // Load all products with availability
            $.ajax({
                url: '/api/products',
                method: 'GET',
                data: { 
                    tenantId: 1, 
                    isActive: true, 
                    limit: 500
                },
                success: function(response) {
                    const productIds = response.products.map(p => p.id);
                    
                    // Get availability for all products
                    $.ajax({
                        url: '/api/products/availability/bulk',
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({
                            tenantId: 1,
                            productIds: productIds
                        }),
                        success: function(availabilityResponse) {
                            // Merge availability data with products
                            const productsWithStock = response.products.map(product => {
                                const availability = availabilityResponse.products.find(av => av.productId === product.id);
                                return {
                                    ...product,
                                    currentStock: availability ? availability.currentStock : 0,
                                    availableStock: availability ? availability.availableStock : 0
                                };
                            });
                            allSellProducts = productsWithStock;
                            applySellFilters();
                        },
                        error: function() {
                            allSellProducts = response.products.map(p => ({ ...p, currentStock: 0, availableStock: 0 }));
                            applySellFilters();
                        }
                    });
                },
                error: function() {
                    showAlert('Error al cargar productos', 'danger');
                }
            });
        }

        function applySellFilters() {
            const searchTerm = ($('#sellProductSearch').val() || '').trim().toLowerCase();
            const typeFilter = ($('#sellTypeFilter').val() || '').trim();
            const categoryId = ($('#sellCategoryFilter').val() || '').trim();
            const presentationId = ($('#sellPresentationFilter').val() || '').trim();
            let filtered = allSellProducts;
            if (typeFilter) {
                filtered = filtered.filter(p => (p.productType || '') === typeFilter);
            }
            if (categoryId) {
                const cid = parseInt(categoryId, 10);
                filtered = filtered.filter(p => parseInt(p.categoryId, 10) === cid);
            }
            if (presentationId) {
                const pid = parseInt(presentationId, 10);
                filtered = filtered.filter(p => parseInt(p.presentationId, 10) === pid);
            }
            if (searchTerm) {
                filtered = filtered.filter(p => (p.name || '').toLowerCase().indexOf(searchTerm) >= 0);
            }
            displaySellProducts(filtered);
        }

        function displaySellProducts(products) {
            const grid = $('#sellProductsGrid');
            grid.empty();

            if (products.length === 0) {
                grid.html(`
                    <div class="col-12 text-center text-muted py-5">
                        <i class="bi bi-inbox" style="font-size: 3em;"></i>
                        <p class="mt-3">No se encontraron productos</p>
                    </div>
                `);
                return;
            }

            products.forEach(product => {
                const isCombo = product.productType === 'COMBO';
                const stockInfo = isCombo ? (product.availableStock || 0) : (product.currentStock || 0);
                const cartItem = sellCart.find(item => parseInt(item.productId) === parseInt(product.id));
                const cartQty = cartItem ? cartItem.quantity : 0;
                const effectiveStock = Math.max(0, stockInfo - cartQty);
                const isAvailable = effectiveStock > 0;
                const stockClass = effectiveStock > 10 ? 'sell-catalog-stock-available' :
                    effectiveStock > 0 ? 'sell-catalog-stock-low' : 'sell-catalog-stock-out';
                const stockText = effectiveStock > 0 ? `Stock: ${effectiveStock}` : 'Sin stock';
                const nameEscaped = (product.name || '').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
                const cardClass = 'sell-catalog-card' + (isAvailable ? '' : ' disabled');
                const cardOnClick = isAvailable ? `onclick="addProductToCartFromCard(${product.id})"` : '';

                const productCard = `
                    <div class="col-12 col-sm-6 col-lg-3 mb-3">
                        <div class="${cardClass} position-relative" ${cardOnClick}>
                            ${isCombo ? '<span class="sell-catalog-combo-badge">COMBO</span>' : ''}
                            ${cartQty > 0 ? `<span class="badge bg-primary position-absolute" style="top: 8px; left: 8px; z-index: 1; font-size: 0.8em;">${cartQty}</span>` : ''}
                            <div class="sell-catalog-card-image-wrap">
                                ${product.imageUrl ? `<img src="${product.imageUrl}" alt="${nameEscaped}">` : '<div class="sell-catalog-card-image-placeholder"><i class="bi bi-image"></i></div>'}
                            </div>
                            <div class="sell-catalog-card-body">
                                <h5 class="mb-0">${nameEscaped}</h5>
                                <span class="sell-catalog-stock-badge ${stockClass}">${stockText}</span>
                                <div class="d-flex justify-content-between align-items-center mt-1">
                                    <strong class="text-primary">$${parseFloat(product.salePrice || 0).toFixed(2)}</strong>
                                    <button type="button" class="btn btn-primary btn-sm" onclick="event.stopPropagation(); addProductToCartFromCard(${product.id})" ${!isAvailable ? 'disabled' : ''}>
                                        <i class="bi bi-cart-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                grid.append(productCard);
            });
        }

        // Real-time search and type filter (Vender - estilo catálogo)
        $(document).ready(function() {
            $('#sellProductSearch').on('input', function() {
                if (sellSearchTimeout) clearTimeout(sellSearchTimeout);
                sellSearchTimeout = setTimeout(applySellFilters, 300);
            });
            $('#sellProductSearch').on('keypress', function(e) {
                if (e.which === 13) {
                    e.preventDefault();
                    if (sellSearchTimeout) clearTimeout(sellSearchTimeout);
                    applySellFilters();
                }
            });
            $('#sellTypeFilter').on('change', applySellFilters);
            $('#sellCategoryFilter').on('change', applySellFilters);
            $('#sellPresentationFilter').on('change', applySellFilters);

            // Real-time search for Products section (Gestion de Productos)
            $('#productSearch').on('input', function() {
                const searchTerm = $(this).val().trim();
                
                // Clear previous timeout
                if (productSearchTimeout) {
                    clearTimeout(productSearchTimeout);
                }
                
                // Debounce search
                productSearchTimeout = setTimeout(function() {
                    filterProductsRealtime(searchTerm);
                }, 300); // 300ms delay
            });
            
            // Allow Enter key to trigger immediate search in Products section
            $('#productSearch').on('keypress', function(e) {
                if (e.which === 13) { // Enter key
                    e.preventDefault();
                    if (productSearchTimeout) {
                        clearTimeout(productSearchTimeout);
                    }
                    const searchTerm = $(this).val().trim();
                    filterProductsRealtime(searchTerm);
                }
            });
            
            // Real-time filter by product type
            $('#productTypeFilter').on('change', function() {
                const searchTerm = $('#productSearch').val().trim();
                filterProductsRealtime(searchTerm);
            });
            
            // Real-time filter by product status
            $('#productStatusFilter').on('change', function() {
                const searchTerm = $('#productSearch').val().trim();
                filterProductsRealtime(searchTerm);
            });

            // Real-time filter by product category
            $('#productCategoryFilter').on('change', function() {
                const searchTerm = $('#productSearch').val().trim();
                filterProductsRealtime(searchTerm);
            });
            $('#productPresentationFilter').on('change', function() {
                const searchTerm = $('#productSearch').val().trim();
                filterProductsRealtime(searchTerm);
            });

            // Load category and presentation dropdowns on startup
            loadCategoriesForDropdowns();
            loadPresentationsForDropdowns();
        });

        function filterSellProducts(searchTerm) {
            if (!searchTerm || searchTerm.length === 0) {
                applySellFilters();
                return;
            }
            const term = searchTerm.toLowerCase();
            const typeFilter = ($('#sellTypeFilter').val() || '').trim();
            let filtered = allSellProducts.filter(p => {
                const name = (p.name || '').toLowerCase();
                const sku = (p.sku || '').toLowerCase();
                return name.indexOf(term) >= 0 || sku.indexOf(term) >= 0;
            });
            if (typeFilter) filtered = filtered.filter(p => (p.productType || '') === typeFilter);
            displaySellProducts(filtered);
        }

        function clearSellSearch() {
            $('#sellProductSearch').val('');
            $('#sellTypeFilter').val('');
            applySellFilters();
        }

        function searchSellProducts() {
            applySellFilters();
        }

        let sellCart = [];
        let isGroupSale = false;
        let selectedCustomers = [];
        let groupSaleParticipants = [];
        let manualAmountDivision = false;
        let allCustomersList = [];

        // Add product to cart from card button
        function addProductToCartFromCard(productId) {
            addToSellCart(productId);
        }

        // Remove product from cart from card button
        function removeProductFromCartFromCard(productId) {
            const cartIndex = sellCart.findIndex(item => parseInt(item.productId) === parseInt(productId));
            if (cartIndex !== -1) {
                if (sellCart[cartIndex].quantity > 1) {
                    sellCart[cartIndex].quantity -= 1;
                } else {
                    sellCart.splice(cartIndex, 1);
                }
                updateSellCart();
                if (allSellProducts.length > 0) applySellFilters();
            }
        }

        function addToSellCart(productId) {
            // Find product in allSellProducts (already has stock info loaded)
            // Use parseInt to ensure type matching (API returns id as string)
            const product = allSellProducts.find(p => parseInt(p.id) === parseInt(productId));
            
            if (!product) {
                showAlert('Producto no encontrado', 'warning');
                return;
            }
            
            // Get availability from cached data
            const isCombo = product.productType === 'COMBO';
            let stockInfo;
            
            if (isCombo) {
                stockInfo = product.availableStock || 0;
            } else {
                stockInfo = product.currentStock || 0;
            }
            
            if (stockInfo === 0) {
                showAlert('Producto sin stock disponible', 'warning');
                return;
            }

            // Check if already in cart
            const existingItem = sellCart.find(item => parseInt(item.productId) === parseInt(productId));
            if (existingItem) {
                if (existingItem.quantity >= stockInfo) {
                    showAlert('No hay suficiente stock disponible', 'warning');
                    return;
                }
                existingItem.quantity += 1;
            } else {
                sellCart.push({
                    productId: product.id,
                    productName: product.name,
                    productSku: product.sku,
                    productType: product.productType,
                    unitPrice: parseFloat(product.salePrice),
                    quantity: 1,
                    maxAvailable: stockInfo,
                    imageUrl: product.imageUrl || null
                });
            }

            showAlert('Producto agregado con éxito!', 'success');
            updateSellCart();
        }

        function updateSellCart() {
            const cartBubble = $('#sellCartBubble');
            const cartBubbleBadge = $('#sellCartBubbleBadge');
            const bottomBar = $('#sellCartBottomBar');
            
            let totalItems = 0;
            let totalAmount = 0;
            sellCart.forEach(item => {
                totalItems += item.quantity;
                totalAmount += item.unitPrice * item.quantity;
            });
            
            // Barra inferior: solo visible en sección "Vender" y cuando hay ítems (como en cliente)
            const activeSection = ($('.content-section.active').attr('id') || '').toLowerCase();
            const showBar = totalItems > 0 && activeSection === 'sell';
            if (showBar) {
                bottomBar.addClass('sell-cart-bar-visible').attr('aria-hidden', 'false');
                document.body.classList.add('sell-cart-bar-visible');
                $('#sellCartBarItems').text(totalItems === 1 ? '1 item' : totalItems + ' items');
                $('#sellCartBarTotal').text('Total: $' + totalAmount.toFixed(2));
                cartBubble.removeClass('show');
                cartBubbleBadge.text('0');
            } else {
                bottomBar.removeClass('sell-cart-bar-visible').attr('aria-hidden', 'true');
                document.body.classList.remove('sell-cart-bar-visible');
                $('#sellCartBarItems').text('0 items');
                $('#sellCartBarTotal').text('Total: $0.00');
            }
            
            updateSellCartModal();
            if (allSellProducts.length > 0) applySellFilters();
        }

        function updateSellCartModal() {
            const cartModalItems = $('#sellCartModalItems');
            const cartModalCount = $('#sellCartModalCount');
            
            // Calcular total de items
            let totalItems = 0;
            sellCart.forEach(item => {
                totalItems += item.quantity;
            });
            
            cartModalCount.text(totalItems);
            
            if (sellCart.length === 0) {
                cartModalItems.html(`
                    <div class="text-center py-5">
                        <i class="bi bi-cart-x" style="font-size: 4em; color: #ccc;"></i>
                        <h5 class="mt-3 text-muted">El carrito está vacío</h5>
                        <p class="text-muted small">Agregue productos desde el catálogo de venta</p>
                    </div>
                `);
                $('#sellCartModalPay').prop('disabled', true);
            } else {
                let cartHtml = '';
                let subtotal = 0;

                sellCart.forEach((item, index) => {
                    const itemTotal = item.unitPrice * item.quantity;
                    subtotal += itemTotal;
                    const nameEscaped = (item.productName || '').replace(/"/g, '&quot;');
                    const imageHtml = item.imageUrl ?
                        `<img src="${item.imageUrl}" alt="${nameEscaped}">` :
                        `<div class="cart-image-placeholder"><i class="bi bi-image"></i></div>`;
                    const leftBtn = item.quantity === 1
                        ? `<button class="btn btn-sm btn-danger" onclick="removeFromSellCart(${index}); updateSellCartModal();" title="Eliminar"><i class="bi bi-trash"></i></button>`
                        : `<button class="btn btn-sm" onclick="updateSellCartQuantity(${index}, ${item.quantity - 1}); updateSellCartModal();"><i class="bi bi-dash"></i></button>`;

                    cartHtml += `
                        <div class="cart-item">
                            <div class="cart-item-image-wrap">${imageHtml}</div>
                            <div class="cart-item-body">
                                <h5>${item.productName}</h5>
                                <div class="cart-item-price-row">
                                    <strong class="text-primary">$${itemTotal.toFixed(2)}</strong>
                                    <div class="quantity-controls">
                                        ${leftBtn}
                                        <span>${item.quantity}</span>
                                        <button class="btn btn-sm" onclick="updateSellCartQuantity(${index}, ${item.quantity + 1}); updateSellCartModal();" ${item.quantity >= item.maxAvailable ? 'disabled' : ''}><i class="bi bi-plus"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                });

                cartModalItems.html(cartHtml);
                
                const tax = (taxEnabled && currentTaxRate != null) ? subtotal * (currentTaxRate / 100) : 0;
                const total = subtotal + tax;
                
                $('#sellCartModalSubtotal').text(`$${subtotal.toFixed(2)}`);
                $('#sellCartModalTax').text(`$${tax.toFixed(2)}`);
                $('#sellCartModalTotal').text(`$${total.toFixed(2)}`);
                if (taxEnabled && currentTaxRate != null) {
                    $('.tax-row-pos').removeClass('d-none').addClass('d-flex');
                    $('#sellCartModalTaxLabel').text(`IVA (${currentTaxRate.toFixed(0)}%):`);
                } else {
                    $('.tax-row-pos').removeClass('d-flex').addClass('d-none');
                }
                
                // Update button text and enable/disable
                if (isGroupSale) {
                    $('#sellCartModalPayButtonText').text('Procesar Venta Grupal');
                    $('#sellCartModalPay').prop('disabled', sellCart.length === 0 || gsParticipantes.length === 0);
                } else {
                    $('#sellCartModalPayButtonText').text('Procesar Venta');
                    $('#sellCartModalPay').prop('disabled', sellCart.length === 0);
                }
                
                // Update group sale participants if active
                if (isGroupSale && groupSaleParticipants.length > 0) {
                    calculateEqualDivision();
                    updateGroupSaleParticipantsTableModal();
                }
            }
        }
        
        function openSellCartModal() {
            // Sincronizar estado de venta grupal
            $('#sellCartModalGroupSaleToggle').prop('checked', isGroupSale);
            if (isGroupSale) {
                $('#sellCartModalNormalSaleFields').hide();
                $('#sellCartModalGroupSaleFields').show();
                if (allCustomersList.length === 0) {
                    loadGroupSaleCustomersModal();
                } else {
                    filterGroupSaleCustomersModal('');
                }
            } else {
                $('#sellCartModalNormalSaleFields').show();
                $('#sellCartModalGroupSaleFields').hide();
            }
            
            // Sincronizar campos de pago
            $('#sellCartModalPaymentMethod').val($('#sellPaymentMethod').val() || 'CASH');
            $('#sellCartModalCustomer').val($('#sellCustomer').val() || '');
            $('#sellCartModalTransferReference').val($('#sellTransferReference').val() || '');
            $('#sellCartModalCustomerId').val('');
            $('#sellCartModalCustomerSearch').val('');
            $('#clearCustomerBtn').hide();
            $('#sellCartModalCustomersList').hide();
            togglePaymentMethodFieldsModal();
            
            updateSellCartModal();
            const cartModal = new bootstrap.Modal(document.getElementById('sellCartModal'));
            cartModal.show();
        }

        function updateSellCartQuantity(index, quantity) {
            if (quantity < 1 || quantity > sellCart[index].maxAvailable) {
                return;
            }
            sellCart[index].quantity = quantity;
            updateSellCart();
        }

        function removeFromSellCart(index) {
            sellCart.splice(index, 1);
            updateSellCart();
        }

        function toggleTransferReference() {
            const paymentMethod = $('#sellPaymentMethod').val();
            if (paymentMethod === 'TRANSFER') {
                $('#transferReferenceField').show();
                $('#sellTransferReference').prop('required', true);
            } else {
                $('#transferReferenceField').hide();
                $('#sellTransferReference').prop('required', false);
                $('#sellTransferReference').val('');
            }
        }
        
        function toggleTransferReferenceModal() {
            const paymentMethod = $('#sellCartModalPaymentMethod').val();
            if (paymentMethod === 'TRANSFER') {
                $('#sellCartModalTransferReferenceField').show();
                $('#sellCartModalTransferReference').prop('required', true);
            } else {
                $('#sellCartModalTransferReferenceField').hide();
                $('#sellCartModalTransferReference').prop('required', false);
                $('#sellCartModalTransferReference').val('');
            }
        }
        
        function togglePaymentMethodFieldsModal() {
            const paymentMethod = $('#sellCartModalPaymentMethod').val();
            
            // Manejar campo de transferencia
            if (paymentMethod === 'TRANSFER') {
                $('#sellCartModalTransferReferenceField').show();
                $('#sellCartModalTransferReference').prop('required', true);
                $('#sellCartModalCreditFields').hide();
                $('#sellCartModalCreditDueDate').prop('required', false);
                // Cliente opcional
                $('#sellCartModalCustomerTextContainer').show();
                $('#sellCartModalCustomerSelectContainer').hide();
                $('#sellCartModalCustomerLabel').html('Cliente (Opcional)');
                $('#sellCartModalCustomer').prop('required', false);
                $('#sellCartModalCustomerId').val('');
            } else if (paymentMethod === 'CREDIT') {
                $('#sellCartModalTransferReferenceField').hide();
                $('#sellCartModalTransferReference').prop('required', false);
                $('#sellCartModalTransferReference').val('');
                $('#sellCartModalCreditFields').show();
                $('#sellCartModalCreditDueDate').prop('required', true);
                // Establecer fecha mínima como hoy
                const today = new Date().toISOString().split('T')[0];
                $('#sellCartModalCreditDueDate').attr('min', today);
                // Cliente obligatorio con selector
                $('#sellCartModalCustomerTextContainer').hide();
                $('#sellCartModalCustomerSelectContainer').show();
                $('#sellCartModalCustomerLabel').html('Cliente <span class="text-danger">*</span>');
                $('#sellCartModalCustomerId').prop('required', true);
                // Ocultar dropdown inicialmente
                $('#sellCartModalCustomersList').hide();
                // Cargar clientes si no están cargados (pero no mostrar la lista)
                if (!allCustomersList || allCustomersList.length === 0) {
                    loadCustomersForCredit(false); // false = no mostrar automáticamente
                } else {
                    // Solo preparar la lista, no mostrarla
                    filterCustomersForCredit('');
                }
            } else {
                $('#sellCartModalTransferReferenceField').hide();
                $('#sellCartModalTransferReference').prop('required', false);
                $('#sellCartModalTransferReference').val('');
                $('#sellCartModalCreditFields').hide();
                $('#sellCartModalCreditDueDate').prop('required', false);
                // Cliente opcional
                $('#sellCartModalCustomerTextContainer').show();
                $('#sellCartModalCustomerSelectContainer').hide();
                $('#sellCartModalCustomerLabel').html('Cliente (Opcional)');
                $('#sellCartModalCustomer').prop('required', false);
                $('#sellCartModalCustomerId').val('');
            }
        }
        
        function loadCustomersForCredit(showDropdown = false) {
            $.ajax({
                url: '/api/customers',
                method: 'GET',
                data: { tenantId: 1, isActive: true, limit: 500 },
                success: function(response) {
                    allCustomersList = response.customers || [];
                    // Preparar la lista pero no mostrarla automáticamente
                    filterCustomersForCredit('');
                    // Solo mostrar si se solicita explícitamente
                    if (showDropdown && $('#sellCartModalPaymentMethod').val() === 'CREDIT') {
                        setTimeout(() => {
                            showCustomersDropdown();
                        }, 50);
                    }
                },
                error: function() {
                    allCustomersList = [];
                    $('#sellCartModalCustomersList').html('<div class="text-danger text-center py-3">Error al cargar clientes</div>');
                }
            });
        }
        
        function filterCustomersForCredit(searchTerm) {
            const list = $('#sellCartModalCustomersList');
            list.empty();
            
            if (!allCustomersList || allCustomersList.length === 0) {
                list.html('<div class="text-muted text-center py-3">No hay clientes disponibles</div>');
                return;
            }
            
            const search = searchTerm ? searchTerm.toLowerCase().trim() : '';
            const filtered = allCustomersList.filter(customer => {
                if (!search) return true;
                return customer.name.toLowerCase().includes(search) ||
                       (customer.email && customer.email.toLowerCase().includes(search)) ||
                       (customer.cedula && customer.cedula.toLowerCase().includes(search));
            });
            
            if (filtered.length === 0) {
                list.html('<div class="text-muted text-center py-3">No se encontraron clientes</div>');
                return;
            }
            
            filtered.forEach(customer => {
                const isSelected = $('#sellCartModalCustomerId').val() == customer.id;
                const customerHtml = `
                    <div class="form-check ${isSelected ? 'selected' : ''}" 
                         onclick="selectCustomerForCredit(${customer.id}, '${customer.name.replace(/'/g, "\\'")}')">
                        <label class="form-check-label" style="cursor: pointer; width: 100%; padding-left: 0;">
                            ${highlightMatch(customer.name, search)}
                        </label>
                    </div>
                `;
                list.append(customerHtml);
            });
            
            // NO mostrar dropdown automáticamente - solo cuando el usuario haga clic en el campo
        }
        
        function highlightMatch(text, search) {
            if (!search) return text;
            const regex = new RegExp(`(${search})`, 'gi');
            return text.replace(regex, '<strong>$1</strong>');
        }
        
        function showCustomersDropdown() {
            const list = $('#sellCartModalCustomersList');
            if ($('#sellCartModalPaymentMethod').val() !== 'CREDIT' || list.children().length === 0) return;
            // Posicionar fixed debajo del input para evitar problemas de z-index/overflow en mobile
            const input = document.getElementById('sellCartModalCustomerSearch');
            const rect = input.getBoundingClientRect();
            list.css({
                position: 'fixed',
                top: (rect.bottom + 2) + 'px',
                left: rect.left + 'px',
                width: rect.width + 'px',
                right: 'auto'
            }).show();
        }

        function hideCustomersDropdown() {
            setTimeout(() => {
                if (!$('#sellCartModalCustomerSearch').is(':focus')) {
                    $('#sellCartModalCustomersList').hide();
                }
            }, 200);
        }
        
        function selectCustomerForCredit(customerId, customerName) {
            $('#sellCartModalCustomerId').val(customerId);
            $('#sellCartModalCustomerSearch').val(customerName);
            $('#clearCustomerBtn').show();
            
            // Actualizar estilos visuales
            $('#sellCartModalCustomersList .form-check').removeClass('selected');
            $(`#creditCustomer_${customerId}`).closest('.form-check').addClass('selected');
            
            // Ocultar dropdown después de seleccionar
            hideCustomersDropdown();
        }
        
        function clearCustomerSelection() {
            $('#sellCartModalCustomerId').val('');
            $('#sellCartModalCustomerSearch').val('');
            $('#clearCustomerBtn').hide();
            $('#sellCartModalCustomersList .form-check').removeClass('selected');
            // Mostrar lista nuevamente
            filterCustomersForCredit('');
        }
        
        function toggleGroupSaleModal() {
            isGroupSale = $('#sellCartModalGroupSaleToggle').is(':checked');
            if (isGroupSale) {
                $('#sellCartModalNormalSaleFields').hide();
                $('#sellCartModalGroupSaleFields').show();
                gsParticipantes = [];
                groupSaleParticipants = [];
                gsRender();
                gsValidar();
            } else {
                $('#sellCartModalNormalSaleFields').show();
                $('#sellCartModalGroupSaleFields').hide();
                gsParticipantes = [];
                groupSaleParticipants = [];
                $('#gsDropdown').hide().empty();
                $('#gsSearch').val('');
            }
            updateSellCartModal();
        }
        
        // ── Venta Grupal (modal) – nueva implementación compacta ──────────────────
        var gsParticipantes = []; // [{customerId, customerName, amountDue, paymentMethod}]
        var gsSearchTimer = null;

        function gsSearchCustomer(q) {
            clearTimeout(gsSearchTimer);
            var query = (q || '').trim();
            if (query.length < 2) { $('#gsDropdown').hide().empty(); return; }
            gsSearchTimer = setTimeout(function() {
                $.get('/api/customers', { search: query, tenantId: 1 }, function(res) {
                    var $d = $('#gsDropdown').empty();
                    (res.customers || []).slice(0, 8).forEach(function(c) {
                        var inList = gsParticipantes.some(function(p) { return p.customerId === c.id; });
                        var $btn = $('<button type="button" class="list-group-item list-group-item-action py-1 small border-0"></button>')
                            .text(c.name + (c.cedula ? ' · ' + c.cedula : ''))
                            .prop('disabled', inList);
                        if (!inList) $btn.click(function() {
                            gsAgregar(c.id, c.name);
                            $('#gsSearch').val('');
                            $d.hide().empty();
                        });
                        $d.append($btn);
                    });
                    if (!res.customers || !res.customers.length) $d.append('<div class="px-3 py-1 text-muted small">Sin resultados</div>');
                    $d.show();
                });
            }, 280);
        }

        function gsAgregar(customerId, customerName) {
            if (gsParticipantes.some(function(p) { return p.customerId === customerId; })) return;
            gsParticipantes.push({ customerId: customerId, customerName: customerName, amountDue: 0, paymentMethod: 'CASH', dueDate: null });
            groupSaleParticipants = gsParticipantes;
            gsCalcMontos();
            gsRender();
            gsValidar();
        }

        function gsRemove(idx) {
            gsParticipantes.splice(idx, 1);
            groupSaleParticipants = gsParticipantes;
            gsCalcMontos();
            gsRender();
            gsValidar();
        }

        function gsSetMetodo(idx, method) {
            if (gsParticipantes[idx]) { gsParticipantes[idx].paymentMethod = method; gsRender(); }
        }

        function gsSetMonto(idx, val) {
            if (gsParticipantes[idx]) gsParticipantes[idx].amountDue = parseFloat(val) || 0;
            gsValidar();
        }


        function gsCalcMontos() {
            if (!gsParticipantes.length) return;
            var subtotal = sellCart.reduce(function(s, i) { return s + i.unitPrice * i.quantity; }, 0);
            var total = (taxEnabled && currentTaxRate != null) ? subtotal * (1 + currentTaxRate / 100) : subtotal;
            var each = Math.floor((total / gsParticipantes.length) * 100) / 100;
            var rem = Math.round((total - each * gsParticipantes.length) * 100) / 100;
            gsParticipantes.forEach(function(p, i) { p.amountDue = each + (i === 0 ? rem : 0); });
        }

        function gsDividirIgualmente() {
            if (!gsParticipantes.length) { showAlert('Agrega al menos un participante primero', 'warning'); return; }
            gsCalcMontos();
            gsRender();
            gsValidar();
        }

        function gsRender() {
            var $c = $('#gsParticipantes').empty();
            if (!gsParticipantes.length) {
                $c.html('<p class="text-muted small mb-0 py-1">Agrega clientes con el buscador.</p>');
                $('#sellCartModalPay').prop('disabled', sellCart.length === 0 || true);
                return;
            }
            gsParticipantes.forEach(function(p, i) {
                var btns = [
                    { v: 'CASH', l: 'Efectivo', c: 'success' },
                    { v: 'TRANSFER', l: 'Transf.', c: 'primary' },
                    { v: 'CREDIT', l: 'Crédito', c: 'warning' }
                ].map(function(m) {
                    var act = p.paymentMethod === m.v ? ' active' : '';
                    return '<button type="button" class="btn btn-sm btn-outline-' + m.c + act + '" onclick="gsSetMetodo(' + i + ',\'' + m.v + '\')">' + m.l + '</button>';
                }).join('');
                var n = String(p.customerName || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
                var row = '<div class="d-flex align-items-center gap-2 border rounded px-2 py-1 mb-1">' +
                    '<span class="small fw-semibold flex-fill text-truncate" title="' + n + '" style="min-width:80px;max-width:150px">' + n + '</span>' +
                    '<div class="btn-group btn-group-sm flex-shrink-0" role="group">' + btns + '</div>' +
                    '<div class="input-group input-group-sm flex-shrink-0" style="width:100px">' +
                        '<span class="input-group-text p-1">$</span>' +
                        '<input type="number" class="form-control p-1" step="0.01" min="0" value="' + p.amountDue.toFixed(2) + '" onchange="gsSetMonto(' + i + ',this.value)" oninput="gsValidar()">' +
                    '</div>' +
                    '<button class="btn btn-sm btn-link text-danger p-0 flex-shrink-0" type="button" onclick="gsRemove(' + i + ')"><i class="bi bi-x-circle"></i></button>' +
                    '</div>';
                $c.append(row);
            });
            // Update pay button state
            $('#sellCartModalPayButtonText').text('Procesar Venta Grupal');
            $('#sellCartModalPay').prop('disabled', sellCart.length === 0);
        }

        function gsValidar() {
            var subtotal = sellCart.reduce(function(s, i) { return s + i.unitPrice * i.quantity; }, 0);
            var total = (taxEnabled && currentTaxRate != null) ? subtotal * (1 + currentTaxRate / 100) : subtotal;
            var suma = gsParticipantes.reduce(function(s, p) { return s + (parseFloat(p.amountDue) || 0); }, 0);
            var $v = $('#gsValidacion');
            if (!gsParticipantes.length) { $v.html(''); return false; }
            if (Math.abs(suma - total) > 0.02) {
                $v.html('<span class="text-danger"><i class="bi bi-exclamation-triangle"></i> Suma $' + suma.toFixed(2) + ' ≠ $' + total.toFixed(2) + '</span>');
                return false;
            }
            $v.html('<span class="text-success"><i class="bi bi-check-circle"></i> $' + suma.toFixed(2) + ' / $' + total.toFixed(2) + '</span>');
            return true;
        }
        // ─────────────────────────────────────────────────────────────────────────
        
        function updateGroupSaleParticipantsTableModal() {
            const tbody = $('#sellCartModalGroupSaleParticipantsTable');
            tbody.empty();

            if (groupSaleParticipants.length === 0) {
                tbody.html('<tr><td colspan="5" class="text-center text-muted">Seleccione clientes primero</td></tr>');
                $('#sellCartModalGroupSaleParticipantsSection').hide();
                return;
            }

            $('#sellCartModalGroupSaleParticipantsSection').show();

            let participantsTotal = 0;

            groupSaleParticipants.forEach((participant, index) => {
                participantsTotal += participant.amountDue || 0;
                
                const row = `
                    <tr>
                        <td>${participant.customerName}</td>
                        <td>
                            ${manualAmountDivision ? 
                                `<input type="number" class="form-control form-control-sm" 
                                        value="${participant.amountDue.toFixed(2)}" 
                                        step="0.01" min="0.01"
                                        onchange="updateParticipantAmount(${index}, this.value); updateGroupSaleParticipantsTableModal();"
                                        style="width: 100px;">` :
                                `$${participant.amountDue.toFixed(2)}`
                            }
                        </td>
                        <td>
                            <select class="form-select form-select-sm" 
                                    onchange="updateParticipantPaymentMethod(${index}, this.value); updateGroupSaleParticipantsTableModal();"
                                    style="width: 120px;">
                                <option value="CASH" ${participant.paymentMethod === 'CASH' ? 'selected' : ''}>Efectivo</option>
                                <option value="TRANSFER" ${participant.paymentMethod === 'TRANSFER' ? 'selected' : ''}>Transferencia</option>
                                <option value="CREDIT" ${participant.paymentMethod === 'CREDIT' ? 'selected' : ''}>Crédito</option>
                            </select>
                        </td>
                        <td>
                            ${participant.paymentMethod === 'CREDIT' ? 
                                `<input type="date" class="form-control form-control-sm" 
                                        value="${participant.dueDate || ''}" 
                                        min="${new Date().toISOString().split('T')[0]}"
                                        onchange="updateParticipantDueDate(${index}, this.value)"
                                        style="width: 150px;">` :
                                '<span class="text-muted">N/A</span>'
                            }
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger" onclick="removeParticipantFromGroupSale(${index}); updateGroupSaleParticipantsTableModal();" title="Remover">
                                <i class="bi bi-x"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });

            const subtotal = sellCart.reduce((sum, item) => sum + (item.unitPrice * item.quantity), 0);
            const tax = (taxEnabled && currentTaxRate != null) ? subtotal * (currentTaxRate / 100) : 0;
            const total = subtotal + tax;

            $('#sellCartModalGroupSaleParticipantsTotal').text(participantsTotal.toFixed(2));
            
            // Validate amounts
            const amountError = $('#sellCartModalGroupSaleAmountError');
            if (Math.abs(participantsTotal - total) > 0.01) {
                amountError.text(`⚠ La suma ($${participantsTotal.toFixed(2)}) no coincide con el total ($${total.toFixed(2)})`).show();
            } else {
                amountError.hide();
            }
            
            // Update button state
            if (isGroupSale) {
                $('#sellCartModalPayButtonText').text('Procesar Venta Grupal');
                $('#sellCartModalPay').prop('disabled', sellCart.length === 0 || gsParticipantes.length === 0);
            }
        }

        function loadGroupSaleCustomersModal() {
            $.ajax({
                url: '/api/customers',
                method: 'GET',
                data: { tenantId: 1, isActive: true, limit: 500 },
                success: function(response) {
                    allCustomersList = response.customers || [];
                    filterGroupSaleCustomersModal('');
                },
                error: function() {
                    allCustomersList = [];
                    $('#sellCartModalGroupSaleCustomersList').html('<div class="text-danger text-center">Error al cargar clientes</div>');
                }
            });
        }
        
        function filterGroupSaleCustomersModal(searchTerm) {
            const list = $('#sellCartModalGroupSaleCustomersList');
            list.empty();
            
            if (!allCustomersList || allCustomersList.length === 0) {
                list.html('<div class="text-muted text-center">No hay clientes disponibles</div>');
                return;
            }
            
            const filtered = allCustomersList.filter(customer => {
                if (!searchTerm || searchTerm.trim() === '') return true;
                const search = searchTerm.toLowerCase();
                return customer.name.toLowerCase().includes(search) ||
                       (customer.email && customer.email.toLowerCase().includes(search)) ||
                       (customer.cedula && customer.cedula.toLowerCase().includes(search));
            });
            
            if (filtered.length === 0) {
                list.html('<div class="text-muted text-center">No se encontraron clientes</div>');
                return;
            }
            
            filtered.forEach(customer => {
                const isSelected = groupSaleParticipants.some(p => p.customerId === customer.id);
                const customerHtml = `
                    <div class="form-check mb-2 ${isSelected ? 'opacity-50' : ''}">
                        <input class="form-check-input" type="checkbox" 
                               id="groupSaleCustomerModal_${customer.id}" 
                               ${isSelected ? 'checked disabled' : ''}
                               onchange="toggleGroupSaleCustomerModal(${customer.id}, this.checked)">
                        <label class="form-check-label" for="groupSaleCustomerModal_${customer.id}">
                            ${customer.name} ${customer.cedula ? `(${customer.cedula})` : ''}
                        </label>
                    </div>
                `;
                list.append(customerHtml);
            });
        }
        
        function toggleGroupSaleCustomerModal(customerId, isChecked) {
            const customer = allCustomersList.find(c => c.id === customerId);
            if (!customer) return;
            
            if (isChecked) {
                groupSaleParticipants.push({
                    customerId: customer.id,
                    customerName: customer.name,
                    amountDue: 0,
                    paymentMethod: 'CASH',
                    dueDate: null
                });
            } else {
                groupSaleParticipants = groupSaleParticipants.filter(p => p.customerId !== customerId);
            }
            
            calculateEqualDivision();
            updateGroupSaleParticipantsTableModal();
            filterGroupSaleCustomersModal($('#sellCartModalGroupSaleCustomerSearch').val());
        }

        function processSale() {
            if (sellCart.length === 0) {
                showAlert('El carrito está vacío', 'warning');
                return;
            }
            if (taxEnabled && currentTaxRate == null) {
                showAlert('El IVA no está configurado. Configure el IVA en Configuración.', 'warning');
                return;
            }

            // Check if it's a group sale
            if (isGroupSale) {
                processGroupSale();
                return;
            }

            // Normal sale - usar campos del modal si está visible, sino los del lateral (para compatibilidad)
            const isModalVisible = $('#sellCartModal').hasClass('show') || $('#sellCartModal').is(':visible');
            const paymentMethod = isModalVisible ? $('#sellCartModalPaymentMethod').val() : $('#sellPaymentMethod').val();
            const customerName = isModalVisible ? $('#sellCartModalCustomer').val() : $('#sellCustomer').val();
            const transferRef = isModalVisible ? $('#sellCartModalTransferReference').val().trim() : $('#sellTransferReference').val().trim();
            const creditDueDate = isModalVisible ? $('#sellCartModalCreditDueDate').val() : null;
            const creditInterestRate = isModalVisible ? parseFloat($('#sellCartModalCreditInterestRate').val() || '1') : 1;
            
            // Normal sale
            const subtotal = sellCart.reduce((sum, item) => sum + (item.unitPrice * item.quantity), 0);
            const tax = (taxEnabled && currentTaxRate != null) ? subtotal * (currentTaxRate / 100) : 0;
            const total = subtotal + tax;
            
            // Validate transfer reference if payment method is TRANSFER
            if (paymentMethod === 'TRANSFER') {
                if (!transferRef) {
                    showAlert('La referencia de transferencia es requerida', 'danger');
                    return;
                }
            }
            
            // Validate credit fields if payment method is CREDIT
            if (paymentMethod === 'CREDIT') {
                if (!creditDueDate) {
                    showAlert('La fecha límite de pago es requerida para ventas a crédito', 'danger');
                    return;
                }
                // Validar que la fecha no sea en el pasado
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const dueDate = new Date(creditDueDate);
                if (dueDate < today) {
                    showAlert('La fecha límite de pago no puede ser en el pasado', 'danger');
                    return;
                }
                // Validar que hay un cliente seleccionado
                const selectedCustomerId = $('#sellCartModalCustomerId').val();
                if (!selectedCustomerId) {
                    showAlert('Debe seleccionar un cliente para ventas a crédito', 'danger');
                    return;
                }
            }
            
            // Obtener customerId según el método de pago
            let finalCustomerId = null;
            if (paymentMethod === 'CREDIT') {
                finalCustomerId = $('#sellCartModalCustomerId').val();
                if (!finalCustomerId) {
                    showAlert('Debe seleccionar un cliente para ventas a crédito', 'danger');
                    return;
                }
            } else if (customerName && customerName.trim() !== '') {
                // Para otros métodos, buscar cliente por nombre si se proporciona
                // El backend lo manejará
                finalCustomerId = null; // Se buscará por nombre en el backend
            }
            
            const saleData = {
                tenantId: 1,
                customerId: finalCustomerId,
                items: sellCart.map(item => ({
                    productId: item.productId,
                    quantity: item.quantity,
                    unitPrice: item.unitPrice
                })),
                paymentMethod: paymentMethod,
                transferReference: paymentMethod === 'TRANSFER' ? transferRef : null,
                totalAmount: total,
                notes: customerName ? `Cliente: ${customerName}` : null,
                // Campos adicionales para crédito
                creditDueDate: paymentMethod === 'CREDIT' ? creditDueDate : null,
                creditInterestRate: paymentMethod === 'CREDIT' ? creditInterestRate : null,
                customerName: paymentMethod === 'CREDIT' ? null : (customerName || null) // Para crédito usamos customerId, no nombre
            };

            const token = localStorage.getItem('adminToken');
            if (!token) {
                showAlert('Sesión no encontrada. Inicie sesión nuevamente.', 'danger');
                setTimeout(function() { window.location.href = '/login'; }, 1500);
                return;
            }

            $.ajax({
                url: '/api/sales',
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + token },
                contentType: 'application/json',
                data: JSON.stringify(saleData),
                success: function(response) {
                    if (paymentMethod === 'TRANSFER') {
                        showAlert('Venta creada pendiente de confirmación de transferencia', 'info');
                    } else if (paymentMethod === 'CREDIT') {
                        showAlert('Venta a crédito procesada exitosamente. Se ha creado la cuenta de deudor.', 'success');
                    } else {
                        showAlert('Venta procesada exitosamente', 'success');
                    }
                    
                    // Clear cart
                    sellCart = [];
                    updateSellCart();
                    
                    // Clear customer field and transfer reference (tanto modal como lateral)
                    $('#sellCustomer').val('');
                    $('#sellCartModalCustomer').val('');
                    $('#sellCartModalCustomerId').val('');
                    $('#sellCartModalCustomerSearch').val('');
                    $('#clearCustomerBtn').hide();
                    $('#sellCartModalCustomersList').hide();
                    $('#sellTransferReference').val('');
                    $('#sellCartModalTransferReference').val('');
                    $('#sellCartModalCreditDueDate').val('');
                    $('#sellCartModalCreditInterestRate').val('1');
                    $('#transferReferenceField').hide();
                    $('#sellCartModalTransferReferenceField').hide();
                    $('#sellCartModalCreditFields').hide();
                    $('#sellPaymentMethod').val('CASH');
                    $('#sellCartModalPaymentMethod').val('CASH');
                    togglePaymentMethodFieldsModal();
                    
                    // Cerrar modal si está abierto
                    $('#sellCartModal').modal('hide');
                    
                    // Reload products to update stock (only if not transfer)
                    if (paymentMethod !== 'TRANSFER') {
                        loadSellProducts();
                    }
                    
                    // Reload dashboard data
                    loadDashboardData();
                    loadSales();
                },
                error: function(xhr) {
                    if (xhr.status === 401) {
                        showAlert('Sesión expirada. Redirigiendo al login...', 'warning');
                        setTimeout(function() { window.location.href = '/login'; }, 1500);
                        return;
                    }
                    const error = xhr.responseJSON?.error || 'Error al procesar la venta';
                    showAlert(error, 'danger');
                }
            });
        }

        function filterSales() {
            loadSales();
        }

        // Group Sale Functions
        function toggleGroupSale() {
            isGroupSale = $('#groupSaleToggle').is(':checked');
            
            if (isGroupSale) {
                $('#normalSaleFields').hide();
                $('#groupSaleFields').show();
                loadCustomersForGroupSale();
            } else {
                $('#normalSaleFields').show();
                $('#groupSaleFields').hide();
                selectedCustomers = [];
                groupSaleParticipants = [];
                updateGroupSaleParticipantsTable();
            }
            
            updateSellCart();
        }

        function loadCustomersForGroupSale() {
            $.ajax({
                url: '/api/customers',
                method: 'GET',
                data: { tenantId: 1, isActive: true, limit: 500 },
                success: function(response) {
                    allCustomersList = response.customers || [];
                    displayGroupSaleCustomers(allCustomersList);
                },
                error: function() {
                    showAlert('Error al cargar clientes', 'danger');
                    $('#groupSaleCustomersList').html('<div class="text-danger">Error al cargar clientes</div>');
                }
            });
        }

        function displayGroupSaleCustomers(customers) {
            const container = $('#groupSaleCustomersList');
            container.empty();

            if (customers.length === 0) {
                container.html('<div class="text-muted text-center">No hay clientes disponibles</div>');
                return;
            }

            customers.forEach(customer => {
                const isSelected = selectedCustomers.includes(customer.id);
                const checkbox = `
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" value="${customer.id}" 
                               id="customer_${customer.id}" 
                               ${isSelected ? 'checked' : ''}
                               onchange="toggleCustomerSelection(${customer.id}, this.checked)">
                        <label class="form-check-label" for="customer_${customer.id}">
                            ${customer.name} ${customer.cedula ? `(${customer.cedula})` : ''}
                        </label>
                    </div>
                `;
                container.append(checkbox);
            });
        }

        function filterGroupSaleCustomers(searchTerm) {
            if (!searchTerm || searchTerm.trim() === '') {
                displayGroupSaleCustomers(allCustomersList);
                return;
            }

            const term = searchTerm.toLowerCase();
            const filtered = allCustomersList.filter(customer => {
                const nameMatch = customer.name.toLowerCase().includes(term);
                const cedulaMatch = customer.cedula && customer.cedula.toLowerCase().includes(term);
                return nameMatch || cedulaMatch;
            });

            displayGroupSaleCustomers(filtered);
        }

        function toggleCustomerSelection(customerId, isSelected) {
            if (isSelected) {
                if (!selectedCustomers.includes(customerId)) {
                    selectedCustomers.push(customerId);
                    addCustomerToGroupSale(customerId);
                }
            } else {
                selectedCustomers = selectedCustomers.filter(id => id !== customerId);
                removeCustomerFromGroupSale(customerId);
            }
            
            updateGroupSaleParticipantsTable();
            calculateEqualDivision();
        }

        function addCustomerToGroupSale(customerId) {
            const customer = allCustomersList.find(c => c.id === customerId);
            if (!customer) return;

            // Check if already added
            if (groupSaleParticipants.find(p => p.customerId === customerId)) {
                return;
            }

            const participant = {
                customerId: customerId,
                customerName: customer.name,
                amountDue: 0,
                paymentMethod: 'CASH',
                dueDate: null,
                interestRate: 0.01, // 1% daily
                amountPaid: 0
            };

            groupSaleParticipants.push(participant);
        }

        function removeCustomerFromGroupSale(customerId) {
            groupSaleParticipants = groupSaleParticipants.filter(p => p.customerId !== customerId);
        }

        function toggleManualAmountDivision() {
            manualAmountDivision = !$('#equalDivisionToggle').is(':checked');
            updateGroupSaleParticipantsTable();
            
            if (!manualAmountDivision) {
                calculateEqualDivision();
            }
        }

        function calculateEqualDivision() {
            if (groupSaleParticipants.length === 0 || sellCart.length === 0) {
                return;
            }

            const subtotal = sellCart.reduce((sum, item) => sum + (item.unitPrice * item.quantity), 0);
            const tax = (taxEnabled && currentTaxRate != null) ? subtotal * (currentTaxRate / 100) : 0;
            const total = subtotal + tax;
            const amountPerCustomer = total / groupSaleParticipants.length;

            groupSaleParticipants.forEach(participant => {
                participant.amountDue = parseFloat(amountPerCustomer.toFixed(2));
            });

            updateGroupSaleParticipantsTable();
            // Actualizar también el modal si está abierto
            if ($('#sellCartModal').hasClass('show')) {
                updateGroupSaleParticipantsTableModal();
            }
        }

        function updateGroupSaleParticipantsTable() {
            const tbody = $('#groupSaleParticipantsTable');
            tbody.empty();

            if (groupSaleParticipants.length === 0) {
                tbody.html('<tr><td colspan="5" class="text-center text-muted">Seleccione clientes primero</td></tr>');
                $('#groupSaleParticipantsSection').hide();
                return;
            }

            $('#groupSaleParticipantsSection').show();

            let participantsTotal = 0;

            groupSaleParticipants.forEach((participant, index) => {
                participantsTotal += participant.amountDue || 0;
                
                const row = `
                    <tr>
                        <td>${participant.customerName}</td>
                        <td>
                            ${manualAmountDivision ? 
                                `<input type="number" class="form-control form-control-sm" 
                                        value="${participant.amountDue.toFixed(2)}" 
                                        step="0.01" min="0.01"
                                        onchange="updateParticipantAmount(${index}, this.value)"
                                        style="width: 100px;">` :
                                `$${participant.amountDue.toFixed(2)}`
                            }
                        </td>
                        <td>
                            <select class="form-select form-select-sm" 
                                    onchange="updateParticipantPaymentMethod(${index}, this.value)"
                                    style="width: 120px;">
                                <option value="CASH" ${participant.paymentMethod === 'CASH' ? 'selected' : ''}>Efectivo</option>
                                <option value="TRANSFER" ${participant.paymentMethod === 'TRANSFER' ? 'selected' : ''}>Transferencia</option>
                                <option value="CREDIT" ${participant.paymentMethod === 'CREDIT' ? 'selected' : ''}>Crédito</option>
                            </select>
                        </td>
                        <td>
                            ${participant.paymentMethod === 'CREDIT' ? 
                                `<input type="date" class="form-control form-control-sm" 
                                        value="${participant.dueDate || ''}" 
                                        min="${new Date().toISOString().split('T')[0]}"
                                        onchange="updateParticipantDueDate(${index}, this.value)"
                                        style="width: 150px;">` :
                                '<span class="text-muted">N/A</span>'
                            }
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger" onclick="removeParticipantFromGroupSale(${index})" title="Remover">
                                <i class="bi bi-x"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });

            const subtotal = sellCart.reduce((sum, item) => sum + (item.unitPrice * item.quantity), 0);
            const tax = (taxEnabled && currentTaxRate != null) ? subtotal * (currentTaxRate / 100) : 0;
            const total = subtotal + tax;

            $('#groupSaleParticipantsTotal').text(participantsTotal.toFixed(2));
            
            // Validate amounts
            const amountError = $('#groupSaleAmountError');
            if (Math.abs(participantsTotal - total) > 0.01) {
                amountError.text(`⚠ La suma ($${participantsTotal.toFixed(2)}) no coincide con el total ($${total.toFixed(2)})`).show();
            } else {
                amountError.hide();
            }
            
            // Actualizar también el modal si está abierto
            if ($('#sellCartModal').hasClass('show')) {
                updateGroupSaleParticipantsTableModal();
            }
        }

        function updateParticipantAmount(index, amount) {
            groupSaleParticipants[index].amountDue = parseFloat(amount) || 0;
            updateGroupSaleParticipantsTable();
        }

        function updateParticipantPaymentMethod(index, method) {
            groupSaleParticipants[index].paymentMethod = method;
            if (method !== 'CREDIT') {
                groupSaleParticipants[index].dueDate = null;
            }
            updateGroupSaleParticipantsTable();
        }

        function updateParticipantDueDate(index, date) {
            groupSaleParticipants[index].dueDate = date || null;
        }

        function removeParticipantFromGroupSale(index) {
            const customerId = groupSaleParticipants[index].customerId;
            groupSaleParticipants.splice(index, 1);
            selectedCustomers = selectedCustomers.filter(id => id !== customerId);
            
            // Uncheck checkbox (tanto en lateral como en modal)
            $(`#customer_${customerId}`).prop('checked', false);
            $(`#groupSaleCustomerModal_${customerId}`).prop('checked', false).prop('disabled', false);
            
            updateGroupSaleParticipantsTable();
            calculateEqualDivision();
            
            // Actualizar lista de clientes en modal si está abierto
            if ($('#sellCartModal').hasClass('show')) {
                filterGroupSaleCustomersModal($('#sellCartModalGroupSaleCustomerSearch').val());
            }
        }

        function validateGroupSaleAmounts() {
            const subtotal = sellCart.reduce((sum, item) => sum + (item.unitPrice * item.quantity), 0);
            const tax = (taxEnabled && currentTaxRate != null) ? subtotal * (currentTaxRate / 100) : 0;
            const total = subtotal + tax;
            
            const participantsTotal = groupSaleParticipants.reduce((sum, p) => sum + (p.amountDue || 0), 0);
            
            if (Math.abs(participantsTotal - total) > 0.01) {
                showAlert(`La suma de montos ($${participantsTotal.toFixed(2)}) debe igualar el total ($${total.toFixed(2)})`, 'warning');
                return false;
            }

            // Validate credit dates
            for (const participant of groupSaleParticipants) {
                if (participant.paymentMethod === 'CREDIT' && !participant.dueDate) {
                    showAlert('Debe especificar fecha límite para clientes con método de pago "Crédito"', 'warning');
                    return false;
                }
            }

            return true;
        }

        function processGroupSale() {
            if (sellCart.length === 0) {
                showAlert('El carrito está vacío', 'warning');
                return;
            }
            if (gsParticipantes.length === 0) {
                showAlert('Debe agregar al menos un participante', 'warning');
                return;
            }
            if (!gsValidar()) {
                showAlert('La suma de montos no coincide con el total del carrito', 'warning');
                return;
            }

            const token = localStorage.getItem('adminToken');
            const payload = {
                tenantId: 1,
                items: sellCart.map(item => ({
                    productId: item.productId,
                    quantity: item.quantity,
                    unitPrice: item.unitPrice
                })),
                participants: gsParticipantes.map(p => ({
                    customerId: p.customerId,
                    amountDue: parseFloat(p.amountDue) || 0,
                    paymentMethod: p.paymentMethod,
                    dueDate: p.dueDate || null
                })),
                notes: 'Venta grupal desde dashboard'
            };

            const $btn = $('#sellCartModalPay');
            $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Procesando...');

            $.ajax({
                url: '/api/group-purchases/from-cart',
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + token },
                contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function() {
                    showAlert('Venta grupal procesada exitosamente', 'success');
                    sellCart = [];
                    gsParticipantes = [];
                    groupSaleParticipants = [];
                    selectedCustomers = [];
                    isGroupSale = false;
                    $('#sellCartModalGroupSaleToggle').prop('checked', false);
                    $('#groupSaleToggle').prop('checked', false);
                    $('#sellCartModal').modal('hide');
                    updateSellCart();
                    loadSellProducts();
                    loadDashboardData();
                    loadGroupPurchases();
                    loadCredits();
                },
                error: function(xhr) {
                    const errorMsg = xhr.responseJSON?.error || 'Error al procesar venta grupal';
                    showAlert(errorMsg, 'danger');
                    $btn.prop('disabled', false).html('<i class="bi bi-credit-card"></i> <span id="sellCartModalPayButtonText">Procesar Venta Grupal</span>');
                }
            });
        }

        // Customer Management Functions
        function loadCustomers() {
            const search = $('#customerSearch').val();
            const isActive = $('#customerStatusFilter').val();

            $.ajax({
                url: '/api/customers',
                method: 'GET',
                data: { 
                    tenantId: 1, 
                    search: search || undefined,
                    isActive: isActive || undefined,
                    limit: 100
                },
                success: function(response) {
                    displayCustomers(response.customers);
                },
                error: function(xhr) {
                    const errorMsg = xhr.responseJSON?.error || 'Error al cargar clientes';
                    console.error('Error loading customers:', xhr.responseJSON || xhr);
                    showAlert(errorMsg + '. Si el error menciona "cedula", ejecuta la migración de base de datos.', 'danger');
                }
            });
        }

        function displayCustomers(customers) {
            const tbody = $('#customersTable tbody');
            tbody.empty();

            if (customers.length === 0) {
                tbody.html(`
                    <tr>
                        <td colspan="9" class="text-center text-muted">
                            No se encontraron clientes
                        </td>
                    </tr>
                `);
                return;
            }

            customers.forEach(customer => {
                const statusBadge = customer.isActive ? 
                    '<span class="badge bg-success">Activo</span>' : 
                    '<span class="badge bg-danger">Inactivo</span>';
                
                const date = new Date(customer.createdAt).toLocaleDateString('es-ES');

                const row = `
                    <tr>
                        <td>${customer.id}</td>
                        <td>${customer.name}</td>
                        <td><strong>${customer.cedula || '<span class="text-muted">N/A</span>'}</strong></td>
                        <td>${customer.email || '<span class="text-muted">N/A</span>'}</td>
                        <td>${customer.phone || '<span class="text-muted">N/A</span>'}</td>
                        <td>${customer.address ? (customer.address.length > 50 ? customer.address.substring(0, 50) + '...' : customer.address) : '<span class="text-muted">N/A</span>'}</td>
                        <td>${statusBadge}</td>
                        <td>${date}</td>
                        <td>
                            <div class="table-actions">
                                <button class="btn btn-sm btn-outline-primary btn-sm-custom" onclick="editCustomer(${customer.id})" title="Editar">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                ${currentUserRole !== 'CASHIER' ? `<button class="btn btn-sm btn-outline-danger btn-sm-custom" onclick="deleteCustomer(${customer.id})" title="Eliminar">
                                    <i class="bi bi-trash"></i>
                                </button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
        }

        function filterCustomers() {
            loadCustomers();
        }

        // Las funciones showCreateCustomerModal, editCustomer, deleteCustomer y saveCustomer
        // están definidas arriba en la sección de clientes

        function logout() {
            if (confirm('¿Está seguro de cerrar sesión?')) {
                localStorage.removeItem('adminToken');
                localStorage.removeItem('adminUser');
                window.location.href = '/login';
            }
        }
        
        // Mapear rol a etiqueta legible (ADMIN/CASHIER/MANAGER/USER)
        function getRoleLabel(role) {
            if (!role) return '';
            if (role === 'ADMIN') return 'Administrador';
            if (role === 'MANAGER') return 'Encargado';
            return 'Empleado'; // CASHIER o USER
        }

        // Enviar token en todas las peticiones AJAX del dashboard
        $.ajaxSetup({
            beforeSend: function(xhr) {
                const token = localStorage.getItem('adminToken');
                if (token) {
                    xhr.setRequestHeader('Authorization', 'Bearer ' + token);
                }
            }
        });

        // Verificar autenticación al cargar
        function checkAuth() {
            const token = localStorage.getItem('adminToken');
            const user = localStorage.getItem('adminUser');
            
            if (!token) {
                // No hay token, redirigir al login
                window.location.href = '/login';
                return false;
            }
            
            // Mostrar nombre y rol del usuario (etiqueta legible)
            if (user) {
                try {
                    const userData = JSON.parse(user);
                    currentUserRole = userData.role;
                    $('#currentUser').text(userData.name || 'Usuario');
                    $('#currentUserRole').text(getRoleLabel(userData.role) || '');
                    // Ocultar menú solo para Empleado (CASHIER): Usuarios, Configuración, Compras grupales, Créditos
                    if (currentUserRole === 'CASHIER') {
                        $('.sidebar .nav-link[data-section="users"]').hide();
                        $('.sidebar .nav-link[data-section="settings"]').hide();
                        $('.sidebar .nav-link[data-section="group-purchases"]').hide();
                        $('.sidebar .nav-link[data-section="credits"]').hide();
                        $('.admin-only').hide();
                        var section = (window.location.pathname.split('/').filter(Boolean).pop() || 'dashboard').replace('.html', '');
                        if (['users', 'settings', 'group-purchases', 'credits'].indexOf(section) !== -1) {
                            history.replaceState(null, '', '/dashboard');
                            $('.content-section').removeClass('active');
                            $('#dashboard').addClass('active');
                            $('.sidebar .nav-link, .mobile-bottom-nav .nav-link').removeClass('active');
                            $('.sidebar .nav-link[data-section="dashboard"], .mobile-bottom-nav .nav-link[data-section="dashboard"]').addClass('active');
                            if (typeof loadDashboardData === 'function') loadDashboardData();
                        }
                    }
                } catch (e) {
                    console.warn('Error parsing user data');
                }
            }
            
            // Verificar token con el servidor (opcional, para mayor seguridad)
            $.ajax({
                url: '/api/admin/auth/me',
                method: 'GET',
                error: function(xhr) {
                    if (xhr.status === 401 || xhr.status === 403) {
                        // Token inválido o expirado
                        localStorage.removeItem('adminToken');
                        localStorage.removeItem('adminUser');
                        window.location.href = '/login';
                    }
                }
            });
            
            return true;
        }
        
        // Ejecutar verificación de autenticación
        checkAuth();

        // Notificaciones (pago en efectivo pendiente de confirmar)
        let notificationsSocket = null;
        function loadNotifications() {
            const token = localStorage.getItem('adminToken');
            if (!token) return;
            $.ajax({
                url: '/api/notifications',
                method: 'GET',
                headers: { 'Authorization': 'Bearer ' + token },
                data: { unreadOnly: 'true' },
                success: function(data) {
                    let notifications = data.notifications || [];
                    if (notifications.length === 0) {
                        $.ajax({
                            url: '/api/sales',
                            method: 'GET',
                            headers: { 'Authorization': 'Bearer ' + token },
                            data: { tenantId: 1, status: 'PENDING', limit: 20 },
                            success: function(salesData) {
                                const sales = salesData.sales || [];
                                const pendingPayments = sales.filter(function(s) { return s.paymentMethod === 'CASH' || s.paymentMethod === 'TRANSFER'; });
                                const badge = $('#notificationsBadge');
                                const container = $('#notificationsListItems');
                                const emptyEl = $('#notificationsListEmpty');
                                container.empty();
                                if (pendingPayments.length > 0) {
                                    badge.text(pendingPayments.length).removeClass('d-none');
                                    emptyEl.hide();
                                    pendingPayments.forEach(function(sale) {
                                        const isTransfer = sale.paymentMethod === 'TRANSFER';
                                        const total = sale.totalAmount != null ? parseFloat(sale.totalAmount).toFixed(2) : '0.00';
                                        const customerName = (sale.customer && sale.customer.name) ? sale.customer.name : '';
                                        const label = isTransfer ? 'Confirmar transferencia' : 'Confirmar pago';
                                        const text = (isTransfer ? 'Cliente espera confirmación de transferencia' : 'Cliente espera confirmación de pago en efectivo') + ' - Venta #' + sale.id + ' - $' + total + (customerName ? ' - ' + customerName : '');
                                        const actionsHtml = '<span class="small notifications-item-text">' + text + '</span> <div class="notifications-item-actions"><button class="btn btn-sm btn-success" type="button" data-sale-id="' + sale.id + '" data-method="' + (isTransfer ? 'TRANSFER' : 'CASH') + '">' + label + '</button><button class="btn btn-sm btn-outline-danger" type="button" data-sale-id="' + sale.id + '" data-action="reject">Cancelar pedido</button></div>';
                                        const li = $('<li class="dropdown-item d-flex align-items-center justify-content-between gap-2 flex-wrap"></li>').html(actionsHtml);
                                        li.find('button[data-method]').on('click', function(e) {
                                            e.preventDefault();
                                            const id = $(this).data('sale-id');
                                            const method = $(this).data('method');
                                            const url = method === 'TRANSFER' ? '/api/sales/' + id + '/confirm-transfer' : '/api/sales/' + id + '/confirm-cash';
                                            const ajaxMethod = method === 'TRANSFER' ? 'PATCH' : 'POST';
                                            $.ajax({
                                                url: url,
                                                method: ajaxMethod,
                                                headers: { 'Authorization': 'Bearer ' + token },
                                                contentType: 'application/json',
                                                data: JSON.stringify({ tenantId: 1 }),
                                                success: function() { loadNotifications(); loadSales(); loadDashboardData(); loadSellProducts(); },
                                                error: function(xhr) { showAlert(xhr.responseJSON && xhr.responseJSON.error ? xhr.responseJSON.error : 'Error al confirmar', 'danger'); }
                                            });
                                        });
                                        li.find('button[data-action="reject"]').on('click', function(e) {
                                            e.preventDefault();
                                            rejectPendingOrder($(this).data('sale-id'));
                                        });
                                        container.append(li);
                                    });
                                } else {
                                    badge.addClass('d-none');
                                    emptyEl.show();
                                }
                            }
                        });
                        return;
                    }
                    const badge = $('#notificationsBadge');
                    badge.text(notifications.length).removeClass('d-none');
                    const container = $('#notificationsListItems');
                    const emptyEl = $('#notificationsListEmpty');
                    container.empty();
                    emptyEl.hide();
                    notifications.forEach(function(n) {
                        const sale = n.sale || {};
                        const total = sale.totalAmount != null ? parseFloat(sale.totalAmount).toFixed(2) : '0.00';
                        const saleId = n.saleId || sale.id;
                        const customerName = (sale.customer && sale.customer.name) ? sale.customer.name : '';
                        const isTransfer = (n.type === 'TRANSFER_CONFIRMATION') || (sale.paymentMethod === 'TRANSFER');
                        const label = isTransfer ? 'Confirmar transferencia' : 'Confirmar pago';
                        const text = (n.title || (isTransfer ? 'Cliente espera confirmación de transferencia' : 'Cliente espera confirmación de pago en efectivo')) + ' - Venta #' + saleId + ' - $' + total + (customerName ? ' - ' + customerName : '');
                        const actionsHtml = '<span class="small notifications-item-text">' + text + '</span> <div class="notifications-item-actions"><button class="btn btn-sm btn-success" type="button" data-sale-id="' + saleId + '" data-method="' + (isTransfer ? 'TRANSFER' : 'CASH') + '">' + label + '</button><button class="btn btn-sm btn-outline-danger" type="button" data-sale-id="' + saleId + '" data-action="reject">Cancelar pedido</button></div>';
                        const li = $('<li class="dropdown-item d-flex align-items-center justify-content-between gap-2 flex-wrap"></li>').html(actionsHtml);
                        li.find('button[data-method]').on('click', function(e) {
                            e.preventDefault();
                            const id = $(this).data('sale-id');
                            const method = $(this).data('method');
                            const url = method === 'TRANSFER' ? '/api/sales/' + id + '/confirm-transfer' : '/api/sales/' + id + '/confirm-cash';
                            const ajaxMethod = method === 'TRANSFER' ? 'PATCH' : 'POST';
                            $.ajax({
                                url: url,
                                method: ajaxMethod,
                                headers: { 'Authorization': 'Bearer ' + token },
                                contentType: 'application/json',
                                data: JSON.stringify({ tenantId: 1 }),
                                success: function() { loadNotifications(); loadSales(); loadDashboardData(); loadSellProducts(); },
                                error: function(xhr) { showAlert(xhr.responseJSON && xhr.responseJSON.error ? xhr.responseJSON.error : 'Error al confirmar', 'danger'); }
                            });
                        });
                        li.find('button[data-action="reject"]').on('click', function(e) {
                            e.preventDefault();
                            rejectPendingOrder($(this).data('sale-id'));
                        });
                        container.append(li);
                    });
                }
            });
        }
        function connectNotificationsSocket() {
            const token = localStorage.getItem('adminToken');
            if (!token || typeof io === 'undefined') return;
            if (notificationsSocket) notificationsSocket.disconnect();
            notificationsSocket = io({
                auth: { token: token }
            });
            notificationsSocket.on('cash-pending', function() {
                loadNotifications();
            });
        }
        if (typeof checkAuth === 'function' && localStorage.getItem('adminToken')) {
            loadNotifications();
            connectNotificationsSocket();
        }
        setTimeout(function() {
            if (localStorage.getItem('adminToken')) {
                loadNotifications();
                connectNotificationsSocket();
            }
        }, 500);

        // Web Push: suscripción para notificaciones en el dispositivo (incl. móvil)
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
            return outputArray;
        }
        function registerWebPush() {
            if (!('Notification' in window) || !('serviceWorker' in navigator) || !('PushManager' in window)) return;
            if (Notification.permission === 'denied') return;
            var token = localStorage.getItem('adminToken');
            if (!token) return;
            function doSubscribe() {
                navigator.serviceWorker.register('/sw.js').then(function(reg) {
                    return fetch('/api/public/vapid-public-key').then(function(r) {
                        if (!r.ok) return null; // VAPID no configurado
                        return r.json();
                    }).then(function(data) {
                        if (!data || !data.publicKey) return;
                        var key = urlBase64ToUint8Array(data.publicKey);
                        return reg.pushManager.subscribe({
                            userVisibleOnly: true,
                            applicationServerKey: key
                        }).catch(function(subErr) {
                            if (subErr.name === 'InvalidStateError') {
                                return reg.pushManager.getSubscription().then(function(old) {
                                    if (old) return old.unsubscribe();
                                }).then(function() {
                                    return reg.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: key });
                                });
                            }
                            throw subErr;
                        });
                    });
                }).then(function(subscription) {
                    if (!subscription) return;
                    return fetch('/api/notifications/push-subscribe', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                        body: JSON.stringify({ subscription: subscription.toJSON() })
                    });
                }).catch(function(err) {
                    // Ignorar errores de red esperados (servicio push no disponible o VAPID no configurado)
                    if (err && (err.message === 'Failed to fetch' || err.name === 'TypeError')) return;
                    console.warn('Web Push subscribe:', err);
                });
            }
            if (Notification.permission === 'granted') {
                doSubscribe();
            } else {
                Notification.requestPermission().then(function(p) { if (p === 'granted') doSubscribe(); });
            }
        }
        setTimeout(function() {
            try {
                if (localStorage.getItem('adminToken')) registerWebPush();
            } catch (e) { console.warn('Web Push init:', e); }
        }, 1500);

        function showAddStockModal(productId) {
            $.ajax({
                url: `/api/products/${productId}`,
                method: 'GET',
                data: { tenantId: 1 },
                success: function(product) {
                    if (product.productType !== 'SIMPLE') {
                        showAlert('Solo los productos SIMPLE pueden tener stock agregado', 'warning');
                        return;
                    }
                    
                    // Get current stock
                    $.ajax({
                        url: `/api/products/${productId}/availability`,
                        method: 'GET',
                        data: { tenantId: 1 },
                        success: function(availability) {
                            $('#addStockProductId').val(productId);
                            $('#addStockProductName').val(product.name);
                            $('#addStockCurrentStock').val(availability.currentStock || 0);
                            $('#addStockQuantity').val('');
                            $('#addStockUnitCost').val('');
                            
                            const modal = new bootstrap.Modal(document.getElementById('addStockModal'));
                            modal.show();
                        },
                        error: function() {
                            $('#addStockProductId').val(productId);
                            $('#addStockProductName').val(product.name);
                            $('#addStockCurrentStock').val('N/A');
                            $('#addStockQuantity').val('');
                            $('#addStockUnitCost').val('');
                            
                            const modal = new bootstrap.Modal(document.getElementById('addStockModal'));
                            modal.show();
                        }
                    });
                },
                error: function() {
                    showAlert('Error al cargar información del producto', 'danger');
                }
            });
        }

        function saveAddStock() {
            const productId = $('#addStockProductId').val();
            const quantity = parseFloat($('#addStockQuantity').val());
            const unitCost = $('#addStockUnitCost').val() ? parseFloat($('#addStockUnitCost').val()) : null;

            if (!quantity || quantity <= 0) {
                showAlert('La cantidad debe ser mayor a 0', 'warning');
                return;
            }

            $.ajax({
                url: `/api/products/${productId}/add-stock`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    tenantId: 1,
                    quantity: quantity,
                    unitCost: unitCost
                }),
                success: function(response) {
                    showAlert(`Stock agregado exitosamente. Stock actual: ${response.currentStock}`, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('addStockModal')).hide();
                    loadProducts();
                    loadDashboardData();
                },
                error: function(xhr) {
                    const error = xhr.responseJSON?.error || 'Error al agregar stock';
                    showAlert(error, 'danger');
                }
            });
        }

        function showAlert(message, type) {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show position-fixed" 
                     style="top: 80px; right: 20px; z-index: 9999; min-width: 300px;" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            $('body').append(alertHtml);
            
            setTimeout(() => {
                $('.alert').alert('close');
            }, 5000);
        }

        function showProductImageModal(imageUrl, productName) {
            $('#productImageModalTitle').text(productName);
            $('#productImageModalImg').attr('src', imageUrl).attr('alt', productName);
            new bootstrap.Modal(document.getElementById('productImageModal')).show();
        }

        // ========== FUNCIONES DE VERIFICACIÓN DE CÓDIGO ==========
        
        function verifyCode() {
            const inputCode = $('#verificationCodeInput').val().trim();
            
            if (!inputCode) {
                $('#verificationError').text('Ingresa el código de 6 dígitos').show();
                return;
            }
            
            if (inputCode !== pendingVerificationCode) {
                $('#verificationError').text('Código incorrecto. Intenta de nuevo.').show();
                $('#verificationCodeInput').val('').focus();
                return;
            }
            
            // Código correcto - crear el cliente
            $('#verificationError').hide();
            
            $.ajax({
                url: '/api/customers',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(pendingCustomerData),
                success: function(response) {
                    bootstrap.Modal.getInstance(document.getElementById('verificationCodeModal')).hide();
                    showAlert('¡Cliente creado exitosamente! Email verificado.', 'success');
                    loadCustomers();
                    // Si el modal de crédito está abierto, actualizar la lista de clientes
                    if ($('#sellCartModal').hasClass('show') && $('#sellCartModalPaymentMethod').val() === 'CREDIT') {
                        // Agregar el nuevo cliente a la lista si no existe
                        const exists = allCustomersList.find(c => c.id === response.id);
                        if (!exists) {
                            allCustomersList.push(response);
                        }
                        filterCustomersForCredit($('#sellCartModalCustomerSearch').val());
                        // Solo mostrar si el campo tiene foco
                        if ($('#sellCartModalCustomerSearch').is(':focus')) {
                            showCustomersDropdown();
                        }
                    }
                    
                    // Limpiar datos pendientes
                    pendingCustomerData = null;
                    pendingVerificationCode = null;
                    currentEditingCustomer = null;
                    
                    // Limpiar campos de ubicación del mapa
                    $('#customerLatitude').val('');
                    $('#customerLongitude').val('');
                    
                    // Enviar email de bienvenida
                    if (response.email) {
                        $.ajax({
                            url: '/api/email/welcome',
                            method: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify({
                                tenantId: 1,
                                email: response.email,
                                customerName: response.name
                            }),
                            success: function() {
                                console.log('Welcome email sent successfully');
                            },
                            error: function(xhr) {
                                console.warn('Could not send welcome email:', xhr.responseJSON?.message || 'SMTP not configured');
                            }
                        });
                    }
                },
                error: function(xhr) {
                    const error = xhr.responseJSON?.error || 'Error al crear cliente';
                    showAlert(error, 'danger');
                }
            });
        }
        
        function cancelVerification() {
            pendingCustomerData = null;
            pendingVerificationCode = null;
            bootstrap.Modal.getInstance(document.getElementById('verificationCodeModal')).hide();
            showAlert('Creación de cliente cancelada', 'warning');
        }
        
        // Permitir verificar con Enter
        $(document).on('keypress', '#verificationCodeInput', function(e) {
            if (e.which === 13) {
                verifyCode();
            }
        });

        // ========== SUPPLIERS FUNCTIONS ==========
        let currentEditingSupplier = null;
        let currentPayingOrderId = null;

        function updateSupplierCode() {
            const ruc = $('#supplierRuc').val().trim();
            $('#supplierCode').val(ruc ? 'P' + ruc : '');
        }

        function loadSuppliers() {
            $.ajax({
                url: '/api/suppliers',
                method: 'GET',
                data: { tenantId: 1, limit: 200 },
                success: function(response) {
                    const tbody = $('#suppliersTable tbody');
                    tbody.empty();

                    if (response.suppliers.length === 0) {
                        tbody.html('<tr><td colspan="8" class="text-center text-muted">No hay proveedores registrados</td></tr>');
                        return;
                    }

                    response.suppliers.forEach(function(s) {
                        const statusBadge = s.isActive ? '<span class="badge bg-success">Activo</span>' : '<span class="badge bg-secondary">Inactivo</span>';
                        const creditLabel = s.creditDays > 0 ? `<span class="badge bg-info text-dark">${s.creditDays} días</span>` : '<span class="text-muted">—</span>';
                        const row = `<tr>
                            <td><code>${s.supplierCode || '—'}</code></td>
                            <td>${s.ruc || '—'}</td>
                            <td><strong>${s.name}</strong></td>
                            <td>${s.contactName || '—'}</td>
                            <td>${s.phone || '—'}</td>
                            <td>${creditLabel}</td>
                            <td>${statusBadge}</td>
                            <td>
                                <div class="table-actions">
                                    <button class="btn btn-sm btn-outline-primary btn-sm-custom" onclick="editSupplier(${s.id})" title="Editar"><i class="bi bi-pencil"></i></button>
                                    <button class="btn btn-sm btn-outline-danger btn-sm-custom" onclick="deleteSupplier(${s.id})" title="Desactivar"><i class="bi bi-x-circle"></i></button>
                                </div>
                            </td>
                        </tr>`;
                        tbody.append(row);
                    });
                },
                error: function() {
                    showAlert('Error al cargar proveedores', 'danger');
                }
            });
        }

        function loadPendingSupplierPayments() {
            $.ajax({
                url: '/api/purchases/pending-payments',
                method: 'GET',
                data: { tenantId: 1 },
                success: function(response) {
                    const tbody = $('#pendingPaymentsTable tbody');
                    tbody.empty();

                    const orders = response.pendingOrders;
                    // Update badge
                    const badge = $('#pendingPaymentsBadge');
                    const sidebarBadge = $('#supplierDebtsBadge');
                    if (orders.length > 0) {
                        badge.text(orders.length).removeClass('d-none');
                        sidebarBadge.text(orders.length).removeClass('d-none');
                    } else {
                        badge.addClass('d-none');
                        sidebarBadge.addClass('d-none');
                    }

                    if (orders.length === 0) {
                        tbody.html('<tr><td colspan="10" class="text-center text-success"><i class="bi bi-check-circle"></i> No hay cuentas pendientes con proveedores</td></tr>');
                        return;
                    }

                    orders.forEach(function(o) {
                        const supplierName = o.supplier ? o.supplier.name : '—';
                        const supplierCode = o.supplier ? (o.supplier.supplierCode || '—') : '—';
                        const balance = (parseFloat(o.totalAmount) - parseFloat(o.amountPaid)).toFixed(2);
                        const today = new Date().toISOString().split('T')[0];
                        let statusBadge = '';
                        if (o.status === 'OVERDUE') statusBadge = '<span class="badge bg-danger">Vencida</span>';
                        else if (o.status === 'PARTIAL') statusBadge = '<span class="badge bg-warning text-dark">Parcial</span>';
                        else statusBadge = '<span class="badge bg-info text-dark">Pendiente</span>';

                        const dueDateClass = o.dueDate && o.dueDate < today ? 'text-danger fw-bold' : '';

                        const row = `<tr>
                            <td>${supplierName}</td>
                            <td><code>${supplierCode}</code></td>
                            <td>${o.invoiceNumber || '—'}</td>
                            <td>${o.purchaseDate || '—'}</td>
                            <td class="${dueDateClass}">${o.dueDate || '—'}</td>
                            <td>$${parseFloat(o.totalAmount).toFixed(2)}</td>
                            <td>$${parseFloat(o.amountPaid).toFixed(2)}</td>
                            <td><strong>$${balance}</strong></td>
                            <td>${statusBadge}</td>
                            <td>
                                <div class="table-actions">
                                    <button class="btn btn-sm btn-success btn-sm-custom" onclick="showPaySupplierModal(${o.id}, '${supplierName}', ${balance}, ${parseFloat(o.totalAmount)})" title="Registrar Pago"><i class="bi bi-cash-coin"></i></button>
                                    <button class="btn btn-sm btn-outline-secondary btn-sm-custom" onclick="sendSupplierReminder(${o.id})" title="Enviar Recordatorio"><i class="bi bi-envelope"></i></button>
                                </div>
                            </td>
                        </tr>`;
                        tbody.append(row);
                    });
                },
                error: function() {
                    $('#pendingPaymentsTable tbody').html('<tr><td colspan="10" class="text-center text-danger">Error al cargar cuentas</td></tr>');
                }
            });
        }

        function showCreateSupplierModal() {
            currentEditingSupplier = null;
            $('#supplierModalTitle').text('Nuevo Proveedor');
            $('#supplierForm')[0].reset();
            $('#supplierRuc').val('');
            $('#supplierCode').val('');
            $('#supplierCreditDays').val(0);
            $('#supplierStatus').val('true');
            new bootstrap.Modal(document.getElementById('supplierModal')).show();
        }

        function editSupplier(id) {
            $.ajax({
                url: `/api/suppliers/${id}`,
                method: 'GET',
                data: { tenantId: 1 },
                success: function(supplier) {
                    currentEditingSupplier = supplier;
                    $('#supplierModalTitle').text('Editar Proveedor');
                    $('#supplierRuc').val(supplier.ruc || '');
                    $('#supplierCode').val(supplier.supplierCode || '');
                    $('#supplierName').val(supplier.name);
                    $('#supplierCreditDays').val(supplier.creditDays || 0);
                    $('#supplierContactName').val(supplier.contactName || '');
                    $('#supplierEmail').val(supplier.email || '');
                    $('#supplierPhone').val(supplier.phone || '');
                    $('#supplierAddress').val(supplier.address || '');
                    $('#supplierNotes').val(supplier.notes || '');
                    $('#supplierStatus').val(supplier.isActive.toString());
                    new bootstrap.Modal(document.getElementById('supplierModal')).show();
                },
                error: function() {
                    showAlert('Error al cargar información del proveedor', 'danger');
                }
            });
        }

        function saveSupplier() {
            const supplierData = {
                tenantId: 1,
                name: $('#supplierName').val(),
                ruc: $('#supplierRuc').val().trim() || null,
                creditDays: parseInt($('#supplierCreditDays').val()) || 0,
                contactName: $('#supplierContactName').val(),
                email: $('#supplierEmail').val(),
                phone: $('#supplierPhone').val(),
                address: $('#supplierAddress').val(),
                notes: $('#supplierNotes').val(),
                isActive: $('#supplierStatus').val() === 'true'
            };

            if (!supplierData.name) {
                showAlert('El nombre del proveedor es requerido', 'warning');
                return;
            }

            const url = currentEditingSupplier ? `/api/suppliers/${currentEditingSupplier.id}` : '/api/suppliers';
            const method = currentEditingSupplier ? 'PUT' : 'POST';

            $.ajax({
                url: url,
                method: method,
                contentType: 'application/json',
                data: JSON.stringify(supplierData),
                success: function() {
                    showAlert(currentEditingSupplier ? 'Proveedor actualizado exitosamente' : 'Proveedor creado exitosamente', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('supplierModal')).hide();
                    loadSuppliers();
                },
                error: function(xhr) {
                    const error = xhr.responseJSON?.error || 'Error al guardar proveedor';
                    showAlert(error, 'danger');
                }
            });
        }

        function deleteSupplier(id) {
            if (!confirm('¿Está seguro de desactivar este proveedor?')) return;
            $.ajax({
                url: `/api/suppliers/${id}`,
                method: 'DELETE',
                data: { tenantId: 1 },
                success: function() {
                    showAlert('Proveedor desactivado exitosamente', 'success');
                    loadSuppliers();
                },
                error: function() {
                    showAlert('Error al desactivar proveedor', 'danger');
                }
            });
        }

        function showPaySupplierModal(orderId, supplierName, balance, total) {
            currentPayingOrderId = orderId;
            const today = new Date().toISOString().split('T')[0];
            $('#supplierPayInfo').text(`Proveedor: ${supplierName} | Total: $${total.toFixed(2)}`);
            $('#supplierPayBalance').text(`Saldo pendiente: $${parseFloat(balance).toFixed(2)}`);
            $('#supplierPayAmount').val(parseFloat(balance).toFixed(2)).attr('max', parseFloat(balance));
            $('#supplierPayDate').val(today);
            $('#supplierPayMethod').val('CASH');
            $('#supplierPayNotes').val('');
            new bootstrap.Modal(document.getElementById('supplierPayModal')).show();
        }

        function saveSupplierPayment() {
            const amount = parseFloat($('#supplierPayAmount').val());
            if (!amount || amount <= 0) {
                showAlert('Ingrese un monto válido', 'warning');
                return;
            }

            $.ajax({
                url: `/api/purchases/${currentPayingOrderId}/pay`,
                method: 'PATCH',
                contentType: 'application/json',
                data: JSON.stringify({
                    tenantId: 1,
                    amount: amount,
                    paymentDate: $('#supplierPayDate').val(),
                    paymentMethod: $('#supplierPayMethod').val(),
                    notes: $('#supplierPayNotes').val()
                }),
                success: function() {
                    showAlert('Pago registrado exitosamente', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('supplierPayModal')).hide();
                    loadPendingSupplierPayments();
                },
                error: function(xhr) {
                    const error = xhr.responseJSON?.error || 'Error al registrar pago';
                    showAlert(error, 'danger');
                }
            });
        }

        function sendSupplierReminder(orderId) {
            $.ajax({
                url: `/api/purchases/${orderId}/send-reminder`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ tenantId: 1 }),
                success: function() {
                    showAlert('Recordatorio enviado exitosamente', 'success');
                },
                error: function(xhr) {
                    const error = xhr.responseJSON?.error || 'Error al enviar recordatorio';
                    showAlert(error, 'danger');
                }
            });
        }

        function checkSupplierDebtsAndNotify() {
            $.ajax({
                url: '/api/purchases/check-overdue-notifications',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ tenantId: 1 }),
                success: function(resp) {
                    if (resp.notified > 0) {
                        showAlert(`Se enviaron ${resp.notified} recordatorio(s) de pago por correo`, 'warning');
                    }
                },
                error: function() { /* silencioso */ }
            });
        }

        // ========== SETTINGS FUNCTIONS ==========
        function loadTaxRate() {
            // Load tax_enabled
            $.ajax({
                url: '/api/settings/tax_enabled',
                method: 'GET',
                data: { tenantId: 1 },
                success: function(resp) {
                    taxEnabled = resp.value === 'true' || resp.value === true;
                    $('#taxEnabled').prop('checked', taxEnabled);
                    $('#taxRate').prop('disabled', !taxEnabled);
                    $('#taxRateSection').css('opacity', taxEnabled ? 1 : 0.5);
                    updateTaxDisplay();
                },
                error: function() { taxEnabled = true; updateTaxDisplay(); }
            });
            // Load tax_rate
            $.ajax({
                url: '/api/settings/tax_rate',
                method: 'GET',
                data: { tenantId: 1 },
                success: function(response) {
                    const parsed = parseFloat(response.value);
                    currentTaxRate = !isNaN(parsed) && parsed >= 0 && parsed <= 100 ? parsed : null;
                    updateTaxDisplay();
                },
                error: function() {
                    currentTaxRate = null;
                    updateTaxDisplay();
                }
            });
        }

        function loadSettings() {
            // Load tax_enabled
            $.ajax({
                url: '/api/settings/tax_enabled',
                method: 'GET',
                data: { tenantId: 1 },
                success: function(resp) {
                    taxEnabled = resp.value === 'true' || resp.value === true;
                    $('#taxEnabled').prop('checked', taxEnabled);
                    $('#taxRate').prop('disabled', !taxEnabled);
                    $('#taxRateSection').css('opacity', taxEnabled ? 1 : 0.5);
                    updateTaxDisplay();
                },
                error: function() { taxEnabled = true; updateTaxDisplay(); }
            });
            // Load tax rate
            $.ajax({
                url: '/api/settings/tax_rate',
                method: 'GET',
                data: { tenantId: 1 },
                success: function(response) {
                    const parsed = parseFloat(response.value);
                    const taxRate = !isNaN(parsed) && parsed >= 0 && parsed <= 100 ? parsed : '';
                    currentTaxRate = taxRate !== '' ? taxRate : null;
                    $('#taxRate').val(taxRate !== '' ? taxRate : '');
                    updateTaxDisplay();
                }
            });

            // Load discount rate
            $.ajax({
                url: '/api/settings/cash_transfer_discount_rate',
                method: 'GET',
                data: { tenantId: 1 },
                success: function(resp) {
                    const val = parseFloat(resp.value);
                    $('#discountRate').val(!isNaN(val) ? val : '');
                }
            });

            // Load SMTP settings
            $.ajax({
                url: '/api/settings',
                method: 'GET',
                data: { tenantId: 1 },
                success: function(response) {
                    response.settings.forEach(setting => {
                        switch(setting.settingKey) {
                            case 'smtp_host':
                                $('#smtpHost').val(setting.settingValue || '');
                                break;
                            case 'smtp_port':
                                $('#smtpPort').val(setting.settingValue || '587');
                                break;
                            case 'smtp_user':
                                $('#smtpUser').val(setting.settingValue || '');
                                break;
                            case 'smtp_password':
                                // Don't populate password for security
                                break;
                            case 'smtp_secure':
                                $('#smtpSecure').prop('checked', setting.settingValue === 'true');
                                break;
                            case 'smtp_from_email':
                                $('#smtpFromEmail').val(setting.settingValue || '');
                                break;
                            case 'smtp_from_name':
                                $('#smtpFromName').val(setting.settingValue || '');
                                break;
                            case 'brand_slogan':
                                const brandVal = setting.settingValue || 'Sistema de Licorería';
                                $('#brandSlogan').val(brandVal);
                                break;
                            case 'page_title_dashboard':
                                $('#pageTitleDashboard').val(setting.settingValue || '');
                                break;
                            case 'page_title_login':
                                $('#pageTitleLogin').val(setting.settingValue || 'Iniciar Sesión - LOCOBAR');
                                break;
                            case 'page_title_register':
                                $('#pageTitleRegister').val(setting.settingValue || 'Registro - LOCOBAR');
                                break;
                            case 'page_title_catalog':
                                $('#pageTitleCatalog').val(setting.settingValue || 'Catálogo - LOCOBAR');
                                break;
                            case 'page_title_cart':
                                $('#pageTitleCart').val(setting.settingValue || 'Carrito - LOCOBAR');
                                break;
                            case 'page_title_checkout':
                                $('#pageTitleCheckout').val(setting.settingValue || 'Checkout - LOCOBAR');
                                break;
                            case 'page_title_credits':
                                $('#pageTitleCredits').val(setting.settingValue || 'Mis Créditos - LOCOBAR');
                                break;
                            case 'page_title_group_purchases':
                                $('#pageTitleGroupPurchases').val(setting.settingValue || 'Mis Compras Grupales - LOCOBAR');
                                break;
                            case 'page_title_orders':
                                $('#pageTitleOrders').val(setting.settingValue || 'Mis Pedidos - LOCOBAR');
                                break;
                            case 'email_subject_verification_code':
                                $('#emailSubjectVerificationCode').val(setting.settingValue || 'Código de Verificación');
                                break;
                            case 'email_subject_welcome':
                                $('#emailSubjectWelcome').val(setting.settingValue || 'Bienvenido');
                                break;
                            case 'email_subject_password_reset':
                                $('#emailSubjectPasswordReset').val(setting.settingValue || 'Código de Recuperación de Contraseña');
                                break;
                            case 'email_subject_temporary_password':
                                $('#emailSubjectTemporaryPassword').val(setting.settingValue || 'Clave Temporal');
                                break;
                        }
                    });
                    // Título de la pestaña: usar page_title_dashboard si está configurado, si no brand_slogan + " - Dashboard"
                    const dashTitle = response.settings.find(function(s) { return s.settingKey === 'page_title_dashboard'; });
                    const brandSetting = response.settings.find(function(s) { return s.settingKey === 'brand_slogan'; });
                    const brandForTitle = (brandSetting && brandSetting.settingValue) ? brandSetting.settingValue : 'Sistema de Licorería';
                    document.title = (dashTitle && dashTitle.settingValue && dashTitle.settingValue.trim()) ? dashTitle.settingValue.trim() : (brandForTitle + ' - Dashboard');
                }
            });
        }

        $('#generalSettingsForm').on('submit', function(e) {
            e.preventDefault();
            const brandSlogan = $('#brandSlogan').val().trim() || 'Sistema de Licorería';
            const pageTitleDashboard = $('#pageTitleDashboard').val().trim();
            const settings = [
                { key: 'brand_slogan', value: brandSlogan, type: 'string', description: 'Frase/eslogan mostrado en login y correos' },
                { key: 'page_title_dashboard', value: pageTitleDashboard, type: 'string', description: 'Título pestaña dashboard' },
                { key: 'page_title_login', value: $('#pageTitleLogin').val().trim() || 'Iniciar Sesión - LOCOBAR', type: 'string', description: 'Título pestaña login' },
                { key: 'page_title_register', value: $('#pageTitleRegister').val().trim() || 'Registro - LOCOBAR', type: 'string', description: 'Título pestaña registro' },
                { key: 'page_title_catalog', value: $('#pageTitleCatalog').val().trim() || 'Catálogo - LOCOBAR', type: 'string', description: 'Título pestaña catálogo' },
                { key: 'page_title_cart', value: $('#pageTitleCart').val().trim() || 'Carrito - LOCOBAR', type: 'string', description: 'Título pestaña carrito' },
                { key: 'page_title_checkout', value: $('#pageTitleCheckout').val().trim() || 'Checkout - LOCOBAR', type: 'string', description: 'Título pestaña checkout' },
                { key: 'page_title_credits', value: $('#pageTitleCredits').val().trim() || 'Mis Créditos - LOCOBAR', type: 'string', description: 'Título pestaña créditos' },
                { key: 'page_title_group_purchases', value: $('#pageTitleGroupPurchases').val().trim() || 'Mis Compras Grupales - LOCOBAR', type: 'string', description: 'Título pestaña compras grupales' },
                { key: 'page_title_orders', value: $('#pageTitleOrders').val().trim() || 'Mis Pedidos - LOCOBAR', type: 'string', description: 'Título pestaña pedidos' },
                { key: 'email_subject_verification_code', value: $('#emailSubjectVerificationCode').val().trim() || 'Código de Verificación', type: 'string', description: 'Asunto: código de verificación (registro)' },
                { key: 'email_subject_welcome', value: $('#emailSubjectWelcome').val().trim() || 'Bienvenido', type: 'string', description: 'Asunto: bienvenida nuevo cliente' },
                { key: 'email_subject_password_reset', value: $('#emailSubjectPasswordReset').val().trim() || 'Código de Recuperación de Contraseña', type: 'string', description: 'Asunto: código recuperación contraseña' },
                { key: 'email_subject_temporary_password', value: $('#emailSubjectTemporaryPassword').val().trim() || 'Clave Temporal', type: 'string', description: 'Asunto: clave temporal cambio contraseña' }
            ];
            $.ajax({
                url: '/api/settings/bulk',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ tenantId: 1, settings: settings }),
                success: function() {
                    document.title = (pageTitleDashboard) ? pageTitleDashboard : (brandSlogan + ' - Dashboard');
                    showAlert('Configuración guardada correctamente', 'success');
                },
                error: function(xhr) {
                    const error = xhr.responseJSON?.error || 'Error al guardar';
                    showAlert(error, 'danger');
                }
            });
        });

        $('#taxEnabled').on('change', function() {
            const isOn = $(this).is(':checked');
            $('#taxRate').prop('disabled', !isOn);
            $('#taxRateSection').css('opacity', isOn ? 1 : 0.5);
        });

        $('#taxSettingsForm').on('submit', function(e) {
            e.preventDefault();
            const isEnabled = $('#taxEnabled').is(':checked');
            const taxRate = parseFloat($('#taxRate').val());
            const discountRateVal = parseFloat($('#discountRate').val()) || 0;

            if (isEnabled && (isNaN(taxRate) || taxRate < 0 || taxRate > 100)) {
                showAlert('El porcentaje de IVA debe ser un número entre 0 y 100', 'warning');
                return;
            }
            if (isNaN(discountRateVal) || discountRateVal < 0 || discountRateVal > 100) {
                showAlert('El porcentaje de descuento debe ser un número entre 0 y 100', 'warning');
                return;
            }

            // Save discount rate
            $.ajax({
                url: '/api/settings/cash_transfer_discount_rate',
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({ tenantId: 1, value: discountRateVal, type: 'number', description: 'Descuento (%) al pagar en efectivo o transferencia' })
            });

            // Save tax_enabled first, then tax_rate
            $.ajax({
                url: '/api/settings/tax_enabled',
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({ tenantId: 1, value: isEnabled.toString(), type: 'string', description: 'IVA habilitado (true/false)' }),
                success: function() {
                    taxEnabled = isEnabled;
                    if (isEnabled) {
                        $.ajax({
                            url: '/api/settings/tax_rate',
                            method: 'PUT',
                            contentType: 'application/json',
                            data: JSON.stringify({ tenantId: 1, value: taxRate, type: 'number', description: 'Porcentaje de IVA actual' }),
                            success: function() {
                                currentTaxRate = taxRate;
                                updateTaxDisplay();
                                showAlert('Configuración guardada exitosamente', 'success');
                                if (sellCart.length > 0) updateSellCart();
                            },
                            error: function(xhr) { showAlert(xhr.responseJSON?.error || 'Error al guardar IVA', 'danger'); }
                        });
                    } else {
                        currentTaxRate = 0;
                        updateTaxDisplay();
                        showAlert('Configuración guardada exitosamente', 'success');
                        if (sellCart.length > 0) updateSellCart();
                    }
                },
                error: function(xhr) { showAlert(xhr.responseJSON?.error || 'Error al guardar configuración', 'danger'); }
            });
        });

        function updateTaxDisplay() {
            if (taxEnabled && currentTaxRate != null) {
                $('.tax-row-pos').removeClass('d-none').addClass('d-flex');
                $('#sellCartModalTaxLabel').text(`IVA (${currentTaxRate.toFixed(0)}%):`);
            } else {
                $('.tax-row-pos').removeClass('d-flex').addClass('d-none');
            }
        }

        $('#smtpSettingsForm').on('submit', function(e) {
            e.preventDefault();
            const settings = [
                { key: 'smtp_host', value: $('#smtpHost').val(), type: 'string' },
                { key: 'smtp_port', value: $('#smtpPort').val(), type: 'number' },
                { key: 'smtp_user', value: $('#smtpUser').val(), type: 'string' },
                { key: 'smtp_password', value: $('#smtpPassword').val(), type: 'string' },
                { key: 'smtp_secure', value: $('#smtpSecure').is(':checked'), type: 'boolean' },
                { key: 'smtp_from_email', value: $('#smtpFromEmail').val(), type: 'string' },
                { key: 'smtp_from_name', value: $('#smtpFromName').val(), type: 'string' }
            ];

            $.ajax({
                url: '/api/settings/bulk',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    tenantId: 1,
                    settings: settings
                }),
                success: function() {
                    showAlert('Configuración SMTP guardada exitosamente', 'success');
                    $('#smtpPassword').val(''); // Clear password field
                },
                error: function(xhr) {
                    const error = xhr.responseJSON?.error || 'Error al guardar configuración SMTP';
                    showAlert(error, 'danger');
                }
            });
        });

        function testSMTPConnection() {
            showAlert('Probando conexión SMTP...', 'info');
            
            $.ajax({
                url: '/api/email/test',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ tenantId: 1 }),
                success: function(response) {
                    if (response.success) {
                        showAlert('Conexión SMTP exitosa', 'success');
                    } else {
                        showAlert('Error en conexión SMTP: ' + response.message, 'danger');
                    }
                },
                error: function(xhr) {
                    const error = xhr.responseJSON?.message || 'Error al probar conexión SMTP';
                    showAlert(error, 'danger');
                }
            });
        }

        // Load settings when settings section is shown
        $(document).on('click', '[data-section="settings"]', function() {
            setTimeout(loadSettings, 100);
        });

        // ── Backup / Restore ──────────────────────────────────────────────────

        $('#backupFileInput').on('change', function() {
            const file = this.files[0];
            if (file) {
                $('#backupFileName').text(file.name + ' (' + (file.size / 1024).toFixed(1) + ' KB)');
                $('#btnRestoreBackup').prop('disabled', false);
            } else {
                $('#backupFileName').text('Ningún archivo seleccionado');
                $('#btnRestoreBackup').prop('disabled', true);
            }
        });

        async function downloadBackup() {
            const btn = $('#btnDownloadBackup');
            btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-1"></span> Generando...');

            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch('/api/backup/download', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (!response.ok) {
                    // El servidor devolvió un error JSON
                    const err = await response.json().catch(() => ({}));
                    throw new Error(err.error || 'Error al generar backup (código ' + response.status + ')');
                }

                // Obtener el nombre del archivo desde el header
                const disposition = response.headers.get('Content-Disposition') || '';
                const match = disposition.match(/filename="([^"]+)"/);
                const filename = match ? match[1] : 'licoreria_backup.sql';

                // Convertir respuesta a blob y disparar descarga
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showAlert('Backup generado: ' + filename, 'success');
            } catch (error) {
                showAlert(error.message, 'danger');
            } finally {
                btn.prop('disabled', false).html('<i class="bi bi-cloud-download"></i> Descargar Backup');
            }
        }

        function confirmRestore() {
            const file = $('#backupFileInput')[0].files[0];
            if (!file) return;

            if (!confirm(
                '⚠️ ADVERTENCIA\n\n' +
                'Esto reemplazará TODOS los datos actuales de la base de datos con el contenido del archivo:\n\n' +
                '"' + file.name + '"\n\n' +
                'Esta acción NO se puede deshacer.\n\n' +
                '¿Confirmas que deseas continuar?'
            )) return;

            const btn = $('#btnRestoreBackup');
            btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-1"></span> Restaurando...');

            const formData = new FormData();
            formData.append('backup', file);

            $.ajax({
                url: '/api/backup/restore',
                method: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                headers: { 'Authorization': 'Bearer ' + localStorage.getItem('adminToken') },
                success: function(response) {
                    let msg = response.message;
                    if (response.warnings) msg += '\n' + response.warnings;
                    showAlert(msg, 'success');
                    $('#backupFileInput').val('');
                    $('#backupFileName').text('Ningún archivo seleccionado');
                    btn.prop('disabled', true).html('<i class="bi bi-arrow-counterclockwise"></i> Restaurar Base de Datos');
                },
                error: function(xhr) {
                    const error = xhr.responseJSON?.error || 'Error al restaurar la base de datos';
                    showAlert(error, 'danger');
                    btn.prop('disabled', false).html('<i class="bi bi-arrow-counterclockwise"></i> Restaurar Base de Datos');
                }
            });
        }
        
        // Event handlers para el modal del carrito (delegación: los botones están más abajo en el DOM)
        $(document).on('click', '#sellCartModalClear', function() {
            if (confirm('¿Está seguro de vaciar el carrito?')) {
                sellCart = [];
                updateSellCart();
                updateSellCartModal();
            }
        });
        
        $(document).on('click', '#sellCartModalPay', function() {
            if (isGroupSale) {
                processGroupSale();
            } else {
                $('#sellCartModal').modal('hide');
                processSale();
            }
        });
        
        // Sincronizar toggle de venta grupal entre modal y función original
        $('#sellCartModalGroupSaleToggle').on('change', function() {
            $('#groupSaleToggle').prop('checked', $(this).is(':checked'));
            toggleGroupSaleModal();
        });
        
        // Cerrar dropdown de búsqueda grupal al hacer clic fuera
        $(document).on('click', function(e) {
            if (!$(e.target).closest('#gsSearch, #gsDropdown').length) {
                $('#gsDropdown').hide();
            }
        });

        // Sincronizar toggle original con modal
        $('#groupSaleToggle').on('change', function() {
            $('#sellCartModalGroupSaleToggle').prop('checked', $(this).is(':checked'));
            if ($('#sellCartModal').hasClass('show')) {
                toggleGroupSaleModal();
            }
        });
        
        // Sincronizar campos cuando se cierra el modal
        $('#sellCartModal').on('hidden.bs.modal', function() {
            // Sincronizar campos de vuelta al lateral (si existe) para compatibilidad
            if ($('#sellPaymentMethod').length) {
                $('#sellPaymentMethod').val($('#sellCartModalPaymentMethod').val());
            }
            if ($('#sellCustomer').length) {
                $('#sellCustomer').val($('#sellCartModalCustomer').val());
            }
            if ($('#sellTransferReference').length) {
                $('#sellTransferReference').val($('#sellCartModalTransferReference').val());
                toggleTransferReference();
            }
            // Ocultar dropdown al cerrar modal
            $('#sellCartModalCustomersList').hide();
        });
        
        // Ocultar dropdown cuando se hace clic fuera
        $(document).on('click', function(e) {
            // Solo ocultar si el método de pago es CREDIT y el clic fue fuera del contenedor
            if ($('#sellCartModalPaymentMethod').val() === 'CREDIT') {
                if (!$(e.target).closest('#sellCartModalCustomerSelectContainer').length) {
                    hideCustomersDropdown();
                }
            }
        });
        
        // Prevenir que el dropdown se oculte al hacer clic dentro
        $('#sellCartModalCustomersList').on('click', function(e) {
            e.stopPropagation();
        });
        
        // Mostrar dropdown solo cuando el campo de búsqueda tiene foco o se hace clic
        $('#sellCartModalCustomerSearch').on('focus click', function() {
            if ($('#sellCartModalPaymentMethod').val() === 'CREDIT') {
                // Asegurar que la lista esté cargada
                if (allCustomersList.length === 0) {
                    loadCustomersForCredit(true);
                } else {
                    // Si ya está cargada, solo mostrar
                    showCustomersDropdown();
                }
            }
        });
    </script>

    <!-- Product Image Modal -->
    <div class="modal fade" id="productImageModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productImageModalTitle">Imagen del Producto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="productImageModalImg" src="" alt="" style="max-width: 100%; max-height: 70vh; border-radius: 8px;">
                </div>
            </div>
        </div>
    </div>

    <!-- Sell Cart Modal -->
    <div class="modal fade" id="sellCartModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-cart3"></i> Carrito de Compras
                        <span class="badge bg-light text-dark ms-2" id="sellCartModalCount">0</span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
                    <!-- Cart Items -->
                    <div id="sellCartModalItems">
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-cart" style="font-size: 3em;"></i>
                            <p class="mt-2">Carrito vacío</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="w-100">
                        <!-- Group Sale Toggle -->
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="sellCartModalGroupSaleToggle" onchange="toggleGroupSaleModal()">
                                <label class="form-check-label" for="sellCartModalGroupSaleToggle">
                                    <strong><i class="bi bi-people"></i> Venta Grupal</strong>
                                </label>
                            </div>
                        </div>

                        <!-- Normal Sale Fields (hidden when group sale is active) -->
                        <div id="sellCartModalNormalSaleFields">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label" id="sellCartModalCustomerLabel">Cliente (Opcional)</label>
                                    <div id="sellCartModalCustomerTextContainer">
                                        <input type="text" class="form-control" id="sellCartModalCustomer" placeholder="Nombre del cliente">
                                    </div>
                                    <div id="sellCartModalCustomerSelectContainer" style="display: none; position: relative;">
                                        <div class="input-group mb-2">
                                            <input type="text" class="form-control" id="sellCartModalCustomerSearch" placeholder="Buscar cliente..." onkeyup="filterCustomersForCredit(this.value); if($('#sellCartModalPaymentMethod').val() === 'CREDIT') showCustomersDropdown();" onfocus="if($('#sellCartModalPaymentMethod').val() === 'CREDIT') showCustomersDropdown();" autocomplete="off">
                                            <button class="btn btn-outline-secondary" type="button" onclick="clearCustomerSelection()" id="clearCustomerBtn" style="display: none;" title="Limpiar selección">
                                                <i class="bi bi-x"></i>
                                            </button>
                                            <button class="btn btn-outline-primary" onclick="showCreateCustomerModal()" title="Agregar Cliente" type="button">
                                                <i class="bi bi-person-plus"></i>
                                            </button>
                                        </div>
                                        <input type="hidden" id="sellCartModalCustomerId" value="">
                                        <div id="sellCartModalCustomersList" class="customer-dropdown" style="display: none; position: fixed; z-index: 9999; max-height: 250px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 5px; background: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                                            <div class="text-muted text-center py-3">Cargando clientes...</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6" id="sellCartModalPaymentMethodCol">
                                    <label class="form-label">Método de Pago</label>
                                    <select class="form-select" id="sellCartModalPaymentMethod" onchange="togglePaymentMethodFieldsModal()">
                                        <option value="CASH">Efectivo</option>
                                        <option value="CARD">Tarjeta</option>
                                        <option value="TRANSFER">Transferencia</option>
                                        <option value="CREDIT">Crédito</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mb-3" id="sellCartModalTransferReferenceField" style="display: none;">
                                <label class="form-label">Referencia de Transferencia <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="sellCartModalTransferReference" placeholder="Número de referencia de la transferencia">
                                <small class="form-text text-muted">Ingrese el número de referencia de la transferencia bancaria</small>
                            </div>
                            <div class="mb-3" id="sellCartModalCreditFields" style="display: none;">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label">Fecha Límite de Pago <span class="text-danger">*</span></label>
                                        <input type="date" class="form-control" id="sellCartModalCreditDueDate" min="" required>
                                        <small class="form-text text-muted">Fecha límite para el pago del crédito</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Tasa de Interés Diaria (%)</label>
                                        <input type="number" class="form-control" id="sellCartModalCreditInterestRate" value="1" step="0.01" min="0" max="100">
                                        <small class="form-text text-muted">Porcentaje de interés diario (opcional, por defecto 1%)</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Group Sale Fields (shown when group sale is active) -->
                        <div id="sellCartModalGroupSaleFields" style="display: none;">
                            <!-- Customer search -->
                            <div class="mb-2" style="position: relative;">
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control" id="gsSearch"
                                           placeholder="Buscar cliente para agregar..."
                                           oninput="gsSearchCustomer(this.value)"
                                           autocomplete="off">
                                </div>
                                <div id="gsDropdown" class="list-group list-group-flush"
                                     style="position: absolute; top: 100%; left: 0; right: 0; z-index: 1100;
                                            max-height: 160px; overflow-y: auto;
                                            border: 1px solid #dee2e6; border-radius: 4px;
                                            background: #fff; display: none;
                                            box-shadow: 0 4px 6px rgba(0,0,0,.1);"></div>
                            </div>
                            <!-- Participant cards -->
                            <div id="gsParticipantes" class="mb-2" style="max-height: 200px; overflow-y: auto;"></div>
                            <!-- Divide + validation -->
                            <div class="d-flex align-items-center gap-2 mb-1">
                                <button class="btn btn-sm btn-outline-secondary" type="button" onclick="gsDividirIgualmente()">
                                    <i class="bi bi-distribute-vertical"></i> Dividir igualmente
                                </button>
                                <div id="gsValidacion" class="small flex-fill text-end"></div>
                            </div>
                        </div>

                        <!-- Resumen del pedido (como carrito cliente) -->
                        <div class="card mb-3">
                            <div class="card-body">
                                <h5 class="card-title mb-3"><i class="bi bi-receipt"></i> Resumen del pedido</h5>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Subtotal:</span>
                                    <span id="sellCartModalSubtotal">$0.00</span>
                                </div>
                                <div class="justify-content-between mb-2 tax-row-pos d-none">
                                    <span id="sellCartModalTaxLabel">IVA:</span>
                                    <span id="sellCartModalTax">$0.00</span>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between mb-0">
                                    <strong>Total:</strong>
                                    <strong id="sellCartModalTotal" class="text-primary">$0.00</strong>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-outline-danger flex-fill" id="sellCartModalClear">
                                <i class="bi bi-trash"></i> Vaciar Carrito
                            </button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            <button type="button" class="btn btn-success flex-fill" id="sellCartModalPay" disabled>
                                <i class="bi bi-credit-card"></i> <span id="sellCartModalPayButtonText">Procesar Venta</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
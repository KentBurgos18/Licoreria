<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Punto de Venta - Licorer铆a</title>
    <link href="/libs/css/bootstrap.min.css" rel="stylesheet">
    <link href="/libs/css/select2.min.css" rel="stylesheet">
    <link href="/libs/css/bootstrap-icons.css" rel="stylesheet">
    <link href="/public/css/theme.css" rel="stylesheet">
    <style>
        .pos-container {
            display: flex;
            height: calc(100vh - 60px);
        }
        
        .products-section {
            flex: 1;
            overflow-y: auto;
            background-color: #f8f9fa;
            width: 100%;
        }
        
        
        /* Burbuja flotante del carrito - tema LOCOBAR */
        .cart-bubble {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, var(--lb-primary-mid, #16213e) 0%, var(--lb-primary-dark, #0f3460) 100%);
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
            animation: pulse 2s infinite;
        }
        
        .cart-bubble:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(102, 126, 234, 0.6);
        }
        
        .cart-bubble.show {
            display: flex;
        }
        
        .cart-bubble-icon {
            color: white;
            font-size: 1.8em;
            position: relative;
        }
        
        .cart-bubble-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: #dc3545;
            color: white;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75em;
            font-weight: bold;
            border: 2px solid white;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            }
            50% {
                box-shadow: 0 4px 30px rgba(102, 126, 234, 0.6);
            }
            100% {
                box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            }
        }
        
        .product-card {
            background-color: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .product-card.combo {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }
        
        .product-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .stock-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 0.8em;
        }
        
        .combo-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: #ffc107;
            color: #000;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: bold;
        }
        
        .cart-items {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        
        .cart-item {
            background-color: #f8f9fa;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
            position: relative;
        }
        
        .cart-item.combo-item {
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
            border: 1px solid #9c27b0;
        }
        
        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .cart-summary {
            border-top: 2px solid #dee2e6;
            padding: 15px;
            background-color: #f8f9fa;
        }
        
        .stock-warning {
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
        }
        
        .stock-error {
            background-color: #f8d7da;
            border: 1px solid #dc3545;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
        }
        
        .combo-info {
            font-size: 0.85em;
            opacity: 0.8;
            margin-top: 5px;
        }
        
        .product-search {
            padding: 15px;
            background-color: white;
            border-bottom: 1px solid #dee2e6;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .filter-tabs {
            display: flex;
            background-color: white;
            border-bottom: 1px solid #dee2e6;
            padding: 0 15px;
        }
        
        .filter-tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .filter-tab:hover {
            background-color: #f8f9fa;
        }
        
        .filter-tab.active {
            border-bottom-color: #007bff;
            background-color: #e3f2fd;
        }
        
        .payment-section {
            padding: 15px;
            border-top: 1px solid #dee2e6;
        }
        
        .btn-pay {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-shop"></i> Licorer铆a POS
            </a>
            <div class="navbar-nav ms-auto align-items-center">
                <div class="dropdown me-3">
                    <button class="btn btn-outline-light btn-sm position-relative" type="button" id="posNotificationsDropdown" data-bs-toggle="dropdown" aria-expanded="false" title="Notificaciones">
                        <i class="bi bi-bell"></i>
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none" id="posNotificationsBadge">0</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" id="posNotificationsList" style="min-width: 320px; max-height: 400px; overflow-y: auto;">
                        <li class="dropdown-header">Notificaciones</li>
                        <li><hr class="dropdown-divider"></li>
                        <li id="posNotificationsListEmpty" class="px-3 py-2 text-muted small">No hay notificaciones</li>
                        <li id="posNotificationsListItems"></li>
                    </ul>
                </div>
                <span class="navbar-text mb-0">
                    <i class="bi bi-person-circle"></i> 
                    <span id="currentUser">Cajero</span>
                </span>
            </div>
        </div>
    </nav>

    <!-- Burbuja flotante del carrito -->
    <div class="cart-bubble" id="cartBubble" onclick="openCartModal()">
        <div class="cart-bubble-icon">
            <i class="bi bi-cart3"></i>
            <span class="cart-bubble-badge" id="cartBubbleBadge">0</span>
        </div>
    </div>

    <div class="pos-container">
        <!-- Products Section -->
        <div class="products-section">
            <!-- Product Search -->
            <div class="product-search">
                <div class="row">
                    <div class="col-md-8">
                        <input type="text" class="form-control" id="productSearch" 
                               placeholder="Buscar producto por nombre o SKU...">
                    </div>
                    <div class="col-md-4">
                        <select class="form-select" id="categoryFilter">
                            <option value="">Todas las categor铆as</option>
                            <option value="SIMPLE">Productos Simples</option>
                            <option value="COMBO">Combos</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Filter Tabs -->
            <div class="filter-tabs">
                <div class="filter-tab active" data-filter="all">
                    <i class="bi bi-grid"></i> Todos
                </div>
                <div class="filter-tab" data-filter="available">
                    <i class="bi bi-check-circle"></i> Disponibles
                </div>
                <div class="filter-tab" data-filter="combos">
                    <i class="bi bi-gift"></i> Combos
                </div>
            </div>

            <!-- Products Grid -->
            <div id="productsGrid">
                <!-- Products will be loaded here -->
            </div>
        </div>

    </div>

    <!-- Cart Modal -->
    <div class="modal fade" id="cartModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-cart3"></i> Carrito de Compras
                        <span class="badge bg-light text-dark ms-2" id="cartModalCount">0</span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
                    <!-- Stock Warnings -->
                    <div id="cartModalWarnings"></div>
                    
                    <!-- Cart Items -->
                    <div id="cartModalItems">
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-cart" style="font-size: 3em;"></i>
                            <p class="mt-2">Carrito vac铆o</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="w-100">
                        <!-- Cart Summary -->
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="row mb-2">
                                    <div class="col">Subtotal:</div>
                                    <div class="col text-end" id="cartModalSubtotal">$0.00</div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col" id="cartModalTaxLabel">IVA:</div>
                                    <div class="col text-end" id="cartModalTax">$0.00</div>
                                </div>
                                <div class="row mb-2 d-none" id="cartModalDiscountRow">
                                    <div class="col text-success">Descuento:</div>
                                    <div class="col text-end text-success" id="cartModalDiscount">-$0.00</div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col fw-bold">Total:</div>
                                    <div class="col text-end fw-bold" id="cartModalTotal">$0.00</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Payment Method -->
                        <div class="mb-3" id="normalPaymentMethodDiv">
                            <label class="form-label">M茅todo de Pago</label>
                            <select class="form-select" id="cartModalPaymentMethod">
                                <option value="CASH">Efectivo</option>
                                <option value="CARD">Tarjeta</option>
                                <option value="TRANSFER">Transferencia</option>
                            </select>
                        </div>

                        <!-- Toggle Venta Grupal -->
                        <div class="mb-2 border-top pt-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="toggleGrupal" role="switch" onchange="toggleModoGrupal()">
                                <label class="form-check-label fw-semibold" for="toggleGrupal">
                                    <i class="bi bi-people"></i> Venta Grupal
                                </label>
                            </div>
                        </div>

                        <!-- Secci贸n Grupal (oculta por defecto) -->
                        <div id="grupalSection" class="d-none mb-3">
                            <!-- Buscador de clientes -->
                            <div style="position:relative">
                                <div class="input-group mb-1">
                                    <input type="text" class="form-control form-control-sm" id="grupalClienteSearch"
                                           placeholder="Buscar cliente por nombre o c茅dula..."
                                           oninput="grupalBuscarCliente(this.value)" autocomplete="off">
                                    <button class="btn btn-outline-secondary btn-sm" type="button" onclick="grupalAgregarDesdeInput()">
                                        <i class="bi bi-person-plus"></i>
                                    </button>
                                </div>
                                <div id="grupalClienteDropdown" class="list-group list-group-flush"
                                     style="position:absolute;top:100%;left:0;right:0;z-index:1100;max-height:150px;overflow-y:auto;border:1px solid #dee2e6;border-radius:4px;background:#fff;display:none"></div>
                            </div>

                            <!-- Lista de participantes (scrollable) -->
                            <div id="grupalParticipantes" class="mb-2 mt-2" style="max-height:220px;overflow-y:auto"></div>

                            <!-- Dividir + Validaci贸n -->
                            <div class="d-flex gap-2 mb-1">
                                <button class="btn btn-outline-secondary btn-sm flex-fill" type="button" onclick="grupalDividirIgualmente()">
                                    <i class="bi bi-distribute-vertical"></i> Dividir igualmente
                                </button>
                            </div>
                            <div id="grupalValidacion" class="small mt-1"></div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-outline-danger flex-fill" id="cartModalClear">
                                <i class="bi bi-trash"></i> Vaciar Carrito
                            </button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            <button type="button" class="btn btn-lb-accent flex-fill" id="cartModalPay" disabled>
                                <i class="bi bi-credit-card"></i> Pagar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sale Confirmation Modal -->
    <div class="modal fade" id="saleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmar Venta</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="saleConfirmation"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-lb-primary" id="confirmSale">Confirmar Venta</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Venta exitosa Modal (POS - despu茅s de procesar venta) -->
    <div class="modal fade" id="saleSuccessModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-body text-center py-4">
                    <h5 class="text-success mb-2"><i class="bi bi-check-circle-fill"></i> Venta exitosa</h5>
                    <p class="text-muted small mb-0" id="saleSuccessTotal"></p>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-lb-primary" data-bs-dismiss="modal" id="saleSuccessCloseBtn">Aceptar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/libs/js/jquery.min.js"></script>
    <script src="/libs/js/bootstrap.bundle.min.js"></script>
    <script src="/libs/js/select2.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        let cart = [];
        let products = [];
        let currentFilter = 'all';
        let currentTaxRate = null; // Solo desde Configuraci贸n
        let currentDiscountRate = 0; // % descuento efectivo/transferencia

        $(document).ready(function() {
            loadTaxRate();
            loadDiscountRate();
            loadProducts();
            initializeEventHandlers();
            loadPosNotifications();
            connectPosNotificationsSocket();
            setTimeout(function() {
                try {
                    if (localStorage.getItem('adminToken')) registerWebPush();
                } catch (e) { console.warn('Web Push init:', e); }
            }, 1500);
        });

        function loadPosNotifications() {
            const token = localStorage.getItem('adminToken');
            if (!token) return;
            $.ajax({
                url: '/api/notifications',
                method: 'GET',
                headers: { 'Authorization': 'Bearer ' + token },
                data: { unreadOnly: 'true' },
                success: function(data) {
                    const notifications = data.notifications || [];
                    const badge = $('#posNotificationsBadge');
                    if (notifications.length > 0) {
                        badge.text(notifications.length).removeClass('d-none');
                    } else {
                        badge.addClass('d-none');
                    }
                    const container = $('#posNotificationsListItems');
                    const emptyEl = $('#posNotificationsListEmpty');
                    container.empty();
                    if (notifications.length === 0) {
                        emptyEl.show();
                        return;
                    }
                    emptyEl.hide();
                    notifications.forEach(function(n) {
                        const sale = n.sale || {};
                        const total = sale.totalAmount != null ? parseFloat(sale.totalAmount).toFixed(2) : '0.00';
                        const saleId = n.saleId || sale.id;
                        const customerName = (sale.customer && sale.customer.name) ? sale.customer.name : '';
                        const text = (n.title || 'Cliente espera confirmaci贸n de pago en efectivo') + ' - Venta #' + saleId + ' - $' + total + (customerName ? ' - ' + customerName : '');
                        const li = $('<li class="dropdown-item d-flex align-items-center justify-content-between gap-2"></li>');
                        li.html('<span class="small text-truncate flex-grow-1">' + text + '</span> <button class="btn btn-sm btn-success flex-shrink-0" type="button" data-sale-id="' + saleId + '">Confirmar pago</button>');
                        li.find('button').on('click', function(e) {
                            e.preventDefault();
                            const id = $(this).data('sale-id');
                            $.ajax({
                                url: '/api/sales/' + id + '/confirm-cash',
                                method: 'POST',
                                headers: { 'Authorization': 'Bearer ' + token },
                                contentType: 'application/json',
                                data: JSON.stringify({ tenantId: 1 }),
                                success: function() { loadPosNotifications(); },
                                error: function(xhr) {
                                    const msg = xhr.responseJSON && xhr.responseJSON.error ? xhr.responseJSON.error : 'Error al confirmar';
                                    if (typeof showAlert === 'function') showAlert(msg, 'danger'); else alert(msg);
                                }
                            });
                        });
                        container.append(li);
                    });
                }
            });
        }
        function connectPosNotificationsSocket() {
            const token = localStorage.getItem('adminToken');
            if (!token || typeof io === 'undefined') return;
            const socket = io({ auth: { token: token } });
            socket.on('cash-pending', function() { loadPosNotifications(); });
        }

        // Web Push: suscripci贸n para notificaciones en el dispositivo (incl. m贸vil)
        function urlBase64ToUint8Array(base64String) {
            var padding = '='.repeat((4 - base64String.length % 4) % 4);
            var base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            var rawData = window.atob(base64);
            var outputArray = new Uint8Array(rawData.length);
            for (var i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
            return outputArray;
        }
        function registerWebPush() {
            if (!('Notification' in window) || !('serviceWorker' in navigator) || !('PushManager' in window)) return;
            if (Notification.permission === 'denied') return;
            var token = localStorage.getItem('adminToken');
            if (!token) return;
            function doSubscribe() {
                navigator.serviceWorker.register('/sw.js').then(function(reg) {
                    return fetch('/api/public/vapid-public-key').then(function(r) { return r.json(); }).then(function(data) {
                        if (!data.publicKey) return;
                        return reg.pushManager.subscribe({
                            userVisibleOnly: true,
                            applicationServerKey: urlBase64ToUint8Array(data.publicKey)
                        });
                    });
                }).then(function(subscription) {
                    if (!subscription) return;
                    return fetch('/api/notifications/push-subscribe', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                        body: JSON.stringify({ subscription: subscription.toJSON() })
                    });
                }).catch(function(err) { console.warn('Web Push subscribe:', err); });
            }
            if (Notification.permission === 'granted') {
                doSubscribe();
            } else {
                Notification.requestPermission().then(function(p) { if (p === 'granted') doSubscribe(); });
            }
        }

        function loadProducts() {
            console.log('Loading products...');
            
            const token = localStorage.getItem('adminToken');
            const authHeaders = token ? { 'Authorization': 'Bearer ' + token } : {};
            $.ajax({
                url: '/api/products',
                method: 'GET',
                headers: authHeaders,
                data: { 
                    tenantId: getCurrentTenantId(),
                    isActive: true,
                    limit: 100
                },
                success: function(response) {
                    console.log('Products loaded:', response.products.length);
                    products = response.products;
                    
                    // Get availability for all products
                    const productIds = products.map(p => p.id);
                    console.log('Getting availability for products:', productIds);
                    
                    $.ajax({
                        url: '/api/products/availability/bulk',
                        method: 'POST',
                        headers: authHeaders,
                        contentType: 'application/json',
                        data: JSON.stringify({
                            tenantId: getCurrentTenantId(),
                            productIds: productIds
                        }),
                        success: function(response) {
                            console.log('Availability loaded:', response.products.length);
                            
                            // Merge availability info into products
                            const availabilityMap = {};
                            response.products.forEach(product => {
                                availabilityMap[product.productId] = product;
                            });
                            
                            products = products.map(product => {
                                const availability = availabilityMap[product.id];
                                if (availability) {
                                    if (availability.productType === 'SIMPLE') {
                                        return {
                                            ...product,
                                            currentStock: availability.currentStock,
                                            availableStock: availability.currentStock
                                        };
                                    } else {
                                        return {
                                            ...product,
                                            availableStock: availability.availableStock
                                        };
                                    }
                                }
                                return product;
                            });
                            
                            console.log('Final products with availability:', products);
                            displayProducts(products);
                        },
                        error: function(xhr) {
                            console.error('Error loading availability:', xhr);
                            // Fallback: display products without availability
                            displayProducts(products);
                        }
                    });
                },
                error: function(xhr) {
                    console.error('Error loading products:', xhr);
                    showAlert('Error al cargar productos', 'danger');
                }
            });
        }

        function displayProducts(productsToDisplay) {
            const grid = $('#productsGrid');
            grid.empty();

            productsToDisplay.forEach(product => {
                const productCard = createProductCard(product);
                grid.append(productCard);
            });
        }

        function createProductCard(product) {
            const isCombo = product.productType === 'COMBO';
            const stockInfo = product.availableStock !== undefined ? 
                product.availableStock : (product.currentStock || 0);
            
            const isAvailable = stockInfo > 0;
            const stockClass = stockInfo === 0 ? 'bg-danger' : 
                              stockInfo < 5 ? 'bg-warning' : 'bg-success';
            
            let cardClass = 'product-card';
            if (!isAvailable) cardClass += ' disabled';
            if (isCombo) cardClass += ' combo';

            let stockText = '';
            if (isCombo) {
                stockText = `${stockInfo} combos`;
            } else {
                stockText = `Stock: ${stockInfo}`;
            }

            return `
                <div class="${cardClass}" onclick="addToCart(${product.id})" data-product-id="${product.id}">
                    ${isCombo ? '<div class="combo-badge">COMBO</div>' : ''}
                    <div class="stock-badge">
                        <span class="badge ${stockClass}">${stockText}</span>
                    </div>
                    <h6>${product.name}</h6>
                    <div class="text-muted small">${product.sku}</div>
                    <div class="fw-bold mt-2">$${product.salePrice.toFixed(2)}</div>
                    ${isCombo ? '<div class="combo-info">Producto virtual compuesto</div>' : ''}
                </div>
            `;
        }

        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            // Check availability
            const stockInfo = product.availableStock !== undefined ? 
                product.availableStock : (product.currentStock || 0);
            
            if (stockInfo === 0) {
                showAlert('Producto sin stock disponible', 'warning');
                return;
            }

            // Check if already in cart
            const existingItem = cart.find(item => item.productId === productId);
            if (existingItem) {
                // Check if we can add more
                if (existingItem.quantity >= stockInfo) {
                    showAlert('No hay suficiente stock disponible', 'warning');
                    return;
                }
                existingItem.quantity += 1;
            } else {
                cart.push({
                    productId: product.id,
                    productName: product.name,
                    productSku: product.sku,
                    productType: product.productType,
                    unitPrice: product.salePrice,
                    quantity: 1,
                    maxAvailable: stockInfo
                });
            }

            updateCart();
            checkStockAvailability();
        }

        function updateCart() {
            const cartBubble = $('#cartBubble');
            const cartBubbleBadge = $('#cartBubbleBadge');
            
            // Calcular total de items
            let totalItems = 0;
            cart.forEach(item => {
                totalItems += item.quantity;
            });
            
            // Actualizar burbuja flotante
            if (totalItems > 0) {
                cartBubble.addClass('show');
                cartBubbleBadge.text(totalItems);
            } else {
                cartBubble.removeClass('show');
                cartBubbleBadge.text('0');
            }
            
            updateTotals();
            updateCartModal();
        }
        
        function updateCartModal() {
            const cartModalItems = $('#cartModalItems');
            const cartModalCount = $('#cartModalCount');
            const cartModalWarnings = $('#cartModalWarnings');
            
            // Calcular total de items
            let totalItems = 0;
            cart.forEach(item => {
                totalItems += item.quantity;
            });
            
            cartModalCount.text(totalItems);
            
            if (cart.length === 0) {
                cartModalItems.html(`
                    <div class="text-center text-muted py-5">
                        <i class="bi bi-cart" style="font-size: 3em;"></i>
                        <p class="mt-2">Carrito vac铆o</p>
                    </div>
                `);
                $('#cartModalPay').prop('disabled', true);
            } else {
                let itemsHtml = '';
                
                cart.forEach(item => {
                    const itemClass = item.productType === 'COMBO' ? 'cart-item combo-item' : 'cart-item';
                    
                    itemsHtml += `
                        <div class="${itemClass} mb-3">
                            <button class="btn btn-sm btn-outline-danger position-absolute top-0 end-0 m-1" 
                                    onclick="removeFromCart(${item.productId}); updateCartModal();">
                                <i class="bi bi-x"></i>
                            </button>
                            <div class="row">
                                <div class="col-8">
                                    <div class="fw-bold">${item.productName}</div>
                                    <div class="text-muted small">${item.productSku}</div>
                                    ${item.productType === 'COMBO' ? 
                                        '<div class="text-muted small"> Combo Virtual</div>' : ''}
                                </div>
                                <div class="col-4 text-end">
                                    <div class="fw-bold">$${(item.unitPrice * item.quantity).toFixed(2)}</div>
                                    <div class="text-muted small">$${item.unitPrice.toFixed(2)} c/u</div>
                                </div>
                            </div>
                            <div class="quantity-controls mt-2">
                                <button class="btn btn-sm btn-outline-secondary" 
                                        onclick="updateQuantity(${item.productId}, ${item.quantity - 1}); updateCartModal();"
                                        ${item.quantity <= 1 ? 'disabled' : ''}>
                                    <i class="bi bi-dash"></i>
                                </button>
                                <span class="mx-2">${item.quantity}</span>
                                <button class="btn btn-sm btn-outline-secondary" 
                                        onclick="updateQuantity(${item.productId}, ${item.quantity + 1}); updateCartModal();"
                                        ${item.quantity >= item.maxAvailable ? 'disabled' : ''}>
                                    <i class="bi bi-plus"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                cartModalItems.html(itemsHtml);
                
                // Actualizar warnings
                let hasIssues = false;
                let warningsHtml = '';
                cart.forEach(item => {
                    if (item.quantity > item.maxAvailable) {
                        hasIssues = true;
                        warningsHtml += `
                            <div class="stock-error mb-2">
                                <strong>${item.productName}</strong>: 
                                Solicitado ${item.quantity}, disponible ${item.maxAvailable}
                            </div>
                        `;
                    } else if (item.maxAvailable < 5) {
                        warningsHtml += `
                            <div class="stock-warning mb-2">
                                <strong>${item.productName}</strong>: 
                                Solo quedan ${item.maxAvailable} unidades
                            </div>
                        `;
                    }
                });
                cartModalWarnings.html(warningsHtml);
                $('#cartModalPay').prop('disabled', hasIssues);
            }
            
            // Actualizar totales en el modal
            const subtotal = cart.reduce((sum, item) => sum + (item.unitPrice * item.quantity), 0);
            const tax = currentTaxRate != null ? subtotal * (currentTaxRate / 100) : 0;
            const payMethod = $('#cartModalPaymentMethod').val();
            const applyDiscount = (payMethod === 'CASH' || payMethod === 'TRANSFER') && currentDiscountRate > 0;
            const discountAmt = applyDiscount ? Math.round((subtotal + tax) * (currentDiscountRate / 100) * 100) / 100 : 0;
            const total = subtotal + tax - discountAmt;

            $('#cartModalSubtotal').text(`$${subtotal.toFixed(2)}`);
            $('#cartModalTax').text(`$${tax.toFixed(2)}`);
            if (applyDiscount) {
                $('#cartModalDiscountRow').removeClass('d-none');
                $('#cartModalDiscount').text(`-$${discountAmt.toFixed(2)}`);
            } else {
                $('#cartModalDiscountRow').addClass('d-none');
            }
            $('#cartModalTotal').text(`$${total.toFixed(2)}`);
            if (currentTaxRate == null) {
                $('#cartModalTaxLabel').text('IVA: No configurado');
            } else {
                $('#cartModalTaxLabel').text(`IVA (${currentTaxRate.toFixed(0)}%):`);
            }
        }
        
        function openCartModal() {
            updateCartModal();
            const cartModal = new bootstrap.Modal(document.getElementById('cartModal'));
            cartModal.show();
        }

        function updateQuantity(productId, newQuantity) {
            if (newQuantity < 1) return;
            
            const item = cart.find(i => i.productId === productId);
            if (item && newQuantity <= item.maxAvailable) {
                item.quantity = newQuantity;
                updateCart();
                checkStockAvailability();
            } else if (newQuantity > item.maxAvailable) {
                showAlert('No hay suficiente stock disponible', 'warning');
            }
        }

        function removeFromCart(productId) {
            cart = cart.filter(item => item.productId !== productId);
            updateCart();
            checkStockAvailability();
        }

        function updateTotals() {
            // Los totales ahora solo se actualizan en el modal
            updateCartModal();
        }

        function checkStockAvailability() {
            // Las advertencias de stock ahora solo se muestran en el modal
            updateCartModal();
        }

        function initializeEventHandlers() {
            // Product search
            $('#productSearch').on('input', function() {
                const searchTerm = $(this).val().toLowerCase();
                const filtered = products.filter(p => 
                    p.name.toLowerCase().includes(searchTerm) || 
                    p.sku.toLowerCase().includes(searchTerm)
                );
                displayProducts(filtered);
            });

            // Category filter
            $('#categoryFilter').on('change', function() {
                const filterValue = $(this).val();
                if (filterValue === '') {
                    displayProducts(products);
                } else {
                    const filtered = products.filter(p => p.productType === filterValue);
                    displayProducts(filtered);
                }
            });

            // Filter tabs
            $('.filter-tab').click(function() {
                $('.filter-tab').removeClass('active');
                $(this).addClass('active');
                currentFilter = $(this).data('filter');
                applyFilter();
            });

            // Actualizar descuento al cambiar m茅todo de pago
            $('#cartModalPaymentMethod').on('change', function() {
                updateCartModal();
            });

            // Cart modal clear button
            $('#cartModalClear').click(function() {
                if (confirm('驴Est谩 seguro de vaciar el carrito?')) {
                    cart = [];
                    updateCart();
                    updateCartModal();
                    $('#cartModalWarnings').empty();
                    resetGrupal();
                }
            });

            $('#cartModal').on('hidden.bs.modal', function() {
                // Only reset grupal state if the toggle is off or we're not mid-processing
                if (!window._grupalProcessing) {
                    resetGrupal();
                }
                window._grupalProcessing = false;
            });

            // Pay button (modal)
            $('#cartModalPay').click(function() {
                if ($('#toggleGrupal').is(':checked')) {
                    processGroupSale();
                } else {
                    $('#cartModal').modal('hide');
                    showSaleConfirmation();
                }
            });

            // Confirm sale
            $('#confirmSale').click(function() {
                processSale();
            });
        }

        function applyFilter() {
            let filtered = products;
            
            switch(currentFilter) {
                case 'available':
                    filtered = products.filter(p => {
                        const stock = p.availableStock !== undefined ? 
                            p.availableStock : (p.currentStock || 0);
                        return stock > 0;
                    });
                    break;
                case 'combos':
                    filtered = products.filter(p => p.productType === 'COMBO');
                    break;
            }
            
            displayProducts(filtered);
        }

        function showSaleConfirmation() {
            if (currentTaxRate == null) {
                showAlert('El IVA no est谩 configurado. Configure el IVA en Configuraci贸n.', 'warning');
                return;
            }
            const subtotal = cart.reduce((sum, item) => sum + (item.unitPrice * item.quantity), 0);
            const tax = subtotal * (currentTaxRate / 100);
            const paymentMethod = $('#cartModalPaymentMethod').val();
            const paymentMethodText = $('#cartModalPaymentMethod option:selected').text();
            const applyDiscount = (paymentMethod === 'CASH' || paymentMethod === 'TRANSFER') && currentDiscountRate > 0;
            const discountAmt = applyDiscount ? Math.round((subtotal + tax) * (currentDiscountRate / 100) * 100) / 100 : 0;
            const total = subtotal + tax - discountAmt;

            let itemsHtml = '';
            cart.forEach(item => {
                itemsHtml += `
                    <tr>
                        <td>${item.productName}</td>
                        <td class="text-end">${item.quantity}</td>
                        <td class="text-end">$${item.unitPrice.toFixed(2)}</td>
                        <td class="text-end">$${(item.unitPrice * item.quantity).toFixed(2)}</td>
                    </tr>
                `;
            });

            const discountRow = applyDiscount ? `
                <tr class="text-success">
                    <td colspan="3">Descuento (${currentDiscountRate}%):</td>
                    <td class="text-end">-$${discountAmt.toFixed(2)}</td>
                </tr>` : '';

            const confirmationHtml = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th class="text-end">Cant.</th>
                            <th class="text-end">Precio</th>
                            <th class="text-end">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemsHtml}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3" class="fw-bold">Subtotal:</td>
                            <td class="text-end fw-bold">$${subtotal.toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td colspan="3" class="fw-bold">${`IVA (${currentTaxRate.toFixed(0)}%):`}</td>
                            <td class="text-end fw-bold">$${tax.toFixed(2)}</td>
                        </tr>
                        ${discountRow}
                        <tr>
                            <td colspan="3" class="fw-bold">Total:</td>
                            <td class="text-end fw-bold">$${total.toFixed(2)}</td>
                        </tr>
                    </tfoot>
                </table>
                <div class="mt-3">
                    <strong>M茅todo de pago:</strong> ${paymentMethodText}
                </div>
            `;

            $('#saleConfirmation').html(confirmationHtml);
            $('#saleModal').modal('show');
        }

        function processSale() {
            if (currentTaxRate == null) {
                showAlert('El IVA no est谩 configurado. Configure el IVA en Configuraci贸n.', 'warning');
                return;
            }
            const subtotal = cart.reduce((sum, item) => sum + (item.unitPrice * item.quantity), 0);
            const tax = subtotal * (currentTaxRate / 100);
            const paymentMethod = $('#cartModalPaymentMethod').val();
            const applyDiscount = (paymentMethod === 'CASH' || paymentMethod === 'TRANSFER') && currentDiscountRate > 0;
            const discountAmt = applyDiscount ? Math.round((subtotal + tax) * (currentDiscountRate / 100) * 100) / 100 : 0;
            const total = subtotal + tax - discountAmt;

            const saleData = {
                tenantId: getCurrentTenantId(),
                items: cart.map(item => ({
                    productId: item.productId,
                    quantity: item.quantity,
                    unitPrice: item.unitPrice
                })),
                paymentMethod: paymentMethod,
                totalAmount: total
            };
            
            $('#saleModal').modal('hide');
            
            const token = localStorage.getItem('adminToken');
            if (!token) {
                showAlert('Debe iniciar sesi贸n como empleado o administrador para procesar ventas.', 'warning');
                return;
            }
            $.ajax({
                url: '/api/sales',
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + token },
                contentType: 'application/json',
                data: JSON.stringify(saleData),
                success: function(response) {
                    showAlert('Venta procesada exitosamente', 'success');
                    cart = [];
                    updateCart();
                    updateCartModal();
                    $('#cartModalWarnings').empty();
                    $('#cartModal').modal('hide');
                    var totalText = response.totalAmount != null ? 'Total: $' + parseFloat(response.totalAmount).toFixed(2) : '';
                    $('#saleSuccessTotal').text(totalText);
                    var successModal = new bootstrap.Modal(document.getElementById('saleSuccessModal'));
                    successModal.show();
                    document.getElementById('saleSuccessCloseBtn').onclick = function() {
                        successModal.hide();
                        if (confirm('驴Desea imprimir el ticket?')) {
                            printReceipt(response);
                        }
                    };
                },
                error: function(xhr) {
                    if (xhr.status === 401) {
                        showAlert('Sesi贸n expirada. Inicie sesi贸n nuevamente.', 'warning');
                        setTimeout(function() { window.location.href = '/login'; }, 2000);
                        return;
                    }
                    const error = xhr.responseJSON?.error || 'Error al procesar la venta';
                    showAlert(error, 'danger');
                }
            });
        }

        function printReceipt(sale) {
            // This would open a print dialog or send to a thermal printer
            console.log('Printing receipt for sale:', sale);
            window.open(`/receipt/${sale.id}`, '_blank');
        }

        function loadTaxRate() {
            const token = localStorage.getItem('adminToken');
            $.ajax({
                url: '/api/settings/tax_rate',
                method: 'GET',
                headers: token ? { 'Authorization': 'Bearer ' + token } : {},
                data: { tenantId: getCurrentTenantId() },
                success: function(response) {
                    const parsed = parseFloat(response.value);
                    currentTaxRate = !isNaN(parsed) && parsed >= 0 && parsed <= 100 ? parsed : null;
                    updateTaxLabel();
                    updateTotals();
                },
                error: function() {
                    currentTaxRate = null;
                    updateTaxLabel();
                    updateTotals();
                }
            });
        }

        function loadDiscountRate() {
            $.ajax({
                url: '/api/public/discount-rate',
                method: 'GET',
                data: { tenantId: getCurrentTenantId() },
                success: function(response) {
                    currentDiscountRate = response.value || 0;
                    updateCartModal();
                },
                error: function() { currentDiscountRate = 0; }
            });
        }

        function updateTaxLabel() {
            if (currentTaxRate == null) {
                $('#cartModalTaxLabel').text('IVA: No configurado');
            } else {
                $('#cartModalTaxLabel').text(`IVA (${currentTaxRate.toFixed(0)}%):`);
            }
        }

        function getCurrentTenantId() {
            // This should get the current tenant ID from session or context
            return 1; // Placeholder
        }

        //  Venta Grupal 

        var grupalParticipantes = []; // [{customerId, customerName, amountDue, paymentMethod, productIndexes:[]}]
        var grupalSearchTimer = null;
        var grupalSelectedCustomer = null; // {id, name}

        function toggleModoGrupal() {
            var on = $('#toggleGrupal').is(':checked');
            if (on) {
                $('#grupalSection').removeClass('d-none');
                $('#normalPaymentMethodDiv').addClass('d-none');
            } else {
                $('#grupalSection').addClass('d-none');
                $('#normalPaymentMethodDiv').removeClass('d-none');
                resetGrupal();
            }
        }

        function resetGrupal() {
            grupalParticipantes = [];
            grupalSelectedCustomer = null;
            $('#toggleGrupal').prop('checked', false);
            $('#grupalSection').addClass('d-none');
            $('#normalPaymentMethodDiv').removeClass('d-none');
            $('#grupalClienteSearch').val('');
            $('#grupalClienteDropdown').hide().empty();
            $('#grupalParticipantes').empty();
            $('#grupalValidacion').empty();
        }

        function grupalBuscarCliente(query) {
            clearTimeout(grupalSearchTimer);
            var q = (query || '').trim();
            if (q.length < 2) {
                $('#grupalClienteDropdown').hide().empty();
                return;
            }
            grupalSearchTimer = setTimeout(function() {
                var token = localStorage.getItem('adminToken');
                $.ajax({
                    url: '/api/customers',
                    method: 'GET',
                    headers: token ? { 'Authorization': 'Bearer ' + token } : {},
                    data: { search: q, tenantId: getCurrentTenantId() },
                    success: function(res) {
                        var customers = res.customers || [];
                        var $drop = $('#grupalClienteDropdown');
                        $drop.empty();
                        if (customers.length === 0) {
                            $drop.append('<div class="list-group-item list-group-item-action disabled small">Sin resultados</div>');
                        } else {
                            customers.slice(0, 8).forEach(function(c) {
                                var already = grupalParticipantes.some(function(p) { return p.customerId === c.id; });
                                var $item = $('<button type="button" class="list-group-item list-group-item-action py-1 small"></button>')
                                    .text(c.name + (c.cedula ? ' 路 ' + c.cedula : ''))
                                    .prop('disabled', already);
                                if (!already) {
                                    $item.click(function() {
                                        grupalAgregarParticipante(c.id, c.name);
                                        $('#grupalClienteSearch').val('');
                                        $drop.hide().empty();
                                    });
                                }
                                $drop.append($item);
                            });
                        }
                        $drop.show();
                    }
                });
            }, 300);
        }

        function grupalAgregarDesdeInput() {
            var q = $('#grupalClienteSearch').val().trim();
            if (q.length < 2) return;
            grupalBuscarCliente(q);
        }

        function grupalAgregarParticipante(customerId, customerName) {
            if (grupalParticipantes.some(function(p) { return p.customerId === customerId; })) return;
            grupalParticipantes.push({
                customerId: customerId,
                customerName: customerName,
                amountDue: 0,
                paymentMethod: 'CASH',
                productIndexes: cart.map(function(_, i) { return i; }) // select all by default
            });
            grupalRenderParticipantes();
            grupalRecalcAmounts();
            grupalValidar();
        }

        function grupalEliminarParticipante(customerId) {
            grupalParticipantes = grupalParticipantes.filter(function(p) { return p.customerId !== customerId; });
            grupalRenderParticipantes();
            grupalValidar();
        }

        function grupalRenderParticipantes() {
            var $cont = $('#grupalParticipantes').empty();
            if (grupalParticipantes.length === 0) {
                $cont.html('<p class="text-muted small mb-0">Agrega participantes usando el buscador.</p>');
                return;
            }
            grupalParticipantes.forEach(function(p, pi) {
                var itemsHtml = '';
                cart.forEach(function(item, ci) {
                    var checked = p.productIndexes.indexOf(ci) !== -1 ? 'checked' : '';
                    var lineTotal = (item.unitPrice * item.quantity).toFixed(2);
                    itemsHtml += '<div class="form-check form-check-sm">' +
                        '<input class="form-check-input" type="checkbox" ' + checked +
                        ' id="gpp_' + pi + '_' + ci + '"' +
                        ' onchange="grupalToggleProducto(' + pi + ',' + ci + ',this.checked)">' +
                        '<label class="form-check-label small" for="gpp_' + pi + '_' + ci + '">' +
                            escapeHtml(item.productName) + ' ' + item.quantity +
                            ' <span class="text-muted">($' + lineTotal + ')</span>' +
                        '</label></div>';
                });

                var methodOptions = [
                    { val: 'CASH', label: 'Efectivo' },
                    { val: 'TRANSFER', label: 'Transferencia' },
                    { val: 'CREDIT', label: 'Cr茅dito' }
                ].map(function(o) {
                    return '<option value="' + o.val + '"' + (p.paymentMethod === o.val ? ' selected' : '') + '>' + o.label + '</option>';
                }).join('');

                var card = '<div class="card card-body py-2 px-3 mb-2">' +
                    '<div class="d-flex justify-content-between align-items-center mb-1">' +
                        '<strong class="small"><i class="bi bi-person-fill me-1"></i>' + escapeHtml(p.customerName) + '</strong>' +
                        '<button type="button" class="btn btn-sm btn-link text-danger p-0" onclick="grupalEliminarParticipante(' + p.customerId + ')">' +
                            '<i class="bi bi-x-circle"></i></button>' +
                    '</div>' +
                    '<div class="mb-1">' + itemsHtml + '</div>' +
                    '<div class="d-flex gap-2 align-items-center">' +
                        '<select class="form-select form-select-sm" style="width:auto" onchange="grupalCambiarMetodo(' + pi + ',this.value)">' +
                            methodOptions +
                        '</select>' +
                        '<div class="input-group input-group-sm flex-fill">' +
                            '<span class="input-group-text">$</span>' +
                            '<input type="number" class="form-control" step="0.01" min="0" value="' + p.amountDue.toFixed(2) + '"' +
                            ' onchange="grupalCambiarMonto(' + pi + ',this.value)" oninput="grupalValidar()">' +
                        '</div>' +
                    '</div>' +
                '</div>';
                $cont.append(card);
            });
        }

        function grupalToggleProducto(pi, ci, checked) {
            var p = grupalParticipantes[pi];
            if (!p) return;
            if (checked) {
                if (p.productIndexes.indexOf(ci) === -1) p.productIndexes.push(ci);
            } else {
                p.productIndexes = p.productIndexes.filter(function(x) { return x !== ci; });
            }
            // Recalc amount for this participant based on selected products
            var amount = 0;
            p.productIndexes.forEach(function(idx) {
                var item = cart[idx];
                if (item) amount += item.unitPrice * item.quantity;
            });
            if (currentTaxRate) amount = amount * (1 + currentTaxRate / 100);
            p.amountDue = Math.round(amount * 100) / 100;
            grupalRenderParticipantes();
            grupalValidar();
        }

        function grupalCambiarMetodo(pi, method) {
            if (grupalParticipantes[pi]) grupalParticipantes[pi].paymentMethod = method;
        }

        function grupalCambiarMonto(pi, val) {
            if (grupalParticipantes[pi]) grupalParticipantes[pi].amountDue = parseFloat(val) || 0;
            grupalValidar();
        }

        function grupalRecalcAmounts() {
            if (grupalParticipantes.length === 0) return;
            var subtotal = cart.reduce(function(s, item) { return s + item.unitPrice * item.quantity; }, 0);
            var total = currentTaxRate ? subtotal * (1 + currentTaxRate / 100) : subtotal;
            var perPerson = Math.round((total / grupalParticipantes.length) * 100) / 100;
            grupalParticipantes.forEach(function(p) { p.amountDue = perPerson; });
        }

        function grupalDividirIgualmente() {
            if (grupalParticipantes.length === 0) {
                showAlert('Agrega al menos un participante primero.', 'warning');
                return;
            }
            var subtotal = cart.reduce(function(s, item) { return s + item.unitPrice * item.quantity; }, 0);
            var total = currentTaxRate ? subtotal * (1 + currentTaxRate / 100) : subtotal;
            var n = grupalParticipantes.length;
            var each = Math.floor((total / n) * 100) / 100;
            var remainder = Math.round((total - each * n) * 100) / 100;
            grupalParticipantes.forEach(function(p, i) {
                p.productIndexes = cart.map(function(_, ci) { return ci; });
                p.amountDue = each + (i === 0 ? remainder : 0); // give remainder to first participant
            });
            grupalRenderParticipantes();
            grupalValidar();
        }

        function grupalValidar() {
            var subtotal = cart.reduce(function(s, item) { return s + item.unitPrice * item.quantity; }, 0);
            var total = currentTaxRate ? subtotal * (1 + currentTaxRate / 100) : subtotal;
            var suma = grupalParticipantes.reduce(function(s, p) { return s + (parseFloat(p.amountDue) || 0); }, 0);
            var diff = Math.abs(suma - total);
            var $val = $('#grupalValidacion');
            if (grupalParticipantes.length === 0) {
                $val.html('<span class="text-muted">Sin participantes a煤n.</span>');
                return false;
            }
            if (diff <= 0.02) {
                $val.html('<span class="text-success"><i class="bi bi-check-circle"></i> Montos correctos ($' + suma.toFixed(2) + ' / $' + total.toFixed(2) + ')</span>');
                return true;
            } else {
                $val.html('<span class="text-danger"><i class="bi bi-exclamation-triangle"></i> Suma $' + suma.toFixed(2) + '  Total $' + total.toFixed(2) + '</span>');
                return false;
            }
        }

        function escapeHtml(str) {
            return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
        }

        function processGroupSale() {
            if (!grupalValidar()) {
                showAlert('La suma de montos no coincide con el total del carrito.', 'warning');
                return;
            }
            if (grupalParticipantes.length === 0) {
                showAlert('Agrega al menos un participante.', 'warning');
                return;
            }
            var subtotal = cart.reduce(function(s, item) { return s + item.unitPrice * item.quantity; }, 0);
            var total = currentTaxRate ? subtotal * (1 + currentTaxRate / 100) : subtotal;

            var payload = {
                tenantId: getCurrentTenantId(),
                items: cart.map(function(item) {
                    return { productId: item.productId, quantity: item.quantity, unitPrice: item.unitPrice };
                }),
                participants: grupalParticipantes.map(function(p) {
                    var obj = { customerId: p.customerId, amountDue: parseFloat(p.amountDue) || 0, paymentMethod: p.paymentMethod };
                    return obj;
                }),
                notes: 'Venta grupal desde POS'
            };

            var token = localStorage.getItem('adminToken');
            if (!token) {
                showAlert('Debe iniciar sesi贸n para procesar ventas.', 'warning');
                return;
            }

            window._grupalProcessing = true;
            $('#cartModal').modal('hide');

            $.ajax({
                url: '/api/group-purchases/from-cart',
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + token },
                contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function(response) {
                    showAlert('Venta grupal procesada exitosamente', 'success');
                    cart = [];
                    updateCart();
                    updateCartModal();
                    $('#cartModalWarnings').empty();
                    resetGrupal();
                    var totalText = response.totalAmount != null ? 'Total: $' + parseFloat(response.totalAmount).toFixed(2) : '';
                    $('#saleSuccessTotal').text(totalText);
                    var successModal = new bootstrap.Modal(document.getElementById('saleSuccessModal'));
                    successModal.show();
                    document.getElementById('saleSuccessCloseBtn').onclick = function() {
                        successModal.hide();
                    };
                },
                error: function(xhr) {
                    if (xhr.status === 401) {
                        showAlert('Sesi贸n expirada. Inicie sesi贸n nuevamente.', 'warning');
                        setTimeout(function() { window.location.href = '/login'; }, 2000);
                        return;
                    }
                    var err = xhr.responseJSON;
                    var msg = (err && err.error) ? err.error : 'Error al procesar la venta grupal';
                    if (err && err.details) msg += ': ' + err.details;
                    showAlert(msg, 'danger');
                    window._grupalProcessing = false;
                    $('#cartModal').modal('show');
                }
            });
        }

        // 

        function showAlert(message, type) {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show position-fixed" 
                     style="top: 20px; right: 20px; z-index: 9999;" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            $('body').append(alertHtml);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                $('.alert').alert('close');
            }, 5000);
        }
    </script>
</body>
</html>